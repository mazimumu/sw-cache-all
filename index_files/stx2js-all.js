function NS_functions(){this.operationWaitingPollingInterval=3000;this.operationWaitingNumberRetries=2;this.currentRetry=0;this.updatePrices=function(){var b=this,a=0;$(".table_container").each(function(){var c=0,d=0;$(this).find("tr").each(function(){var k,i,h,g,f=true,j,e;k=$('td.quantity select, td.quantity input[type="text"], td input[type="hidden"].quantity',this);if(k.length>0){f=b.validateQuantityInputField(k)}j=$(this).find(".unit_price .amount").last();e=$(this).find('.subscription input[type="checkbox"]');if(k.length>0&&f&&(e.length===0||e.is(":checked"))){i=parseInt($(k).val(),10);h=j.data("amount");g=i*h;$(this).find(".subtotal .amount").html(functions.generateAmount(g));c+=g;d+=i}else{$(this).find(".subtotal .amount").html(functions.generateAmount(0))}});$(this).find("tr.subtotal td.reservation_amount .amount").html(functions.generateAmount(c));a+=c;if(typeof selectedProductPlural!="undefined"){b.updateSelectedQuantityIndicator(d,this)}});return a};this.updateSelectedQuantityIndicator=function(d,a){var b=selectedProductPlural,c=$(a).find("tr.subtotal span.quantity");if(d>0){if(d===1){b=selectedProductSingular}c.show()}else{c.hide()}c.html(d+" "+b)};this.addCardNumberSeparators=function(a){var b=a.split("-").join("");return b.match(/.{1,4}/g).join("-")};this.handleFormSubmit=function(a,c,e,d){var b;if(d&&secutix.date&&secutix.date.picker&&secutix.date.picker.check&&secutix.date.picker.check.isDatepickerSetToToday(d)){return}$("#notification").hide();b=$(c).parents("form:first");if(a){b.submit(function(){var g,h,f;for(h=0,f=e.length;h<f;h++){g=e[h].split(".")[0];$(this).find("[name^='"+g+"']").each(function(){$(this).attr("disabled","disabled")});$(this).find("[name^='preferredAreas']").each(function(){if($(this).val()===""){$(this).attr("disabled","disabled")}})}return true})}b.submit()};this.validateQuantities=function(a,h,e,g,j){var f,d,i=this,b=false,c=true,k=true;h=h||".table_container";if(!$("#emptyMemberCard").hasClass("hidden")){$("#emptyMemberCard").addClass("hidden")}f=false;d=[];$(h).each(function(){$('td.quantity select, td.quantity input[type="text"]',this).each(function(){if(!i.validateQuantityInputField($(this))){b=true}else{if(parseInt($(this).val(),10)>0){f=true}else{d.push($(this).attr("name"))}}})});if(b){if(j){j(false)}return}$("#freeAmountRange").hide();priceElements=$('.unit_price input[type="text"]');priceElements.each(function(){c=c&&i.validateUnitPriceInputField($(this))});if(f&&c&&typeof audSubCatVerification!=="undefined"){audSubCatVerification.validateAllQuantities(e,false,function(l){if(!l){k=false}else{i.handleFormSubmit(a,h,d,g)}if(j){j(k)}})}else{if(typeof audSubCatVerification==="undefined"){i.handleFormSubmit(a,h,d,g)}if(!f){k=false;$(".main_content_notification:has(div.error)").not(".hidden").addClass("hidden");$("#notification.hidden").removeClass("hidden");window.scrollTo(0,0)}if(j){j(k)}}};this.validateQuantityInputField=function(b){var a=[{rule:validation.numericRule(true)},{rule:validation.numericBoundsRule(b.data("minQuantity"),b.data("maxQuantity"),true,true)}];return validation.validateField(b,a,null,true)};this.validateQuantityInputFieldAndHideTooltipIfOk=function(b){var a=[{rule:validation.numericRule(true)},{rule:validation.numericBoundsRule(b.data("minQuantity"),b.data("maxQuantity"),true,true)}];return validation.validateFieldAndHandleTooltip(true,b,a,null,true)};this.validateUnitPriceInputField=function(e){var b,d=e.attr("name").split("[")[1].split("]")[0],a,c;a=parseInt($('[name="serviceFormData['+d+'].quantity"]').val(),10)===0||e.data("minQuantity")<=0;b=[{rule:validation.numericBoundsRule(e.data("minQuantity"),e.data("maxQuantity"),a,false,undefined,function(f){return f*1000}),errorId:"freeAmountRange"}];e.parent().removeClass("error");c=validation.validateField(e,b,null,true,true);if(!a&&e.val().length===0){c=false;e.parent().addClass("error");$("#freeAmountRange").show()}if(typeof preventFormSubmit!="undefined"&&preventFormSubmit){c=false}return c};this.updateOrderAmount=function(b){var c,a;c=parseInt($("#saleAmountValue").val(),10);a=c+b;if(a===0){$(".button.pay").hide();$(".button.not_paying").show()}else{$(".button.pay").show();$(".button.not_paying").hide()}$("#final_amount").html(functions.generateAmount(a));$("#main_content_summary_delivery .subtotal .amount").html(functions.generateAmount(b))};this.conditionsAccepted=function(a){if(!$("#conditionsAccepted1").is(":checked")){$(".main_content_group.hidden").removeClass("hidden");window.scrollTo(0,0);return false}$("#notification").hide();tools.form.submitWithProcessing($("form:first"))};this.getIntPartFromAmount=function(c){var b="0",a=/(\d+)(\d{3})/;if(c.length<secutixAmountDecimalSize+1){return b}b=c.substring(0,c.length-secutixAmountDecimalSize);if(priceSeparator.length==1&&b.length>0){while(a.test(b)){b=b.replace(a,"$1"+priceSeparator+"$2")}}return b};this.getMantissaFromAmount=function(c){var b,a,d="";if(currencyFractionDigit===0){return""}for(b=c.length;b<secutixAmountDecimalSize;b++){c="0"+c}a=c.substring(Math.max(c.length-secutixAmountDecimalSize,0),c.length-secutixAmountDecimalSize+currencyFractionDigit);for(b=0;b<currencyFractionDigit;b++){d+="0"}if(a==d){return zeroCentLabel}return a};this.generateAmount=function(e){var h,b,g,d,a,c,f="";e=e.toString();c=functions.getMantissaFromAmount(e);if(c===zeroCentLabel){f="zeroCentMantissa"}h='<span class="int_part">'+functions.getIntPartFromAmount(e)+"</span>";b='<span class="mantissa '+f+'">'+c+"</span>";g='<span class="currency currency_code">'+currencyCode+"</span>";d='<span class="currency currency_symbol">'+currencySymbol+"</span>";amountDecimalSeaparatorHtml='<span class="decimal_separator '+f+'">'+amountDecimalSeaparator+"</span>";a=amountFormat;a=a.replace("{amountIntPart}",h);a=a.replace("{amountMantissa}",b);a=a.replace("{currencyCode}",g);a=a.replace("{currencySymbol}",d);a=a.replace("{decimalSeparator}",amountDecimalSeaparatorHtml);return a};this.checkCrossSell=function(b,a){var c=a!==undefined?a:"confirmationDialog_"+b;$.ajax({type:"POST",url:contextPath+"/ajax/cart/cancelOperations/checkCrossSell",cache:false,data:{operationIds:b},success:function(d){if(d!==""){$("#"+c).attr("title",crossSellDialogTitle);$("#"+c).find(".dialog-message").html(d);$("#"+c).find(".dialog-button-ok").find(".text").html(crossSellDialogRemove);$("#"+c).find(".dialog-button-cancel").find(".text").html(crossSellDialogCancel);tools.dialog.showDialog(c,true,false,false,null);$("#"+c).parent().addClass("cross-sell-dialog")}else{tools.dialog.showDialog(c,true,true,false,"cancel_message_dialog")}},error:function(){tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.cancelOperations=function(a,b){this.genericAjaxPost(contextPath+"/ajax/cart/cancelOperations",{operationIds:b},function(c){if(isNaN(c)){tools.dialog.showDialog("concurrencyDialog",true,true)}else{window.location.reload()}})};this.genericAjaxPost=function(b,c,a){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"POST",url:b,cache:false,data:c,success:function(d){tools.dialog.hideDialog("loadingDialog");a(d)},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.interruptCheckout=function(){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/checkout/interruptCheckout",cache:false,success:function(a){location.reload()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.cancelCheckout=function(){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/checkout/cancelCheckout",cache:false,success:function(a){location.reload()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.toggleTableView=function(a,b){var c;if(b){c=$("#table_"+b)}else{c=$(a).closest(".seat_category_section").find("table")}functions.toggleElementViewStatus(c,a)};this.toggleElementViewStatus=function(b,a){b.toggle(0,function(){var c=compactCheckoutViewShow;if($(this).is(":visible")){c=compactCheckoutViewHide;$(a).parent().removeClass("plus");$(a).parent().addClass("less")}else{$(a).parent().removeClass("less");$(a).parent().addClass("plus")}$(a).find(".text").html(c)})};this.resetEnclosingForm=function(b,a){$(b).closest("form")[0].reset();if(a!==true){$(b).closest("form").find("table").each(function(){$(this).find("input[type='radio']").each(function(){if(!$(this).is(":disabled")){$(this).prop("checked",true);return false}})})}};this.waitForOperationCompletion=function(){tools.dialog.showWaitingPopup("operationOnGoingDialog",true,null);jQuery.ajax({type:"GET",url:contextPath+"/ajax/orderModificationOngoing",cache:false,success:function(a){if(a===true){if(functions.currentRetry<functions.operationWaitingNumberRetries){functions.currentRetry++;setTimeout(functions.waitForOperationCompletion,functions.operationWaitingPollingInterval)}else{tools.dialog.hideDialog("operationOnGoingDialog");tools.dialog.showDialog("ajaxErrorDialogReload",true,true)}}else{location.reload()}},error:function(){tools.dialog.hideDialog("operationOnGoingDialog");tools.dialog.showDialog("ajaxErrorDialogReload",true,true)}})};this.setSoldOutDivInTable=function(){var b,a=null;$(".table_container .category_unavailable_overlay").each(function(){b=$(this).parent().parent();if(b.hasClass("group_end")){a=b}else{a=b.find("~ tr.group_end");if(!a.length){a=null}}if(a!==null){$(this).css(b.position());$(this).css("height",a.position().top-b.position().top+a.height()-1+"px");$(this).css("width",b.width()+"px");$(this).css("display","block");$(this).parent().siblings(".quantity").find(".buy_unavailable,.no_quantity").each(function(){$(this).css("visibility","hidden")})}})};this.initAudienceSubCategoryDescription=function(){var b=$(".audience-subcat-desc"),a;if(b.hasClass("mobile")){b.click(function(){a=$("#audience-subcat-desc-popup");if(a.length===0){a=$("<div></div>",{id:"audience-subcat-desc-popup",title:b.parent().clone().children().remove().end().text(),"class":"dialog-content",html:b.html()}).appendTo($(document.body))}tools.dialog.showDialog("audience-subcat-desc-popup",true,false)})}else{b.hover(function(){$(this).tipsy("show")},function(){$(this).tipsy("hide")})}}}var functions=new NS_functions();$(function(){functions.initAudienceSubCategoryDescription()});function NS_tools(){$(function(){$(document).on("click","input[type=radio]",function(){$(this).focus()})});this.log=((typeof console!=="undefined")&&(typeof console.log!=="undefined"))?function(f){console.log(f)}:function(){};this.isInteger=function(f){return/^\d+$/.test(f)};var b=function(){var f=$(this);if(!tools.isInteger(f.val())){f.val("")}};this.registerAsIntegerInput=function(f){$("."+f).each(function(g,h){$(this).on("keyup",b).on("change",b)})};this.preventFormAutoSubmit=function(f){$("#"+f).bind("keypress keydown keyup",function(g){if(g.keyCode==13){g.preventDefault();return false}})};this.registerGlobalHandlerAjaxFragmentResponse=function(){$.ajaxSetup({dataFilter:function(g,f){if($.type(g)==="string"&&g.indexOf("login_form")!=-1){location.reload(true);return""}return g}})};this.registerAsToggleLink=function(h,g,f){$("."+h).click(function(i){var j=$(this).parent();i.preventDefault();if($(this).hasClass("less")){$(this).removeClass("less").addClass("plus");j.removeClass(g);j.parent().find(f).slideUp("slow")}else{$(this).removeClass("plus").addClass("less");j.addClass(g);j.parent().find(f).slideDown("slow")}})};this.makePath=function(m,j){var k=m.split("."),f=k.length,h=0,g;j=j||window;for(;h<f-1;h++){g=k[h];if(!j[g]){j[g]={}}j=j[g]}return{scope:j,key:k[f-1]}};this.module=function(l,i,h,f){var k=this.makePath(l,h),g=k.key;h=k.scope;if(typeof f==="object"&&"loadOnce" in f&&f.loadOnce&&g in h){return}if(typeof i==="function"){try{i=i()}catch(j){setTimeout(function(){throw j},10)}}h[g]=i};this.scrollToElement=function(f,g){$("html, body").animate({scrollTop:$(f).offset().top},g)};this.scrollToElementBottom=function(g,h,f){$("html, body").animate({scrollTop:$(g).offset().top-($(window).height()-$(g).height())+f},h)};this.scrollElementInViewport=function(g,h,f){var i=$(g).offset().top+$(g).height()-$(window).scrollTop();if(i>window.innerHeight){this.scrollToElementBottom(g,h,f)}};this.displayLazyImages=function(){$("img.lazy").lazyload({effect:"fadeIn",failure_limit:10,threshold:500})};function a(){this.buttons={};this.timeouts={};this.showDialog=function(g,k,i,m,l){var h=(l?l:""),j=this,f=null;if(displayDialogEffects){f="fade"}$("body > .tipsy").remove();$("#"+g).dialog({buttons:this.buttons[g]?this.buttons[g]:null,closeText:dialogCloseText,draggable:false,closeOnEscape:i!==true,open:function(n,o){j.forceButtonDisplay();if(i){$("#"+g).closest(".ui-dialog").find(".ui-dialog-titlebar-close").hide()}if(!i){$(".ui-widget-overlay").bind("click",function(){$("#"+g).dialog("close")})}},close:m,modal:k,width:"auto",resizable:false,show:f,hide:f,minWidth:50,minHeight:50,dialogClass:h})};this.showWaitingPopup=function(h,f,g){tools.dialog.showDialog(h,true,f,g,"pleaseWaitDialog")};this.showWaitingPopupDelayed=function(j,f,i,h){var g=this;this.timeouts[j]=setTimeout(function(){delete g.timeouts[j];g.showWaitingPopup(j,f,i)},h)};this.hideDialog=function(f){var g=$("#"+f);if(f in this.timeouts){clearTimeout(this.timeouts[f]);delete this.timeouts[f]}if(g.hasClass("ui-dialog-content")){g.dialog("close")}};this.addButton=function(f,h,g){if(!this.buttons[f]){this.buttons[f]={}}this.buttons[f][h]=g};this.hasButtons=function(f){return this.buttons[f]!==undefined};this.forceButtonDisplay=function(){if($("body").hasClass("ie_lte_8")){var f=$(".alternative_button",".ui-dialog-content"),g=$(".button",".ui-dialog-content");g.removeClass("button");f.removeClass("alternative_button");setTimeout(function(){g.addClass("button");f.addClass("alternative_button");g=null;f=null},0)}}}this.dialog=new a();function e(){var g,h,f,i;g="message_title";h="message_content";f="message_container";i=200;this.show=function(k,j){k=k||"";j=j||"";$("#"+g).html(k);$("#"+h).html(j);if(!$("#"+f).is(":hidden")){$("#"+f).fadeTo(0,0,function(){$("#"+f).fadeTo(i,1);return})}$("#"+f).slideDown(200)};this.hide=function(){$("#"+g).html("");$("#"+h).html("");$("#"+f).slideUp(i)}}this.message=new e();function d(){var g=1000,f=null,m="",j="",n="",k="",p="",h=false,o,i,l;this.expirationTime=0;this.setConfig=function(q){m=q.hours;j=q.minutes;n=q.seconds;k=q.and;h=q.isWRCountdown;computeCountdown(q.countdownSeconds)};this.updateTimer=function(){$.ajax({type:"GET",url:contextPath+"/ajax/countdown/update",success:function(q){if(q.basketEmpty===false&&q.countdown){h=q.countDownWR||false;computeCountdown(parseInt(q.countdown,10))}}})};computeCountdown=function(q){var r=new Date();r.setSeconds(r.getSeconds()+q);tools.countdown.expirationTime=r.getTime()};l=function(){$(".countdown_seconds").addClass("highlight")};o=function(v){var r=[],u=0,q=0,t=0;if(v>0&&v<=checkoutCountdownThresholdSeconds){l();q=Math.floor(v/60);t=(v-(q*60));if(q<10){q="0"+q}if(t<10){t="0"+t}r.push(q+":"+t);if(q==="00"){r.push("&nbsp;"+n)}else{r.push("&nbsp;"+j)}return r.join("")}if(v>0){u=Math.floor(v/3600);q=Math.floor((v-(u*3600))/60);t=((v-(u*3600))-(q*60))}if(u>0){r.push(u+" "+m+" "+k+" "+q+" "+j)}else{if(q>0){r.push(q+"&nbsp;"+j)}}if(u===0&&q===0){r.push(t+"&nbsp;"+n)}return r.join("")};i=function(){var q=Math.floor((tools.countdown.expirationTime-(new Date().getTime()))/1000),s,r;if(q>0){s=$(".countdown_seconds");if(s){r=o(q);if(p!=r){p=r;s.each(function(){$(this).html(r)})}}}else{clearTimeout(f);if(h===false){$.ajax({type:"GET",url:contextPath+"/ajax/cart/cancelOrder",success:function(t){if(t&&t===true){tools.dialog.showDialog("expirationDialog",true,true,false,"expiration_dialog")}}})}else{tools.dialog.showDialog("timeoutWRExpirationDialog",true,true);setTimeout(function(){$("#buttonExpiration").removeAttr("style");$("#timeoutWRExpirationDialog .please_wait").attr("style","display:none")},5000)}}};this.startCountdown=function(){if(!f){i();f=setInterval(i,g)}};this.stopCountdown=function(){if(!h){clearTimeout(f)}}}this.countdown=new d();function c(){this.DatePicker=function(f,g,h,j){var i=this;this.calendarConfiguration=f;this.isVisitSpecialCalendar=false;this.preComputedDates={};this.alreadyLoadedMonths={};this.LEGEND_TYPE_NONE=0;this.LEGEND_TYPE_AVAILABILITY=1;this.LEGEND_TYPE_RATE=2;this.LEGEND_TYPE_AVAILABILITY_TABLE=3;this.LEGEND_TYPE_AVAILABILITY_OVER=4;this.productId=0;this.advantageId=undefined;this.baseProductId=undefined;this.crossSellId=undefined;if(typeof j!=="undefined"){this.dateUpdateUrl=j}else{if(h){this.dateUpdateUrl="/ajax/selection/package/date/range"}else{this.dateUpdateUrl="/ajax/event/date/range"}}this.isPackage=h;this.packageLineId=null;this.rateTypes=[];this.singularText=datePickerConfig.singularText;this.pluralText=datePickerConfig.pluralText;this.legendFree=datePickerConfig.legendFree;this.legendLimited=datePickerConfig.legendLimited;this.legendFull=datePickerConfig.legendFull;this.legendAdvantage=datePickerConfig.legendAdvantage;this.legendToday=datePickerConfig.legendToday;this.dateFormat=datePickerConfig.dateFormat;this.isAllowHideAvailabilityLegend=datePickerConfig.isAllowHideAvailabilityLegend;this.isAvailabilitiesAreGood=false;this.cssLegendFree="datepicker_legend_free";this.cssLegendLimited="datepicker_legend_limited";this.cssLegendFull="datepicker_legend_full";this.cssLegendAdvantage="datepicker_legend_advantage";this.cssLegendToday="datepicker_legend_today";this.cssLegendRate="datepicker_legend_rate_";this.legendContainer=".datepicker_legend";this.minDate=null;this.maxDate=null;this.selectedDateText=null;this.requirePerformances=g;this.legendType=this.LEGEND_TYPE_NONE;this.showAdvantageLegend=false;this.parseDate=function(k){return $.datepicker.parseDate(this.dateFormat,k)};this.getPerformanceForDate=function(k){return this.getCalendarConfigForDate(k).performances};this.getCalendarConfigForDate=function(k){var l=0;for(l in this.calendarConfiguration){if(this.calendarConfiguration[l].performanceDate===k){return this.calendarConfiguration[l]}}};this.getMinDate=function(n){var l,m,k;for(m=0,k=i.calendarConfiguration.length;m<k;m++){l=this.parseDate(i.calendarConfiguration[m].performanceDate);if(this.minDate===undefined||this.minDate>l){this.minDate=l}}return this.minDate};this.getMinDateWithAvailability=function(){var l,n,k,m=undefined;for(n=0,k=i.calendarConfiguration.length;n<k;n++){if(i.calendarConfiguration[n].availability!="NONE"){l=this.parseDate(i.calendarConfiguration[n].performanceDate);if(m===undefined||m>l){m=l}}}return m};this.setMaxDate=function(k){this.maxDate=this.parseDate(k)};this.setMinDate=function(k){this.minDate=this.parseDate(k)};this.preComputeDates=function(l){var q="",n,p,o,m,k;i.isAvailabilitiesAreGood=true;for(o=0,k=l.length;o<k;o++){if(l[o].availability!=="GOOD"){i.isAvailabilitiesAreGood=false}p=this.parseDate(l[o].performanceDate);if(this.preComputedDates[p]!==undefined){continue}if(l[o].numPerformances>0){if(l[o].numPerformances===1){q="1 "+this.singularText}else{q=l[o].numPerformances+" "+i.pluralText}}n="datepicker_selectable";if(i.legendType===i.LEGEND_TYPE_AVAILABILITY||i.legendType===i.LEGEND_TYPE_AVAILABILITY_TABLE){if(l[o].availability==="NONE"){if(i.isPackage){n="datepicker_full"}else{n+=" datepicker_full"}}else{if(l[o].advantage){n+=" advantage"}if(l[o].availability==="GOOD"){n+=" datepicker_free"}else{if(l[o].availability==="LIMITED"){n+=" datepicker_limited"}}}}else{if(i.legendType===i.LEGEND_TYPE_AVAILABILITY_OVER){q+="\n";if(l[o].availability==="NONE"){q+=i.legendFull;if(i.isPackage){n="datepicker_full"}else{n+=" datepicker_full"}}else{if(l[o].advantage){q=this.legendAdvantage+", ";n+=" advantage"}if(l[o].availability==="GOOD"){q+=i.legendFree;n+=" datepicker_free"}else{if(l[o].availability==="LIMITED"){q+=i.legendLimited;n+=" datepicker_limited"}}}}else{if(i.legendType===i.LEGEND_TYPE_RATE){if(l[o].advantage){n+=" advantage";q=this.legendAdvantage}else{n+=" datepicker_rate datepicker_rate_"+l[o].rateTypeId;for(m=0;m<i.rateTypes.length;m++){if(parseInt(i.rateTypes[m].id,10)===parseInt(l[o].rateTypeId,10)){q=datePickerConfig.legendRate.replace("{0}",i.rateTypes[m].description);break}}}}else{n+=" datepicker_existing_performances"}}}this.preComputedDates[p]={text:q,cssClass:n}}};this.showDatePicker=function(p,m){var o,k,l,n;if(this.minDate===null){for(o=0,k=this.calendarConfiguration.length;o<k;o++){l=this.parseDate(this.calendarConfiguration[o].performanceDate);if(this.minDate===null||this.minDate>l){this.minDate=l}}}if(this.selectedDateText===null){this.selectedDateText=$.datepicker.formatDate(this.dateFormat,this.minDate)}n=this.parseDate(this.selectedDateText);this.preComputeDates(this.calendarConfiguration);i.alreadyLoadedMonths[""+n.getFullYear()+(n.getMonth()+1)]=true;tools.date.makeDatePicker(p,{minDate:this.minDate,maxDate:this.maxDate,beforeShowDay:this.checkDatesToShow,onSelect:function(r,q){if(r!==i.selectedDateText){i.selectedDateText=r;m.apply(this,[r,q])}else{if($(p).dialog&&$(p).hasClass("ui-dialog-content")){$(p).dialog("close")}}},onChangeMonthYear:this.updateCalendarConfiguration,dateFormat:this.dateFormat,defaultDate:this.isPackage?this.getMinDateWithAvailability():this.selectedDateText,closeOnEscape:true,firstDay:1,showOtherMonths:false,hideIfNoPrevNext:true});if(this.legendType>this.LEGEND_TYPE_NONE){this.createLegend()}};this.createLegend=function(){var l,k;l="";if(this.isAllowHideAvailabilityLegend===true&&this.isAvailabilitiesAreGood===true){$(this.legendContainer).html(l);return}switch(this.legendType){case this.LEGEND_TYPE_AVAILABILITY:l+=this.createLegendItem(this.legendFree,this.cssLegendFree);l+=this.createLegendItem(this.legendLimited,this.cssLegendLimited);l+=this.createLegendItem(this.legendFull,this.cssLegendFull);if(this.showAdvantageLegend){l+=this.createLegendItem(this.legendAdvantage,this.cssLegendAdvantage)}break;case this.LEGEND_TYPE_AVAILABILITY_TABLE:l+="<table>";l+="<tr>";l+="<td>";l+=this.createLegendItem(this.legendFree,this.cssLegendFree);l+=this.createLegendItem(this.legendLimited,this.cssLegendLimited);l+=this.createLegendItem(this.legendFull,this.cssLegendFull);l+="</td>";l+="<td>";if(this.showAdvantageLegend){l+=this.createLegendItem(this.legendAdvantage,this.cssLegendAdvantage)}l+="</td>";l+="</tr>";l+="</table>";break;case this.LEGEND_TYPE_RATE:for(k=0;k<this.rateTypes.length;k++){l+=this.createLegendItem(this.rateTypes[k].description,this.cssLegendRate+this.rateTypes[k].id)}if(this.showAdvantageLegend){l+=this.createLegendItem(this.legendAdvantage,this.cssLegendAdvantage)}break}$(this.legendContainer).html(l)};this.createLegendItem=function(m,l){var k='<span class="datepicker_legend_item '+l+'">';k+='<span class="datepicker_legend_color_box"></span>';k+='<span class="datepicker_legend_text">'+m+"</span></span>";return k};this.updateCalendarConfiguration=function(l,o,k){var m,n=this;if(i.alreadyLoadedMonths[""+l+o]===true){return}m={productId:i.productId,advantageId:i.advantageId,ppid:i.baseProductId,crossSellId:i.crossSellId,month:o,year:l,requirePerformances:i.requirePerformances,visitExtendedInfo:i.isVisitSpecialCalendar};if(i.isPackage===true){m.packageLineId=i.packageLineId}tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",async:(typeof k==="undefined"?true:k),url:contextPath+i.dateUpdateUrl,data:m,success:function(p){i.calendarConfiguration=i.calendarConfiguration.concat(p);i.preComputeDates(p);if(i.legendType>i.LEGEND_TYPE_NONE){i.createLegend()}i.alreadyLoadedMonths[""+l+o]=true;$(n).datepicker("refresh");tools.dialog.hideDialog("loadingDialog")},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.checkDatesToShow=function(k){var m=i.preComputedDates[k],l=true;if(m!==undefined){if(i.isPackage&&m.cssClass==="datepicker_full"){l=false}return[l,m.cssClass,m.text]}return[false,"",""]}};this.isTodayDate=function(g){var f=new Date();return this.isSameDate(f,g)};this.isSameDate=function(g,f){return(g.getDate()===f.getDate()&&g.getMonth()===f.getMonth()&&g.getYear()===f.getYear())};this.makeDatePicker=function(f,g){g=g||{};g.selectOtherMonths=g.selectOtherMonths!==false;g.dateFormat=g.dateFormat||datePickerConfig.dateFormat;g.dayNames=datePickerConfig.dayNames;g.dayNamesShort=datePickerConfig.dayNamesShort;g.dayNamesMin=datePickerConfig.dayNamesShort;g.monthNames=datePickerConfig.monthNames;g.monthNamesShort=datePickerConfig.monthNamesShort;g.hideIfNoPrevNext=true;g.firstDay=1;return $(f).datepicker(g)};this.fromJodaDateTime=function(f){if(f.length===6){return new Date(f[0],f[1]-1,f[2],f[3],f[4],f[5])}else{return new Date(f[0],f[1]-1,f[2])}}}this.date=new c();this.isStorageAvailable=function(){try{if(typeof sessionStorage!="undefined"&&typeof JSON!="undefined"&&sessionStorage&&JSON){sessionStorage.setItem("storageCheck","");return true}return false}catch(f){return false}};this.storage=(this.isStorageAvailable())?{setItem:function(f,g){sessionStorage.setItem(f,JSON.stringify(g))},getItem:function(f){try{return JSON.parse(sessionStorage.getItem(f))}catch(g){return null}},removeItem:function(f){sessionStorage.removeItem(f)},clear:function(){sessionStorage.clear()}}:{setItem:function(){},getItem:function(){},removeItem:function(){},clear:function(){}};this.form={submitWithProcessing:function(g){var f=100;tools.dialog.showWaitingPopup("requestProcessingDialog",true);setTimeout(function(){g.submit();g=null},f)},focusFirstEmptyField:function(f){f.find('input:visible[value=""], select:visible[value="0"]').not("disabled").first().focus()}};this.hasClick={};this.preventFormSpam=function(){var f=this;$(document).on("submit","form",function(h){var g=$(this).attr("id")||"no_id";if(f.hasClick[g]){h.preventDefault()}else{f.hasClick[g]=true;$("span.button",this).addClass("disabled")}})};this.preventButtonSpam=function(f,g){var h=this;$(document).on("click",f,function(j){var i=$(this).attr("id")||"no_id";if(h.hasClick[i]){j.preventDefault()}else{h.hasClick[i]=true;$(f).parent().addClass("disabled");if(g){tools.dialog.showWaitingPopup("requestProcessingDialog",true)}}})};this.disableLink=function(g){var h=$(g.target||g.srcElement),f=/MSIE|Trident/gi.test(window.navigator.userAgent);if(h.length){h.attr("onclick","");h.click(function(i){if(!f){i.preventDefault()}f=false})}};this.fireFancybox=function(f){var g=function(){this.title='<a href="'+this.href+'" target="_blank" id="openInNewWindow">'+openInNewWindowLabel+"</a> "+this.title};if(!displayFancyboxInNewTab){$(f).data("fancybox-type","iframe").fancybox({width:"85%",height:"90%",helpers:{title:{type:"inside",position:"top"}},afterLoad:g})}};this.cookie={setItem:function(g,i,f,k){var j=new Date(),h;j.setDate(j.getDate()+f);h=escape(i)+((f===null)?"":"; expires="+j.toUTCString());h+=k?"; path="+k:"";document.cookie=g+"="+h},getItem:function(g){try{var f,k,j,h=document.cookie.split(";");for(f=0;f<h.length;f++){k=h[f].substr(0,h[f].indexOf("="));j=h[f].substr(h[f].indexOf("=")+1);k=k.replace(/^\s+|\s+$/g,"");if(k==g){return unescape(j)}}return null}catch(i){return null}}};this.checkToken=function(){var g=$("input[name=_token]"),h=g.length?g.val():null,f=tools.isStorageAvailable()?tools.storage.getItem("csrfToken"):tools.cookie.getItem("csrfToken");if(h){if(h==f){if(tools.isStorageAvailable()){tools.storage.setItem("csrfToken",null)}else{tools.cookie.setItem("csrfToken","",null)}window.location.reload()}else{if(tools.isStorageAvailable()){tools.storage.setItem("csrfToken",h)}else{tools.cookie.setItem("csrfToken",h,null)}}}};this.keyBoardSubmit=function(h,g){var f=/firefox/gi.test(window.navigator.userAgent)?"input[type=text]:last":"input";$(f,h).on("keypress",function(i){if(i.which===13){$(g).click()}})};this.toggleGroup=function(j,i,g){var h=j.find(".group_content"),f=j.find("> h3");i=i!==false;if((typeof g==="undefined"&&j.hasClass("group_open"))||((typeof g!=="undefined")&&!g)){j.removeClass("group_open").addClass("group_closed");f.removeClass("open").addClass("closed").find(".group_count").removeClass("hidden");if(i){h.slideUp()}else{h.hide()}}else{j.removeClass("group_closed").addClass("group_open");f.removeClass("closed").addClass("open").find(".group_count").addClass("hidden");if(i){h.slideDown()}else{h.show()}}};this.addSelectWrapper=function(){jQuery.each($("form select"),function(f,g){if(($("option",$(g)).length>50)&&(!$(g).parent().is("form"))){$(g).wrap("<form class='select_wrapper'></form>")}})};this.removeSelectWrapper=function(){jQuery.each($("form select"),function(f,g){if(($("option",$(g)).length>50)&&($(g).parent().is("form"))){$(g).unwrap()}})};this.bindGroups=function(){$(".group.group_foldable > h3").on("click",function(f){f.preventDefault();tools.toggleGroup($(this).parent());tools.triggerLazyImagesRefresh()})};this.triggerLazyImagesRefresh=function(){$(window).trigger("scroll")};this.getAmount=function(g){var f=$(g+" .mantissa").text(),h=parseInt($(g+" .int_part").text().replace(/\D/g,""),10);if($.isNumeric(f)){h+=parseInt(f,10)/100}if(!isNaN(h)){return h*1000}else{return null}}}var tools=new NS_tools();$(function(){tools.registerGlobalHandlerAjaxFragmentResponse();tools.fireFancybox("a.iframe[href^='https://'], a.iframe[href^='/']");tools.preventFormSpam();if(/webkit/i.test(window.navigator.userAgent)){tools.checkToken()}tools.displayLazyImages();tools.bindGroups()});tools.module("viewer",{openSeatViewDialog:function(a){$("#scene_photo_dialog").dialog({modal:true,width:"auto",resizable:false,show:"fade",hide:"fade",title:a})},seatViewInit:function(){var a=$("#scene_photo");a.attr("src","")},seatView:function(b,c){var a=$("#scene_photo");viewer.seatViewInit();a.on("load",function(){viewer.openSeatViewDialog(c)});a.attr("src",b)}});function Performances(e,d,b,c,a){var f=this,g=function(h){$("#performance_container").html(h);$("#performanceSelectedDate").html($("#newPerformanceDate").html());$("#newPerformanceDate").remove();tools.displayLazyImages()};this.productId=e;this.advantageId=d;this.baseProductId=b;this.crossSellId=c;this.reservationIdx=a;this.cachedPerformances={};$(function(){var h=function(){var j=$("#min_quantity").val();if(!/^\d*$/.test(j)){return}if(!j||j==="0"){j=null}util.url.updateUrlAndReload({minQuantity:j},true);return false};$("#min_quantity_submit").on("click",h);$("select#min_quantity").on("change",h);$("#min_quantity").on("keydown",function(j){if(j.keyCode==13){return h()}});$("#min_quantity_reset").on("click",function(){$("#min_quantity").val("");return h()})});this.cacheFirstPerformance=function(j){var h=$.datepicker.parseDate(datePickerConfig.dateFormat,j);f.cachedPerformances[h]=[{language:"all",rateType:"all",content:$("#performance_container").html()}]};this.updatePerformances=function(j){var k=$(".date_filter"),l=null,h=null;if(!(j instanceof Object)){j=$.datepicker.parseDate(datePickerConfig.dateFormat,j)}if(k){l=$("#performanceLanguageFilter").val();h=$("#performanceRateTypeFilter").val();k.find(".date").html($.datepicker.formatDate(dateShortPattern,j))}f.getPerformances(j,l,h,f.minQuantity)};this.updateAllPerformances=function(){var j=$("#performanceLanguageFilter").val(),h=$("#performanceRateTypeFilter").val();this.getPerformances(null,j,h,this.minQuantity)};this.getPerformances=function(k,m,h,l){var n,p=k,j,q,o;q=m;o=h;if(q===""){q="all"}if(!o){o="all"}j=this.cachedPerformances[k];if(j){for(i in j){if(!j.hasOwnProperty(i)){continue}if(q&&j[i].language!==q){continue}if(o&&j[i].rateType!==o){continue}g(j[i].content);return}}tools.dialog.showWaitingPopupDelayed("loadingDialog",true,false,300);if(k!==null){if(!(k instanceof Object)){k=$.datepicker.parseDate(datePickerConfig.dateFormat,k)}n={year:k.getFullYear(),month:k.getMonth()+1,day:k.getDate()};if(h){n.rateType=h}}else{n={}}n.productId=f.productId;n.advantageId=f.advantageId;n.language=m;n.ppid=f.baseProductId;n.crossSellId=f.crossSellId;n.reservationIdx=f.reservationIdx;if(h){n.rateType=h}if(l){n.minQuantity=l}$.ajax({type:"GET",url:contextPath+"/ajax/event/date/performances",cache:false,data:n,success:function(r){g(r);if(!f.cachedPerformances[p]){f.cachedPerformances[p]=[]}f.cachedPerformances[p].push({content:r,language:q,rateType:o});tools.dialog.hideDialog("loadingDialog")},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.togglePerformancesGroup=function(l,k){var j=$(k),h=j.siblings(".performances_group_container");if(j.hasClass("open")){h.slideUp();j.removeClass("open");j.addClass("closed")}else{h.slideDown();j.removeClass("closed");j.addClass("open")}};this.bindFilters=function(){performances.bindVenueFilter();performances.bindTeamFilter();performances.bindToggleUnavailableMatchFilter()};this.bindVenueFilter=function(){var h=$("#venue"),j=h.parent().find("label .alternative_button.filter_reset");h.change(performances.applyFilters);j.hide();j.click(function(){h.val("");performances.applyFilters();return false})};this.bindTeamFilter=function(){var h=$("#team"),j=h.parent().find("label .alternative_button.filter_reset");h.change(performances.applyFilters);j.hide();j.click(function(){h.val("");performances.applyFilters();return false})};this.bindToggleUnavailableMatchFilter=function(){var h=$("#toggle_unavailable_matches");h.click(performances.applyFilters)};this.clickToggleUnavailableMatchesCheckbox=function(){var h=$("#toggle_unavailable_matches");h.prop("checked",true);h.triggerHandler("click")};this.filterVenue=function(){var l=$("#venue").val(),k=$("#venue").parent().find("label .alternative_button.filter_reset"),j=[],h,m;if(typeof l!=="undefined"&&l!==""){k.show();j=f.getVisiblePerformances($("#performance_container"));for(h=0;h<j.length;h++){m=j[h];$(m).toggle(l===$(m).data("venue-id"))}}performances.togglePerformanceContainerHeading()};this.filterTeam=function(){var l=$("#team").val(),k=$("#team").parent().find("label .alternative_button.filter_reset"),j=[],h,m;if(typeof l!=="undefined"&&l!==""){k.show();j=f.getVisiblePerformances($("#performance_container"));for(h=0;h<j.length;h++){m=j[h];$(m).toggle(l===String($(m).data("host-team-id"))||l===String($(m).data("opposing-team-id")))}}performances.togglePerformanceContainerHeading()};this.filterUnavailableMatches=function(){var h=$("#toggle_unavailable_matches");if(h.length>0){$("#performance_container .performance.sold_out").each(function(){if($(this).css("display")!=="none"){$(this).toggle(!$(h).is(":checked"))}});performances.togglePerformanceContainerHeading()}};this.applyFilters=function(){var h=$("#team").parent().find("label .alternative_button.filter_reset"),j=$("#venue").parent().find("label .alternative_button.filter_reset");performances.initBeforeFiltering();h.hide();j.hide();performances.filterVenue();performances.filterTeam();performances.filterUnavailableMatches()};this.togglePerformanceContainerHeading=function(){var h=$("#performance_container");$("h4",h).each(function(){var j=$(this),k=f.hasVisiblePerformances(j.next());j.toggle(k);j.next().toggle(k)});$("h3",h).each(function(){var j=$(this);j.parent().toggle(f.hasVisiblePerformances(j.next()))})};this.hasVisiblePerformances=function(h){var j=false;$(".performance",h).each(function(){if($(this).css("display")!=="none"){j=true;return true}});return j};this.getVisiblePerformances=function(h){var j=[];$(".performance",h).each(function(){if($(this).css("display")!=="none"){j.push(this)}});return j};this.initBeforeFiltering=function(){var h=$("#performance_container");$(".performances_sub_group_container",h).show();$(".performances_group_container",h).show();$("h3",h).show();$("h4",h).show();$(".performance",h).show()}};tools.module("account.addToCalendar",function(){var f=null,h=null,c=3600,a=function(q,p){var n=q,o=null;for(o in p){if(p.hasOwnProperty(o)){n=n.replace(o,p[o])}}return n},l=function(n){return a(h.descriptionTemplate,{"{name}":n.title,"{location}":n.address,"{date}":n.startDateStr,"{time}":n.startTimeStr,"{url}":document.URL,"{homeUrl}":h.homeUrl})},k=function(n){var t=i(n.data("date-start")),s=n.data("date-start-time-str"),u=n.data("date-start-date-str"),q=n.data("duration"),r=q===""?c:q,v=n.data("address"),p=n.data("name"),o={title:p,start:t,startTimeStr:s,startDateStr:u,duration:r,address:v};o.description=l(o);if(h.fromEmail){o.from=h.fromEmail}if(h.toEmail){o.to=h.toEmail}return o},e=function(){var q=$(this),p=k(q),o=a(f,{"{google}":g.google(p),"{yahoo}":g.yahoo(p),"{ical}":g.ical(p),"{outlook}":g.outlook(p)}),n=$(o),r=n.last();$button=n.first();r.hide();q.parents(".product").first().append(n);$("a",n.first()).on("click",function(s){s.preventDefault();r.slideToggle(200)});$("a",r).on("click",function(s){r.slideUp(200)})},b=60*1000,j=1000,i=function(n){var o=n.replace(/\D/g," ").split(" ");o[1]--;return new Date(Date.UTC(o[0],o[1],o[2],o[3],o[4]))},m=function(n){if(!Date.prototype.toISOString){(function(){function o(q){var p=String(q);if(p.length===1){p="0"+p}return p}Date.prototype.toISOString=function(){var p=this.getUTCFullYear();p+="-"+o(this.getUTCMonth()+1);p+="-"+o(this.getUTCDate());p+="T"+o(this.getUTCHours());p+=":"+o(this.getUTCMinutes());p+=":"+o(this.getUTCSeconds());p+="."+String((this.getUTCMilliseconds()/1000).toFixed(3)).slice(2,5);p+="Z";return p}}())}return n.toISOString().replace(/-|:|\.\d+/g,"")},d=function(n){return n.end?m(n.end):m(new Date(n.start.getTime()+(n.duration*j)))},g={google:function(p){var o=m(p.start),n=d(p);return encodeURI(["https://www.google.com/calendar/render","?action=TEMPLATE","&text="+(p.title||""),"&dates="+(o||""),"/"+(n||""),"&details="+(p.description||""),"&location="+(p.address||""),"&sprop=&sprop=name:"].join(""))},yahoo:function(q){var p=q.end?((q.end.getTime()-q.start.getTime())/b):(q.duration/60),s=p<600?"0"+Math.floor((p/60)):Math.floor((p/60))+"",r=p%60<10?"0"+p%60:p%60+"",n=s+r,o=m(new Date(q.start))||"";return encodeURI(["http://calendar.yahoo.com/?v=60&view=d&type=20","&title="+(q.title||""),"&st="+o,"&dur="+(n||""),"&desc="+(q.description||""),"&in_loc="+(q.address||"")].join(""))},ics:function(s,o,r){var q=m(s.start),n=d(s),t=["BEGIN:VCALENDAR","VERSION:2.0","BEGIN:VEVENT","URL:"+document.URL,"DTSTART:"+(q||""),"DTEND:"+(n||""),"SUMMARY:"+(s.title||""),"DESCRIPTION:"+(s.description.replace(/\n/g,"\\n")||""),"LOCATION:"+(s.address||""),s.from?"ORGANIZER:MAILTO:"+s.from:"",s.to?"ATTENDEE;CUTYPE=INDIVIDUAL;ROLE=REQ-PARTICIPANT;MAILTO:"+s.to:"","END:VEVENT","END:VCALENDAR"],p=t.length;while(p){p--;if(!t[p]){t.splice(p,1)}}return encodeURI("data:text/calendar;charset=utf8,"+t.join("\n"))},ical:function(n){return this.ics(n,"icon-ical","iCal")},outlook:function(n){return this.ics(n,"icon-outlook","Outlook")}};return{init:function(o){h=o;var n=h.homeUrl;if(!/^http/.test(n)){h.homeUrl=window.location.protocol+"//"+window.location.host+n}f=$("#addToCalendarTpl").html();$('[type="performance/js-date"]').each(e)}}});tools.makePath("account.beneficiary.Questionnaire");account.beneficiary.Questionnaire=function(b,a){this.REUSE_ANSWERS_CONTAINER_SELECTOR="#beneficiary_save_checkbox_container";this.REUSE_ANSWERS_CHECKBOX_SELECTOR="#beneficiary_save_checkbox";this.FORM_HIDDEN_INPUT_ID_SELECTOR="#input_beneficiary_questionnaire_id";this.FORM_SELECTOR_ADDRESS_LINE1='input[id$="_line1"]';this.FORM_SELECTOR_ADDRESS_LINE2='input[id$="_line2"]';this.FORM_SELECTOR_ADDRESS_LINE3='input[id$="_line3"]';this.FORM_SELECTOR_ADDRESS_COUNTRY=".beneficiary_address_country select";this.FORM_SELECTOR_ADDRESS_ZIP_CODE='input[id$="_zipcode"]';this.FORM_SELECTOR_ADDRESS_CITY='input[id$="_city"]';this.GET_QUESTIONNAIRE_ANSWERS_URL="/ajax/account/order/questionnaireAnswers";this.BENEFICIARY_NAMES_CONTAINER="#beneficiary_names_container";this.BENEFICIARY_NAMES_OUTSIDE_QUESTIONNAIRES_CONTAINER="#beneficiary_names_outside_questionnaires_container";this.BENEFICIARY_NAMES_INSIDE_QUESTIONNAIRE_CONTAINER=".beneficiary_names_inside_questionnaire_container";this.currentId=null;this.answerQustnnrMapKey=null;this.$currentContainer=null;this.defaultAnswersValues=b;this.hasMandatoryFields=false;this.savedAnswersValuesForReuse={};this.savedAnswersValues={};this.alreadySetAnswersValues=a;this.hasMultipleTicketsOnPage=false;this.isUpdateBeneficiary=false};account.beneficiary.Questionnaire.prototype.initNewQuestionnaire=function(a,d,b,e,c){this.currentId=a;if(c&&(b in this.savedAnswersValues||b in this.alreadySetAnswersValues)){this.answerQustnnrMapKey=b}else{this.answerQustnnrMapKey=d||b}this.isUpdateBeneficiary=c;this.hasMultipleTicketsOnPage=e;$('div[id^="beneficiary_questionnaire_"]').hide();if(this.currentId){$(this.FORM_HIDDEN_INPUT_ID_SELECTOR).val(a);this.$currentContainer=$("#beneficiary_questionnaire_"+this.currentId);if(this.$currentContainer.find(this.BENEFICIARY_NAMES_INSIDE_QUESTIONNAIRE_CONTAINER).length===1){$(this.BENEFICIARY_NAMES_CONTAINER).detach().appendTo(this.$currentContainer.find(this.BENEFICIARY_NAMES_INSIDE_QUESTIONNAIRE_CONTAINER))}else{$(this.BENEFICIARY_NAMES_CONTAINER).detach().appendTo(this.BENEFICIARY_NAMES_OUTSIDE_QUESTIONNAIRES_CONTAINER)}this.$currentContainer.show();this.hasMandatoryFields=this.$currentContainer.length?this.$currentContainer.find(".mandatory").length>0:false}else{$(this.FORM_HIDDEN_INPUT_ID_SELECTOR).val("");this.$currentContainer=null;this.hasMandatoryFields=false;$(this.BENEFICIARY_NAMES_CONTAINER).detach().appendTo(this.BENEFICIARY_NAMES_OUTSIDE_QUESTIONNAIRES_CONTAINER)}$(this.REUSE_ANSWERS_CHECKBOX_SELECTOR).prop("checked",false);if(this.$currentContainer&&this.$currentContainer.length&&this.hasMultipleTicketsOnPage&&this.$currentContainer.find(".copyAllowed").length>0){$(this.REUSE_ANSWERS_CONTAINER_SELECTOR).show()}else{$(this.REUSE_ANSWERS_CONTAINER_SELECTOR).hide()}if(this.$currentContainer&&this.$currentContainer.length){this.$currentContainer.find(".beneficiary_question").each(function(g){var f=$(this);$.each([".beneficiary_boolean",".beneficiary_number",".beneficiary_date",".beneficiary_phone",".beneficiary_email",".beneficiary_text",".beneficiary_single",".beneficiary_multi",".beneficiary_address_line_1",".beneficiary_address_line_2",".beneficiary_address_line_3",".beneficiary_address_country",".beneficiary_address_zip_city",".beneficiary_address_existing"],function(h,i){account.beneficiary.validation.cleanContainerFromError(f.find(i))})})}if(this.$currentContainer&&this.$currentContainer.length){this.$currentContainer.find(".beneficiary_address_existing").each(function(g){var f=$(this);f.find(".beneficiary_address_existing_item").hide();f.find("select").val("");f.find("select").on("change",function(){f.find(".beneficiary_address_existing_item").hide();f.find("#beneficiary_existing_address_"+$(this).val()).show()})})}this.applyDefaultValues()};account.beneficiary.Questionnaire.prototype.applyDefaultValues=function(){var a=this;if(this.$currentContainer&&this.$currentContainer.length){this.$currentContainer.find(".beneficiary_question").each(function(l){var r=$(this),b=r.attr("data-id"),j=b in a.defaultAnswersValues,o=b in a.savedAnswersValuesForReuse,c=(a.answerQustnnrMapKey in a.savedAnswersValues&&b in a.savedAnswersValues[a.answerQustnnrMapKey]),g=a.answerQustnnrMapKey in a.alreadySetAnswersValues&&b in a.alreadySetAnswersValues[a.answerQustnnrMapKey],n=j||o||c||g,d="",m,e="0",k="0",f="0",p={},h=0,q=[];if(c){d=a.savedAnswersValues[a.answerQustnnrMapKey][b]}else{if(g){d=a.alreadySetAnswersValues[a.answerQustnnrMapKey][b]}else{if(o){d=a.savedAnswersValuesForReuse[b]}else{if(j){d=a.defaultAnswersValues[b]}}}}if(r.find(".beneficiary_boolean").length){r.find('input[type="radio"]').each(function(){$(this).prop("checked",false)});if(n){r.find('input:radio[value="'+d+'"]').prop("checked",true)}}else{if(r.find(".beneficiary_number").length||r.find(".beneficiary_phone").length||r.find(".beneficiary_email").length||r.find(".beneficiary_text").length){r.find('input[type="number"], input[type="text"], input[type="email"]').val(n?d:"")}else{if(r.find(".beneficiary_date").length){if(n){m=d.split("-");if(m.length===3){f=m[0];k=parseInt(m[1],10).toString();e=parseInt(m[2],10).toString()}}r.find('select[id$="_day"]').val(e);r.find('select[id$="_month"]').val(k);r.find('select[id$="_year"]').val(f)}else{if(r.find(".beneficiary_single").length){r.find("select").val(n?d:"")}else{if(r.find(".beneficiary_address_existing").length){r.find("select").val(n?d:"");if(n&&d.length){r.find(".beneficiary_address_existing_item").hide();r.find("#beneficiary_existing_address_"+d).show()}}else{if(r.find(".beneficiary_multi").length){r.find("option:selected").removeAttr("selected");if(n){q=d.split(",");for(h=0;h<q.length;h++){if(q[h].length){r.find('option[value="'+q[h]+'"]').attr("selected",true)}}}}else{if(r.find(".beneficiary_address").length){if(d.length){p=JSON.parse(d)}r.find(a.FORM_SELECTOR_ADDRESS_LINE1).val(n&&"addressLine1" in p?p.addressLine1:"");r.find(a.FORM_SELECTOR_ADDRESS_LINE2).val(n&&"addressLine2" in p?p.addressLine2:"");r.find(a.FORM_SELECTOR_ADDRESS_LINE3).val(n&&"addressLine3" in p?p.addressLine3:"");r.find(a.FORM_SELECTOR_ADDRESS_COUNTRY).val(n&&"addressCountry" in p?p.addressCountry:"");r.find(a.FORM_SELECTOR_ADDRESS_ZIP_CODE).val(n&&"addressZipCode" in p?p.addressZipCode:"");r.find(a.FORM_SELECTOR_ADDRESS_CITY).val(n&&"addressCity" in p?p.addressCity:"")}}}}}}}})}if(a.isUpdateBeneficiary){$("#beneficiary_save_checkbox").attr("disabled","disabled")}else{$("#beneficiary_save_checkbox").removeAttr("disabled")}};account.beneficiary.Questionnaire.prototype.save=function(){var b=this,a=$(this.REUSE_ANSWERS_CHECKBOX_SELECTOR).is(":checked");if(this.$currentContainer&&this.$currentContainer.length){this.$currentContainer.find(".beneficiary_question").each(function(k){var r=$(this),d=r.attr("data-id"),e=r.hasClass("copyAllowed"),l="",o,i,m,f,j,h,g,q,n,p,c=b.answerQustnnrMapKey in b.savedAnswersValues;if(r.find(".beneficiary_boolean").length){o=r.find('input[type="radio"]:checked');if(o.length){l=o.val()}}else{if(r.find(".beneficiary_number").length||r.find(".beneficiary_phone").length||r.find(".beneficiary_email").length||r.find(".beneficiary_text").length){o=r.find('input[type="number"], input[type="text"], input[type="email"]');if(o.length===1){l=o.val()}}else{if(r.find(".beneficiary_date").length){i=r.find('select[id$="_day"]');m=r.find('select[id$="_month"]');f=r.find('select[id$="_year"]');if(i.length===1&&m.length===1&&f.length===1&&i.val()!="0"&&m.val()!="0"&&f.val()!="0"){l=f.val()+"-"+m.val()+"-"+i.val()}}else{if(r.find(".beneficiary_single").length||r.find(".beneficiary_address_existing").length){o=r.find("select");if(o.val()!==null&&o.val().length){l=o.val()}}else{if(r.find(".beneficiary_multi").length){o=r.find("select");if(o.val()!==null&&o.val().length){l=o.val().toString()}}else{if(r.find(".beneficiary_address")){j=r.find(b.FORM_SELECTOR_ADDRESS_LINE1);h=r.find(b.FORM_SELECTOR_ADDRESS_LINE2);g=r.find(b.FORM_SELECTOR_ADDRESS_LINE3);q=r.find(b.FORM_SELECTOR_ADDRESS_COUNTRY);n=r.find(b.FORM_SELECTOR_ADDRESS_ZIP_CODE);p=r.find(b.FORM_SELECTOR_ADDRESS_CITY);if(j.val().length||h.val().length||g.val().length||q.val().length||n.val().length||p.val().length){l=JSON.stringify({addressLine1:j.val(),addressLine2:h.val(),addressLine3:g.val(),addressZipCode:n.val(),addressCity:p.val(),addressCountry:q.val()})}}}}}}}if(a&&e){b.savedAnswersValuesForReuse[d]=l}if(!c){b.savedAnswersValues[b.answerQustnnrMapKey]={}}b.savedAnswersValues[b.answerQustnnrMapKey][d]=l})}};account.beneficiary.Questionnaire.prototype.fillEmails=function(){if(this.$currentContainer&&this.$currentContainer.length){this.$currentContainer.find(".beneficiary_question .beneficiary_email input").each(function(a){$(this).val(contactName.email)})}};account.beneficiary.Questionnaire.prototype.propagate=function(e,a){var c=this.savedAnswersValues,b=c[e],d={};if(b){$.extend(true,d,c[e]);c[a]=d}};tools.module("account.beneficiary.form",function(){var H="#beneficiary_form",ah=H+" .content",P=H+" form",aw=null,ak=null,aq=150,q=400,a="#beneficiary_last_name",o="#beneficiary_first_name",G="#first_name_label",S="#number_plate_label",au="#last_name_if_plate_label",ao="#input_rfid_card_zipcode",y="#field_rfid_card_zip_code",ac=".rfid_card_desc",l="#rfid_card_number",ap="#rfid_card_info",av="#rfid_checkbox_container",C=H+" label.for-eticket",V=H+" label.for-rfid",N="#field_rfid_checkbox",an="#card_number_available",i="#card_number_fill",ax=H+" .message.info",F="#beneficiary_mandatory",O="#beneficiary_generic_mandatory",at="#beneficiary_optional",ae="#beneficiary_already_set",s="#first_beneficiary_not_changeable",L="#mandatory_info_description",m="#input_hospitality_questionnaire",r=H+" .message.error.generic_mandatory_msg",af=H+" .message.error.rfid_checkbox_not_checked",Y=H+" .message.error.rfid_wrong_card_from_server",az=H+" .message.error.rfid_server_error",ag=H+" .message.error.rfid_already_used_card_from_server",B=H+" .message.error.rfid_wrong_card",d=H+" .message.error.invalid_pesel",t=H+" .message.error.rfid_wrong_card_or_postcode_from_server",u="/account/order/generateTicket",w="/ajax/account/order/normalizeTicketName",J="/ajax/account/order/loadTicketOntoCard",ar="/ajax/account/order/setBeneficiaryOnMovement",W=null,k={},ab="",K="",c=false,z=false,A=false,v=false,j="",p="",aa=null,am=function(aB,aA){var aD=0,aC=[];$(ap).html("");for(aD=0;aD<aB.length;aD++){if(aC.indexOf(aB[aD].url)==-1){aC.push(aB[aD].url)}}if(aC.length>1){$(ap).append('<img src="'+aA+'" alt="rfid img info" />')}else{if(aC.length===1){$(ap).append('<img src="'+aC[0]+'" alt="rfid img info" />')}}},h=function(){var aE=$(H).addClass("open"),aD=$(aw).addClass("open"),aA=aD.parents(".print_button_container_for_expand_panel"),aC=aD.parents(".ticket_additional_container").addClass("beneficiary_expanded"),aB=aD.parents(".print, .print_options").find(".questionnaire_answers");if(aB.length&&aB.is(":visible")){aB.find(".close_expand_panel").trigger("click")}aE.detach().appendTo(aC);aA.addClass("beneficiary_expanded").find(".triangle_expand_panel").show();aE.slideDown(aq);tools.form.focusFirstEmptyField($("#beneficiary_form"));aE.find("select[multiple='multiple']").each(function(aG,aH){var aF=[];$("#"+aH.id+" option[selected='selected']").each(function(aJ,aI){aF.push(aI.value)});$(aH).val(aF)})},U=function(){$("body, html").animate({scrollTop:$(aw).offset().top-60},q,function(){h()})},Z=function(aB){var aC=$(aB).removeClass("open"),aA=aC.parents(".print_button_container_for_expand_panel");aA.removeClass("beneficiary_expanded").find(".triangle_expand_panel").hide();aC.parents(".ticket_additional_container").removeClass("beneficiary_expanded");$(H).removeClass("open");ad(aB)},g=function(){if(W.$currentContainer&&W.$currentContainer.length){W.$currentContainer.find(".beneficiary_question").each(function(aB){var aA=$(this),aC;if(aA.find(".beneficiary_single").length){aC=aA.find("select");aC.removeAttr("disabled")}else{if(aA.find(".beneficiary_text").length){aC=aA.find('input[type="text"]');aC.removeAttr("disabled")}}})}},T=function(){$(H).slideUp(aq,function(){Z(aw)})},I=function(){$(H).slideUp(aq,function(){Z(ak);U()})},D=function(aA){var aB=aA.parents(".print, .print_options").find("#beneficiary_form");if(aB.length&&aB.is(":visible")){aB.find(".close_expand_panel").trigger("click")}aA.slideDown(aq);aA.find(".close_expand_panel").click(function(){x(aA);return false});aA.find(".triangle_expand_panel").show()},x=function(aA){aA.slideUp(aq,function(){aA.find(".triangle_expand_panel").hide()})},ay=function(aA){if(aA.length){$("body,html").animate({scrollTop:aA.parents(".print, .print_options").offset().top-60},q,function(){D(aA)})}},al=function(aE,aB,aG,aC){var aF=R(aE,aB),aA=account.beneficiary.validation.checkBeneficiaryForm(aG,o,a,W,aF.isParking,v,j),aD=$(r);if(!$(N).is(":checked")){aA=true;aD=$(af)}else{$(B).hide()}if($.trim($(l).val())===""){aA=true;aD=$(Y);$(l).addClass("wrong");$(l).one("focus",function(){$(l).removeClass("wrong")})}else{$(Y).hide()}if(aA){aD.show();M(aD)}else{tools.dialog.showWaitingPopup("LoadingRFIDDialog",true);W.save();$.ajax({url:contextPath+J,type:"POST",cache:false,data:$(P).serialize(),success:function(aI,aK,aH){var aJ={ERR_WRONG_RFID_CARD_NUMBER:Y,ERR_UNKNOWN_LOADING_RFID:az,ERR_ALREADY_USED_RFID_CARD_NUMBER:ag,ERR_WRONG_RFID_CARD_NUMBER_OR_POSTCODE:t};$(Y).hide();$(t).hide();$(az).hide();$(ag).hide();$(af).hide();$(ao).val("");if(aI.success){if(aI.parameters!==null&&aI.parameters.requireZipCode){$("#cancel_card_verification").unbind("click").on("click",function(){tools.dialog.hideDialog("card_verification_popup");tools.dialog.hideDialog("LoadingRFIDDialog");return false});$("#process_card_verification").unbind("click").on("click",function(){if($(y).val()===""){return false}$(ao).val($(y).val());tools.dialog.hideDialog("card_verification_popup");al(aE,aB,aG,aC);return false});$(y).unbind("keyup").on("keyup",function(){if($(y).val()===""){$("#process_card_verification").parent().addClass("disabled")}else{$("#process_card_verification").parent().removeClass("disabled")}});$(y).val("");$("#process_card_verification").parent().addClass("disabled");tools.dialog.showDialog("card_verification_popup",true,true)}else{window.location.reload()}}else{if(aJ[aI.status]){tools.dialog.hideDialog("LoadingRFIDDialog");$(aJ[aI.status]).show();$(l).addClass("wrong");$(l).one("focus",function(){$(l).removeClass("wrong")})}else{tools.dialog.hideDialog("LoadingRFIDDialog");T();tools.dialog.showDialog("ajaxErrorDialog",true)}}},error:function(){tools.dialog.hideDialog("LoadingRFIDDialog");T();tools.dialog.showDialog("ajaxErrorDialog",true)}})}},X=function(aD){var aB=aD.ticketId,aC=aD.ticketFileName,aA=contextPath+u+"?id="+aB+"&ticketName="+encodeURIComponent(aC)+"&printed=true";$("#print_"+aB+"_MOBILE").unbind("click").attr("target","_blank").attr("href",aA+"&support=MOBILE");$("#print_"+aB+"_ETICKET").unbind("click").attr("target","_blank").attr("href",aA+"&support=ETICKET");$("#print_"+aB+"_PASSBOOK").unbind("click").attr("target","_blank").attr("href",aA+"&support=PASSBOOK")},b=function(aE,aD){var aA=aE.ticketFileName,aC=aE.firstName,aB=aE.lastName;$.ajax({url:contextPath+w,type:"POST",cache:false,data:{filename:aA.replace("{firstname}",aC).replace("{lastname}",aB)},success:aD,error:function(){aD(aA)}})},f=function(aG,aF,aE,aD,aB){tools.dialog.showWaitingPopup("beneficiaryProcessingDialog",true);var aA="Ticket"+aF,aC=window.open(contextPath+"/account/file/generateTicket",aA);b(aG,function(aH){aB(aH);$("#input_beneficiary_fileName").val(aH);$.ajax({url:contextPath+"/ajax/account/order/generateTicketWithAnswers"+(aD?"?isUpdateBeneficiary=true":""),method:"POST",data:$(P).serialize()}).then(function(aI){tools.dialog.hideDialog("beneficiaryProcessingDialog");if(aI.status==="SESSION_EXPIRED"){tools.dialog.showDialog("sessionExpiredWhileGeneratingTicketDialog",true,true);aC.close();return false}else{if(aI.status!=="OK"){tools.dialog.showDialog("ajaxErrorDialog",true);aC.close();return false}}var aJ="";try{aJ=aC.location.href}catch(aK){}aC=window.open(contextPath+"/account/order/ticket/"+encodeURIComponent(aH)+"?id="+aI.ticketId+"&support="+aE+"&isUpdateBeneficiary=true",aA);try{aC.account.beneficiary.general.checkDownloaded(aJ)}catch(aL){}if(aC){aC.focus()}if(aI.ticketId!=aF){window.location.reload()}},function(){tools.dialog.hideDialog("beneficiaryProcessingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)})})},E=function(aF,aN,aA){var aE=R(aF,aN),aG=aE.mandatoryBeneficiary,aJ=aE.isTabletOrMobile,aH=aE.containsRFIDSupport,aM=aE.shipmentMode||[],aQ=aM.typeRFID,aB=aM.typeElectronic,aK=aM.typeMobile,aP=account.beneficiary.validation.checkBeneficiaryForm(aG,o,a,W,aE.isParking,v,j),aL=$(o).val(),aO=$(a).val(),aC=$(r),aD=null,aI=account.beneficiary.form.setPrintedStatus;if(aQ&&aH&&!$(N).is(":checked")){aP=true;aC=$(af)}if(aP){aC.show();M(aC);return}W.save();if($(o).val()===contactName.firstName&&$(a).val()===contactName.lastName){z=true}aD=function(aR){aE.ticketFileName=aR;X(aE);if(aQ){$("#print_"+aF+"_RFID").parents(".print_button_container_for_expand_panel").hide();$("#print_"+aF+"_RFID").parent().parent().parent().find(".support_separator").hide();$("#print_"+aF+"_DEMAT_BADGE").parents(".print_button_container_for_expand_panel").hide();$("#print_"+aF+"_DEMAT_BADGE").parent().parent().parent().find(".support_separator").hide()}if(aA){aI(aE.movementId,aL,aO,aJ,aB,aK,W.currentId,false,aE.allowUpdateTicketInfo)}else{aI(aF,aL,aO,aJ,aB,aK,W.currentId,false,aE.allowUpdateTicketInfo)}Q(aF,aN,function(aS){b(aS,function(aT){var aU=aS.shipmentMode||[];aS.ticketFileName=aT;X(aS);aI(aS.ticketId,aS.firstName,aS.lastName,aS.isTabletOrMobile,aU.isShipmentModeTypeElectronic,aU.isShipmentModeTypeMobile,aS.questionnaireId,true,aS.allowUpdateTicketInfo)})})};n(aE);tools.dialog.showWaitingPopup("beneficiaryProcessingDialog",true);T();f(aE,aF,aN,aA,aD)},aj=function(aA){var aC=R(aA),aB=aC.mandatoryBeneficiary;if(account.beneficiary.validation.checkBeneficiaryForm(aB,o,a,W,aC.isParking,v,j)){$(r).show();M(r)}else{tools.dialog.showWaitingPopup("beneficiaryProcessingDialog",true);W.save();$.ajax({url:contextPath+ar,type:"POST",cache:false,data:$(P).serialize(),success:function(aE,aG,aD){if(aE.success){if($(o).val()===contactName.firstName&&$(a).val()===contactName.lastName){z=true}n(aC);var aF=function(aL){var aK=aL.ticketId,aJ=aL.movementId,aI=aK||aJ,aH="";$("#set_beneficiary_"+aK).find(".text").html(ab);if(aL.questionnaireId&&!aL.noAlreadyPrintedStatus){aH=" with_answers";$("#printed_status_"+aI+",#not_printed_status_"+aI).unbind().on("click",function(){account.beneficiary.form.showAnswers(this,aK,aJ);return false})}$("#printed_status_"+aI).html('<span class="already_printed_status'+aH+'">'+K+": "+aL.firstName+" "+aL.lastName+"</span>");$("#not_printed_status_"+aI).html('<span class="not_printed_status'+aH+'">'+K+": "+aL.firstName+" "+aL.lastName+"</span>")};aF(aC);Q(aA,null,aF);tools.dialog.hideDialog("beneficiaryProcessingDialog");T();if(aa){aa(aC.movementId)}}else{if(errors[aE.status]){tools.dialog.hideDialog("beneficiaryProcessingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}}},error:function(){tools.dialog.hideDialog("beneficiaryProcessingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}},n=function(aA){aA.firstName=$(o).val();aA.lastName=$(a).val()},R=function(aC,aB){var aA=aC;if(aB){aA+="_"+aB}return k[aA]},Q=function(aE,aG,aD){var aF=R(aE,aG),aB=aF.ticketId||aF.movementId,aC,aA=aF.associatedMovements;if(!aA||!aA.length){return}$.each(k,function(){if($.inArray(this.movementId,aA)<0){return}this.firstName=aF.firstName;this.lastName=aF.lastName;if(aD){aD(this)}aC=this.ticketId||this.movementId;if(aB&&aC){W.propagate(aB,aC)}})},ai=function(aC,aA){var aB=[];$.each(k,function(){if((this.ticketId===aC+""||this.movementId===aA)&&this.allowUpdateTicketInfo&&["MOBILE","ETICKET"].indexOf(this.support)>=0){aB.push(this)}});return aB},e=function(aE,aD){var aA=$("#print_"+aE+"_MOBILE, #print_"+aE+"_ETICKET, #print_"+aE+", #print_"+aD+"_MOBILE, #print_"+aD+"_ETICKET, #print_"+aD),aC=$(".printed_status",aA.closest(".ticket_additional_container")),aB=$("<span></span>").addClass("current_edit_beneficiary").text(currentEditBeneficiary);$(".current_edit_beneficiary",aC).remove();$(".already_printed_status",aC).hide();aC.append(aB)},ad=function(aB){var aC=$(aB).closest(".ticket_additional_container"),aA=$(".printed_status",aC);$(".current_edit_beneficiary",aC).remove();$(".already_printed_status",aA).show()},M=function(aD){var aB=$(window).height(),aA=$(document).scrollTop(),aF=aA,aE=aA+aB,aC=$(aD).offset();if(aC.top<aF||aC.top>aE){$("body,html").animate({scrollTop:$(H).offset().top-50},q)}};return{init:function(aE,aG,aH,aA,aB,aJ,aC,aF){var aI=$(H+" .beneficiary_question > span.beneficiary_date"),aD=this;ab=aH;K=aA;c=aB;j=aJ;p=aC;aI.each(function(aL){var aK=$(this).find('select[id$="_day"]'),aN=$(this).find('select[id$="_month"]'),aM=$(this).find('select[id$="_year"]');if(aK.length&&aN.length&&aM.length){secutix.date.combos.populateCombosDatepicker(aK.attr("id"),aN.attr("id"),aM.attr("id"),datePickerConfig.monthNames);secutix.date.combos.dynamizeDateCombos(aK.attr("id"),aN.attr("id"),aM.attr("id"))}});W=new account.beneficiary.Questionnaire(aE,aG);$('[id^="print_"], [id^="set_beneficiary_"]').on("click",function(){var aK=$(this),aL=aK.attr("id").replace("print_","").replace("set_beneficiary_",""),aM=k[aL];if(aM){aD.show(aK,aM.ticketId,aM.movementId,aM.support,aM.beneficiariesAlwaysModifiable==="true");return false}});$(P).submit(function(aK){return false});$('[id^="toggle_questionnaire_btn_"]').on("click",function(){var aM,aK,aL;aM=this.id.replace("toggle_questionnaire_btn_","");if(isNaN(parseInt(aM,10))){return false}aL=$(this).parent();if(aL.hasClass("plus")){aL.switchClass("plus","less",0);$(aL).find(".plus").addClass("hidden");$(aL).find(".less").removeClass("hidden")}else{aL.switchClass("less","plus",0);$(aL).find(".less").addClass("hidden");$(aL).find(".plus").removeClass("hidden")}aK="#questionnaire_table_"+aM;$(aK).slideToggle();return false});A=$(".ticket_formats_container .formats").length>1;if(typeof aF.newSetBeneficiaryOnMovementUrl!=="undefined"){ar=aF.newSetBeneficiaryOnMovementUrl}},show:function(aR,aS,aX,aK,aI,aJ){var aT=0,aP=null,aD=null,aW=null,aL=null,aV=$(o),aZ=$(a),aG=$(H),aU=null,aY=aS||aX,aM=R(aY,aK),aA=aM.firstName,aN=aM.lastName,aB=aM.mandatoryBeneficiary,aO=aM.containsRFIDSupport,aQ=aM.cardTypes,aC=aM.isParking,aF=aM.shipmentMode||[],aH=aF.typeRFID,aE=aM.isB2BOrB2B2C;if($(aR).hasClass("open")){return false}$("#input_beneficiary_ticketId").val(aS||aX);$("#input_beneficiary_support").val(aK);$("#input_beneficiary_movement_id").val(aM.movementId);$("#input_beneficiary_file_id").val(aM.fileId);$("#input_beneficiary_hospitalityProductType").val(aM.isHospitalityProductType);W.initNewQuestionnaire(aM.questionnaireId,aS,aM.movementId,A,aJ);ak=aw;aw=aR;$(F).hide();$(O).hide();$(at).hide();$(ae).hide();$(m).hide();$(s).hide();$(r).hide();$(B).hide();$(Y).hide();$(t).hide();$(ag).hide();$(az).hide();$(af).hide();$(d).hide();aZ.removeAttr("disabled");aV.removeAttr("disabled");g();if(aA&&aN){aZ.val(aN);aV.val(aA)}else{if(!z&&!aE){aZ.val(contactName.lastName);aV.val(contactName.firstName);W.fillEmails()}else{aZ.val("");aV.val("")}}if(aA&&aN&&((!c&&!aI&&!aJ)||aM.readOnlyBeneficiary)){if(aM.readOnlyBeneficiary){$(s).show()}else{$(ae).show()}aZ.attr("disabled","disabled");aV.attr("disabled","disabled");if(!inCheckout){if(W.$currentContainer&&W.$currentContainer.length){W.$currentContainer.find(".beneficiary_question").each(function(a3){var a0=$(this),a2,a1,a4,a5;if(a0.find(".beneficiary_date").length){a2=a0.find('select[id$="_day"]');a1=a0.find('select[id$="_month"]');a4=a0.find('select[id$="_year"]');if(a2.length===1&&a1.length===1&&a4.length===1&&(a2.val()!=="0"||a1.val()!=="0"||a4.val()!=="0")){a2.attr("disabled","disabled");a1.attr("disabled","disabled");a4.attr("disabled","disabled")}}else{if(a0.find(".beneficiary_single").length){a5=a0.find("select");if(a5.length===1&&a5.val()!==null&&a5.val().length>0){a5.attr("disabled","disabled")}}else{if(a0.find(".beneficiary_text").length){a5=a0.find('input[type="text"]');if(a5.length===1&&a5.val().length>0){a5.attr("disabled","disabled")}}}}})}}}else{if(aB){$(F).show()}else{if(aI){$(O).hide();$(m).show()}else{if(W.hasMandatoryFields){$(O).show();$(L).show()}else{$(at).show()}}}}if(p){aU=$("input[value='"+p+"']").attr("name");if(typeof aU!=="undefined"){aU=aU.substr(0,aU.lastIndexOf("."));if(aM.birthdayYear&&aM.birthdayMonth&&aM.birthdayDay){$("select[name='"+aU+".year']").val(aM.birthdayYear);$("select[name='"+aU+".month']").val(aM.birthdayMonth);$("select[name='"+aU+".day']").val(aM.birthdayDay)}if(aM.readOnlyBeneficiary&&aM.birthdayYear&&aM.birthdayMonth&&aM.birthdayDay){$("select[name='"+aU+".year']").attr("disabled","disabled");$("select[name='"+aU+".month']").attr("disabled","disabled");$("select[name='"+aU+".day']").attr("disabled","disabled")}else{if(c){$("select[name='"+aU+".year']").removeAttr("disabled");$("select[name='"+aU+".month']").removeAttr("disabled");$("select[name='"+aU+".day']").removeAttr("disabled")}}}}if(aC){$(H+" #field_first_name label").html($(S).html());$(H+" #field_last_name label").html($(au).html());aV.val("");if(!z){aZ.val(contactName.firstName+" "+contactName.lastName)}}else{$(H+" #field_first_name label").html($(G).html())}aG.find('label[for="beneficiary_first_name"] .mandatory').remove();aG.find('label[for="beneficiary_last_name"] .mandatory').remove();if(aB){account.beneficiary.validation.addMandatory2Label(H,"#field_first_name",true);account.beneficiary.validation.addMandatory2Label(H,"#field_last_name",true)}account.beneficiary.validation.setNeededCardTypesInstance($.extend(true,[],aQ));$(av).hide();$(an).hide();$(N).prop("checked",false);$(l).val("");$(ao).val("");$(ah).removeClass("rfid");if(aH&&aO){$(av).show();if(aK!="RFID"&&aK!="DEMAT_BADGE"){$(C).show();$(V).hide()}else{$(C).hide();$(V).show();$(ah).addClass("rfid")}}if(aK!="RFID"&&aK!="DEMAT_BADGE"){$(ac).hide();$(l).parent().hide();$(ax).show();$(ap).hide()}else{$(ap).show();$(ac).show();$(l).parent().show();$(ax).hide();for(aT=0;aT<aQ.length;aT++){if(aQ[aT].cardNumber||aQ[aT].cardNumberProposal){aP=aQ[aT].cardNumber;aW=aQ[aT].beneficiary;aD=aQ[aT].cardNumberProposal}}if(aD){$(l).val(aD);aV.val(aW.firstName);aZ.val(aW.lastName)}if(aP){$(an).show();$(i).unbind("click");$(i).click(function(){$(l).val(aP);aV.val(aW.firstName);aZ.val(aW.lastName);account.beneficiary.validation.checkInput(null,$(l)[0]);return false})}am(aQ,aM.multipleCardTypesUrl)}aZ.removeClass("error");aZ.parent().removeClass("error");aV.removeClass("error");aV.parent().removeClass("error");$(l).removeClass("wrong").removeClass("valid");if(aD){account.beneficiary.validation.checkInput(null,$(l)[0])}if(aK=="RFID"){$(H+" .button.print a").html($("#beneficiaryPopupContinueRFIDLabel").val())}else{if(aK=="DEMAT_BADGE"){$(H+" .button.print a").html($("#beneficiaryPopupContinueBadgeLabel").val())}else{$(H+" .button.print a").html($("#beneficiaryPopupContinuePrintLabel").val())}}aL=function(){var a1=R(aS,"ETICKET"),a0=R(aS,"MOBILE");tools.removeSelectWrapper();if(!aK){aj(aY)}else{if(aK!="RFID"&&aK!="DEMAT_BADGE"){E(aS,aK,aJ);if(a1){a1.isPrinted=true}if(a0){a0.isPrinted=true}}else{$(B).hide();$(Y).hide();$(t).hide();$(az).hide();$(ag).hide();al(aS,aK,aB,aQ)}}return false};$(H+" .button.print a").unbind().on("click",aL);$(H+" input").unbind().keypress(function(a0){if(a0.which===13){return aL()}});$(H+" input").unbind().focus(function(){$(this).removeClass("error")});$(H+" .close_expand_panel").click(function(){T();return false});if(aG.hasClass("open")){I()}else{U(aw)}return false},showAnswers:function(aG,aF,aB){var aE=$(aG).parents(".ticket_additional_container"),aA=$("#questionnaire_answers_"+aF),aC,aH,aD;if(aA.length){aA.remove()}aC=ai(aF,aB);if(aC.length>0){aH=aC[0];if(aH.questionnaireId==="-1"){aD=$('[id^="print_'+aH.movementId+'"]:first');if(aD.length===0){aD=$('[id^="print_'+aH.ticketId+'"]:first')}if(aD.length>0){this.show(aD,aH.ticketId,aH.movementId,aH.support,aH.beneficiariesAlwaysModifiable==="true",true);e(aH.ticketId,aH.movementId);return false}}}aH=R(aF,"ETICKET")||R(aF,"MOBILE")||R(aF,null);tools.dialog.showWaitingPopup("beneficiaryProcessingDialog",true);$.ajax({type:"GET",url:contextPath+W.GET_QUESTIONNAIRE_ANSWERS_URL,cache:false,data:{ticketId:aF,movementId:aB,allowUpdateTicketInfo:aH?aH.allowUpdateTicketInfo:false},success:function(aI){$(".questionnaire_answers",aE).remove();aE.append(aI);if(!aH||!aH.isPrinted||(aH.support!=="ETICKET"&&aH.support!=="MOBILE")){$("#modify_"+aF,aE).remove()}ay($("#questionnaire_answers_"+aF));tools.dialog.hideDialog("beneficiaryProcessingDialog")},error:function(){tools.dialog.hideDialog("beneficiaryProcessingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},modifyTicketHolders:function(aC){var aA,aD,aB;aA=ai(aC);if(aA.length>0){aD=aA[0];aB=$('[id^="print_'+aD.movementId+'"]:first');if(aB.length===0){aB=$('[id^="print_'+aD.ticketId+'"]:first')}if(aB.length>0){this.show(aB,aD.ticketId,aD.movementId,aD.support,aD.beneficiariesAlwaysModifiable==="true",true);e(aD.ticketId,aD.movementId)}}},setPrintedStatus:function(aF,aK,aM,aH,aA,aJ,aN,aL,aO){var aD=$("#print_"+aF+"_MOBILE, #print_"+aF+"_ETICKET, #print_"+aF),aI=aD.parent().parent().parent().parent().find(".printed_status .not_printed_status, .printed_status .already_printed_status"),aB=aJ||(aH&&aA),aG="",aE=aI.hasClass("not_printed_status"),aC=aL&&aE;$(".current_edit_beneficiary",aD.closest(".ticket_additional_container")).remove();if(aE||aC){if(aK!==""&&aM!==""){if(aC){if(aB){aG=notDownloadedBeneficiary}else{aG=notPrintedBeneficiary}}else{if(aB){aG=alreadyDownloadedBeneficiary}else{aG=alreadyPrintedBeneficiary}}aI.text(aG.replace("{0}",aK+" "+aM))}else{if(aJ||(aH&&aA)){aI.html(alreadyDownloaded)}else{aI.html(alreadyPrinted)}}if(aN&&aN.length){aI.unbind().click(function(){if(aO){account.beneficiary.form.showAnswers(this,aF,aF)}else{account.beneficiary.form.showAnswers(this,aF)}return false});aI.addClass("with_answers");if(aO){aI.html(aI.html()+" "+editLabel)}}if(!aC){aI.removeClass("not_printed_status").addClass("already_printed_status");$("#printed_tickets").html(Number($("#printed_tickets").html())+1);$("#beneficiary_"+aF).html("")}if(aE&&aC){aD.unbind().click(function(){account.beneficiary.form.setPrintedStatus(aF,aK,aM,aH,aA,aJ,aN,false,aO)})}}},register:function(aB){var aA=aB.ticketId||aB.movementId;if(aB.support){aA+="_"+aB.support}k[aA]=aB;if(aB.readOnlyBeneficiary){z=true}},nationalityChanged:function(aA){if(pesel.needsPeselValidation($(aA).val())){$(".idNumberLabel").hide();$(".idNumberLabelPl").show();v=true}else{$(".idNumberLabelPl").hide();$(".idNumberLabel").show();v=false}},setSuccessfulBeneficiarySetCallback:function(aA){aa=aA}}});tools.module("account.beneficiary.general",{generateTicketAndShow:function(d,h,e,i,l,b,j,a,g,k){var f="",c=contextPath+"/ajax/account/order/generateTicket";if(tools.isStorageAvailable()){f=tools.storage.getItem("beneficiary"+d)}if(!f&&k){setTimeout(function(){throw"Expected data in sessionStorage, found none"},10)}if(f!==null&&f.length&&(!g||a)){c=contextPath+"/ajax/account/order/generateTicketWithAnswers"}else{f={id:d,movementId:h?parseInt(h,10):"",fileId:e?parseInt(e,10):"",firstName:i,lastName:l,support:j}}if(a){c+="?isUpdateBeneficiary="+a}jQuery.ajax({url:c,type:"POST",cache:false,data:f,success:function(m){tools.dialog.hideDialog("ticketProcessingDialog");if(m.status==="SESSION_EXPIRED"){tools.dialog.showDialog("sessionExpiredWhileGeneratingTicketDialog",true,true);return false}else{if(m.status!=="OK"){tools.dialog.showDialog("ajaxErrorDialog",true);return false}}var n=window.location.href;window.location.replace(contextPath+"/account/order/ticket/"+b+"?id="+m.ticketId+"&support="+j+(a?"&isUpdateBeneficiary=true":""));account.beneficiary.general.checkDownloaded(n);if(m.ticketId!==d){window.opener.location.reload(true)}},error:function(){tools.dialog.hideDialog("ticketProcessingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},switchToTnMCTickets:function(){window.location.href="http://tnmc.secutix.com/switchToTickets"},checkDownloaded:function(a){setTimeout(function(){if(a===window.location.href){tools.dialog.showDialog("no_redirection_dialog",true)}},100)}});tools.module("account.beneficiary.validation",function(){var h="#field_rfid_card_type",c=[],l=false,a=function(){var n=null,o=0;for(o=0;o<c.length;o++){if($(h).val()===c[o].id){n={format:c[o].codeCheck,autocomplete:c[o].enableAutoComplete,autoUppercase:c[o].enableAutoUppercase}}}return n},j=function(x,v){var p=0,q=0,n,t,u,o,w=/[a-zA-Z0-9]/,s=/[0-9]/,r=/[a-fA-F0-9]/;for(;p<x.length;p++){n=v.charAt(q);t=x.charAt(p);if(n==="x"){if(!w.test(t)){return false}q++}else{if(n==="h"){if(!r.test(t)){return false}q++}else{if(n==="n"){if(!s.test(t)){return false}q++}else{if(n==="["){q++;for(u=q;u<v.length;u++){if(v.charAt(u)==="]"){break}}if(u===v.length-1&&v.charAt(u)!=="]"){return false}o=p+(u-q);if(j(x.substring(p,o),v.substring(q,u))){p=o-1}else{p--}q=u+1}else{if(n==="]"){return false}else{if(n===t){q++}else{return false}}}}}}}return p===x.length&&q===v.length},k=function(o){var p=o?o:window.event,n=false;if(p.ctrlKey&&(p.charCode==99||p.charCode==118)){n=true}else{if(l&&(p.keyCode==67||p.keyCode==86)){n=true}}l=p.keyCode==17;return n},i=function(o,n){if((typeof(o.keyCode)!="undefined"&&o.keyCode>0&&String.fromCharCode(o.keyCode).search(n)!=(-1))||(typeof(o.charCode)!="undefined"&&o.charCode>0&&String.fromCharCode(o.charCode).search(n)!=(-1))||(typeof(o.charCode)!="undefined"&&o.charCode==o.keyCode&&typeof(o.keyCode)!="undefined"&&o.keyCode.toString().search(/^(8|9|13)$/)!=(-1))){return true}else{return false}},e=function(o,p){var n;if(o.setSelectionRange){o.setSelectionRange(p,p)}else{if(o.createTextRange){n=o.createTextRange();n.collapse(true);n.moveEnd("character",p);n.moveStart("character",p);n.select()}}},d=function(n){if(n.selectionStart){return n.selectionStart}else{if(document.selection){n.focus();var o=document.selection.createRange();o.moveStart("character",-n.value.length);return o.text.length}else{return n.value.length}}},b=function(o,n){o.addClass("error");o.one("focus click",function(){o.removeClass("error");if(n){$.each(n,function(p,q){q.removeClass("error")})}})},g=function(n,u,t,r){var s=u||t||r,o=n.find(".beneficiary_address_line_1"),p=n.find(".beneficiary_address_line_2"),q=n.find(".beneficiary_address_line_3");if(!s){if(!u){b(o,[p,q])}if(!t){b(p,[o,q])}if(!r){b(q,[o,p])}}return s},f=function(v,q,o,s){var t=v.find(".beneficiary_address_country"),r=v.find(".beneficiary_address_zip_city"),u=function(){b(t)},p=function(){b(r)},n=validation.checkZipCodeValues(q,o,u,p,p);if(!s.length){b(r);n=false}if(!q.length){b(t);n=false}return n},m=function(x,v){var r=x.find('input[id$="_line1"]').val().length,p=x.find('input[id$="_line2"]').val().length,o=x.find('input[id$="_line3"]').val().length,q=x.find(".beneficiary_address_country select").val(),n=x.find('.beneficiary_address_zip_city input[id$="_zipcode"]').val(),u=x.find('.beneficiary_address_zip_city input[id$="_city"]').val(),t=r||p||o||q.length||n.length||u.length,s=t||v?g(x,r,p,o):true,w=t||v?f(x,q,n,u):true;return s&&w};return{setNeededCardTypesInstance:function(n){c=n},isCorrectFormat:function(z,v,p){var s,w,q,o,x=false,u,y=z.replace(/[\s|\-|\/]/g,""),n=[],t=0,r;if(!p){q=/[^a-zA-Z0-9\-\.]/}else{if(v.indexOf("x")!==-1){q=/[^a-zA-Z0-9]/}else{if(v.indexOf("h")!==-1){q=/[^g-zG-Z]/}else{q=/[^0-9]/}}}s=p?v.replace(/[\s|\-|\/]/g,""):v;w=!p||!q.test(y);n=[];for(;t<v.length;t++){if(v.charAt(t)=="["){for(r=t+1;r<v.length;r++){if(v.charAt(r)=="]"){n.push({start:t,stop:r,length:(r-t)+1,cleanedLength:v.substring(t+1,r).replace(/[\s|\-|\/]/g,"").length});t+=(r-t);break}}}}if(n.length>0){t=0;if(p){u=v.replace(/[\s|\-|\/]/g,"").length}else{u=v.length}u-=(n.length*2);x=u==y.length;for(;!x&&t<n.length;t++){u-=n[t].cleanedLength;x=u==y.length}}else{x=s.length==y.length}o=p||j(z,v);return o&&w&&x},formatCardNumber:function(w,t){var r=a(),u,n,v,p="",s=0,q,o;if(r===null){return}v=w.value.replace(/[\s|\-|\/]/g,"");u=r.format;n=r.autocomplete;autoUppercase=r.autoUppercase;if(n){for(q=0;q<u.length;q++){if(s==v.length){break}else{if(u.charAt(q)=="x"||u.charAt(q)=="h"||u.charAt(q)=="n"){p=p+v.charAt(s);s++}else{if(u.charAt(q)!="["&&u.charAt(q)!="]"){p=p+u.charAt(q)}}}}}o=account.beneficiary.validation.isCorrectFormat(w.value,u,n);if(o){$(w).addClass("valid")}else{$(w).removeClass("valid")}if(n){if(s<v.length){for(q=s;q<v.length;q++){p=p+v.charAt(q)}}w.value=p;if(t){if(p.charAt(t)==" "||p.charAt(t)=="-"||p.charAt(t)=="/"){t++}e(w,t)}}if(autoUppercase){w.value=w.value.toUpperCase()}},checkKey:function(t,p){var r,u=t?t:window.event,o,n=a(),q,s;if(n===null){return true}q=n.format;s=n.autocomplete;if(!s){regex=/[a-zA-Z0-9\-\.]/}else{if(q.indexOf("h")!==-1){regex=/[^a-fA-F0-9]/}else{if(q.indexOf("x")!==-1){regex=/[a-zA-Z0-9]/}else{regex=/[0-9]/}}}o=k(t)||i(u,regex);if(!o&&p&&u.keyCode>48){o=i({keyCode:u.keyCode-48},regex)}r=(u.keyCode==9)||(u.keyCode==8)||(u.keyCode==35)||(u.keyCode==36)||(u.keyCode==37)||(u.keyCode==39)||(u.keyCode==46)||(u.keyCode==12);return(o||r)},checkInput:function(q,o){var n=!q||account.beneficiary.validation.checkKey(q,true),p=null;if(n){p=d(o);if(p!=o.value.length){account.beneficiary.validation.formatCardNumber(o,d(o))}else{account.beneficiary.validation.formatCardNumber(o)}}return n},addMandatory2Label:function(p,n,o){var q=$(p+" "+n+" "+(o?"label":"span.label"));if(q.find("span.mandatory").length===0){q.append('<span class="mandatory">*</span>')}},cleanContainerFromError:function(n){if(n.length){n.removeClass("error")}},checkBeneficiaryForm:function(p,t,r,s,o,v,q){var x=false,u=$.trim($(t).val()),w=$.trim($(r).val()),n;if(p||(((u===""&&w!=="")||(u!==""&&w===""))&&!o)){if(u===""||!validation.validateField($(t),[{rule:validation.rules.firstname}],null,false,false)){x=true;b($(t).parent())}if(w===""||!validation.validateField($(r),[{rule:validation.rules.lastname}],null,false,false)){x=true;b($(r).parent())}}if(s.$currentContainer&&s.$currentContainer.length){s.$currentContainer.find(".beneficiary_question").each(function(C){var y=$(this),z=y.hasClass("mandatory"),E,B,A,D;if(y.find(".beneficiary_boolean").length&&z&&!y.find('input[type="radio"]:checked').length){b(y.find(".beneficiary_boolean"));x=true}else{if(y.find(".beneficiary_number").length){E=y.find('input[type="number"]');if(E.length===1&&(z||E.val().length)&&!validation.validateFieldAndHandleTooltip(false,E.attr("id"),[{rule:validation.numericRule(false)}],null,false,false,false)){b(y.find(".beneficiary_number"));x=true}}else{if(y.find(".beneficiary_date").length){B=y.find('select[id$="_day"]');A=y.find('select[id$="_month"]');D=y.find('select[id$="_year"]');if(B.length===1&&A.length===1&&D.length===1&&(z||B.val()!="0"||A.val()!="0"||D.val()!="0")){if(B.val()==="0"||A.val()==="0"||D.val()==="0"){b(y.find(".beneficiary_date"));x=true}}}else{if(y.find(".beneficiary_phone").length){E=y.find('input[type="text"]');if(E.length===1&&(z||E.val().length)&&!validation.validateFieldAndHandleTooltip(false,E.attr("id"),[{rule:validation.rules.singleFieldPhone}],null,false,false,false)){b(y.find(".beneficiary_phone"));x=true}}else{if(y.find(".beneficiary_email").length){E=y.find('input[type="email"]');if(E.length===1&&(z||E.val().length)&&!validation.validateFieldAndHandleTooltip(false,E.attr("id"),[{rule:validation.rules.email}],null,false,false,false)){b(y.find(".beneficiary_email"));x=true}}else{if(y.find(".beneficiary_text").length){E=y.find('input[type="text"]');if(E.length===1&&z&&!$.trim(E.val()).length){b(y.find(".beneficiary_text"));x=true}}else{if(y.find(".beneficiary_single").length){E=y.find("select");if(z&&(E.val()===null||!E.val().length)){b(y.find(".beneficiary_single"));x=true}}else{if(y.find(".beneficiary_multi").length){E=y.find("select");if(z&&(E.val()===null||!E.val().length)){b(y.find(".beneficiary_multi"));x=true}}else{if(y.find(".beneficiary_address").length){if(!m(y,z)){x=true}}else{if(y.find(".beneficiary_address_existing").length){E=y.find("select");if(z&&(E.val()===null||!E.val().length)){b(y.find(".beneficiary_address_existing"));x=true}}}}}}}}}}}})}if(v&&q){n=$("input[value='"+q+"']").attr("name");n=n.substr(0,n.lastIndexOf("."))+".answer";if(!pesel.isValidPesel($("input[name='"+n+"']").val())){b($("input[name='"+n+"']").parent());x=true}}return x}}});tools.module("dashboard",function(){var g=null,c=null,b=null,h=null,a=null,i=null,f=null,e=null,d=function(){g=$("#tab_late_payments");c=$("#tab_offers");b=$("#tab_quotes");h=$("#tab_requests");a=$("#tab_content_late_payments");i=$("#tab_content_offers");f=$("#tab_content_quotes");e=$("#tab_content_requests")};return{init:function(){d();if(!g.hasClass("highlight")){a.hide()}if(!c.hasClass("highlight")){i.hide()}if(!b.hasClass("highlight")){f.hide()}if(!h.hasClass("highlight")){e.hide()}if(!g.hasClass("disabled")){g.click(function(){a.show();g.addClass("highlight");i.hide();c.removeClass("highlight");f.hide();b.removeClass("highlight");e.hide();h.removeClass("highlight")})}if(!c.hasClass("disabled")){c.click(function(){a.hide();g.removeClass("highlight");i.show();c.addClass("highlight");f.hide();b.removeClass("highlight");e.hide();h.removeClass("highlight")})}if(!b.hasClass("disabled")){b.click(function(){a.hide();g.removeClass("highlight");i.hide();c.removeClass("highlight");f.show();b.addClass("highlight");e.hide();h.removeClass("highlight")})}if(!h.hasClass("disabled")){h.click(function(){a.hide();g.removeClass("highlight");i.hide();c.removeClass("highlight");f.hide();b.removeClass("highlight");e.show();h.addClass("highlight")})}}}});tools.module("account.edit.aliasManagement",function(){var i="edit_payment_method_popup",w="remove_payment_method_popup",v="editAlias_",q="removeAlias_",o="pleaseWaitDialog",c=null,p=null,h=null,n=null,s=null,b=null,x=null,j=null,y=null,u=null,a=null,g=null,D=function(E,F){$(F).html(Mustache.render(p,E))},r=function(F,E){var J=$(E).find(".payment_method_label .code"),K=$(E).find(".payment_method_label .cardNumber"),I,H,G;$(E).removeClass();$(J).html("");$(K).html("");if(F){I=F.paymentMethod.code;if(I){$(E).addClass("payment_method");$(E).addClass("payment_method_"+I);$(J).html(I)}H=F.cardNumber.value;if(H){G="XXXX-"+H.substring(H.length-4);$(K).html(G)}}},C=function(M){var L,E,G,N,K,I,F,H,J;a=M;$(s).val("");$(b).val($(b).find("option:first").val());$(x).val($(x).find("option:first").val());$(y).removeClass("error");$(j).html("");z();if(M){r(M,h);L=M.cardHolder.name;E=M.cardHolder.value;G=M.cardHolder.editable;if(L){$(s).attr("name",L);if(E){$(s).val(E)}if(!G){$(s).prop("readonly",true);$(s).addClass("disabled")}else{$(s).prop("readonly",false);$(s).removeClass("disabled")}}$(s).blur();N=M.cardExpMonth.name;K=M.cardExpMonth.value;I=M.cardExpMonth.editable;if(N){$(b).attr("name",N);if(K){$.each($(b).find("option"),function(){if($(this).text()===K){$(b).val($(this).val())}})}if(!I){$(b).prop("disabled",true)}else{$(b).prop("disabled",false)}}F=M.cardExpYear.name;H=M.cardExpYear.value;J=M.cardExpYear.editable;if(F){$(x).attr("name",F);if(H){$(x).val(H)}if(!J){$(b).prop("disabled",true)}else{$(b).prop("disabled",false)}}}},d=function(F){var E=c[F];if(E){r(E,n)}},A=function(){$(u).closest(".button").removeClass("disabled")},z=function(){$(u).closest(".button").addClass("disabled")},e=function(){if(!$(s).val()){return false}return true},k=function(){var F=new Date(),G,E,H;if($(b).find(":selected").attr("value")&&$(x).find(":selected").attr("value")){G=$(b).val();E=$(x).val();H=parseInt(E,10)>F.getFullYear()||(parseInt(E,10)===F.getFullYear()&&parseInt(G,10)>=F.getMonth()+1);$(y).toggleClass("error",!H);if(!H){$(j).html(account.edit.aliasManagement._MSG_EXP_DATE_ERROR)}else{$(j).html("")}return H}else{$(y).removeClass("error");$(j).html("")}return false},B=function(F,E){tools.dialog.showWaitingPopup(o,true);D(F,$(E));$("#alias_mgt_form").submit()},f=function(){var K={},G,E,I,F,J,H;if(a){K.url=a.url;K.hiddenFields=[];G=a.hiddenFields;if(G){$.each(G,function(L){E=G[L];K.hiddenFields.push({name:E.name,value:E.value})})}I=a.cardNumber;if(I){K.hiddenFields.push({name:I.name,value:I.value})}F=a.cardHolder;if(F){K.hiddenFields.push({name:F.name,value:$(s).val()})}J=a.cardExpMonth;if(J){K.hiddenFields.push({name:J.name,value:$(b).val()})}H=a.cardExpYear;if(H){K.hiddenFields.push({name:H.name,value:$(x).val()})}B(K,$("#aliasEditFormContainer"))}},m=function(E){if(E&&c[E]){tools.dialog.showWaitingPopup(o,true);var F={aliasId:E};$.ajax({type:"POST",url:contextPath+"/ajax/account/updateAliasData",data:F,dataType:"json",success:function(G){tools.dialog.hideDialog(o);if(G.status==="OK"){C(G.epcAliasPaymentDetails);tools.dialog.showDialog(i,true)}else{if(G.status==="ERR_UPDATE_OR_REMOVE_ALIAS_DATA"){tools.dialog.showDialog("genericAjaxErrorDialog",true)}}}})}},t=function(E){if(E&&c[E]){tools.dialog.showWaitingPopup(o,true);var F={aliasId:E};$.ajax({type:"POST",url:contextPath+"/ajax/account/removeAliasData",data:F,dataType:"json",success:function(G){tools.dialog.hideDialog(o);if(G.status==="OK"){g=G.removeAliasData;d(E);tools.dialog.showDialog(w,true)}else{if(G.status==="ERR_UPDATE_OR_REMOVE_ALIAS_DATA"){tools.dialog.showDialog("genericAjaxErrorDialog",true)}}}})}},l=function(){var G={},F,E;if(g){G.url=g.postUrl;G.hiddenFields=[];F=g.hiddenFields;if(F){$.each(F,function(H){E=F[H];G.hiddenFields.push({name:E.name,value:E.value})})}B(G,$("#aliasRemoveFormContainer"))}};return{init:function(E){c=E.aliasById;h=$("#edit_alias_payment_method_placeholder");n=$("#remove_alias_payment_method_placeholder");s=$("#card_holder");b=$("#card_expiration_date_month");x=$("#card_expiration_date_year");u=$("#confirmEditAliasButton");j=$("#card_expiration_field_error");y=$("#card_expiration_field");p=$("#aliasManagementFormTpl").html();$("#howto_add_new_payment_method").click(function(F){F.preventDefault();$("#info_add_new_payment_method").slideDown("fast")});$(".payment_method .alternative_button.edit").click(function(H){var G=$(this).find("a").attr("id"),F=G.substring(v.length);H.preventDefault();m(F)});$(".payment_method .alternative_button.delete").click(function(H){var G=$(this).find("a").attr("id"),F=G.substring(q.length);H.preventDefault();t(F)});$("#cancelEditAliasButton").click(function(F){F.preventDefault();tools.dialog.hideDialog(i)});$(u).click(function(F){F.preventDefault();if(!$(u).closest(".button").hasClass("disabled")){f()}});$(s).change(function(F){F.preventDefault();if(e()){A()}else{z()}});$([b,x]).each(function(){$(this).change(function(F){F.preventDefault();if(k()){A()}else{z()}})});$("#cancelRemoveAliasButton").click(function(F){F.preventDefault();tools.dialog.hideDialog(w)});$("#confirmRemoveAliasButton").click(function(F){F.preventDefault();if(!$(confirmRemoveAliasButton).closest(".button").hasClass("disabled")){l()}})}}});tools.module("account.edit.password",function(){var c=function(e){account.register.hideNotifications();if(!d(e)){$("#notification_mandatory").show();return false}if(!account.register.checkPassword($("#new_password").val())){$("#notification_password_invalid").show();return false}if(e){if(!a()){$("#notification_password_identical").show();return false}}if(!account.register.checkConfirmPassword()){$("#notification_password_confirmation").show();return false}if(!b()){return false}return true},d=function(f){var e;$("span.field.error").removeClass("error");e=["old_password","new_password","password_confirm"];if(f){e=["old_password","new_password","password_confirm"]}else{e=["new_password","password_confirm"]}return account.register.checkFields(e)},a=function(){var e,f;e=$("#old_password").val();f=$("#new_password").val();return(e!==f)},b=function(){if(!account.register.validateField(account.register.validationRules.password,"new_password")){$("#notification_validate_password").show();$("#field_password").addClass("error");return false}return true};return{submitEditForm:function(e){if(c(e)){$("#edit_password_request_form").submit()}else{window.scrollTo(0,0)}}}});tools.module("account.edit.personalDetails",function(){var b=function(f,e,d){account.register.hideNotifications();if(!c(f,e,d)){$("#notification_mandatory").show();return false}if(!account.register.checkConfirmEmail()){$("#notification_email_confirmation").show();return false}if(typeof d!="undefined"&&typeof d.birthdate!="undefined"&&d.birthdate){if(!account.register.checkBirthdate()){$("#notification_invalid_birthdate").show();return false}}if(!account.register.checkMandatoryContactAuthorizations()){return false}if(!account.register.checkMandatoryContactCriteria()){return false}if(!account.register.checkZipCode()){return false}if(account.register.enableContactAddress&&!account.register.checkAddressLinesLength()){return false}if(!a()){return false}return true},c=function(j,g,e){var i,f,k,h,d;$("span.field.error").removeClass("error");d=true;i=["login","login_confirm","firstname","lastname"];if(!account.register.checkFields(i)){d=false}if(typeof e!="undefined"&&typeof e.civility!="undefined"&&e.civility){if(typeof $("input[name=title]:checked").val()==="undefined"){$("#field_title").addClass("error");d=false}}f=$("#day").val();k=$("#month").val();h=$("#year").val();if(typeof e!="undefined"&&typeof e.birthdate!="undefined"&&e.birthdate){if(f==="0"||k==="0"||h==="0"){$("#field_birthdate").addClass("error");d=false}}else{if((f!=="0"||k!=="0"||h!=="0")&&(f==="0"||k==="0"||h==="0")){$("#field_birthdate").addClass("error");d=false}}if(j||g||account.register.enableContactAddress){if(!account.register.checkContactAddressMandatoryFields(e)){d=false}if(!account.register.checkPhoneFields(e,true)){d=false}}return d},a=function(){if(!account.register.validateField(account.register.validationRules.email,"login")){$("#notification_validate_login").show();$("#field_login").addClass("error");return false}if(!account.register.validateField(account.register.validationRules.firstname,"firstname")){$("#notification_validate_firstname").show();$("#field_firstname").addClass("error");return false}if(!account.register.validateField(account.register.validationRules.lastname,"lastname")){$("#notification_validate_lastname").show();$("#field_lastname").addClass("error");return false}if(!account.register.validateAllowedCharacters()){return false}if(!account.register.validatePhoneNumbers()){return false}return true};return{init:function(){var e=$(".fieldset_container.address input"),d=$(".fieldset_container.address select");$([e,d]).each(function(){$(this).change(function(){$("#notification_addressModification").show()})})},submitEditForm:function(f,e,d,g){tools.removeSelectWrapper();account.register.filterPhoneMobileFax();account.register.validationRules.addressLine.maxLength=g;if(b(f,e,d)){$("#edit_personal_details_form").submit()}else{account.register.scrollToErrorMessage()}},resetRemoveAccountPopup:function(){$('#remove_account_popup input[type="password"]').val("");if(!$("#btn_remove_account").hasClass("disabled")){$("#btn_remove_account").addClass("disabled")}$("#remove_account_msg_invalid_password").hide()},showRemoveAccountPopup:function(d){account.edit.personalDetails.resetRemoveAccountPopup();tools.dialog.showDialog("remove_account_popup",true);if(d){$("#remove_account_msg_instruction").hide();$("#remove_account_msg_invalid_password").hide();$("#remove_account_password_label").hide();$('#remove_account_popup input[type="password"]').hide()}},hideRemoveAccountPopup:function(){tools.dialog.hideDialog("remove_account_popup")},removeAccount:function(d){if(d||validation.validateField($('#remove_account_popup input[type="password"]'),validation.rules.password,"remove_account_msg_invalid_password",true,false)){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"POST",url:contextPath+"/ajax/account/remove",cache:false,data:{password:$('#remove_account_popup input[type="password"]').val()},success:function(e){tools.dialog.hideDialog("loadingDialog");if(e.success){window.location.replace(contextPath+"/account/logout")}else{if(e.status==="ERR_CONTACT_INVALID_PASSWORD"&&!d){$("#remove_account_msg_invalid_password").show()}else{if(e.status==="ERR_CONTACT_NOT_DELETABLE"){$("#remove_account_not_allowed_popup .error_message").hide();$("#remove_account_not_allowed_popup #error_message_generic").show();tools.dialog.hideDialog("remove_account_popup");tools.dialog.showDialog("remove_account_not_allowed_popup",true)}else{if(e.status==="ERR_CONTACT_NOT_DELETABLE_BALANCE"){$("#remove_account_not_allowed_popup .error_message").hide();$("#remove_account_not_allowed_popup #error_message_balance").show();tools.dialog.hideDialog("remove_account_popup");tools.dialog.showDialog("remove_account_not_allowed_popup",true)}else{if(e.status==="ERR_CONTACT_NOT_DELETABLE_OPEN_ORDER"){$("#remove_account_not_allowed_popup .error_message").hide();$("#remove_account_not_allowed_popup #error_message_open_order").show();tools.dialog.hideDialog("remove_account_popup");tools.dialog.showDialog("remove_account_not_allowed_popup",true)}else{tools.dialog.showDialog("ajaxErrorDialog",true)}}}}}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}}}});tools.module("exportCustomerInfo",function(){var b={},d=null,e=function(){b.season=$("#season");b.includeVoucherCode=$("#includeVoucherCode");b.includeInvitation=$("#includeInvitation");b.exportButton=$("#btn_generate")},c=function(){exportCustomerInfo.generateReport();return false},a=function(){$([b.includeVoucherCode,b.includeInvitation]).each(function(f){$(this).change(function(){if(b.includeVoucherCode.is(":checked")||b.includeInvitation.is(":checked")){b.exportButton.parent(".button").removeClass("disabled");b.exportButton.off("click").on("click",c);$("#criteria_required").slideUp("hidden")}else{b.exportButton.parent(".button").addClass("disabled");b.exportButton.off("click");$("#criteria_required").slideDown("hidden")}})});b.exportButton.on("click",c)};return{init:function(f){d=f.reportUrl;e();a()},generateReport:function(){var h,f,g;h=b.includeVoucherCode.is(":checked")?"true":"false";f=b.includeInvitation.is(":checked")?"true":"false";g=b.season.val()?b.season.val():"";window.open(d+"&seasonId="+g+"&includeVoucherCode="+h+"&includeInvitation="+f+"&exportType=CSV")}}});tools.module("file",function(){var p=null,m={},c=false,e=function(){m.filterType=$("#filter_type");m.status=$("#status");m.dateFrom=$("#date_from");m.dateTo=$("#date_to");m.buyer=$("#buyer");m.orderOrFileId=$("#order_file_id");m.orderOdFileIdButton=$("#btn_submit_search");m.toggleCancelledFiles=$("#toggle_cancelled_files_id")},o=function(){$([m.filterType,m.status,m.dateFrom,m.dateTo,m.buyer,m.toggleCancelledFiles]).each(function(){$(this).focus(function(){m.orderOrFileId.val("")})});m.status.on("change",b);m.buyer.on("change",b);$(".filterToolReset").on("click",function(){$(this).hide().parents(".criteria").find("input, select").val("");b()});m.filterType.change(function(){l();if(m.status.val()!=="ALL"||m.buyer.val()!==""||m.dateFrom.val()!==""||m.dateTo.val()!==""||c){b()}});m.orderOrFileId.bind("change keydown keyup",function(r){if(k()){$(this).tipsy("hide")}if(r.which===13){m.orderOdFileIdButton.click()}});$([m.dateFrom,m.dateTo]).each(function(){$(this).keydown(function(r){$(this).datepicker("hide");if(r.which===13){if(!h($(this))){r.preventDefault()}}})});m.toggleCancelledFiles.on("click",b)},q=function(){$("input[name=cancelledFiles]").val(!m.toggleCancelledFiles.is(":checked"))},n=function(){b()},a=function(){$("#date_criteria").show();m.dateFrom.prop("disabled",false);m.dateTo.prop("disabled",false);$("#status_criteria, #buyer_criteria").hide();m.status.prop("disabled",true);m.buyer.prop("disabled",true)},g=function(){$("#status_criteria").show();$("#status").prop("disabled",false);$("#date_criteria, #buyer_criteria").hide();m.dateFrom.prop("disabled",true);m.dateTo.prop("disabled",true);m.buyer.prop("disabled",true);$("#hide_cancelled_files_criteria").hide();m.toggleCancelledFiles.prop("checked",false)},f=function(){$("#buyer_criteria").show();m.buyer.prop("disabled",false);$("#date_criteria, #status_criteria").hide();m.dateFrom.prop("disabled",true);m.dateTo.prop("disabled",true);m.status.prop("disabled",true)},l=function(){if(m.filterType.val()=="date"){a()}else{if(m.filterType.val()=="status"){g()}else{if(m.filterType.val()=="buyer"){f()}}}},h=function(t){var u,r;try{u=$.datepicker.parseDate(datePickerConfig.dateFormat,m.dateFrom.val());r=$.datepicker.parseDate(datePickerConfig.dateFormat,m.dateTo.val());if((u!==null&&r!==null&&u>r)){validation.showErrorTooltip(t,p.startDateEndDate);return false}}catch(s){t.val("");return false}return true},k=function(){return !m.orderOrFileId.val()||validation.validateField(m.orderOrFileId,[{rule:validation.numericRule(true)}],null,true,false)},b=function(){if((m.filterType.val()=="date"&&!h(m.dateFrom))||!k()){return}q();$("#file_filter_form").submit()},d=function(){$("#file_cancel_error_remark").hide();$("#file_cancel_error_options").hide();$("#file_cancel_error_checkbox").hide()},j=function(){$("#file_cancel_form_reason").val("");$("#file_cancel_form_checkbox").prop("checked",false);if($("input[type=radio]").length>0){$("input[type=radio]").prop("checked",false)}},i=function(r){r.placeholder();r.datepicker(datePickerConfig);r.datepicker("option","maxDate",new Date())};return{completeMissingInfo:function(r){$.ajax({type:"GET",url:contextPath+"/ajax/account/file/dynamicInfo",cache:false,data:{fileId:r},success:function(s){$("#file_"+r+" .label_value.file_amount").remove();$("#file_"+r+" .label_value.last_update_date").remove();$("#file_"+r+" .label_value.file_status").remove();$("#file_"+r+" .fields_container").append(s)}})},initFileList:function(r,s){p=r;datePickerConfig.onSelect=n;datePickerConfig.dayNamesMin=datePickerConfig.dayNamesShort;e();o();l();i(m.dateFrom);i(m.dateTo);c=s},submitFilter:function(){b()},deleteDocument:function(s,u,r,v,t){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"POST",url:s,cache:false,data:{documentId:u,fileId:r,contactNumber:v},success:function(x){var w=parseInt($("#main_content_file_documents .sub_section_quantity").html(),10);tools.dialog.hideDialog("loadingDialog");if(x.indexOf(u)!==-1){$("#document_"+u).hide();w--;if(w===0){$("#message_upload_no_file").show();$("#main_content_file_documents .sub_section.document_list").hide()}else{if(w===1){$("#main_content_file_documents .sub_section_txt").html(t)}$("#main_content_file_documents .sub_section_quantity").html(w.toString());$("#main_content_file_documents .sub_section_separator").hide();$("#main_content_file_documents .sub_section_last_date").hide()}}else{tools.dialog.showDialog("ajaxErrorDialog",true)}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},cancelFormSubmit:function(){d();if($("#file_cancel_form_reason").val()===""){$("#file_cancel_error_remark").show()}else{if($("input[type=radio]").length===4&&$("input[type=radio]:checked").length!==2){$("#file_cancel_error_options").show()}else{if(!$("#file_cancel_form_checkbox").is(":checked")){$("#file_cancel_error_checkbox").show()}else{if($("#file_cancel_form_fileid").val()!==""){$("#file_cancel_form").submit()}}}}},checkAllCancel:function(){var r=$("input[type=radio]:checked");if(r.length===2&&r[0].value==="false"&&r[1].value==="false"){$("#cancelNowButton").addClass("disabled")}else{$("#cancelNowButton").removeClass("disabled")}},showCancelForm:function(){d();j();tools.dialog.showDialog("cancel_file_popup",true)},hideCancelForm:function(){tools.dialog.hideDialog("cancel_file_popup",true);d();j()},checkPaymentOngoing:function(s,r,u,v){var t=contextPath+"/account/file/pay?fileId="+s+"&orderId="+r+"&amount="+u+"&contactNumber="+v;tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/account/file/checkPaymentPossible",cache:false,success:function(w){if(w===true){window.location.href=t}else{tools.dialog.hideDialog("loadingDialog");$("#paymentAlreadyOngoingDialog #continue-payment").attr("href",t);tools.dialog.showDialog("paymentAlreadyOngoingDialog",true,false,null,"message_dialog message_warning")}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}}});tools.module("file.history",{showFileHistory:function(a){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/account/file/history",cache:false,data:{fileId:a},success:function(b){tools.dialog.hideDialog("loadingDialog");$(b).dialog({draggable:false,modal:true,resizable:false,width:"auto",close:function(){$("#fileHistoryDialog").dialog("destroy").remove()}})},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}});tools.module("loginAndReset",function(){$(function(){$("#sendNewPassword").submit(function(){var a;$("#sendNewPassword").prevAll().hide();$("#email_address").removeClass("error");a=validation.validateFields([{fieldId:"email_adress",rules:[{rule:validation.rules.mandatory,errorId:"notification_mandatory"},{rule:validation.rules.email,errorId:"notification_validate_email"}]},{fieldId:"captcha_response_field",rules:validation.rules.mandatory,defaultErrorId:"notification_mandatory"},{fieldId:$("[name=g-recaptcha-response]"),rules:validation.rules.mandatory,defaultErrorId:"notification_captcha"}]);if(a){loginAndReset.storeResetFields()}return a});$("#resetSubmit").click(function(a){a.preventDefault();$("#sendNewPassword").submit()})});return{storeLoginFields:function(){tools.storage.setItem("loginUsername",$("#login").val())},storeResetFields:function(){tools.storage.setItem("loginUsername",$("#email_adress").val())},storeLoginFromRegister:function(){tools.storage.setItem("loginUsername",$("#login").val())},restoreLoginFields:function(){var a=tools.storage.getItem("loginUsername");if(a!==null&&$("#login").val()===""){$("#login").val(a)}},restoreResetFields:function(){var a=tools.storage.getItem("loginUsername");if(a!==null&&$("#email_adress").val()===""){$("#email_adress").val(a)}}}});tools.module("account.massPrinting",function(){var c=null,d=null,e=0,b=function(){var g,f;f="tickets_"+Math.random().toString().replace(".","");d.find(".useCulturalContact").val(c);g=d.find("form");g.attr("action",g.attr("action")+f+".pdf");g.attr("target","_"+f);g[0].submit();setTimeout(function(){window.location.reload(true)},1000)},a=function(g,f,j){var i=false,h=false;e=0;tools.dialog.showWaitingPopup("requestProcessingDialog",true);$.ajax({type:"GET",url:contextPath+"/account/order/massPrintingCheck",data:{orderId:f,fileId:g,movementIds:j}}).done(function(k){if(k.indexOf("BENEFICIARY_MANDATORY_MISSING")>=0){tools.dialog.showDialog("massPrintingDlg_mandatory_beneficiaries",true,false,null,"")}else{if(k.indexOf("BENEFICIARY_OPTIONAL_MISSING")>=0&&!(k.indexOf("QUESTIONNAIRE_MANDATORY_MISSING")>=0)){e++;tools.dialog.showDialog("massPrintingDlg_optional_beneficiaries",true,true,null,"")}else{i=true}}if(k.indexOf("QUESTIONNAIRE_MANDATORY_MISSING")>=0){tools.dialog.showDialog("massPrintingDlg_mandatory_questionnaire",true,false,null,"")}else{if(k.indexOf("QUESTIONNAIRE_OPTIONAL_MISSING")>=0&&!(k.indexOf("BENEFICIARY_MANDATORY_MISSING")>=0)){tools.dialog.showDialog("massPrintingDlg_optional_questionnaire",true,true,null,"");e++}else{h=true}}if(i&&h){b(false)}tools.dialog.hideDialog("requestProcessingDialog")}).fail(function(){tools.dialog.hideDialog("requestProcessingDialog")})};return{checkBeforePrint:function(i){var h=$(i).parents(".massPrintingWidget"),f=h.find("[name=orderId]").val(),g=h.find("[name=fileId]").val(),j=h.find(".movementIds"),k=j.val();d=h;a(g,f,k,h)},doPrint:function(f){if(typeof f!=="undefined"){c=f}if(--e<=0){b()}}}});tools.module("menu",function(){var a=null;showOffCanvasMenu=function(){$('[id^="page_"]').addClass("slide_right");$("#secondary_content_navigation").addClass("slide_right");$('[id^="page_"] #footer_wrapper').addClass("slide_right");a=$("body").css("overflow-y");$("body").css("overflow","hidden");$("#close_menu_overlay").show()};hideOffCanvasMenu=function(){$('[id^="page_"]').removeClass("slide_right");$("#secondary_content_navigation").removeClass("slide_right");$('[id^="page_"] #footer_wrapper').removeClass("slide_right");if(a!==null&&typeof(a)!=="undefined"){$("body").css("overflow-y",a)}else{$("body").css("overflow-y","visible")}$("#close_menu_overlay").hide()};return{init:function(){$("#secondary_content_navigation .openable").on("click",function(b){return false});$("#account_account_mobile").on("click",function(b){showOffCanvasMenu();return false});$("#close_menu_overlay").on("click",function(){hideOffCanvasMenu()});$("#secondary_content_navigation .content_title .menu_close_button").on("click",function(){hideOffCanvasMenu()})}}});tools.module("ongoingOrder",function(){var c,a,d,b;return{submit:function(g,f,e){c=g;a=f;d=e;tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/account/cartEmpty",cache:false,data:b,success:function(h){if(h.success){$.ajax({type:"GET",url:contextPath+"/ajax/request/cartEmpty",cache:false,data:{isRequestCart:false},success:function(i){if(i.success){if(g){$(g).submit()}else{if(typeof a==="function"){tools.dialog.hideDialog("loadingDialog");a()}else{tools.dialog.hideDialog("loadingDialog")}}}else{tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("clear_request_basket_dialog",true,true)}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}else{tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("clear_basket_dialog",true,true)}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},previewRequest:function(f,e){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/request/cartEmpty",cache:false,data:{isRequestCart:true,fileId:e},success:function(g){if(g.success){$.ajax({type:"GET",url:contextPath+"/ajax/account/cartEmpty",cache:false,success:function(h){if(h.success){window.location.href=contextPath+f+"/request/summary?fileId="+e}else{tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("clear_basket_dialog",true,true)}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}else{tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("clear_request_basket_dialog",true,true)}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},registerAdvantageClick:function(f){var e=$("#adv_promo_box .perf_link");e.click(function(){analytics.onClickAdvantagePromotion(f,$(this).attr("id"))})},clearCartAndSubmit:function(f){var e=(d?{newOrderType:d}:{});if(f){e.isAbandonOrder=true}tools.dialog.showWaitingPopup("loadingDialog",true);tools.dialog.hideDialog("clear_basket_dialog");$.ajax({type:"GET",url:contextPath+"/ajax/account/clearShoppingCart",data:e,cache:false,success:function(g){if(c){$(c).submit()}else{if(typeof a==="function"){tools.dialog.hideDialog("loadingDialog");a()}else{tools.dialog.hideDialog("loadingDialog")}}window.location.reload()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},clearRequestCartAndSubmit:function(){var e=(d?{newOrderType:d}:{});tools.dialog.showWaitingPopup("loadingDialog",true);tools.dialog.hideDialog("clear_request_basket_dialog");$.ajax({type:"GET",url:contextPath+"/ajax/request/clearCart",data:e,cache:false,success:function(f){if(c){$(c).submit()}else{if(typeof a==="function"){tools.dialog.hideDialog("loadingDialog");a()}else{tools.dialog.hideDialog("loadingDialog")}}window.location.reload()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},submitRequest:function(e){window.location.href=contextPath+e+"/request/summary"},finalizeCart:function(){window.location.href=contextPath+"/cart/shoppingCart"},validateBeforeSubmit:function(e,g,f){if(e){tools.dialog.showDialog(f,true)}else{this.submit(g,null,null)}}}});tools.module("orders",function(){var l=null,i={},d=function(){i.filterType=$("#filter_type");i.status=$("#status");i.dateFrom=$("#date_from");i.dateTo=$("#date_to");i.orderId=$("#order_id");i.buyer=$("#buyer");i.orderIdButton=$("#btn_submit_search")},k=function(){$([i.filterType,i.status,i.dateFrom,i.dateTo]).each(function(){$(this).focus(function(){i.orderId.val("")})});i.status.on("change",c);i.buyer.on("change",c);$(".filterToolReset").on("click",function(){$(this).hide().parents(".criteria").find("input, select").val("");c()});i.filterType.change(function(){h();c()});i.orderId.bind("change keydown keyup",function(m){if(b()){$(this).tipsy("hide")}if(m.which===13){i.orderIdButton.click()}});$([i.dateFrom,i.dateTo]).each(function(){$(this).keydown(function(m){$(this).datepicker("hide");if(m.which===13){if(!g($(this))){m.preventDefault()}}})})},j=function(){c()},a=function(){$("#purchase_date_criteria").show();i.dateFrom.prop("disabled",false);i.dateTo.prop("disabled",false);$("#status_criteria, #buyer_criteria").hide();i.status.prop("disabled",true);i.buyer.prop("disabled",true)},f=function(){$("#status_criteria").show();i.status.prop("disabled",false);$("#purchase_date_criteria, #buyer_criteria").hide();i.dateFrom.prop("disabled",true);i.dateTo.prop("disabled",true);i.buyer.prop("disabled",true)},e=function(){$("#buyer_criteria").show();i.buyer.prop("disabled",false);$("#purchase_date_criteria, #status_criteria").hide();i.dateFrom.prop("disabled",true);i.dateTo.prop("disabled",true);i.status.prop("disabled",true)},h=function(){if(i.filterType.val()=="purchase_date"){a()}else{if(i.filterType.val()=="status"){f()}else{if(i.filterType.val()=="buyer"){e()}}}},g=function(o){var p,m;try{p=$.datepicker.parseDate(datePickerConfig.dateFormat,i.dateFrom.val());m=$.datepicker.parseDate(datePickerConfig.dateFormat,i.dateTo.val());if((p!==null&&m!==null&&p>m)){validation.showErrorTooltip(o,l.startDateEndDate);return false}}catch(n){o.val("");return false}return true},b=function(){return !i.orderId.val()||validation.validateField(i.orderId,[{rule:validation.numericRule(true)}],null,true,false)},c=function(){if(i.filterType.val()=="purchase_date"&&!g(i.dateFrom)||!b()){return}$("#order_filter_form").submit()};return{initOrderList:function(m){l=m;datePickerConfig.onSelect=j;datePickerConfig.dayNamesMin=datePickerConfig.dayNamesShort;d();i.dateFrom.placeholder();i.dateTo.placeholder();k();h();i.dateFrom.datepicker(datePickerConfig);i.dateTo.datepicker(datePickerConfig)},submitFilter:function(){c()}}});function NS_punch(){var a=undefined;this.lastStatusClass="";this.alertMessage="";this.switchToNeutralTimeout=1000;$(function(){$("#ticket_number").focus();$("#ticket_number").bind("keypress",function(c){var b;b=(c.keyCode?c.keyCode:c.which);if(b===13){punch.punchTicket();$("#ticket_number").val("")}})});this.punchTicket=function(){var b;b=$("#ticket_number").val();$("#ticket_number").val("");if(!punch.isTicketNumberValid(b)){$("#instruction_message_container").hide();$("#error_message_container").hide();$("#notification_missing_ticket_number").show();return false}clearTimeout(a);$.ajax({url:contextPath+"/pro/ajax/account/punchTicket",type:"POST",data:{ticketNumber:b},cache:false,beforeSend:function(){$("#ticket_number").attr("disabled","disabled")},success:function(d){$("#error_message_container").hide();$("#notification_missing_ticket_number").hide();$("#instruction_message_container").show();var c;$(".table_container").html(d);c=$("#h_ticket_status").val();punch.setTicketStatus(c);$("#ticket_number").removeAttr("disabled");$("#ticket_number").focus()},error:function(c){$("#error_message_container").hide();$("#notification_missing_ticket_number").hide();$("#instruction_message_container").show();$("#ticket_number").removeAttr("disabled");$("#ticket_number").focus()}})};this.setTicketStatus=function(b){if(punch.lastStatusClass!==""){$(".image_result").removeClass(punch.lastStatusClass)}if(b==="ERROR"){$("#instruction_message_container").hide();$("#error_message_container").show();$("#error_message").html($("#h_error_message").val());return}if(b==="SUCCESS"){punch.setSuccessStatus()}else{if(b==="FAIL"){punch.setFailStatus()}}$(".ticket_number").html($("#h_ticket_number").val())};this.setSuccessStatus=function(){$(".image_result").addClass("success");punch.lastStatusClass="success";a=setTimeout(function(){$(".image_result").removeClass("success");$(".image_result").addClass("success_neutral");punch.lastStatusClass="success_neutral"},punch.switchToNeutralTimeout)};this.setFailStatus=function(){$(".image_result").addClass("fail");punch.lastStatusClass="fail";a=setTimeout(function(){$(".image_result").removeClass("fail");$(".image_result").addClass("fail_neutral");punch.lastStatusClass="fail_neutral"},punch.switchToNeutralTimeout)};this.isTicketNumberValid=function(b){return(b!=="")}}var punch=new NS_punch();tools.module("account.register",function(){var c=function(p,o,q,r,n){if(!account.register.validateField(account.register.validationRules.email,"login")){$("#notification_validate_login").show();$("#field_login").addClass("error").removeClass("filled_by_social").parents(".fieldset_container.filled_by_social").removeClass("filled_by_social");return false}if(!r&&!n){if(!account.register.validateField(account.register.validationRules.password,"new_password")){$("#notification_validate_password").show();$("#field_password").addClass("error");return false}}if(!account.register.validateField(account.register.validationRules.firstname,"firstname")){$("#notification_validate_firstname").show();$("#field_firstname").addClass("error").removeClass("filled_by_social");return false}if(!account.register.validateField(account.register.validationRules.lastname,"lastname")){$("#notification_validate_lastname").show();$("#field_lastname").addClass("error").removeClass("filled_by_social");return false}if((p||o)&&$("input[name=isNewStructure]:checked").attr("id")==="new_structure_yes"||q){if(!account.register.validateField(account.register.validationRules.addressLine,"structure_name")){$("#notification_validate_address_line_too_long").show();$("#field_structure_name").addClass("error");return false}if($("#siret_code").length>0&&!account.register.validateField(account.register.validationRules.siretCode,"siret_code")){$("#notification_validate_siret_code").show();$("#field_siret_code").addClass("error");return false}}if(!account.register.validateAllowedCharacters()){return false}if(!account.register.validatePhoneNumbers()){return false}return true},i=function(n,o){account.register.hideNotifications();$("span.field.error").removeClass("error");if(!account.register.checkContactAddressMandatoryFields(n)){$("#notification_mandatory").show();return false}if(!m()){$("#notification_address_name").show();return false}if(!account.register.checkZipCode()){return false}if(o){if(!account.register.validateAddressStatus()){$("#notification_address_status").show();return false}}if(!account.register.validateAllowedCharacters()){return false}if(account.register.enableContactAddress){if(!account.register.checkPhoneFields(n,false)){return false}if(!account.register.validatePhoneNumbers()){return false}return account.register.checkAddressLinesLength()}return true},b=function(p,o){var q=p instanceof jQuery?p:$("#"+p),n=$("[name=g-recaptcha-response]");if(n.length&&!n.val()){q.addClass("error");$("#"+o).show();return false}q.removeClass("error");$("#"+o).hide();return true},j=function(r,p,q,t,n,o){var s=q&&$("#account_type_company").is(":checked");account.register.hideNotifications();if(!k(r,p,s,t,n,o)){$("#notification_mandatory").show();return false}if(!t&&$("#field_captcha").hasClass("field_mandatory")&&!b("field_captcha","notification_captcha")){return false}if(!account.register.checkConfirmEmail()){$("#notification_email_confirmation").show();$("#field_login").parents(".fieldset_container.filled_by_social").removeClass("filled_by_social");return false}if(l(o,"birthdate")){if(!account.register.checkBirthdate()){$("#notification_invalid_birthdate").show();return false}}if(!t&&!n){if(!account.register.checkPassword($("#new_password").val())){$("#notification_password_invalid").show();return false}if(!account.register.checkConfirmPassword()){$("#notification_password_confirmation").show();return false}}if(account.register.enableContactAddress&&(!account.register.checkAddressLinesLength()||!account.register.checkZipCode())){return false}if(!c(r,p,s,t,n)){return false}return true},k=function(r,q,s,t,o,p){var n=true;$("span.field.error").removeClass("error");if(!h(r,q,t,o,p)){n=false}if(l(p,"prefered_language")){if(!g()){return false}}if(r||q||s){if(!f(s,p)){n=false}}if(account.register.enableContactAddress){if(!account.register.checkContactAddressMandatoryFields(p)){n=false}}if(r||q||account.register.enableContactAddress){if(!account.register.checkPhoneFields(p,true)){n=false}}if(!account.register.checkMandatoryContactAuthorizations()){n=false}if(!account.register.checkMandatoryContactCriteria()){n=false}if($("input[name=isNewStructure]:checked").attr("id")==="new_structure_yes"||s){if(!account.register.checkMandatoryStructureAuthorizations()){n=false}if(!account.register.checkMandatoryStructureCriteria()){n=false}}return n},g=function(){return account.register.checkFields(["language"])},h=function(s,o,r,v,p){var n,u,q,t,w;w=true;if(r){n=["login","login_confirm","firstname","lastname"]}else{if(v){n=["login","login_confirm","firstname","lastname","captcha_response_field"]}else{n=["login","login_confirm","new_password","password_confirm","firstname","lastname","captcha_response_field"]}}if(!account.register.checkFields(n)){w=false}if(l(p,"civility")){if(typeof $("input[name=title]:checked").val()==="undefined"){$("#field_title").addClass("error").removeClass("filled_by_social");w=false}}u=$("#day").val();q=$("#month").val();t=$("#year").val();if(l(p,"birthdate")){if(u==="0"||q==="0"||t==="0"){$("#field_birthdate").addClass("error");w=false}}else{isAnyFieldValid=u!=="0"||q!=="0"||t!=="0";isAnyFieldInvalid=u==="0"||q==="0"||t==="0";if(isAnyFieldValid&&isAnyFieldInvalid){$("#field_birthdate").addClass("error");w=false}}return w},f=function(q,o){var n,p,s,r;n=true;if($("input[name=isNewStructure]:checked").attr("id")==="new_structure_yes"||q){if(l(o,"official_name")){p=$("#official_name").val();if(p===""){$("#field_official_name").addClass("error");n=false}}if(l(o,"type")){s=$("#structure_type").val();if(s==="0"){$("#field_structure_type").addClass("error");n=false}}if(l(o,"headcount")){r=parseInt($("#number_of_employees").val(),10);if(isNaN(r)||r>2147483647||r<0){$("#field_number_of_employees").addClass("error");n=false}}if($("#siret_code").length>0){siretCode=$("#siret_code").val();if(siretCode===""){$("#field_siret_code").addClass("error");n=false}}}else{if($("#structure_code").val()===""){$("#field_structure_code").addClass("error");n=false}}return n},m=function(){var n;n=$("#address_name").val();if(n.length>60){$("#field_address_name").addClass("error");return false}return true},e=function(p){var o={},n=true;$("input[name^="+p+"]").each(function(){if($(this).data("mandatory")){o[$(this).data("authorizationCode")]=true}});jQuery.each(o,function(q,r){if(jQuery.type($("input[name="+p+"\\["+q+"\\]]:checked").val())==="undefined"){$("input[name="+p+"\\["+q+"\\]]").parent().parent().addClass("error");n=false}});return n},d=function(q){var p={},n=true,o;$("input[name^="+q+"]").each(function(){if($(this).data("mandatory")){p[$(this).data("criterionIdCode")]=true}});$("select[name^="+q+"]").each(function(){if($(this).data("mandatory")){p[$(this).data("criterionIdCode")]=true}});jQuery.each(p,function(r,s){if(!$(this).data("list")){o=$("input[type='radio'][name="+q+"\\["+r+"\\]\\.values\\[0\\]]");if(o.length>0&&jQuery.type($("input[type='radio'][name="+q+"\\["+r+"\\]\\.values\\[0\\]]:checked").val())==="undefined"){o.parent().parent().addClass("error");n=false}o=$("[name="+q+"\\["+r+"\\]\\.values\\[0\\]]");if(o.val().length===0){o.parent().addClass("error");n=false}}else{}});return n},l=function(n,o){return typeof n!="undefined"&&typeof n[o]!="undefined"&&n[o]},a=function(q){var n=$("#official_name"),p=$("#structure_name"),o=function(){p.data("dirty",true)};n.on("change",function(){if(!p.length||p.data("dirty")){return}p.val(n.val().substring(0,q))});p.on("keydown",o);if(p.val()){o()}};return{enableContactAddress:false,checkOnlyZipCode:false,validationRules:{email:{minLength:1,maxLength:200,regExp:new RegExp("^[a-z0-9\\_\\-\\+\\$]+(\\.[a-z0-9\\_\\-\\+\\$]+)*@[a-z0-9\\-]+(\\.[a-z0-9\\-]+)*\\.[a-z]+$","i")},password:{minLength:6,maxLength:40,regExp:new RegExp("^.*(?=.{6,40})(?=(.*[0-9]){2}).*$")},firstname:{minLength:1,maxLength:100,regExp:undefined},lastname:{minLength:1,maxLength:100,regExp:undefined},addressLine:{minLength:0,maxLength:100,regExp:undefined},phone:{regExp:new RegExp("^[0-9]*$")},siretCode:{minLength:1,maxLength:14,regExp:undefined}},validateField:function(o,n){var p;if($("#"+n).length===0){return true}p=$("#"+n).val();if(typeof o.minLength!=="undefined"){if(p.length<o.minLength){return false}}if(typeof o.maxLength!=="undefined"){if(p.length>o.maxLength){return false}}if(typeof o.regExp!=="undefined"){if(!o.regExp.test(p)){return false}}return true},submitRegisterForm:function(r,p,q,t,n,o,s){tools.removeSelectWrapper();account.register.filterPhoneMobileFax();account.register.validationRules.addressLine.maxLength=s;if(j(r,p,q,t,n,o)){loginAndReset.storeLoginFromRegister();$("#register_request_form").submit()}else{account.register.scrollToErrorMessage()}},submitAddressForm:function(n,q,p,o){tools.removeSelectWrapper();account.register.filterPhoneMobileFax();account.register.validationRules.addressLine.maxLength=q;if(p&&!$("#is_delivery_address").prop("checked")){tools.dialog.showWaitingPopup("confirmationDialog_removeDelivery",true);return}if(i(n,o)){$("#address_form").submit()}else{account.register.scrollToErrorMessage()}},hideNotifications:function(){$("#backend_error_notification").hide();$("#notification_mandatory").hide();$("#notification_email_confirmation").hide();$("#notification_password_invalid").hide();$("#notification_password_identical").hide();$("#notification_password_confirmation").hide();$("#notification_validate_login").hide();$("#notification_validate_password").hide();$("#notification_validate_firstname").hide();$("#notification_validate_lastname").hide();$("#backend_error_notification_container").hide();$("#notification_validate_address_line_too_long").hide();$("#notification_validate_siret_code").hide();$("[id^='allowedChars_error_']").hide();$("#notification_address_status").hide();$("#notification_validate_zipcode").hide();$("#notification_validate_zipcode_too_long").hide();$("#notification_validate_zipcode_invalid").hide();$("#field_address_line_1 input").removeClass("error");$("#notification_address_name").hide()},validateAllowedCharacters:function(){var r=new RegExp(account.register.allowedFieldCharacters),n=$("input[type='text']"),o,q=true,p;$("span.field.error").removeClass("error");for(o=0;o<n.length;o++){if($(n[o]).val()!==""&&!r.test($(n[o]).val())){p=$(n[o]).closest("span.field");account.register.showErrorMsgBelowTheField(p);$(p).addClass("error");q=false}}return q},showErrorMsgBelowTheField:function(q){var n,o,p,r;n=$(q).attr("id");if(typeof n!=="undefined"&&n.length>0){p=n.replace(/([[\]])/g,"_");if(n==="field_address_line_1"){r="multiFields"}else{r="singleField"}o=$("#allowedChars_error_"+p);if($(o).length===0){o=$("#notification_"+r+"_allowedChars_error").clone().attr("id","allowedChars_error_"+p);o.insertAfter(q)}$(o).show()}},scrollToErrorMessage:function(){var n;if($("[id^='allowedChars_error_']:visible").length>0){n=$("[id^='allowedChars_error_']:visible").first().closest(".fieldset_container");$("html, body").animate({scrollTop:$(n).offset().top},0)}else{window.scrollTo(0,0)}},validateAddressStatus:function(){var n=$("#is_delivery_address").is(":checked")||$("#is_billing_address").is(":checked");if(n){$("#field_is_delivery_address").removeClass("error");$("#field_is_billing_address").removeClass("error")}else{$("#field_is_delivery_address").addClass("error");$("#field_is_billing_address").addClass("error")}return n},validatePhoneNumbers:function(){if($("#phone_number").length>0&&!account.register.validateField(account.register.validationRules.phone,"phone_number")){account.register.showErrorMsgBelowTheField($("#field_phone"));$("#field_phone").addClass("error");return false}if($("#mobile_number").length>0&&!account.register.validateField(account.register.validationRules.phone,"mobile_number")){account.register.showErrorMsgBelowTheField($("#field_mobile"));$("#field_mobile").addClass("error");return false}if($("#fax_number").length>0&&!account.register.validateField(account.register.validationRules.phone,"fax_number")){account.register.showErrorMsgBelowTheField($("#field_fax"));$("#field_fax").addClass("error");return false}return true},checkPhoneFields:function(o,p){var n=true;if(l(o,"phone_group_mandatory")){if(p){if(($("#phone_number").val()!==""&&$("#phone_prefix").val()!=="")||($("#mobile_prefix").val()!==""&&$("#mobile_number").val()!=="")||($("#fax_prefix").val()!==""&&$("#fax_number").val()!=="")){n=true}else{$("#field_phone").addClass("error");$("#field_mobile").addClass("error");$("#field_fax").addClass("error");n=false}}else{if(($("#phone_number").val()!==""&&$("#phone_prefix").val()!=="")||($("#fax_prefix").val()!==""&&$("#fax_number").val()!=="")){n=true}else{$("#field_phone").addClass("error");$("#field_fax").addClass("error");n=false}}}else{if(l(o,"fix_phone")){if($("#phone_number").val()!==""){if($("#phone_prefix").val()===""){$("#field_phone").addClass("error");n=false}}else{$("#field_phone").addClass("error");n=false}}else{if($("#phone_number").val()!==""&&$("#phone_prefix").val()===""){$("#field_phone").addClass("error");n=false}}if(l(o,"mobile_phone")){if($("#mobile_number").val()!==""){if($("#mobile_prefix").val()===""){$("#field_mobile").addClass("error");n=false}}else{$("#field_mobile").addClass("error");n=false}}else{if($("#mobile_number").val()!==""&&$("#mobile_prefix").val()===""){$("#field_mobile").addClass("error");n=false}}if(l(o,"fax_phone")){if($("#fax_number").val()!==""){if($("#fax_prefix").val()===""){$("#field_fax").addClass("error");n=false}}else{$("#field_fax").addClass("error");n=false}}else{if($("#fax_number").val()!==""&&$("#fax_prefix").val()===""){$("#field_fax").addClass("error");n=false}}}return n},checkContactAddressMandatoryFields:function(o){var n=true,q,r,p=$("#address_zipcode");q=["address_name","address_town"];if($("input[name=isNewStructure]:checked").attr("id")==="new_structure_yes"){q.push("structure_name")}if(!account.register.checkFields(q)){n=false}if(p.length&&!account.register.checkValue(validation.getFilteredZipCode(p.val()),"address_zipcode")){n=false}if(!account.register.checkOnlyZipCode){addressIds=["address_line_1","address_line_2","address_line_3"];if(!account.register.checkOneMandatoryFields(addressIds)){n=false}}r=$("#address_country").val();if(r===""){$("#field_address_country").addClass("error");n=false}return n},checkMandatoryContactAuthorizations:function(){return e("contactAuthorizations")},checkMandatoryStructureAuthorizations:function(){return e("structureAuthorizations")},checkMandatoryContactCriteria:function(){return d("contactCriteria")},checkMandatoryStructureCriteria:function(){return d("structureCriteria")},checkFields:function(q){var p,o,n;n=true;for(p=0,o=q.length;p<o;p++){if(!account.register.checkValue($("#"+q[p]).val(),q[p])){n=false}}return n},checkValue:function(n,o){if(n===""){$("#"+o).parent(".field").addClass("error").removeClass("filled_by_social").parents(".fieldset_container.filled_by_social").removeClass("filled_by_social");if(o==="captcha_response_field"){$("#field_captcha").addClass("error")}return false}return true},checkOneMandatoryFields:function(o){var n;for(n=0;n<o.length;n++){if($("#"+o[n]).val()!==""){return true}}$("#"+o[0]).parent().parent().parent(".field").addClass("error");return false},checkConfirmEmail:function(){if($("#login").val()!==$("#login_confirm").val()){$("#field_login_confirm").addClass("error");return false}return true},checkZipCode:function(){var r=$("#address_country").val(),q=$("#address_zipcode"),n,p=function(){$("#field_address_zipcode_town").addClass("error");$("#notification_validate_zipcode").show()},o=function(){$("#field_address_zipcode_town").addClass("error");$("#notification_validate_zipcode_too_long").show()};invalidZipCode=function(){$("#field_address_zipcode_town").addClass("error");$("#notification_validate_zipcode_invalid").show()};if(!q.length){return true}n=validation.getFilteredZipCode(q.val());return validation.checkZipCodeValues(r,n,p,o,invalidZipCode)},checkBirthdate:function(){var o,s,r,p,t,q,n;o=$("#day").val();s=$("#month").val();r=$("#year").val();t=parseInt(o,10);q=parseInt(s,10);n=parseInt(r,10);p=new Date(r,s-1,o);return(t===p.getDate()&&q===(p.getMonth()+1)&&n===p.getFullYear())},checkConfirmPassword:function(){if($("#new_password").val()!==$("#password_confirm").val()){$("#field_password_confirm").addClass("error");return false}return true},checkPassword:function(q){var r,n,p,s,o;if(q.length<8){$("#field_password").addClass("error");return false}p=0;s=0;for(r=0,n=q.length;r<n;r++){o=q.charCodeAt(r);if(o>=48&&o<=57){s++}else{p++}}if(s<2){$("#field_password").addClass("error");return false}return true},checkAddressLinesLength:function(){if(!account.register.validateField(account.register.validationRules.addressLine,"address_line_1")){$("#notification_validate_address_line_too_long").show();$("#address_line_1").addClass("error");return false}if(!account.register.validateField(account.register.validationRules.addressLine,"address_line_2")){$("#notification_validate_address_line_too_long").show();$("#address_line_2").addClass("error");return false}if(!account.register.validateField(account.register.validationRules.addressLine,"address_line_3")){$("#notification_validate_address_line_too_long").show();$("#address_line_3").addClass("error");return false}if($("#address_zipcode").val().length+1+$("#address_town").val().length>account.register.validationRules.addressLine.maxLength){$("#notification_validate_address_line_too_long").show();$("#field_address_zipcode_town").addClass("error");return false}return true},filterPhoneMobileFax:function(){if($("#phone_number").length>0){$("#phone_number").val($("#phone_number").val().replace(/ /g,""))}if($("#mobile_number").length>0){$("#mobile_number").val($("#mobile_number").val().replace(/ /g,""))}if($("#fax_number").length>0){$("#fax_number").val($("#fax_number").val().replace(/ /g,""))}},showFieldsFilledBySocial:function(){$(".filled_by_social:hidden").each(function(){$(this).slideToggle("fast")});$(".fields_obtained_from_social").slideToggle("fast");return false},init:function(n){a(n)}}});tools.module("account.register.address",{prefixCodes:[],prefixNumbers:[],prefixLookupTable:[],countryCodes:[],countryNames:[],populateSelects:function(){$("#address_country").append('<option value="">--</option>');for(i=0,len=account.register.address.countryCodes.length;i<len;i++){$("#address_country").append('<option value="'+account.register.address.countryCodes[i]+'">'+account.register.address.countryNames[i]+"</option>")}},populatePhone:function(){var b,a;$("#phone_prefix").append('<option value="">--</option>');for(b=0,a=account.register.address.prefixCodes.length;b<a;b++){account.register.address.prefixLookupTable[account.register.address.prefixCodes[b]]=account.register.address.prefixNumbers[b];$("#phone_prefix").append('<option value="'+account.register.address.prefixNumbers[b]+'">+'+account.register.address.prefixNumbers[b]+"</option>")}$("#mobile_prefix").append('<option value="">--</option>');for(b=0,a=account.register.address.prefixCodes.length;b<a;b++){account.register.address.prefixLookupTable[account.register.address.prefixCodes[b]]=account.register.address.prefixNumbers[b];$("#mobile_prefix").append('<option value="'+account.register.address.prefixNumbers[b]+'">+'+account.register.address.prefixNumbers[b]+"</option>")}$("#fax_prefix").append('<option value="">--</option>');for(b=0,a=account.register.address.prefixCodes.length;b<a;b++){account.register.address.prefixLookupTable[account.register.address.prefixCodes[b]]=account.register.address.prefixNumbers[b];$("#fax_prefix").append('<option value="'+account.register.address.prefixNumbers[b]+'">+'+account.register.address.prefixNumbers[b]+"</option>")}},setPrefix:function(){var b,a;if($("#phone_number").val()!==""){return}b=$("#address_country option:selected").val();a=account.register.address.prefixLookupTable[b];$("#phone_prefix").val(a)},setMobilePrefix:function(){var b,a;if($("#mobile_number").val()!==""){return}b=$("#address_country option:selected").val();a=account.register.address.prefixLookupTable[b];$("#mobile_prefix").val(a)},setFaxPrefix:function(){var b,a;if($("#fax_number").val()!==""){return}b=$("#address_country option:selected").val();a=account.register.address.prefixLookupTable[b];$("#fax_prefix").val(a)}});tools.module("account.register.addressConfirmation",{showOriginalAddress:function(){$("#address_confirmation_seized").show("blind","slow");$("#button_rewrite_address").show("blind","slow");$("#button_incorrect_address").hide("blind","slow");$("#button_accept_proposed_address").addClass("aligned");return false},confirmProposedAddress:function(){$("#address_confirmation_form input[name=action]").val("confirmProposedAddress");$("#address_confirmation_form").submit();return false},keepOriginalAddress:function(){$("#address_confirmation_form input[name=action]").val("keepOriginalAddress");$("#address_confirmation_form").submit();return false}});tools.module("salesReports",function(){var e=null,b={},c,d=function(){b.relay=$("#relay");b.dateFrom=$("#date_from");b.dateTo=$("#date_to");b.decomposedProduct=$("#decomposedProduct");b.ticketDetail=$("#ticketDetail")},a=function(){$(".filterToolReset").on("click",function(){$(this).hide().parents(".criteria").find("input, select").val("");$(this).hide().parents(".criteria").find('input[type="checkbox"]').prop("checked",false)});$([b.relay,b.decomposedProduct,b.ticketDetail,b.dateTo]).each(function(){$(this).closest(".criteria").find(".filterToolReset").hide()});$([b.relay,b.dateFrom,b.dateTo]).each(function(){$(this).change(function(){if($(this).val()!==""){$(this).closest(".criteria").find(".filterToolReset").show()}else{$(this).closest(".criteria").find(".filterToolReset").hide()}})});$([b.decomposedProduct,b.ticketDetail]).each(function(){$(this).change(function(){if(b.decomposedProduct.is(":checked")||b.ticketDetail.is(":checked")){$(this).closest(".criteria").find(".filterToolReset").show()}else{$(this).closest(".criteria").find(".filterToolReset").hide()}})});$([b.dateFrom,b.dateTo]).each(function(){$(this).keydown(function(g){$(this).datepicker("hide");if(g.which===13){if(!f($(this))){g.preventDefault()}}})})},f=function(i){var j,g;try{j=$.datepicker.parseDate(datePickerConfig.dateFormat,b.dateFrom.val());g=$.datepicker.parseDate(datePickerConfig.dateFormat,b.dateTo.val());if((j!==null&&g!==null&&j>g)){validation.showErrorTooltip(i,e.startDateEndDate);return false}}catch(h){i.val("");return false}return true};return{init:function(g){e=g.messages;c=g.reportUrl;d();b.dateFrom.placeholder();b.dateTo.placeholder();a();b.dateFrom.datepicker(datePickerConfig);b.dateTo.datepicker(datePickerConfig);b.dateFrom.datepicker("setDate",new Date())},generateReport:function(){var g,i,h;g=b.decomposedProduct.is(":checked")?"T":"F";h=b.ticketDetail.is(":checked")?"T":"F";i=b.relay.val()?b.relay.val():"";window.open(c+"&relayNumber="+i+"&fromDate="+b.dateFrom.val()+"&toDate="+b.dateTo.val()+"&decomposedByProduct="+g+"&ticketDetail="+h)}}});tools.module("socialLink",function(){$(function(){$("#social_login_link_question_yes").click(function(a){a.preventDefault();$("#social_link_instruction").slideToggle("fast");$("#social_link_question_container").slideToggle("fast");$("#social_login_form_container").slideToggle("fast")})})});tools.module("upload",function(){var d="",a={},b=100,c=function(){a.fileInput=$("#file_upload_form_input");a.submitButton=$("#file_upload_form_container .button.upload");a.browseButton=$("#file_upload_form_container .button.browse");a.fileTxt=$("#file_upload_form_name");a.form=$("#file_upload_form")};return{init:function(f,e){d=f;c();if(e){a.fileTxt.hide();a.browseButton.hide()}else{a.fileInput.hide()}a.submitButton.click(function(){if(!a.submitButton.hasClass("disabled")){a.form.submit()}});a.fileInput.change(function(i){var h="",g=$(this).val();$("#msg_long_file_name").addClass("hidden");if(g!==""&&g.length<=b){h=g.split("\\");a.fileTxt.html(h[h.length-1]);a.submitButton.removeClass("disabled")}else{if(!a.submitButton.hasClass("disabled")){a.fileTxt.html(d);a.submitButton.addClass("disabled")}if(g.length>b){$("#msg_long_file_name").removeClass("hidden")}}});a.browseButton.click(function(){a.fileInput.focus().trigger("click")})}}});tools.module("account.voucherCodes",function(){return{initDashboard:function(){$("#filter_season").change(function(){$("#file_filter_form").submit()})}}});tools.module("advantages",{submitPartnerAdvantageCode:function(){var a=$("#specialOfferForm #code");if(a.val().length>0){a.val(a.val().substring(0,20));$("#specialOfferForm").submit()}else{return false}},toggleAdvantageTouchBloc:function(){$(this).parent().find(".advantage_container").toggle(0,function(){if(!$(this).parent().hasClass("advantage_open")){$(this).parent().addClass("advantage_open")}else{$(this).parent().removeClass("advantage_open")}})}});tools.module("analytics",{onClickAdvantagePromotion:function(b,a){if(!window.dataLayer){dataLayer=[]}dataLayer.push({event:"onClickAdvantagePromotion",currentPerfId:b,promotionPerfId:a})}});tools.module("audSubCatVerification",function(){var e='<span class="external_membership_icon"></span>',c=null,i=null,k=null,j=null,a=[],b=[],m=function(q){var s=q.find("td.tariff").index(),r=q.find("td.area"),n=q.find("td.subtotal").index(),o=$("#tpl_external_membership").text(),p=$(o);if(r.length&&!r.is(":visible")){s--}p.children().first().attr("colspan",s);p.children().last().attr("colspan",n-s+1).attr("width",1);return p.insertAfter(q)},g=function(n){var o=n.next(".external_membership");if(o.hasClass("group_end")){n.addClass("group_end")}o.remove()},l=function(o){var n=o.next(".external_membership").children().last();if(!n.length){n=m(o).children().last()}if(o.hasClass("group_end")){o.removeClass("group_end");o.next(".external_membership").addClass("group_end")}return n},f=function(q){var r=parseInt(q.val(),10),n=q.parent().parent(),p=0,o=null;if(r>0){o=a.index(q);a.slice(0,o).each(function(){if($(this).attr("data-verificationId")==$(q).attr("data-verificationId")){p+=parseInt($(this).val(),10)}});tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/selection/showMemberCardList"+window.location.search,data:{verificationId:q.attr("data-verificationId"),audSubCatId:q.attr("data-audSubCatId"),quantityIndex:o,quantity:r,totalPreviousQuantity:p}}).done(function(s){if($.trim(s)){l(n).html(s)}else{g(n)}tools.dialog.hideDialog("loadingDialog")}).fail(function(){q.val("0");tools.dialog.hideDialog("loadingDialog")})}else{g(n)}},d=function(n){$.each(n.find("input"),function(o,p){$(p).keypress(function(q){if(q.keyCode===13){$(p).parent().find("a").trigger("click")}})})},h=function(o){var p=$(this),n=a.index(p);f(p);a.slice(n+1).each(function(){if($(this).attr("data-verificationId")==$(p).attr("data-verificationId")){f($(this))}})};return{initMessages:function(n){c=n.lblNote;i=n.lblErrInvalidCard;k=n.lblErrAreadyUsedCard;j=n.lblErrNotEnoughCards},init:function(n){this.initMessages(n);a=$(".quantity_to_verify");b=[];a.each(function(){var o=$(this).attr("data-verificationId");if($.inArray(o,b)<0){b.push(o)}});if(b.length){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/selection/getAudSubCatVerification",data:{verificationIds:b}}).done(function(o){$("#external_membership_secondary_content").removeClass("hidden").find(".content").html(o);a.each(function(q){var s=$(this),r=s.attr("data-verificationId"),p=s.parent().parent(),t=$.trim($("#external_membership_"+r+" h5").text())+": "+c;p.find(".tariff").prepend(e).attr("title",t);if(!q){$("#membershipLegend").html(e+c)}f(s);s.bind("change",h)});tools.dialog.hideDialog("loadingDialog")}).fail(function(){tools.dialog.hideDialog("loadingDialog")})}},getVerificationDescriptor:function(t){var u=[],p=[],s=[],q={},o,v,r,n,w;for(key in t){o=key.split("_")[1];v=t[key];r=v.externalVerification;n=r.id;w=s.indexOf(n);if(w===-1){s.push(n);u.push(o);p.push(v.count)}else{p[w]+=v.count}}q={verificationIds:s,quantities:p,audSubCatIds:u};return q},initVerificationDialog:function(s,n){var q=[],t=[],p=[],r={},o=n?$("#verification_container_mobile"):$("#external_verification_block");membershipVerificationCommon.init(n);r=audSubCatVerification.getVerificationDescriptor(s);p=r.verificationIds;t=r.quantities;q=r.audSubCatIds;tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/selection/showMultiMemberCardList"+window.location.search,contentType:"application/json",data:{verificationIds:p,audSubCatIds:q,quantities:t}}).done(function(u){tools.dialog.hideDialog("loadingDialog");if($.trim(u)){o.html(u);d(o);membershipVerificationCommon.handleKeyUp(o);membershipVerificationCommon.showVerificationDialog(n)}else{tools.dialog.showDialog("ajaxErrorDialog",true)}}).fail(function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)})},verify:function(n,o,q,s){var v=$("#card_number_"+q),u=$("#pin_code_"+q),r=$("#member_card_"+q+" .new"),p=$("#member_card_"+q+" .existing"),t=$("#existing_card_number_"+q);if(!($.trim(v.val()))){validation.showErrorTooltip(s,validationErrors.mandatory);return}s.parent().removeClass("continue").addClass("working").parent().addClass("validating");$.ajax({type:"POST",dataType:"json",url:contextPath+"/ajax/selection/verifyMemberCard",data:{verificationId:n,audSubCatId:o,cardNumber:v.val(),pinCode:u.val()}}).done(function(w){switch(w){case"INVALID":validation.showErrorTooltip(s,i);break;case"ALREADY_USED":validation.showErrorTooltip(s,k);break;default:t.val(v.val());r.hide();p.show()}s.parent().removeClass("working").addClass("continue").parent().removeClass("validating")}).fail(function(){s.parent().removeClass("working").addClass("continue").parent().removeClass("validating")})},remove:function(q,r,o,p){var t=$("#member_card_"+o+" .new"),s=$("#member_card_"+o+" .existing"),n=$("#pin_code_"+o);p.parent().removeClass("delete").addClass("working").parent().addClass("validating");$.ajax({type:"POST",dataType:"json",url:contextPath+"/ajax/selection/removeMemberCard",data:{verificationId:q,cardNumber:r}}).done(function(u){n.val("");s.hide();t.show();$(".button.addWithValidation").addClass("disabled");p.parent().removeClass("working").addClass("delete").parent().removeClass("validating")}).fail(function(){p.parent().removeClass("working").addClass("delete").parent().removeClass("validating")})},validateAllQuantities:function(s,w,x){var z=true,t=w?$(".external_verification_container .card_number"):$(".external_membership .card_number"),n,o,y,v,p=[],r=[],u=[],q=[];$(".new.member_card_elem:visible").each(function(){n=$(this).attr("data-verificationId");o=$(this).attr("data-audsubcatid");y=$(this).find(".card_number").val();v=$(this).find(".pin_code").val();if(y===""||v===""){z=false;return false}p.push(n);r.push(o);u.push(y);q.push(v)});if(!z){if(s){validation.showErrorTooltip(s,j.replace("{0}",t.filter(":enabled").length))}if(x){x(false)}return}if(p.length>0){tools.dialog.showWaitingPopup("requestProcessingDialog",true);$.ajax({type:"GET",contentType:"application/json",url:contextPath+"/ajax/selection/validate"+window.location.search,data:{verificationIds:p,audSubCatIds:r,cardNumbers:u,pinCodes:q}}).done(function(A){tools.dialog.hideDialog("requestProcessingDialog");if(!A){z=A;if(!w){a.each(function(){f($(this))})}if(s){validation.showErrorTooltip(s,j.replace("{0}",t.filter(":enabled").length))}}if(x){x(z)}}).fail(function(){tools.dialog.hideDialog("requestProcessingDialog");if(x){x(false)}})}else{if(x){x(true)}}}}});tools.module("beneficiaries",function(){var c={},b=null,d=[],a=function(){var e=null;$.each(d,function(f,g){if(e!==null){return false}if(!c[g]){e=g}});return e};return{init:function(f,e){c=f;b=e;account.beneficiary.form.setSuccessfulBeneficiarySetCallback(function(g){beneficiaries.beneficiarySeized(g)});$(".ticket_formats_container[data-movement-id]").each(function(){d[d.length]=$(this).attr("data-movement-id")});nextMovementIdToFill=a();if(nextMovementIdToFill!==null){b.find("a").unbind().on("click",function(){return false});$(function(){$("#set_beneficiary_"+nextMovementIdToFill).trigger("click")})}else{b.find("a").unbind().on("click",function(){$("#beneficiariesForm").submit();return false})}},beneficiarySeized:function(e){var f;c[e]=true;f=a();if(f===null){b.removeClass("disabled");b.find("a").unbind().on("click",function(){$("#beneficiariesForm").submit();return false})}else{$("#set_beneficiary_"+f).trigger("click")}}}});var buyer={lastTilte:"",remove:function(b,a){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"DELETE",url:contextPath+"/pro/ajax/buyer",data:{},success:function(c){if(a){$("#buy_order").attr("href",b);$("#buyNow").attr("href",b);if(typeof proceed2CheckoutFromCart!="undefined"){proceed2CheckoutFromCart.forceNextPageUri(b)}}tools.dialog.hideDialog("loadingDialog");$("#main_content_buyer_box").hide()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},showContactOrStructureTag:function(){$("#buyer_box_infos").hide();$("#buyer_box_buttons").hide();$("#add_buyer_box_buttons").show();$(".contact_structure_selection").removeClass("hidden");this.lastTilte=$("#main_content_buyer_box > .content_title > .title > .title_text").html();this.changeTitle(buyerTitleChange)},showContactOrStructureTagFromCheckout:function(){$("#buyer_box_infos").hide();$("#buyer_box_buttons").hide();$(".contact_structure_selection").removeClass("hidden");$("#btn_cancel_add_buyer").parent().show();$("#btn_continue").parent().addClass("disabled")},hideContactOrStructureTag:function(){orderContactSelection.cancelContact();orderContactSelection.return2ContactSearch();$("#add_buyer_box_buttons").hide();$(".contact_structure_selection").addClass("hidden");$("#buyer_box_infos").show();$("#buyer_box_buttons").show();$("#btn_add_buyer").parent().addClass("disabled");this.changeTitle(this.lastTilte)},hideContactOrStructureTagFromCheckout:function(){orderContactSelection.cancelContact();orderContactSelection.return2ContactSearch();$(".contact_structure_selection").addClass("hidden");$("#buyer_box_infos").show();$("#buyer_box_buttons").show();$("#btn_cancel_add_buyer").parent().hide()},changeTitle:function(a){$("#main_content_buyer_box > .content_title > .title > .title_text").html(a)},updateBuyerDetailedInfo:function(c,b,a,d,e){$("#buyer_info_name_structure").html(c+" "+b+(d!==null?" / "+d:""));$("#buyer_info_email").html(a);$("#buyer_info_number").html(e)},changeBuyer:function(){$.ajax({type:"POST",url:contextPath+"/pro/ajax/buyer",data:{contactNumber:$("#selected_contact").val(),email:$("#selected_email").val(),firstName:$("#selected_first_name").val(),lastName:$("#selected_last_name").val(),structureName:$("#selected_structureName").val()},success:function(a){tools.dialog.hideDialog("loadingDialog");buyer.hideContactOrStructureTag();buyer.changeTitle(buyerTitleSellingTo+" "+$("#selected_first_name").val()+" "+$("#selected_last_name").val());buyer.updateBuyerDetailedInfo($("#selected_first_name").val(),$("#selected_last_name").val(),$("#selected_email").val(),$("#selected_structureName").val(),$("#selected_contact").val())},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},checkoutBuyerFormSubmit:function(){$("#buyer_form").submit()},checkoutBillingContactFormSubmit:function(){$("#billing_contact_form").submit()},addBuyer:function(b,a,c){if(!$("#btn_continue").parent().hasClass("disabled")){this.checkoutBuyerFormSubmit()}},addBillingContact:function(a){if(!$("#btn_continue").parent().hasClass("disabled")){this.checkoutBillingContactFormSubmit()}},proceedWithNoUpdate:function(a){window.location.replace(a)},redirect2FilteredOrders:function(a){window.location.replace(a+"/account/orders?filter_type=buyer&buyer="+$("#buyer_info_number").html())},redirect2FilteredFiles:function(a){window.location.replace(a+"/account/files?filter_type=buyer&buyer="+$("#buyer_info_number").html())}};tools.module("catalog.goods.controller",function(){return{init:function(){var c=new catalog.goods.model.Catalog(),g=new catalog.goods.model.Filters(),b=new catalog.goods.view.View(),e=function(i){return function(j){j.preventDefault();i.call(this,j)}},a=function(i){$("#goods_left_column, #goods_central_column").toggleClass("goods-choose-category",i)},d=function(i){$(".goods-search-form .search").toggle(!i);$(".goods-search-form .delete").toggle(i)},h=function(){$("#goods_filters").removeClass("show")},f=null;$("#goods_back_to_top").hide();c.fetch().then(function(){try{var i=/familyId\=(.*)/.exec(History.getState().url),j=c.families._map[i[1]];if(j){g.familyId=j.id}else{History.replaceState({familyId:null},null,"?")}}catch(k){}b.render(c,g);$(".goods-loading").removeClass("goods-loading");$("#goods_loading_indicator").hide()});$("#main_content_list_products_GOODS").on("click",".goods-family, .goods-breadcrumb-child",e(function(){var i=$(this).data("family-id");g.familyId=i;g.topicId=null;a(false);History.pushState({familyId:g.familyId},null,"?familyId="+i)}));$("#goods_breadcrumb .goods-breadcrumb-home, #goods_filters_back a").on("click",e(function(){g.familyId=null;g.topicId=null;History.pushState({familyId:null},null,"?")}));$("#goods_filters_sort").on("change",function(){g.sort=$(this).val();h();b.itemsView.render(c,g)});$("#goods_pagination .page.previous").on("click",e(function(){g.pagination.page--;b.itemsView.render(c,g);window.scrollTo(0,0)}));$("#goods_pagination").on("click",".page.page-link",e(function(){g.pagination.page=$(this).data("page");b.itemsView.render(c,g);window.scrollTo(0,0)}));$("#goods_pagination .page.next").on("click",e(function(){g.pagination.page++;b.itemsView.render(c,g);window.scrollTo(0,0)}));$("#goods_back_to_top").on("click",e(function(){window.scrollTo(0,0)}));f=e(function(){var i=null;$(".goods-search-form input").each(function(){var j=$(this).val();if(j){i=j}});g.searchValue=i;g.search=diacritics.removeDiacritics(i).toUpperCase();d(true);h();b.render(c,g)});$(".goods-search-form").on("submit",f);$(".goods-search-form .search a").on("click",f);$(".goods-search-form, #goods_search_notification").find(".delete a").on("click",e(function(){g.searchValue=null;g.search=null;d(false);$(".goods-search-form input").val("");h();b.render(c,g)}));$("#goods_filters_topic").on("change",function(){g.topicId=$(this).val();h();b.render(c,g);$("#goods_filters_topic_container .delete").toggleClass("show",!!g.topicId)});$("#goods_filters_topic_container .delete").on("click",e(function(){g.topicId=null;h();b.render(c,g);$("#goods_filters_topic_container .delete").removeClass("show")}));$(".goods-category-general-title, .goods-category-general-subtitle").on("click",e(function(){a(true);h()}));$("#goods_filters_mobile a").on("click",e(function(){$("#goods_filters").toggleClass("show")}));$("#goods_close_categories a").on("click",e(function(){a(false)}));$("#goods_search_mobile input").on("keydown, keyup, change",function(){$("#goods_search input").val("")});$("#goods_search input").on("keydown, keyup, change",function(){$("#goods_search_mobile input").val("")});$(window).on("resize",function(){h()}).on("scroll",(function(){var j=false,i=$("#goods_back_to_top");return function(){var k=$(this).scrollTop()>1000;if(k==j){return}j=k;if(k){i.stop().fadeIn()}else{i.stop().fadeOut()}}})());History.Adapter.bind(window,"statechange",function(){var i=History.getState();g.familyId=i.data.familyId;b.render(c,g)})}}});tools.module("catalog.goods.model",function(){var h,d,c=jQuery.get,g=function(j,i){if(j.rank!=i.rank){return j.rank>i.rank?1:-1}return j.name>i.name?1:(j.name==i.name?0:-1)},f=function(i,j){i.forEach(function(l){j.push(l);var k=l.childs;if(!k){return}f(k,j)});return j},e=function(j,i){if(!i._map){i._map={}}Object.keys(j).forEach(function(k){var m=j[k],l=m.parent?j[m.parent]:null,n;m.id=parseInt(k,10);i._map[m.id]=m;if(l){n=l.childs;if(!n){n=[];l.childs=n}n.push(m);n.sort(g);m.parent=l}else{i.push(m)}i.sort(g)});i._flat=f(i,[])},b=function(j){var i=functions.generateAmount;j.forEach(function(l){var k=l.minPrice,m=l.minPriceWithoutAdvantage;if(m!==null){l.viewMinPrice=i(m);if(m>k){l.viewMinPriceWithAdvantage=i(k)}}l._searchName=diacritics.removeDiacritics(l.name).toUpperCase()})},a=function(m,i){if(!i){return null}var j=m[i],k=[j.id],l=j.childs;if(l){k=k.concat(l.map(function(n){return n.id}))}return k};h=function(){this.products=null;this.families=null;this.topics=null};h.prototype.fetch=function(j){var i=function(k){this.products=k.items;this.families=[];this.topics=[];e(k.families,this.families);e(k.topics,this.topics);b(this.products)}.bind(this);return c(contextPath+"/ajax/list/goods").then(i,function(){tools.dialog.showDialog("ajaxErrorDialogReload",true,true)})};d=function(){this.topicId=null;this.familyId=null;this.search=null;this.searchValue=null;this.sort="ALPHABET";this.pagination={page:1,displayWindow:2,nbPerPage:99}};d.prototype.getFilteredProducts=function(j,l){var i=a(j.families._map,this.familyId),k=this.search;l=!!l;return this._getSortedProducts(j.products.filter(function(m){if(m.isStoreFrontProduct!=l){return false}if(i&&i.indexOf(m.familyId)==-1){return false}if(k&&m._searchName.indexOf(k)==-1){return false}return true}))};d.prototype._getSortedProducts=function(i){return i.sort(function(k,j){if(this.sort=="PRICE_UP"){return k.minPrice-j.minPrice}else{if(this.sort=="PRICE_DOWN"){return j.minPrice-k.minPrice}else{return g(k,j)}}}.bind(this))};d.prototype.getTopics=function(p,k){var o=p.reduce(function(l,q){var i=q.topicId;if(l.indexOf(i)==-1){l.push(i)}return l},[]),n=0,j=o.length,m;if(j<=1){return null}for(;n<j;n++){m=k.topics._map[o[n]];if(m.parent){o.push(m.parent.id);j++}}return k.topics._flat.slice(0).filter(function(i){return o.indexOf(i.id)!=-1})};d.prototype.getTopicFilteredProducts=function(j,i){var k=a(i.topics._map,this.topicId);if(!k){return j}return j.filter(function(l){return k.indexOf(l.topicId)!=-1})};return{Catalog:h,Filters:d}});tools.module("catalog.goods.view",function(){var b,g,k,d=null,f=null,a=null,e=null,i=null,h="goods-family-highlight",c=function(n,l,o){var m=Mustache.render(n,l,{});if(o){$(o).html(m)}return m},j=function(l){return $(c(i,l))};b=function(){this.familiesView=new g();this.itemsView=new k()};b.prototype.render=function(l,m){this.familiesView.render(l,m);this.itemsView.render(l,m)};g=function(){};g.prototype.render=function(l,p){var o,r,q=p.familyId,n=$("#goods_breadcrumb"),m=null;if(!this.initialized){this.initialized=true;c(e,l,"#goods_families")}n.find(".goods-breadcrumb-child").remove();$("."+h).removeClass(h);$("#goods_category_title").toggleClass("goods-with-category",!!q);$("#goods_category_title, #goods_search_notification").toggleClass("goods-with-search",!!p.searchValue);$(".goods-category-title").text("");if(q){o=l.families._map[q];r=o.parent;if(r){n.append(j(r))}n.append(j(o));$(".goods-family[data-family-id="+q+"]").addClass(h);m=o.name}else{m=$(".goods-breadcrumb-home").text()}if(p.searchValue){$(".goods-category-search").text(p.searchValue)}else{$(".goods-category-search").text("")}$(".goods-category-text").text(m)};k=function(){};k.prototype.render=function(p,n){var t=n.getFilteredProducts(p),m=n.getTopics(t,p),s=n.getTopicFilteredProducts(t,p),o=$("#goods_list"),r=$("#goods_empty_list"),l=$("#goods_filters"),q=$(".goods-total-products"),v=$("#goods_filters_topic"),u=null;if(t.length==1){q.text(f.LABEL_PRODUCT_COUNT_SINGULAR)}else{if(t.length>1){$("#goods_empty_list").hide();q.text(f.LABEL_PRODUCT_COUNT_PLURAL.replace("{0}",t.length))}else{q.html("&nbsp;")}}r.toggle(!s.length);l.toggleClass("hide",!s.length);o.html("");u=pagination.paginate(s,n.pagination);u.list.forEach(function(w){o.append($(c(a,w)))});pagination.updatePaginationWidget("#goods_pagination",u.view);$("#goods_filters_topic_container").toggle(!!m);if(m){$("option",v).each(function(){var w=$(this);if(w.val()){w.remove()}});m.forEach(function(w){var y=$(document.createElement("option")),z=!!w.parent,x=w.id;y.text((z?"- ":"")+w.name);y.val(x);if(n.topicId==x){y.prop("selected",true)}v.append(y)})}this.renderStoreFront(p,n)};k.prototype.renderStoreFront=function(l,m){var n=m.getFilteredProducts(l,true),o=$("#goods_storefront_list");$("#goods_storefront").toggle(n.length>0);o.html("");n.forEach(function(p){o.append($(c(a,p)))})};return{init:function(m){d=m;f=d.labels;a=$("#goodsItemTpl").html();e=$("#goodsFamiliesTpl").html();i=$("#goodsBreadcrumbElementTpl").html();var l=f.LABEL_PRODUCT_SEARCH.replace("{1}","<span class='goods-category-text'></span>");l=l.replace("{0}","<span class='goods-category-search'></span>");$(".goods-category-title-extended").html(l)},View:b,FamiliesView:g}});tools.module("conditionalRatesMessage",function(){var a=null,d=function(g){a=g},b=function(g,h){var i=$(".quantity",g).find('input[type="text"],select');if(h){$(i).val("0")}$(i).prop("disabled",h)},f=function(){$(".quantity",".promotion_rate").find('input[type="text"],select').each(function(h,g){c(g)})},e=function(l){var k=0,h=l.requiredRateAudSubCatIds.length,g=0,m;for(;k<h;k++){m='[data-conditionalrateid="'+l.prefixId+l.requiredRateAudSubCatIds[k]+'"]';$(".quantity",m).find('input[type="text"],select').each(function(n,j){if($(j).val()!==""){g+=Number($(j).val())}})}m='[data-conditionalrateid="'+l.prefixId+l.specialAudSubCatId+'"]';b($(m),g<l.minQuantityOfRequired)},c=function(g){var k=0,h=a.length,n=$(g).closest("tr"),m=$(n).data("conditionalrateid"),l;for(;k<h;k++){l=a[k];if(l.id==m){e(l)}}};return{init:function(g,i,h){$(function(){d(h);f();$(".quantity",".conditional_group").find('select,input[type="text"]').on("change",function(){c(this)});$(".dismiss_button").on("click",function(){$(".commercial_banner").slideUp()});if(g==="true"){$(".commercial_banner").removeClass("hidden")}$(".banner_instruction",".commercial_banner").text(i)})}}}());tools.module("confirmation",function(){var a=null;pollForOrderClosing=function(b){$.ajax({type:"GET",url:contextPath+"/ajax/checkout/isOrderClosed",cache:false,success:function(c){if(c===true){$("#confirmation_polling").fadeOut("fast",function(){$("#confirmation_order_closed").fadeIn("fast")})}else{if(b<a.length-1){setTimeout(function(){pollForOrderClosing(b+1)},a[b+1])}else{$("#confirmation_polling").fadeOut("fast",function(){$("#confirmation_polling_stop").fadeIn("fast")})}}}})};changePollTitle=function(){var b=$("#confirmation_generating_tickets");if(b.length>0){$("#confirmation_processing_order").fadeOut("fast",function(){b.fadeIn("fast")})}};changeThreePoints=function(){var b=$("#confirmation_three_points");setTimeout(function(){changeThreePoints()},300);switch(b.text().length){case 1:b.html(". .");break;case 3:b.html(". . .");break;case 5:b.html("");break;default:b.html(".")}};return{initPolls:function(b){a=b;setTimeout(function(){pollForOrderClosing(0)},a[0]);setTimeout(function(){changePollTitle()},2500);changeThreePoints()}}});function NS_contact(){function a(){var b,c,j,d,e,k,g,i,l,h;b=["BY_MAIL","BY_RECOMMANDED_MAIL","DHL","FEDEX"];c="#cc01";j="#address";d="#contact_email";e="#buttonContainer";i=".delivery_address-";this.deliveryModesScreen=false;this.orderSummaryLocked=false;this.contactAddresses={};this.editLink="";this.contactEmail="";this.lastDeliveryMode="";this.lastGoodsDeliveryMode="";this.submitDeliveryModeForm=function(){if($('input[name="goodsShipmentModeId"]:checked').length>0){contact.delivery.lastDeliveryMode=$('input[name="goodsShipmentModeId"]:checked').attr("attr-type");$("#goodsShipmentModeType").val(contact.delivery.lastDeliveryMode)}if(($.inArray(contact.delivery.lastDeliveryMode,b)>=0&&typeof contact.delivery.getSelectedContactId()==="undefined")||($.inArray(contact.delivery.lastGoodsDeliveryMode,b)>=0&&this.getSelectedGoodsContactAddress()==="")){$("#notification_delivery_address").show();window.scrollTo(0,0);return}else{$("#notification_delivery_address").hide()}$("#delivery_modes_form").submit()};this.getSelectedContactId=function(){return $('select[id="cc01"] option:selected').val()};this.getSelectedGoodsContactAddress=function(){if($("#goodsContactAddressId")){return $("#goodsContactAddressId").val()}return""};k=function(n,m){var o;o=$(i+m);o.find("#address").html(n.formattedAddress)};g=function(m){var n=$(i+m);n.find(c).show();$("select",n).prop("disabled",true);if(!contact.delivery.orderSummaryLocked){n.find(c).removeAttr("disabled")}n.find(j).show();n.find(e).show();n.find(d).hide();contact.delivery.setCurrentAddress(m)};this.showContainer=function(m){$(i+m).show()};this.setCurrentAddress=function(n){var o,m;shipment_mode_id=n;if(this.contactAddresses[n].length<=0){return}o=$(i+n).find(c)[0].selectedIndex;m=this.contactAddresses[n][o];k(m,n);edit_contact_address_id=m.addressId;h="";if($('input[name="goodsShipmentModeId"]:checked').length>0){h=$('input[name="goodsShipmentModeId"]:checked').attr("value");if(Number(h)===n){$("#goodsContactAddressId").val(m.addressId)}}};this.showShippingAddressForm=function(n,m,o){l=$('input[name="shipmentModeId"]:checked').attr("value");h="";if($('input[name="goodsShipmentModeId"]:checked').length>0){h=$('input[name="goodsShipmentModeId"]:checked').attr("value")}$(".delivery_address").filter(function(p,q){return !$(q).hasClass("delivery_address-"+l)&&!$(q).hasClass("delivery_address-"+h)}).each(function(p,q){$("select",q).prop("disabled",true);$(q).hide()});if($.inArray(n,b)>=0){this.showContainer(m);g(m);if(o){$("#goodsContactAddressId").val($(c,i+m).val())}}else{shipment_mode_id=m;edit_contact_address_id="";if(o){$("#goodsContactAddressId").val("")}}};this.updateGoodsShipmentModes=function(n,p){var m=false,o;l=$('input[name="shipmentModeId"]:checked').attr("value");$('input[name="goodsShipmentModeId"]').each(function(q,r){if($.inArray(Number($(r).attr("value")),n)>=0){$(r).removeAttr("disabled");$(r).parent().removeClass("disabled");if($(r).attr("value")===l&&!p){$(r).prop("checked",true);contact.delivery.setGoodsDeliveryMode($(r).attr("attr-type"),$(r).attr("value"));m=true}}else{$(r).attr("disabled","disable");$(r).parent().addClass("disabled")}});if(!m&&!p){o=$('input[name="goodsShipmentModeId"]').filter(function(q,r){return !$(r).is(":disabled")&&$(r).attr("attr-externalProvider")==="true"}).first();if(!o||o.length===0){o=$('input[name="goodsShipmentModeId"]').filter(function(q,r){return !$(r).is(":disabled")}).first()}$(o).prop("checked",true);contact.delivery.setGoodsDeliveryMode($(o).attr("attr-type"),$(o).attr("value"))}};this.setDeliveryMode=function(n,m,o){contact.delivery.lastDeliveryMode=n;this.showShippingAddressForm(n,m);$("#shipmentModeType").val(n);if($("#goodsShipmentModeType").length>0&&this.deliveryModesScreen){contact.delivery.ajax.showGoodsShipmentModes(m,n,o,this.updateGoodsShipmentModes)}};this.setGoodsDeliveryMode=function(n,m,o){contact.delivery.lastGoodsDeliveryMode=n;this.showShippingAddressForm(n,m,true);$("#goodsShipmentModeType").val(n);if(o){$('input[name="goodsShipmentModeId"]').each(function(p,q){if($(q).attr("value")===m+""){$(q).prop("checked",true)}})}};this.lockScreen=function(){$("select").attr("disabled","disabled");$("input:not([name='_token'])").attr("disabled","disabled");$("form").each(function(){this.reset()})};this.editContactAddress=function(n,m){n+="&shipmentModeId="+shipment_mode_id;n+="&contactAddressId="+edit_contact_address_id;window.location.href=this.buildAddtionalAddressUrlParameters(n,m)};this.newContactAddress=function(n,m){n+="&shipmentModeId="+shipment_mode_id;window.location.href=this.buildAddtionalAddressUrlParameters(n,m)};this.buildAddtionalAddressUrlParameters=function(n,m){l=$('input[name="shipmentModeId"]:checked').attr("value");h="";if($('input[name="goodsShipmentModeId"]:checked').length>0){h=$('input[name="goodsShipmentModeId"]:checked').attr("value")}if(m===l){n+="&ticketingShipmentAddress=true"}if(m===h){n+="&goodsShipmentAddress=true"}return n};function f(){var m=function(p,n,o){if(o!=="abort"){tools.dialog.showDialog("ajaxErrorDialog",true)}};this.showGoodsShipmentModes=function(q,n,o,p){$.ajax({url:contextPath+"/ajax/checkout/deliveryModes/getGoodsShipmentModes",type:"POST",data:{ticketingShipmentModeId:q,ticketingShipmentModeType:n},cache:false}).done(function(r){return p(r,o)}).fail(m)}}this.ajax=new f()}this.delivery=new a()}var contact=new NS_contact();tools.module("contactOrStructureSelection",{DIST_SEARCH_MIN_LENGTH:3,saveButtonSelector:"",searchContactAjax:function(a,b){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/pro/ajax/contactSearch",data:{searchText:a,from:b},success:function(c){tools.dialog.hideDialog("loadingDialog");$("#contact_lookup_result").append(c);if($(".contact_result_item").length>0){$("#contact_create").hide();$("#reset_lookup").hide()}else{$("#contact_create").show();$("#contact_lookup_text").focus().select()}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},searchStructureAjax:function(a){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/pro/ajax/structureSearch",data:{email:$("#search_relay_email").val(),structurecode:$("#search_relay_code").val()},success:function(b){if(typeof b.contactNumber!="undefined"&&typeof b.individualFirstname!="undefined"&&typeof b.individualLastname!="undefined"&&typeof b.email!="undefined"&&typeof b.structureOfficialName!="undefined"){$(contactOrStructureSelection.saveButtonSelector).parent().removeClass("disabled");contactOrStructureSelection.selectStructure(b);tools.dialog.hideDialog("loadingDialog")}else{tools.dialog.hideDialog("loadingDialog");$("#structure_create").show();$("#search_relay_email").focus().select();$(contactOrStructureSelection.saveButtonSelector).parent().addClass("disabled")}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true);return false}})},reset:function(){this.enableSearch(false,false);this.enableSearch(false,true);$("#contact_lookup_text").val("");$("#contact_lookup_result").empty();$("#reset_lookup").hide();$("#contact_create").hide();$("#structure_create").hide();$("#search_relay_email").val("");$("#search_relay_code").val("");this.hideStructureError()},checkContactName:function(a,b){if(a&&b&&(a.firstName.toUpperCase()!==b.firstName.toUpperCase()||a.lastName.toUpperCase()!==b.lastName.toUpperCase())){tools.dialog.showDialog("warning_contact_existed",true)}},selectStructure:function(a){var b=$("#contact_selection");$("#selected_contact").val(a.contactNumber);$("#selected_first_name").val(a.individualFirstname);$("#selected_last_name").val(a.individualLastname);$("#selected_email").val(a.email);$("#selected_structureName").val(a.structureOfficialName);b.find(".contact_first_name").html(a.individualFirstname);b.find(".contact_last_name").html(a.individualLastname);b.find(".contact_email").html(a.email);b.find(".contact_structure").html(a.structureOfficialName).show();$("#structure_search").hide();$("#structure_create").hide();b.show();if(contactOrStructureSelection.saveButtonSelector!==null){$(contactOrStructureSelection.saveButtonSelector).parent().removeClass("disabled")}contactOrStructureSelection.reset()},selectContact:function(a,b){var c=$("#contact_selection");contactOrStructureSelection.checkContactName(a,b);$("#selected_contact").val(a.contactNumber);$("#selected_first_name").val(a.firstName);$("#selected_last_name").val(a.lastName);$("#selected_email").val(a.email);$("#selected_structureName").val(a.structureName);c.find(".contact_first_name").html(a.firstName);c.find(".contact_last_name").html(a.lastName);c.find(".contact_email").html(a.email);c.find(".contact_structure").html(a.structureName).hide();$("#contact_search").hide();$("#contact_create").hide();$("#structure_create").hide();c.show();if(contactOrStructureSelection.saveButtonSelector!==null){$(contactOrStructureSelection.saveButtonSelector).parent().removeClass("disabled")}contactOrStructureSelection.reset()},enableSearch:function(d,c){var a=c?$("#lookup_structure"):$("#lookup_members"),b=!a.hasClass("disabled");if(b==d){return}if(d){a.removeClass("disabled");a.parent().removeClass("disabled");a.on("click",function(){if(c){contactOrStructureSelection.searchStructure()}else{contactOrStructureSelection.search()}})}else{a.addClass("disabled");a.parent().addClass("disabled");a.off("click")}},handleTypeChangeForContact:function(){$("#structure_search").hide();$("#contact_selection").hide();$("#structure_create").hide();$("#contact_search").show();$("#contact_create").show();contactOrStructureSelection.reset();if(contactOrStructureSelection.saveButtonSelector!==null){$(contactOrStructureSelection.saveButtonSelector).parent().addClass("disabled")}},handleTypeChangeForStructure:function(){$("#contact_search").hide();$("#contact_create").hide();$("#contact_selection").hide();$("#structure_search").show();$("#structure_create").show();contactOrStructureSelection.reset();if(contactOrStructureSelection.saveButtonSelector!==null){$(contactOrStructureSelection.saveButtonSelector).parent().addClass("disabled")}},handleChangeInStructureInputs:function(){if(contactOrStructureSelection.saveButtonSelector!==null&&$("#search_relay_email").val()!==null&&$("#search_relay_code").val()!==null&&$("#search_relay_email").val().length>contactOrStructureSelection.DIST_SEARCH_MIN_LENGTH&&$("#search_relay_code").val().length>0){contactOrStructureSelection.enableSearch(true,true)}else{contactOrStructureSelection.enableSearch(false,true)}},init:function(a){if(a!==null){this.saveButtonSelector=a}$("#contact_lookup_text").on({keyup:function(){contactOrStructureSelection.enableSearch($(this).val().length>=contactOrStructureSelection.DIST_SEARCH_MIN_LENGTH,false)},keypress:function(b){if(b.keyCode===13){$("#lookup_members").click()}}});$("#search_relay_email").on({keypress:function(b){if(b.keyCode===13&&$("#search_relay_email").val().length>=contactOrStructureSelection.DIST_SEARCH_MIN_LENGTH&&$("#search_relay_code").val().length>=0){$("#lookup_relays").click()}}});$("#search_relay_code").on({keypress:function(b){if(b.keyCode===13&&$("#search_relay_email").val().length>=contactOrStructureSelection.DIST_SEARCH_MIN_LENGTH&&$("#search_relay_code").val().length>=0){$("#lookup_relays").click()}}});$("#contact_search_radio_container input:radio").on({change:function(){if($(this).val()=="contact"){contactOrStructureSelection.handleTypeChangeForContact();$("#info_message_contact").show();$("#info_message_structure").hide();$("#contact_lookup_text").focus()}else{if($(this).val()=="structure"){contactOrStructureSelection.handleTypeChangeForStructure();$("#info_message_contact").hide();$("#info_message_structure").show();$("#search_relay_email").focus()}}}});$("#search_relay_email").keyup(this.handleChangeInStructureInputs);$("#search_relay_code").keyup(this.handleChangeInStructureInputs);this.reset()},search:function(b){var a=$("#contact_lookup_text").val();if(!b){$("#contact_lookup_result").empty()}$("#show_more").detach();this.searchContactAjax(a,b)},searchStructure:function(){this.searchStructureAjax()},selectContactFromList:function(a){this.selectContact({contactNumber:a,firstName:$.trim($("#result_first_name_"+a).text()),lastName:$.trim($("#result_last_name_"+a).text()),email:$.trim($("#result_email_"+a).text()),structureName:$.trim($("#result_structure_"+a).text())})},cancelContact:function(){if(this.saveButtonSelector!==null){$(this.saveButtonSelector).parent().addClass("disabled")}if($("#contact_search_radio_container input:radio:checked").val()=="contact"){$("#contact_search").show();$("#contact_create").hide();$("#contact_selection").hide();$("#selected_contact").val("");$("#contact_lookup_text").focus()}else{if($("#contact_search_radio_container input:radio:checked").val()=="structure"){$("#contact_selection").hide();$("#structure_search").show();$("#search_relay_email").val("");$("#search_relay_code").val("");$("#structure_create").hide();$("#search_relay_email").focus()}}},return2ContactSearch:function(){jQuery("#search_type_contact_radio").prop("checked",true);$("#info_message_contact").show();$("#info_message_structure").hide();this.handleTypeChangeForContact()},showEditContactForm:function(){distribution.editContact.showEditContactForm({email:$("#contact_lookup_text").val()})},validateContact:function(a){var b=$("#selected_contact").val();if(!b){validation.showErrorTooltip($(a),$("#contact-selection-msg .content").html())}return b},showStructureError:function(){$("#structure_create").show()},hideStructureError:function(){$("#structure_create").hide()}});tools.module("creditNote",function(){var d=false,c=false,e=function(){return tools.getAmount("#final_amount")},a=function(h,g){var i=e();if(h){$("#credit_note_amount_text").removeClass("hidden")}else{$("#credit_note_amount_text").addClass("hidden")}if(i!==null){if(h){b($("#credit_note_amount_value").val())}else{b("")}}},b=function(h){var i=null,g=$('input[name="paymentMethodId"]:checked');if(g&&g.length>0){i=$(g[0]).val()}else{i=creditNote.ccPaymentMethodId}tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({url:contextPath+"/ajax/checkout/setCreditNotePaymentAmount",type:"POST",data:{creditNotePaymentAmount:h,paymentMethodId:i},cache:false,success:function(j){tools.dialog.hideDialog("loadingDialog");if(j.splitPayment==="OK"){$("#notification_split_payment, #notification_split_payment_finish").hide();$("#warning_credit_note_split_payment").hide();waitingAccount.enableWaitingAccountButtons()}else{if(j.splitPayment==="KO"){$("#notification_split_payment").show();$("#notification_split_payment_finish").hide();$("#warning_credit_note_split_payment").hide()}else{$("#notification_split_payment").hide();if(waitingAccount.isWaitingAccountSelected()){$("#warning_credit_note_split_payment").toggle(creditNote.isCreditNoteSelected());waitingAccount.disableWaitingAccountButtons();$("#notification_split_payment_finish").hide()}else{$("#notification_split_payment_finish").show();waitingAccount.enableWaitingAccountButtons()}}if(!waitingAccount.isWaitingAccountSelected()){window.scrollTo(0,0)}}$("#final_amount").html(functions.generateAmount(j.dueAmount));orderSummary.changeProceedButtonState()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},f=function(){var h=Number($("#credit_note_amount_value").val()),g=Number($("#credit_note_balance").val()),i=e();if(i!==null){if(i<=g){h=i}else{h=g}$("#credit_note_amount_value").val(h);$("#credit_note_amount_text").html(functions.generateAmount(-h));a(d||$("#useCreditNote").is(":checked"),false);if(h>0){$("#main_content_credit_note").removeClass("hidden")}else{$("#main_content_credit_note").addClass("hidden")}}};return{creditNoteAvailable:null,ccPaymentMethodId:null,updateCreditNoteAmount:function(){if(this.creditNoteAvailable){f()}},isCreditNoteSelected:function(){return $("#useCreditNote").is(":checked")},init:function(g){d=g.compulsoryCreditUse;c=g.useCreditByDefault;if(this.creditNoteAvailable){if(d||c){$(function(){a(true,true)})}if(!d){$("#useCreditNote").on("click",function(){a(this.checked,true)});$("#credit_note_amount_text").addClass("hidden")}}}}});tools.module("crossSellingUtils",function(){insertExpandWidgetDynamically=function(d,c,f,e){var b=false,a=$(d).parents(".cross_selling_grids_panel").find("[id^=cs_product_brief_view_]");a.each(function(){if($(this).offset().top>c){$(f).insertBefore(this);b=true;f.show();return false}});if(!b){$(f).insertAfter(a.last());b=true;f.show()}$("#triangle_tip_"+e).css("top",f.offset().top-c-10);return b};expandQuickShopPanel=function(b,h){$("[id^=cs_product_expand_view_prod_]").each(function(){var m="cs_product_expand_view_prod_",o=$(this).attr("id").substring(m.length),n=$("#cs_product_brief_view_"+o).find(".mobileButton"),k=$("#cs_product_brief_view_"+o).find(".modifyButton"),l=$("#expandQuickShopButton_"+o);$(this).hide();$(this).removeClass("open");if(l.css("visibility")=="hidden"&&!k.is(":visible")&&!n.is(":visible")){l.css("visibility","visible")}});$("[id^=triangle_tip_]").hide();if($(".mobileButton").first().is(":visible")){$(".mobileButton").removeClass("collapse");$(".mobileButton").addClass("expand")}var d=$(b).find("a").attr("id"),g=d.indexOf("_"),a=d.substring(g+1),e=$("#cs_product_expand_view_prod_"+a),f=false,j=$("#cs_product_brief_view_"+a),i=j.offset().top,c;$("#triangle_tip_"+a).show();f=insertExpandWidgetDynamically(b,i,e,a);if(f){c=$("#quick_booking_form_"+a);if(c.length>0){crossSellingUtils.updateQuantitySelectionBox($("#quick_booking_form_"+a))}if(typeof h==="undefined"){$("body,html").animate({scrollTop:j.offset().top-12},800,function(){e.addClass("open")})}else{e.addClass("open")}crossSellingUtils.updatePrices($("#quick_booking_form_"+a));return false}return false};adjustOpenExpandWidget=function(){var d,c,e,a,b="cs_product_expand_view_prod_";$("[id^=cs_product_expand_view_prod_]").each(function(){if($(this).is(":visible")){d=$(this);e=$(this).attr("id").substring(b.length);a=$("#cs_product_brief_view_"+e);c=a.offset().top;d.hide();insertExpandWidgetDynamically(this,c,d,e);return false}})};checkWindowResize=function(a){var b=$("#content").width(),c;if((a>=700&&b<700)||(a<700&&b>=700)){adjustOpenExpandWidget()}c=b;return c};closeCSExpandPanel=function(c,e){var d=$(c).attr("id"),h=d.indexOf("_"),b=d.substring(h+1),f=$("#cs_product_expand_view_prod_"+b),a=$("#cs_product_brief_view_"+b).find(".mobileButton"),i=$("#cs_product_brief_view_"+b).find(".modifyButton"),g=$("#expandQuickShopButton_"+b);if(f.hasClass("open")){f.slideUp(e,function(){$("#triangle_tip_"+b).fadeOut(100);if(typeof(a)!=="undefined"&&a!==null&&a.is(":visible")){a.removeClass("collapse");a.addClass("expand")}f.removeClass("open");if(g.css("visibility")=="hidden"&&!i.is(":visible")&&!a.is(":visible")){g.css("visibility","visible")}})}};addCSGridClickListener=function(){$("[id^=cross_selling_grids_panel_]").on("click",".expandQuickShopButton",function(a){a.preventDefault()});$("[id^=cross_selling_grids_panel_]").on("click",".mobileButton",function(a){a.preventDefault()});$("[id^=cross_selling_grids_panel_]").on("click",".cs_product_brief_view",function(f,c){var b="cs_product_brief_view_",h=$(this).attr("id").substring(b.length),g=$("#cs_product_expand_view_prod_"+h),d=$(this).find(".mobileButton"),a=$(this).find(".expandQuickShopButton");if(formEnabled()===true){if(d.is(":visible")||a.is(":visible")){f.preventDefault();if(!g.is(":visible")){expandQuickShopPanel(d,c);if(typeof(d)!=="undefined"&&d!==null&&d.is(":visible")){d.removeClass("expand");d.addClass("collapse")}}else{closeCSExpandPanel(g.find(".close_expand_panel"),200)}}}})};setCSGridsMaxMinHeight=function(){var c={},b={},e=0,a,d=4;$("[id^=cs_product_brief_view_]").each(function(f){e=Math.floor(f/d);a=$(this).find(".cross_selling_product_image_container .product_image_container");if(f%d===0){c[e]=$(this).outerHeight();b[e]=a.outerHeight(true)}if($(this).outerHeight()>c[e]){c[e]=$(this).outerHeight()}if(a.outerHeight(true)>b[e]){b[e]=a.outerHeight(true)}});$("[id^=cs_product_brief_view_]").each(function(f){e=Math.floor(f/d);$(this).css("min-height",c[e]);$(this).find(".cross_selling_product_image_container").css("min-height",b[e])})};formEnabled=function(){var a=true;$("input, select").each(function(){if($(this).prop("disabled")===true){a=false;return false}});return a};countElements=function(a){var b=0,c;for(c in a){if(a.hasOwnProperty(c)){b++}}return b};checkAndExpand1ClickPanelIfOneRow=function(b){var a=$(b).find(".expandQuickShopButton:not(.modifyButton) a");if(a.length>0){if(a.is(":visible")){$(b).trigger("click",[false]);crossSellingUtils.gridClickTriggered=true;a.css("visibility","hidden")}}};return{gridClickTriggered:false,init:function(){var a={},b=$("#content").width();addCSGridClickListener();$("#errorMsgDialogOKButton").click(function(c){c.preventDefault();tools.dialog.hideDialog("crossSellAjaxErrorDialog")});$("[id^=cross_selling_grids_panel_]").on("click",".close_expand_panel",function(){if(formEnabled()===true){closeCSExpandPanel(this,200)}});$(window).resize(function(){clearTimeout(a);a=setTimeout(function(){b=checkWindowResize(b)},100)});setCSGridsMaxMinHeight();$("[id^=cs_product_expand_view_prod_]").on("change","select",function(c){crossSellingUtils.updatePrices($(this).closest("[id^=quick_booking_form_]"))});$("[id^=cs_product_brief_view_]").on("isInited",function(){var d=4,c=$("[id^=cs_product_brief_view_]").length;if(c<=d){if(crossSellingUtils.gridClickTriggered===false){checkAndExpand1ClickPanelIfOneRow($(this))}}})},updateQuantitySelectionBox:function(a){var i="quick_booking_form_",d="#cs_product_expand_view_prod_",f=$(a),g=f.attr("id").substring(i.length),j=$("#cs_product_brief_view_"+g+" .addedQuantity"),h,c,e=parseInt($(d+g+" #maxAllowedQty")[0].value,10),b=f.parent();if(j.is(":empty")){h=0}else{h=j.html()}c=e-parseInt(h,10);$(a).find(".item").each(function(){var l=$(this),m=l.find(".quantity select")[0],k;if(c<m.options.length){for(k=m.options.length;k>c;k--){m.remove(k)}}});if(c===0){b.remove()}},updatePrices:function(c){var b="quick_booking_form_",d=$(c).attr("id").substring(b.length),a=0;$(c).find(".item").each(function(){var e=$(this).find(".article select"),f,g,i,h=$(this).find(".quantity select").find(":selected").val();if(e.length===0){i=$(this).find(".article input").val()}else{i=$(e).find(":selected").val()}if(countElements(quickBooking.products[d].items[i].audienceSubCategories)===1){f=$(this).find(".tariff input").attr("data-id")}else{f=$(this).find(".tariff select").find(":selected").attr("data-id")}g=quickBooking.products[d].items[i].audienceSubCategories[f].tariffs[0];a+=parseInt(h,10)*g.amount});$(c).find("tr.subtotal td.subtotal .amount").html(functions.generateAmount(a))}}});tools.module("secutix.date.picker.check",function(){var b=false,c=null,a=function(e){var f=new Date(),d=false;f.setHours(0,0,0,0);if($.datepicker&&$.datepicker.parseDate&&datePickerConfig&&datePickerConfig.dateFormat){$(".datepicker_element input").each(function(g){var h=$.datepicker.parseDate(datePickerConfig.dateFormat,$(this).val());if(h.getTime()==f.getTime()){d=true}});if(e){e=$.datepicker.parseDate(datePickerConfig.dateFormat,e);if(e.getTime()==f.getTime()){d=true}}}return d};return{setIsEnable:function(d){b=d},checkToday:function(e,d){c=e;if(b&&a(d)){tools.dialog.showWaitingPopup("confirmationDialog_check_popup",true)}else{this.submit()}},isDatepickerSetToToday:function(f,e){var d=false;c=f;if(b&&a(e)){tools.dialog.showWaitingPopup("confirmationDialog_check_popup",true);d=true}return d},submit:function(){if(c){c()}}}});tools.module("secutix.date.combos",function(){var j=["0","1","3","5","7","8","10","12"],h=["0","1","3","4","5","6","7","8","9","10","11","12"],c=function(k){$("#"+k+" option").each(function(){$(this).removeAttr("disabled")})},g=function(l,k){$("#"+l+" option").each(function(){if($.inArray($(this).val(),k)===-1){$(this).attr("disabled","disabled")}else{$(this).removeAttr("disabled")}})},f=function(k){$("#"+k+" option").each(function(){if(a(parseInt($(this).val(),10))){$(this).removeAttr("disabled")}else{$(this).attr("disabled","disabled")}})},i=function(k,m,l){if(k==="29"&&m==="2"){f(l)}else{c(l)}},a=function(k){if(k%400===0){return true}else{if(k%100===0){return false}else{if(k%4===0){return true}else{return false}}}},e=function(l,q,n,o){var k,p,m;if(o){c(q);c(n)}k=$("#"+l).val();p=$("#"+q).val();m=$("#"+n).val();if(k==="31"){g(q,j)}else{if(k==="30"||(k==="29"&&!a(parseInt(m,10)))){g(q,h)}else{c(q)}}i(k,p,n)},b=function(l,q,n,o){var k,p,m;if(o){c(l);c(n)}k=$("#"+l).val();p=$("#"+q).val();m=$("#"+n).val();if($.inArray(p,j)===-1){$("#"+l+' option[value="31"]').attr("disabled","disabled")}if(p==="2"){$("#"+l+' option[value="30"]').attr("disabled","disabled");if(!a(parseInt(m,10))){$("#"+l+' option[value="29"]').attr("disabled","disabled")}}i(k,p,n)},d=function(l,q,n,o){var k,p,m;if(o){c(l);c(q)}k=$("#"+l).val();p=$("#"+q).val();m=$("#"+n).val();if(k==="31"){g(q,j)}else{if(k==="30"||(k==="29"&&!a(parseInt(m,10)))){g(q,h)}else{c(q)}}if(p==="2"){$("#"+l+' option[value="31"]').attr("disabled","disabled");$("#"+l+' option[value="30"]').attr("disabled","disabled");if(!a(parseInt(m,10))){$("#"+l+' option[value="29"]').attr("disabled","disabled")}}};return{populateCombosDatepicker:function(l,q,p,n){var o,k,m;for(o=1,k=31;o<=k;o++){$("#"+l+" option:last").val(o);$("#"+l+" option:last").html(o);if(o!==31){$("#"+l).append($("#"+l+" option:last").clone())}}for(o=0,k=12;o<k;o++){$("#"+q+" option:last").val(o+1);$("#"+q+" option:last").html(n[o]);if(o!==11){$("#"+q).append($("#"+q+" option:last").clone())}}m=new Date().getFullYear();for(o=m,k=m-100;o>=k;o--){$("#"+p+" option:last").val(o);$("#"+p+" option:last").html(o);if(o!==m-100){$("#"+p).append($("#"+p+" option:last").clone())}}},dynamizeDateCombos:function(k,m,l){$("#"+k).change(function(){e(k,m,l,true)});$("#"+m).change(function(){b(k,m,l,true)});$("#"+l).change(function(){d(k,m,l,true)});e(k,m,l,false);b(k,m,l,false);d(k,m,l,false)},resetDateCombosValues:function(k,m,l){$("#"+k).val(0);$("#"+m).val(0);$("#"+l).val(0);c(k);c(m);c(l)}}});tools.module("distribution.detail",function(){var a=function(C,E){var F=false,G=true,D=validation.numericRule(),H;if(typeof(C)!="object"){H=$("."+C)}else{H=$(C)}H.each(function(){var I;I=[{rule:D},{rule:validation.numericBoundsRule(1,parseInt($(this).attr("data-maxQuantity"),10),false,true,true)}];if($(this).val()&&parseInt($(this).val(),10)>0){F=true;if(!validation.validateField(this.id,I,null,true)){G=false}}});if(E&&!F){G=false;validation.showErrorTooltip($(E),$("#quantity-selection-msg .content").html())}return G},j=null,l={},f={},i={},o={},A={},y={},B={},p=null,k=null,q=null,e=null,m="select_seat_popup_",r="tickets_list_",c=function(D,C){var E=D.find("input.toogle_all_seats");if(C){E.prop("checked",true)}else{E.removeProp("checked")}},n=function(){return $("#distribution_form")},u=function(){var C=n(),D=0,E=function(){var G=(parseInt($(this).val(),10)>0),F=$(this).parent().find("input");if(!G){F.removeAttr("name")}else{F.each(function(){var H=$(this).attr("name");if(H){if(!($(this).val())){$(this).removeAttr("name")}else{$(this).attr("name",H.replace("[]","["+D+"]"))}}});D++}};C.find("input.distribution_quantity").each(E)},s=function(J,F){var E=$(F).closest("[id^="+r+"]"),I=$(E).find(".ticketsList"),H=$(E).attr("id"),K=H.substring(r.length),D=K.split("_"),G=D[0],C=D[1];distribution.detail.showPaginatedSeatSelection(G,C,J,true,I)},w=function(){$(".seat_cat_show_hide").click(function(C){var G=$(this).closest("[id^="+m+"]"),D=$(G).find(".seat_cat_show_hide"),F=$(this).closest(".seatCat_tickets_container").find(".ticketsList"),E=$(this).find("span.text");C.preventDefault();if($(this).hasClass("plus")){$(G).find(".ticketsList").addClass("close");$(D).removeClass("less").addClass("plus");$(D).find("span.text").text(q);$(this).removeClass("plus");$(this).addClass("less");$(E).text(e);$(F).removeClass("close")}else{$(this).removeClass("less");$(this).addClass("plus");$(E).text(q);$(F).addClass("close")}tools.dialog.showDialog($(G).attr("id"),true)})},d=function(F){var E=$("#"+r+F),D=$(E).find("input.toogle_all_seats"),C=$(E).find("input.selected_seat");$(C).change(function(){var I=$(this).val(),H=$(E).find(".seatCat_summary .counter"),G=parseInt($(H).text(),10);o[I]=$(this).prop("checked");if(o[I]){G+=1}else{G-=1}H.html(G);if($(D).is(":checked")){if(!o[I]){$(D).prop("checked",false)}}else{g(D,C)}});$(D).change(function(){var G=$(E).find("input.selected_seat:checked"),I=$(E).find(".seatCat_summary .counter"),H=parseInt($(I).text(),10);if($(this).is(":checked")){$(C).prop("checked",true);H+=C.length-G.length}else{$(C).prop("checked",false);H-=G.length}$(C).each(function(){var J=$(this).val();o[J]=$(this).prop("checked")});I.html(H)})},b=function(C){$("#"+m+C+" .seatCat_tickets_container").each(function(){var F=this,E=$(F).find("input.toogle_all_seats"),D=$(F).find("input.selected_seat");$(D).each(function(){var G=$(this).val();if(o[G]){$(this).prop("checked",true)}else{$(this).prop("checked",false)}});g(E,D)})},t=function(C){$("#"+m+C+" .seatCat_tickets_container").each(function(){var F=this,D=$(this).attr("id").substring(r.length),E=B[D],G=$(F).find(".seatCat_summary .counter");if(typeof E!=="undefined"){G.html(E)}else{G.html("0")}})},g=function(D,C){var E=true;$(C).each(function(){var F=$(this).val();if(!o[F]){E=false;return false}});if(E){$(D).prop("checked",true)}else{$(D).prop("checked",false)}},h=function(C){o=$.extend(true,{},A);b(C);t(C)},x=function(E){var D=$("#"+r+E),C=$(D).find("input.selected_seat");$(C).each(function(){var F=$(this).val();y[F]=$(this).attr("data-opId")})},v=function(){$(".close_expand_panel").click(function(){$(this).closest(".expand_panel").slideUp(function(){$(".distribution_action_buttons_container .triangle_tip").hide()})})},z=function(C,D){$(D).html(Mustache.render(j,C))};return{events:$({}),init:function(C){$(function(){tools.preventFormAutoSubmit("distribution_form");tools.registerAsToggleLink("toogle_button","expanded_box",".toggle_content");tools.registerAsIntegerInput("distribution_quantity");$(".toogle_button").slice(1).click();j=$("#ticketsListTpl").html();if(!C.isDistributionSeatMap){distribution.pagination.setPaginationConfiguration({displayWindow:2,nbPerPage:C.ticketsPageSize});distribution.pagination.onPageChange(s)}p=C.pId;k=C.distributableTicketSupport;q=C.showDetails;e=C.hideDetails;w();v()})},checkPrintingStatus:function(){$.ajax({url:contextPath+"/pro/account/distribution/event/getCompleteStatus",dataType:"json"}).done(function(C){if(C===true){window.location.reload(true)}})},validateQuantity:function(C,D){return a(C,D)},showPaginatedSeatSelection:function(E,F,J,G,I){var C=E,L=E+"_"+F,D=L+"_"+J,H={productId:p,perfId:E,seatCatId:F,ticketSupport:k,page:J},K=function(){return function(N,M){return M(functions.generateAmount(N))}};if(typeof i[D]==="undefined"){distribution.pagination.doPaginate(H,l[L],J);z(H,I);if(G){tools.dialog.showDialog(m+C,true)}$.ajax({type:"POST",url:contextPath+"/ajax/pro/account/distribution/event/detail/tickets",data:H,dataType:"json",success:function(M){if(M.success){M.displayTickets=true;M.generateAmount=K;distribution.pagination.doPaginate(M,l[L],J);z(M,I);d(L);x(L);i[D]=M;if($("#"+m+C).is(":visible")){tools.dialog.showDialog(m+C,true)}}}})}else{z(i[D],I);d(L);b(C);if(G){tools.dialog.showDialog(m+C,true)}}if(typeof f[L]==="undefined"){distribution.pagination.init(I);f[L]=true}},showSeatSelection:function(F){var D={},E=$("#"+m+F),C=true;E.find("input.selected_seat").each(function(){var G=$(this).attr("data-opId"),I=$(this).val(),H=$("#distrib_quantity_"+G),J=H.attr("data-explicitlyInputPath");if(!D[G]){D[G]=[];H.nextAll('input:hidden[name^="'+J+'"]').each(function(){D[G].push($(this).val())})}if($.inArray(I,D[G])>=0){$(this).prop("checked",true)}else{$(this).removeProp("checked");C=false}});c(E,C);tools.dialog.showDialog(m+F,true)},confirmSeatSelection:function(E){var D={},C=m+E;$.each(o,function(H,G){var F=y[H];if(typeof F!=="undefined"){if(!D[F]){D[F]=[]}if(G){D[F].push(H)}}});$.each(D,function(F,G){var H=$("#distrib_quantity_"+F),I=H.attr("data-explicitlyInputPath");H.nextAll('input:hidden[name^="'+I+'"]').remove();if(G.length){H.val(G.length);H.attr("disabled",true);$.each(G,function(J,K){$("<input>").attr({type:"hidden",name:I+"["+J+"]",value:K}).insertAfter(H)})}else{H.val("");H.removeAttr("disabled")}});A=$.extend(true,{},o);$("#"+C+" .seatCat_tickets_container").each(function(){var F=$(this).attr("id").substring(r.length),G=parseInt($(this).find(".seatCat_summary .counter").text(),10);B[F]=G});tools.dialog.hideDialog(C)},toggleAllSeats:function(E,D){var C=$("#"+m+E).find("input.selected_seat");if(D){C.prop("checked",true)}else{C.removeProp("checked")}},updateToggleAllCheckBox:function(F,C){var E=$("#"+m+F),D=!(C||E.find("input.selected_seat").is(":not(:checked)"));c(E,D)},cancelSeatSelection:function(C){tools.dialog.hideDialog(m+C)},distributionFormSubmit:function(){tools.dialog.showWaitingPopup("requestProcessingDialog",true);$("#is_automatic_distribution").val(true);n().submit()},proceedWithNoContactChange:function(){tools.dialog.showWaitingPopup("requestProcessingDialog",true);u();$("#is_automatic_distribution").val(true);$("#selected_contact").val("");$("#selected_first_name").val("");$("#selected_last_name").val("");$("#selected_email").val("");n().submit()},doDistribute:function(C){if(!$("#btn_distribute").parent().hasClass("disabled")){this.events.trigger("onBeforeDistributionFormSubmit");if(!a("distribution_quantity",C)){return}else{if(($("#contact_search_radio_container input:radio:checked").val()=="contact"&&!$("#selected_contact").val())||($("#contact_search_radio_container input:radio:checked").val()=="structure"&&($("#selected_email").val()===""||$("#selected_contact").val()===""))){if($("#buyer_info_number").html()!==null){this.proceedWithNoContactChange()}return}}u();if($("#contact_search_radio_container input:radio:checked").val()=="contact"&&contactOrStructureSelection.validateContact(C)){this.distributionFormSubmit()}else{if($("#contact_search_radio_container input:radio:checked").val()=="structure"){this.distributionFormSubmit()}}}},doImmediatelyPrint:function(C){if(!$("#btn_immediate_print").parent().hasClass("disabled")){this.events.trigger("onBeforeDistributionFormSubmit");if(!a("distribution_quantity",C)){return}u();$(".printing-item-info").removeAttr("disabled");tools.dialog.showWaitingPopup("requestProcessingDialog",true);$("#is_automatic_distribution").attr("disabled","disabled");n().submit()}},openDistributionPanel:function(C){if(!$("#btn_distribute_tickets").parent().hasClass("disabled")){$(".distribution_action_buttons_container .triangle_tip").show();$(".distribution_contact_selection_panel").slideDown();$("body,html").animate({scrollTop:$("#main_content_distribution_product_detail_step2").offset().top-12})}},showContactOrStructureTag:function(){$("#buyer_box_infos").hide();$("#buyer_box_buttons").hide();$(".contact_distribution").removeClass("hidden");$("#btn_distribute").parent().addClass("disabled")},setPerfIdSeatCatIdToTicketsNbMap:function(D,C){l[D]=C},preLoadTicketsPopupContent:function(C,D){$(function(){var E=C+"_"+D,F=$("#"+r+E+" .ticketsList");distribution.detail.showPaginatedSeatSelection(C,D,1,false,F)})},showSelectSeatPopup:function(C,E){var F=C+"_"+E,D=$("#toggle_details_"+F).closest(".seat_cat_show_hide");if($(D).hasClass("plus")){D.trigger("click")}else{tools.dialog.showDialog(m+C,true)}h(C)}}});tools.module("distribution.disableF5",{doDisableF5:function(a){if((a.which||a.keyCode)==116){a.preventDefault()}}});tools.module("distribution.editContact",function(){var a=function(){$("#notification_save_error").hide();$("#notification_validate_mandatory_field_empty").hide();$("#notification_validate_email_invalid").hide();$("#edit_structure_member_form").find(".field, input").removeClass("error")},b=function(c,d){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"POST",url:contextPath+"/pro/ajax/account/distribution/saveContact",data:{firstName:c.firstName,lastName:c.lastName,email:c.email,contactNumber:c.contactNumber,isMemberOfStructure:c.isAddToMember,_token:c.token},success:function(e){tools.dialog.hideDialog("loadingDialog");if(e.errorMessage){$("#notification_save_error").find(".error_message").html(e.errorMessage);$("#notification_save_error").show()}else{if(e.contact){tools.dialog.hideDialog("edit_structure_member_form");if(typeof(d)=="function"){d(e.contact,c)}}else{tools.dialog.showDialog("sessionExpiredDialog",true)}}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})};return{showEditContactForm:function(c,d){a();$("#edit_structure_member_form").find("span").removeClass("error");$("#editFirstName").val(c.firstName);$("#editLastName").val(c.lastName);$("#editEmail").val(c.email);$("#contactNumber").val(c.contactNumber);tools.dialog.showDialog("edit_structure_member_form",true,true)},hideEditContactForm:function(){tools.dialog.hideDialog("edit_structure_member_form")},validateAndSubmit:function(f){var e=false,d,c={rule:validation.rules.mandatory,errorId:"notification_validate_mandatory_field_empty"};a();e=validation.validateFields([{fieldId:"editEmail",rules:[c,{rule:validation.rules.email,errorId:"notification_validate_email_invalid"}]},{fieldId:"editFirstName",rules:[c]},{fieldId:"editLastName",rules:[c]}],true);if(e){d=$("#addToMemberCheckBox");b({firstName:$("#editFirstName").val(),lastName:$("#editLastName").val(),email:$("#editEmail").val(),contactNumber:$("#contactNumber").val(),isAddToMember:d.length===0?true:d.is(":checked"),token:$("#memberData").find("input[name=_token]").val()},f);return true}}}});tools.module("distribution.immediatePrint",function(){var a=function(c,b){var d=true,e;if(typeof(c)!="object"){e=$("."+c).find(".field")}else{e=$(c)}e.each(function(){$field=$(this).find("input, select");$(this).removeClass("error");$field.removeClass("error");if($(this).hasClass("beneficiary_boolean")){if($(this).find('input[type="radio"]:checked').length<1){d=false;$(this).addClass("error")}return true}$field.each(function(){if(!validation.validateField($(this),validation.mandatoryRule(),null,false,b)){d=false}})});if(d){$('.beneficiary_container, div[id^="beneficiary_questionnaire_"]').each(function(){var f={method:function(g){return pesel.isValidPesel(g)},tooltipError:peselErrorMessage};if(pesel.needsPeselValidation($(this).find("select.country").val())&&!validation.validateField($(this).find(".id_number input"),f,null,true,b)){d=false}})}return d};return{validateBeneficiary:function(c,b){a(c,b)},copyBeneficiary:function(c){var b=[".first_name_",".last_name_"];$.each(b,function(f,e){var d=$(e+c);d.each(function(g){var i=$(this).find("input"),h=$(d).first().find("input").val();if($("#chk_copy_beneficiary_"+c).is(":checked")){if(g>0){i.attr("disabled",true).val(h);$(this).removeClass("error")}}else{i.attr("disabled",false)}})})},setBeneficiary:function(){tools.removeSelectWrapper();if(!a("mandatory",true)){return}var b=$("#immediate_print_form");$.ajax({type:"POST",url:contextPath+"/ajax/pro/account/distribution/event/setBeneficiary",cache:false,data:b.serialize(),dataType:"json",success:function(c){$(".tickets_beneficiary").hide();$("#btn_save").hide();$("#beneficiary_save_info").show();tools.dialog.hideDialog("loadingDialog")},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},doPrint:function(d){tools.removeSelectWrapper();if(!a("mandatory",true)){return}var c=$("#immediate_print_form"),b="tickets"+Math.random().toString().replace(".","");window.open("","_"+b);c.attr("action","print/"+b+".pdf");c.attr("target","_"+b);c.submit();$(".tickets_beneficiary").hide();$("#btn_print").hide();$("#download_ticket_info").show()},init:function(c,b){var d=$('div[id^="beneficiary_questionnaire_"]');if(d.length>0){d.find(".beneficiary_address_existing").each(function(f){var e=$(this);e.find(".beneficiary_address_existing_item").hide();e.find("select").val("");e.find("select").on("change",function(){e.find(".beneficiary_address_existing_item").hide();e.find("#beneficiary_existing_address_"+$(this).val()).show()})})}distribution.immediatePrint.initDate(c,b);tools.registerAsToggleLink("toggle_button","",".beneficiary_container .toggle_content");$(c).each(function(){var e=$(this);e.find('input[name$="firstName"], input[name$="lastName"]').focus(function(f){f.preventDefault();if(e.find(".toggle_content").is(":hidden")){e.find(".toggle_button").trigger("click")}})})},initDate:function(c,b){var d=$(c+" span.beneficiary_date");d.each(function(f){var e=$(this).find('select[id*="_day_"]'),h=$(this).find('select[id*="_month_"]'),g=$(this).find('select[id*="_year_"]');if(e.length&&h.length&&g.length){secutix.date.combos.populateCombosDatepicker(e.attr("id"),h.attr("id"),g.attr("id"),b);secutix.date.combos.dynamizeDateCombos(e.attr("id"),h.attr("id"),g.attr("id"))}})},nationalityChanged:function(b){var d=$(b),c=d.parent().parent().parent();if(pesel.needsPeselValidation(d.val())){c.find(".idNumberLabel").hide();c.find(".idNumberLabelPl").show();checkPesel=true}else{c.find(".idNumberLabelPl").hide();c.find(".idNumberLabel").show();checkPesel=false}}}});tools.module("distribution.members",function(){var b,a;a=function(c){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"POST",url:contextPath+"/pro/ajax/account/distribution/removeMember",data:{contactNumber:c.contactNumber},success:function(d){tools.dialog.hideDialog("loadingDialog");if(d.statusCode==="success"){$("#searchCriteria").submit()}else{if(d.statusCode==="error.contact.wrongContactNumber"){tools.dialog.showDialog("error_remove_member_wrong_number",true)}else{tools.dialog.showDialog("ajaxErrorDialog",true)}}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})};return{showEditMemberForm:function(e){var f,d,c;if(typeof e!="undefined"){f=$("#firstName-"+e).val();d=$("#lastName-"+e).val();c=$("#email-"+e).val();contactNumber=$("#contactNumber-"+e).val()}else{f=$("#fNameCriteria").val();d=$("#lNameCriteria").val();c=$("#emailCriteria").val();contactNumber=$("#contactNumber-"+e).val()}distribution.editContact.showEditContactForm({firstName:f,lastName:d,email:c,contactNumber:contactNumber})},search:function(){var c=true;if($("#emailCriteria").val()){c=validation.validateField("emailCriteria",[{rule:$.extend({tooltipError:$("#notification_validate_email_invalid > .content").html()},validation.rules.email)}],null,true)}if(c){$("#searchCriteria").submit()}},showDeleteMemberPopup:function(c){b=c;tools.dialog.showDialog("warning_remove_member",true)},deleteMember:function(){a({contactNumber:$("#contactNumber-"+b).val()})}}});tools.module("distribution.pagination",function(){var c={displayWindow:2,nbPerPage:10},b=$.Callbacks(),a=function(h,f){var g=d(f);if(g!==h){b.fire(h,f)}},d=function(f){var g=$(f).siblings(".page.current");if(g.length===0){return 1}else{return parseInt($(g).text(),10)}},e=function(f){$(f).on("click",".pagination span.page",function(i){var j=$(this),g,h=d(this);if(!j.hasClass("current")){if(j.hasClass("previous")){g=h-1}else{if(j.hasClass("next")){g=h+1}else{g=parseInt(j.text(),10)}}a(g,this)}i.preventDefault()})};return{init:function(f){e(f)},setPaginationConfiguration:function(f){c=f},onPageChange:function(g){b.add(g)},doPaginate:function(l,q,m){var g=[],p=c.displayWindow,k=c.nbPerPage,o=null,n,j,f,h;if(q>k){n=Math.ceil(q/k);if(m<1){m=1}else{if(m>n){m=n}}f=Math.max(1,Math.min(m-p,n-2*p));h=Math.min(n,Math.max(m+p,f+2*p));for(j=f;j<=h;j++){g.push({index:j,selected:j===m})}o={nbPages:n,page:m,pages:g,hasPages:g.length!==0,hasPrevious:m!==1,hasNext:m!==n,remainBefore:f!==1,remainAfter:h!==n};l.pagination=o}}}});tools.module("distribution.productList",function(){var b=function(){$("#btnSubmitSearch").parent().removeClass("hidden");$("#btnClearSearch").parent().addClass("hidden")},a=function(){$("#btnSubmitSearch").parent().addClass("hidden");$("#btnClearSearch").parent().removeClass("hidden")};return{addToggleButtonHandler:function(c){$(c).click(function(d){d.preventDefault();if(this.state===undefined||this.state===0){this.state=1;$(this).removeClass("less");$(this).addClass("plus");$(this).parent().siblings().slideUp()}else{this.state=0;$(this).removeClass("plus");$(this).addClass("less");$(this).parent().siblings().slideDown()}})},submitFilter:function(){$("#filterCriteria").submit();a()},clearFilter:function(){$("#searchProductName").val("");this.submitFilter();b()},chooseProperSearchButton:function(){var c=$("#searchProductName");if(c.val()===""){b()}else{a()}},addSearchBoxHandler:function(){var c=$("#searchProductName");c.blur(function(d){if($(this).val().trim()===""){$("#filterCriteria").submit();b()}})}}});tools.module("distribution.seatmap.lasso",function(){var d=null,n=null,j=false,l=true,m=null,s=true,f=18,p=false,i=null,g=0,b=false,o=function(){var w,t,u,v;t=[new OpenLayers.Rule({filter:new OpenLayers.Filter.Function({evaluate:function(x){return b}}),symbolizer:{externalGraphic:contextPath+"/resources/images/buttons-icons/lassoPointerEnd.svg",graphicWidth:35,graphicHeight:25,graphicOpacity:1}}),new OpenLayers.Rule({filter:new OpenLayers.Filter.Function({evaluate:function(x){return j&&!b}}),symbolizer:{externalGraphic:contextPath+"/resources/images/buttons-icons/lassoPointerMinus.svg",graphicWidth:35,graphicHeight:25,graphicOpacity:1}}),new OpenLayers.Rule({filter:new OpenLayers.Filter.Function({evaluate:function(x){return !j&&!b}}),symbolizer:{graphicName:"circle"}})];u=new OpenLayers.Style({strokeWidth:2,pointRadius:5,fillColor:"#83D5D5",fillOpacity:0.3,strokeColor:"#83D5D5"},{rules:t});n=new OpenLayers.Layer.Vector("lasso",{renderers:OpenLayers.Layer.Vector.prototype.renderers,styleMap:new OpenLayers.StyleMap({temporary:u})});v={callbacks:{point:h}};m={lassoPolygon:new OpenLayers.Control.DrawFeature(n,OpenLayers.Handler.Polygon,v)};SeatMap.map.addLayer(n);w=m.lassoPolygon;SeatMap.map.addControl(w);n.events.on({featureadded:function(D){var y,B,A,z=SeatMap.seatsLayer.features,C=D.feature,x=C.geometry;setTimeout(function(){for(y in z){B=z[y];A=B.data?B.data.id:B.attributes.id;if(x.intersects(B.geometry)){if(!j){if(!distribution.seatmap.seatList.getSeat(A)){SeatMap.selectControl.select(B)}}else{if(distribution.seatmap.seatList.getSeat(A)){SeatMap.selectControl.unselect(B)}}}}distribution.seatmap.seatDetails.hideSeatDetails();n.removeFeatures(C);e()},400)}});a()},h=function(u,t){g++;if(g===1){i=jQuery.extend(true,{},u)}else{if(g===2){p=true}else{if(b){m.lassoPolygon.drawFeature(t)}}}},a=function(){var t=new OpenLayers.Control(),u;u=new OpenLayers.Handler.Keyboard(t,{keydown:function(v){if(v.altKey||v.ctrlKey){if(!SeatMap.freeSeatsCallInProgress){j=v.altKey;c()}}},keyup:function(v){if(!SeatMap.freeSeatsCallInProgress){j=false;e()}}});u.activate();SeatMap.map.addControl(t)},q=function(){r(SeatMap.map.getResolution());SeatMap.map.events.on({zoomend:function(u){var t=this.getResolution();r(t)},mousemove:function(t){k(t)}})},k=function(u){if(m!==null){var y=m.lassoPolygon,x=SeatMap.map.getLonLatFromPixel(u.xy),w=x.lon,v=x.lat,t=new OpenLayers.Geometry.Point(w,v);if(p){if(t.distanceTo(i)<=f){b=true}else{b=false}}else{if(g===0&&(u.altKey||u.ctrlKey)){y.insertXY(w,v);h(t)}}}},r=function(t){if(l){if(t>SeatMap.seatsLayer.maxResolution){e();s=false}else{s=true}}},c=function(){if(m!==null){var t=m.lassoPolygon;if(!t.active&&s){t.activate();SeatMap.selectControl.deactivate()}}},e=function(){if(m!==null){var t=m.lassoPolygon;t.deactivate();p=false;i=null;g=0;b=false;SeatMap.selectControl.activate()}};return{init:function(t){d=t.performanceId;l=t.hasBlocks;SeatMap.events.on("initSeatsLayerDone",o);SeatMap.events.on("mapLoaded",q);util.domHelper.onDomBlur(e)}}});tools.module("distribution.seatmap.seatDetails",function(){var e=null,n=null,t=null,l=null,g={},j=null,s=null,b=null,i=null,u=null,q="distributionSeatMap_lastZoomInfo_",k=true,h=null,A=function(){if(e){tools.storage.setItem(q+e,{zoomLevel:SeatMap.map.getZoom(),center:SeatMap.map.getCenter()})}},a=function(){if(e){return tools.storage.getItem(q+e)}return null},w=function(){var C=a();if(C){SeatMap.map.setCenter(new OpenLayers.LonLat(C.center.lon,C.center.lat),C.zoomLevel)}z(SeatMap.map.getResolution(),true);SeatMap.map.events.on({zoomend:function(E){var D=this.getResolution();z(D,false)}})},z=function(C,D){if(k){$(u).hide();if(C>SeatMap.seatsLayer.maxResolution){$(j).show();$(i).hide()}else{$(j).hide();$(i).show()}}if(D&&!k){$(i).show()}},r=function(){var C=new OpenLayers.Control.SelectFeature(SeatMap.blocksLayer,{hover:true,highlightOnly:true,eventListeners:{featurehighlighted:f,featureunhighlighted:d}});SeatMap.map.addControl(C);C.activate();SeatMap.blocksLayer.events.on({beforefeatureadded:function(E){var D=SeatMap.additionalBlockInfo[E.feature.data.id];if(D){E.feature.attributes.fillColor="url(#"+D.gradientIdentifier+")";return true}return false},featureselected:function(D){SeatMap.selectControl.unselect(D.feature)}})},v=function(){var C=new OpenLayers.Control.SelectFeature(SeatMap.seatsLayer,{hover:true,highlightOnly:true,eventListeners:{featurehighlighted:p,featureunhighlighted:x}});SeatMap.map.addControl(C);C.activate();SeatMap.seatsLayer.events.on({beforefeatureadded:function(D){var H=D.feature.data.id,F=e+"_"+H,E=D.feature.data.distributionTicketResult.audienceCatComplimentary,G=D.feature.data.distributionTicketResult.distributed;D.feature.attributes.isComplimentary=E;D.feature.attributes.isDistributed=G;if(!g[F]){g[F]=D.feature.data}if(distribution.seatmap.seatList.getSeat(H)){SeatMap.selectControl.select(D.feature);distribution.seatmap.seatDetails.hideSeatDetails()}return true},featureselected:function(E){var H=E.feature.data.id,F=e+"_"+H,D={data:g[F]},G=E.feature.data.distributionTicketResult.distributed;if(!G){distribution.seatmap.seatList.addSeat(D);SeatSessionStorage.storeSelectedSeat(e,D,true)}},featureunselected:function(F){var J=F.feature.data.id,H=e+"_"+J,D={data:g[H]},G=F.feature.attributes.currentPage,E=G?G:1,I=F.feature.data.distributionTicketResult.distributed;if(!I){SeatSessionStorage.removeStoredSeat(e,D);distribution.seatmap.seatList.deleteSeat(D,E)}}})},x=function(C){n=null;t=setTimeout(function(){distribution.seatmap.seatDetails.hideSeatDetails()},10)},p=function(D){var C=null,F=D.feature.data.id,E=e+"_"+F;n=F;window.clearTimeout(t);C=g[E];if(C){distribution.seatmap.seatDetails.displaySeatDetails(D,C)}},f=function(C){var E=C.feature.data.id,D=SeatMap.additionalBlockInfo[E];window.clearTimeout(l);if(D){y(D)}},d=function(C){l=setTimeout(function(){$(b).hide();$(s).show()},10)},B=function(C,D){$(D).html(Mustache.render(h,C))},y=function(I){var G={},C=[],E=I.seatCatAvailabilityById,D,F=0,H=0;for(seatCatId in E){D=E[seatCatId];F+=D.nbOfDistributableTickets;H+=D.nbOfTotalTickets;if(!D.hashSign){D.hashSign="#";D.isSingular=D.nbOfTotalTickets===1}C.push(D)}G.seatCategory=C;G.availability=F;G.totalNumber=H;G.isSingular=H===1;G.blockName=I.blockName;G.showTotal=C.length>1?true:false;B(G,b);$(b).show();$(s).hide()},o=function(G){var J=G.distributionTicketResult,E=J.audienceSubCategory,H=J.audienceCatComplimentary,I=J.distributed,D=J.displayTicketHolder,C=J.distributionContactInfo,F=null;$("#seat-info-category .color").css("background-color","#"+G.color);$("#seat-info-category .name").html(G.seatCategory);$("#seat-info-areaname").html(G.area);if(G.blockName&&G.blockName!==null){$("#seat-info-blockname").html(" - "+distribution.seatmap.seatDetails._LABEL_SEAT_BLOCK+" "+G.blockName)}else{$("#seat-info-blockname").html("")}if(G.row&&G.row!==null){$("#seat-info-rowname").html(distribution.seatmap.seatDetails._LABEL_SEAT_RANK+" "+G.row)}else{$("#seat-info-rowname").html("")}if(G.number&&G.number!==null){if(G.row&&G.row!==null){$("#seat-info-text").html(distribution.seatmap.seatDetails._LABEL_SEAT_NUMBER);$("#seat-info-text").addClass("with_row")}else{$("#seat-info-text").html(distribution.seatmap.seatDetails._LABEL_SEAT_NUMBER);$("#seat-info-text").removeClass("with_row")}$("#seat-info-seat").html(G.number);$("#seat-info-seat-container").show()}else{$("#seat-info-seat-container").hide()}if(J){if(H){$("#seat-info-is-complimentary").html(E)}else{$("#seat-info-is-complimentary").html("")}if(I){if(D){F=distribution.seatmap.seatDetails._LABEL_GUEST}else{F=distribution.seatmap.seatDetails._LABEL_DISTRIBUTED_TO}$("#distributed-to-label-container").html(F);$("#distributed-to-contact-info-container").html(C)}else{$("#distributed-to-label-container").html("");$("#distributed-to-contact-info-container").html("")}}},m=function(E,C){var D=C.data,F=D.distributionTicketResult.distributionTicket;E.seatId=D.id;E.color=E.color?E.color:D.color;E.row=D.row;E.number=D.number;E.seatCentroid=C.geometry.getCentroid();E.block=F.block;E.blockName=F.blockName;E.area=F.area},c=function(){if($("body").hasClass("ie_lte_8")||$("body").hasClass("ie_lte_9")){tools.log("GTM does not work well with VML. Please be aware that 'Click Listener' and 'Form Submit Listener' in GTM should not be enabled on this page for IE8/9. \nOtherwise it will cause an 'Attribute only valid on v:image' error.")}};return{init:function(C){e=C.performanceId;k=C.hasBlocks;s=$("#seat-details .seat_info_instruction.block");j=$("#seat-details .block_instructions_details_container");b=$("#seat-details .seat_info_block_details");i=$("#seat-details .seat-info-placeholder");u=$("#seat-details .seat-info-content");h=$("#blockAvailabilityInfoTpl").html();SeatMap.events.on("initSeatsLayerDone",v);SeatMap.events.on("initBlocksLayerDone",r);SeatMap.events.on("mapLoaded",w);if(distribution.detail){distribution.detail.events.on("onBeforeDistributionFormSubmit",A)}c()},displaySeatDetails:function(D,C){if(!C.seatId){m(C,D.feature)}o(C);$(u).show();$(i).hide()},hideSeatDetails:function(){$(u).hide();if(!$(j).is(":visible")){$(i).show()}}}});tools.module("distribution.seatmap.seatList",function(){var k={},g={},j={},d=null,r=null,e=null,c=null,b=null,h=20,p="ticketsList_",f="toggle_details_",n=function(w){return w.data.id},a=function(w){$(r).html(Mustache.render(e,w,b));distribution.seatmap.seatList.setSeatCatColor(r,".seatCat_summary")},m=function(w,y){var x,A={},B,z=function(){return function(D,C){return C(functions.generateAmount(D))}};x=w.seatCategoryId;B=w.distributionTicketResult;if(y){if(g[x]){g[x].totalDistributableTickets.unshift(B)}else{A.performanceId=d;A.seatCategoryId=x;A.seatCategory=w.seatCategory;A.audienceSubCategory=B.audienceSubCategory;A.displayTickets=true;A.generateAmount=z;A.totalDistributableTickets=[B];A.isSeatMap=true;g[x]=A}}},l=function(B,D,F){var G,E=[],z,w,A,y,x=(D-1)*h,C=x+h;for(G in g){E.push(g[G])}B.hasSelection=E.length>0;B.selectedSeatCat=E;for(G in B.selectedSeatCat){z=B.selectedSeatCat[G];w=z.seatCategoryId;z.counter=z.totalDistributableTickets.length;z.isSingleSelection=z.counter===1;if(w===F){y=z.totalDistributableTickets.length;if(x<0){x=0}if(C>y){C=y}if(x>=y){x=x-h;C=x+h}z.distributableTickets=z.totalDistributableTickets.slice(x,C);distribution.pagination.doPaginate(z,z.counter,D);z.closeClass=null}else{A=$("#"+f+w).closest(".seat_cat_show_hide");if(A.hasClass("plus")){z.closeClass="close"}else{z.closeClass=null}}}},i=function(z,w,y,A){var x={},B=w.seatCategoryId;if(typeof k[z]==="undefined"){m(w,y);l(x,A,B);a(x);distribution.seatmap.selectionSummary.updateSummary(g)}},o=function(B,y){var z=$(y).closest("[id^="+p+"]"),w=$(z).attr("id"),C=w.substring(p.length),A=parseInt(C,10),x={};l(x,B,A);a(x)},v=function(){var w={};$.each(k,function(z,x){var A=x.distributionTicketResult,y=A.operationKey,B=A.distributionTicket.ticketId;if(typeof y!=="undefined"){if(!w[y]){w[y]=[]}w[y].push(B)}});$.each(w,function(x,y){var B=$("#hidden-fields-container"),z=$("#distrib_quantity_"+x),A="quantities[].explicitlySelectedTickets";if(z.length===0){z=$("<input>").attr({type:"hidden",id:"distrib_quantity_"+x,name:"quantities[].quantity"});z.addClass("distribution_quantity");z.appendTo(B);z.wrap("<div class='distrib_seat_map_hidden_inputs'></div>");$("<input>").attr({type:"hidden",name:"quantities[].targetItems[0].performanceId",value:d}).insertAfter(z);$("<input>").attr({type:"hidden",name:"quantities[].targetItems[0].requestItemKey",value:x}).insertAfter(z)}z.nextAll('input:hidden[name^="'+A+'"]').remove();if(y.length){z.val(y.length);$.each(y,function(C,D){$("<input>").attr({type:"hidden",name:A+"["+C+"]",value:D}).insertAfter(z)})}else{z.val("")}})},s=function(z,y){var w,x;for(w in y){x=y[w];if(x.distributionTicket.ticketId===z.distributionTicket.ticketId){return w}}return -1},u=function(){$(r).on("click",".seat_cat_show_hide",function(x){var w=$(this).find("[id^="+f+"]"),A=$(w).attr("id").substring(f.length),z=$(r).find("#"+p+A),y=$(this).find("span.text");x.preventDefault();if($(this).hasClass("plus")){$(this).removeClass("plus");$(this).addClass("less");$(y).text(hideDetailsLabel);$(z).slideDown().removeClass("close")}else{$(this).removeClass("less");$(this).addClass("plus");$(y).text(showDetailsLabel);$(z).slideUp()}})},t=function(){$(r).on("click",".remove_row_button",function(x){var H=false,y=$(this).attr("id"),C="remove_row_",F=parseInt(y.substring(C.length),10),z=distribution.seatmap.seatList.getSeatFeature(F),E={data:k[F]},G=$(this).closest("tr"),A=$(G).find("td"),w,B,D;if(k[F]){w=k[F].seatCategoryId;B=$(r).find("#"+p+w+" .page.current");if(B.length===0){D=1}else{D=parseInt($(B).text(),10)}}$(A).wrapInner('<div style="display: block;" />');$(G).find("td > div").fadeOut("slow",function(){if(!H){if(z){z.attributes.currentPage=D;SeatMap.selectControl.unselect(z);z.attributes.currentPage=null}else{SeatSessionStorage.removeStoredSeat(d,E);distribution.seatmap.seatList.deleteSeat(E,D)}distribution.seatmap.seatDetails.hideSeatDetails();H=true}})})},q=function(){SeatMap.seatsLayer.events.on({beforefeatureadded:function(A){var w=A.feature.data,z=w.seatCategoryId,x=w.color,y=j[z];if(!y){if(x){j[z]=x}}}})};return{init:function(w){d=w.performanceId;e=$("#selectedTicketsListTpl").html();c=$("#ticketsListTpl").html();b={ticketsListTpl:c};r=$("#seat-list-container");showDetailsLabel=w.showDetails;hideDetailsLabel=w.hideDetails;distribution.pagination.setPaginationConfiguration({displayWindow:4,nbPerPage:h});distribution.pagination.onPageChange(o);distribution.pagination.init(r);if(distribution.detail){distribution.detail.events.on("onBeforeDistributionFormSubmit",v)}u();t();SeatMap.events.on("initSeatsLayerDone",q)},setSeatCatColor:function(w,x){w.find(x).each(function(){var z=parseInt($(this).attr("data-seatcatid"),10),y=j[z];if(y){$(this).find(".color").css("background-color","#"+y)}else{$(this).find(".color").hide()}})},getSeat:function(w){return k[w]},getSelectedSeats:function(){return k},getSeatFeature:function(x){var w,y,z=SeatMap.seatsLayer.features;for(w in z){y=z[w];if(x===y.data.id){return y}}return null},addSeat:function(w){var x=n(w);i(x,w.data,true,1);if(typeof k[x]==="undefined"){k[x]=w.data}},deleteSeat:function(x,z){var C,B,y,A,w;if(x){C=n(x);B=x.data;y=B.seatCategoryId;A=g[y].totalDistributableTickets;if(k[C]){delete k[C]}w=s(B.distributionTicketResult,A);if(w>-1){A.splice(w,1);g[y].pagination=null;if(A.length===0){delete g[y]}}i(C,B,false,z)}}}});tools.module("distribution.seatmap.selectionSummary",function(){var b=null,d=null,a=null,c=null;return{init:function(e){a=e.performanceId;b=$("#selection-summary-container");d=$("#selectionSummaryTpl").html();c=e.seatCatSummaryMap;b.on("click",".seat-info-sub-title",function(g){var f=$(this).find(".collapse"),h=$(this).find(".expand");b.find(".summary-content").toggle("blind",{direction:"up"});if(f.hasClass("hidden")){f.removeClass("hidden");h.addClass("hidden")}else{f.addClass("hidden");h.removeClass("hidden")}});b.on("click","#remove_all_selection",function(j){var g=distribution.seatmap.seatList.getSelectedSeats(),h,i,f;for(id in g){h=parseInt(id,10);i=distribution.seatmap.seatList.getSeatFeature(h);f={data:g[id]};if(i){SeatMap.selectControl.unselect(i)}else{distribution.seatmap.seatList.deleteSeat(f,1)}}SeatSessionStorage.clearPerformance(a);distribution.seatmap.seatDetails.hideSeatDetails()})},updateSummary:function(j){var o={},f=[],i={},m,p=!jQuery.isEmptyObject(j),r=0,g,h,l,k,e,s,n,q;if(p){for(key in c){s=0;n=c[key];m=j[key];k={};for(distributableAudSubCatId in n){q=n[distributableAudSubCatId];e=q.audienceSubCategoryId;l={audSubCatId:e,audSubCat:q.audienceSubCategory,isComplimentary:q.audienceCatComplimentary,countByAudSubCat:0};k[e]=l;g=q.seatCategory}if(m){$.each(m.totalDistributableTickets,function(t,u){k[u.audienceSubCategoryId].countByAudSubCat+=1});s=m.counter}for(tempAudSubCatId in k){if(k[tempAudSubCatId].countByAudSubCat===0){k[tempAudSubCatId].hideAudSubCat=true}else{k[tempAudSubCatId].hideAudSubCat=false}}h=$.map(k,function(t){return t});i={seatCategoryId:key,seatCategory:g,countBySeatCat:s,hideSeatCat:s===0?true:false,audSubCats:h};f.push(i);r+=s}}o={hasSelection:p,seatCats:f,totalSeatCount:r};b.html(Mustache.render(d,o));distribution.seatmap.seatList.setSeatCatColor(b,".seat-cat")}}});tools.module("distribution.ticketDistribution",function(){var b=function(){var c=document.querySelectorAll('.dashboard input[name="ck_performanceId"]:checked'),e=[],d;for(d=0;d<c.length;d++){e.push(c[d].value)}return e.join(",")},a=function(c){$("#exportTicketButton").toggleClass("disabled",!c)};return{addHoverButtonHandler:function(c){$("#exportTicketButton").hover(function(){$(this).tipsy({className:"tipsy-hover",delayIn:0,gravity:"sw",title:function(){if(!$(this).hasClass("disabled")){return""}return c.message.selectExportTicketConditions}})})},checkAll:function(e){var f=document.getElementsByName("ck_performanceId"),c=false,d;for(d=0,n=f.length;d<n;d++){f[d].checked=e.checked}if(e.checked){c=true}a(c)},checkPerformance:function(){var e=document.getElementsByName("ck_performanceId"),c=false,d;$("#ck_all_performances").prop("checked",false);for(d=0,n=e.length;d<n;d++){if(e[d].checked){c=true;break}}a(c)},exportTicketDetail:function(f,g,d,e){if(!$("#exportTicket").parent().hasClass("disabled")){var h=b(),c=f+"/report/generate/ExportTicketDistributionDetail?productId="+g+"&performanceId="+h+"&ticketSupport="+d+"&exportType="+e;window.open(c)}}}});tools.module("fastline",function(){var b={labels:null},g="XXXX-XXXX-XXXX-XXXX",c=5000,f={minLength:19,maxLength:19,regExp:/^([0-Za-z]{4}-?){3}[0-Za-z]{4}$/},h=function(i){return validation.validateField(i,[{rule:f}],null,false)},d=function(){var i=$(".code_line","#codes_list");$(i).each(function(j,k){var l=$(".delete_code",k);if(j===i.length-1){if($('input[class="input_text"]',$(l).closest(".code_line")).val()!==""){$(l).show()}else{$(l).hide()}}else{$(l).show()}})},e=function(){var k=$("#verify_codes"),l=$("#add_new_code"),j=false,i;$(".input_text","#codes_list").each(function(n,m){if(f.regExp.test(m.value)){j=true;return false}});if(j){k.parent().removeClass("disabled")}else{k.parent().addClass("disabled")}i=$(".input_text","#codes_list").filter(function(m,n){return !f.regExp.test(n.value)}).first();if(i.length>0){l.parent().hide()}else{l.parent().show()}},a=function(j,i){j.tipsy({className:"tipsy-validation",delayIn:1000,html:true,offset:0,trigger:"manual",gravity:"se",opacity:1,title:function(){return i}}).tipsy("show");setTimeout(function(){j.tipsy("hide")},c)};return{deleteCode:function(i){$(i).closest(".code_line").remove();if($(".input_text","#codes_list").length===0){this.addCodeLine()}e()},addCodeLine:function(){var k=$("#base_code_line").clone(),j=$(".input_text","#codes_list"),i;if(j.length>0){i=$(".input_text","#codes_list").filter(function(l,m){return m.value===""}).first();if(i.length>0){i.focus();return}}k.removeClass("hidden").removeAttr("id");$(".input_text",k).mask(g).on("keyup",function(){e()}).on("change",function(){e()});$("#codes_list").append(k);d();e();$(".input_text",k).focus()},init:function(i){b.labels=i;$.mask.definitions.X="[A-Za-z0-9]";if($(".input_text","#codes_list").length===0){this.addCodeLine()}else{d();$(".input_text","#codes_list").each(function(k,j){$(j).mask(g).on("keyup",function(){e()}).on("change",function(){e()})})}e()},verifyCodes:function(){var k=0,i=false,j;$("#hidden_codes_list").empty();if($("#verify_codes").parent().hasClass("disabled")){return false}$(".input_text","#codes_list").each(function(m,l){j=h($(l));if(j){if($('input[value="'+l.value+'"]',"#hidden_codes_list").length>0){a($(l),b.labels.duplicatedCode);$(l).focus();i=true}else{var n=$('<input type="hidden"></input>').attr("name","codes["+k+"]").val(l.value);$("#hidden_codes_list").append(n);k++}}else{$(l).removeClass("error")}});if(k>0&&!i){$("#codes_form").submit()}else{if(k<=0){a($("#verify_codes"),b.labels.missingCode)}}}}});tools.module("hospitality.session.overlay",function(){var b=null,c='<div class="bundle-session-preview">{{#session}}<div><strong>{{name}} :</strong></div>{{#hostTeam}}{{#visitTeam}}<div>{{hostTeam}} vs {{visitTeam}}</div>{{/visitTeam}}{{/hostTeam}}<div>{{site}}</div><div>{{date}}</div><div>{{availabilityLabel}}{{/session}}: {{availability}}</div></div>',d='<div class="bundle-session-preview">{{#session}}<div><strong>{{name}} :</strong></div>{{#hostTeam}}{{#visitTeam}}<div>{{hostTeam}} vs {{visitTeam}}</div>{{/visitTeam}}{{/hostTeam}}<div>{{site}}</div><div>{{date}}</div>{{/session}}</div>',e=function(f){f.stopPropagation();$(this).tipsy({html:true,trigger:"manual",gravity:$.fn.tipsy.autoNS,className:"bundle-session-tooltip",opacity:1,title:function(){var j=$(this),k=j.data("session-id"),h=j.data("session-availability"),i=b[k],g={availability:h,session:b[k]};if(i){if(h){return Mustache.render(c,g)}else{return Mustache.render(d,g)}}else{return j.attr("original-title")||""}}});$(this).tipsy("show")},a=function(){$(this).tipsy("hide")};return{init:function(f,g){$(f).on("mouseover",g,e);$(f).on("mouseout",g,a);$(f).on("click",g,e);$(document).on("click",function(h){$(".tipsy.bundle-session-tooltip").remove()})},addConf:function(f){if(b===null){b=f}else{$.extend(b,f)}}}});tools.module("hospitality.lounge",{filterItemsAreas:function(c){var f=c.value,b,d,a,e;$(".item_area option:not(.soldout)").attr("disabled",false);$(".item_area option").each(function(){e=false;b=$(this).attr("class").split(" ");for(d=0;d<b.length;d++){if(b[d].indexOf("availability_")!=-1){a=parseInt(b[d].substring(13),10);if(a<f){e=true}}}if(e){$(this).attr("disabled",true);if($(this).is(":selected")){$(this).parent().each(function(){$("option:not([disabled]):first",this).attr("selected","selected")})}}})},resetAllQuantities:function(){$(".table_container").each(function(){$(this).find("tr").each(function(){var a;a=$('td.quantity select, td.quantity input[type="text"], td input[type="hidden"].quantity',this);if(a.length>0){$(a).val("0");$(a).tipsy("hide")}})});functions.updatePrices(0);$(".item_area option:not(.soldout)").attr("disabled",false)},checkQuantities:function(){$(".table_container").each(function(){$(this).find("tr").each(function(){var a;a=$('td.quantity select, td.quantity input[type="text"]',this);if(a.length>0&&a.is(":visible")===true){functions.validateQuantityInputFieldAndHideTooltipIfOk(a)}})})},handleAudSubCatChange:function(a){hospitality.lounge.resetAllQuantities();$(".cat_quantity:not(.audsubcat_"+a+")").hide();$(".cat_quantity.audsubcat_"+a).show();$("#audSubCatId").val(a)},handleStandartInit:function(){$('#main_content_hospitality_quantity input[name*="quantity"]').bind("input",function(a){hospitality.lounge.checkQuantities();functions.updatePrices(0);hospitality.lounge.filterItemsAreas($('#main_content_hospitality_quantity input[name*="quantity"]').val())});$('#main_content_hospitality_quantity input[name*="quantity"]').bind("keypress",function(a){if(a.keyCode==13){a.preventDefault();functions.validateQuantities(true,null,$("#bookLounges"))}});$("#bookLounges #book").on("click",function(a){a.preventDefault();functions.validateQuantities(true,null,$("#bookLounges"))})},selectionInit:function(){$("input[type=radio][name=audSubCat]").change(function(){hospitality.lounge.handleAudSubCatChange(this.value);$("tr.item:not(.audsubcat_"+this.value+")").hide();$("tr.item.audsubcat_"+this.value).show()});hospitality.lounge.handleStandartInit()},selectionSimpleProductInit:function(a){if(!a){$("input[type=radio][name=audSubCat]").change(function(){hospitality.lounge.handleAudSubCatChange(this.value)});hospitality.lounge.handleStandartInit()}}});tools.module("hospitality.skybox",{resetAllQuantities:function(){$(".table_container").each(function(){$(this).find("tr").each(function(){var a;a=$('td.quantity select, td.quantity input[type="text"], td input[type="hidden"].quantity',this);if(a.length>0){$(a).val("0");$(a).tipsy("hide")}})});functions.updatePrices(0);hospitality.skybox.updateSeatsTotal()},updateSeatsTotal:function(){$(".table_container").each(function(){var a=0;$(this).find("tr").each(function(){var g,f,e,d,c,b=true;g=$('td.quantity select, td.quantity input[type="text"], td input[type="hidden"].quantity',this);if(g.length>0){b=functions.validateQuantityInputField(g)}c=$('input[type="hidden"].areaSeatQuantity',this);if(g.length>0&&b&&c.length>0){f=parseInt($(g).val(),10);e=parseInt($(c).val(),10);d=f*e;a+=d}});if(a===0){$(this).find("tr.subtotal td.reservation_amount .custom").hide()}else{$(this).find("tr.subtotal td.reservation_amount .custom").show()}$(this).find("tr.subtotal td.reservation_amount .custom_reservation_value").html(a)})},selectionInit:function(a){if(!a){$("input[type=radio][name=audSubCat]").change(function(){hospitality.skybox.resetAllQuantities();$(".area:not(.audsubcat_"+this.value+")").hide();$(".area.audsubcat_"+this.value).show();$("#audSubCatId").val(this.value)});$("#bookSkyboxes #book").on("click",function(b){b.preventDefault();functions.validateQuantities(true,null,$("#bookSkyboxes"))});$("#bookSkyboxes").on("keypress",function(b){if(b.keyCode==13){b.preventDefault();functions.validateQuantities(true,null,$("#bookSkyboxes"))}})}}});tools.module("insurance",{dif:null,adjustPrice:function(c){var a=parseInt($(".int_part",c).text().replace(/\D/g,""),10),d=parseInt($(".mantissa",c).text().replace(/\D/g,""),10),b=a*1000+d*10;c.html(functions.generateAmount(b+this.dif))},init:function(b,a){var c=[];$(".insurance input").on("change",function(){var o=$(this),j=o.data("amount"),k=o.data("operationid"),p=$(this).parents("table"),m=$(".charges_insurance",p),d=$(".reservation_amount",p),h=d.data("amount"),f=0,e=c.length,g,n;m.toggleClass("cancelled");if(o.is(":checked")){n=j;g=functions.generateAmount(h);for(;f<e;f++){if(c[f]===k){c.splice(f,1);break}}}else{n=-j;g=functions.generateAmount(h-j);c.push(k)}$("span.amount",d).html(g);insurance.dif=n;$(".total span.amount").each(function(){insurance.adjustPrice($(this))});if(b){$("#cancelInsuranceOperations").val(c.join("_"))}});if(!b){$(window).on("beforeunload",function(){if(c.length){$.ajax({url:contextPath+"/ajax/cart/cancelInsurances",async:false,type:"POST",data:{operationIds:c.join("_")}});c=null}})}if(a){$(".insurance input").click()}}});var CreditCardProvider={_formalize:function(b){var c,a;a="";for(c=0;c<b.length;c++){if(b.charAt(c).match(/[0-9]/)){a=a.concat(b.charAt(c))}}return a},identify:function(a){a=this._formalize(a);if(a.match(/^4(.{12}|.{15})$/)){return"VISA"}if(a.match(/^5[1-5].{14}$/)){return"MASTERCARD"}if(a.match(/^3[47].{13}$/)){return"AMEX"}if(a.match(/^3(0[0-5].{11}|[68].{12})$/)){return"DINERS"}if(a.match(/^(3.{15}|(2131|1800).{11})$/)){return"JCB"}if(a.match(/^600451.{11}$/)){return"JELMOLI"}},ccmaxlength:function(a){if(a==="VISA"){return 16}if(a==="MASTERCARD"){return 16}if(a==="CB"){return 16}if(a==="AMEX"){return 15}if(a==="DINERS"){return 16}if(a==="JCB"){return 16}if(a==="JELMOLI"){return 16}},validate:function(b){var d,a,c;b=this._formalize(b);d="";for(a=0;a<b.length;++a){d+=(a%2)?b.charAt(b.length-1-a)*2:b.charAt(b.length-1-a)}c=0;for(a=0;a<d.length;++a){c+=parseInt(d.charAt(a),10)}return(c%10)?false:true}};tools.module("legacyPayment",function(){var o=-1,h="AMEX",m="JCB",e="CB",c="DINERS",d="VISA",j="MASTERCARD",k="JELMOLI",p=null,f=null,g=null,b=function(q){switch(q){case h:case m:case c:case k:return false;case d:case j:case e:return true;default:return false}},n=function(q){if(b(q)){$("#card_cvv_field label span.mandatory").html("*")}else{$("#card_cvv_field label span.mandatory").html("")}},a=function(q){if(q==m){$("#card_cvv_field label").html(f)}else{$("#card_cvv_field label").html(p)}$("#card_cvv_field label").append(" <span class='tooltip_icon'><span class='icon' /></span>");$("#card_cvv_field label .tooltip_icon .icon").tipsy({gravity:"sw",className:"tipsy-information tipsy-hover",title:function(){return g}})},l=function(q){var r=CreditCardProvider.ccmaxlength(q);$("#card_number").attr("maxLength",r);$("#card_cvv").attr("maxLength",4)},i=function(){var y,r,q=$("input:radio[name=card_type]:checked").val(),x=$("#card_expiration_date_month").val(),v=$("#card_expiration_date_year").val(),u=$("#card_cvv").val(),t=b(q),w=new Date(),s=false;$(".message.error.hidden").hide();$(".field.error, .field.error input").removeClass("error");y=validation.validateFields([{fieldId:"card_number",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"},{rule:{method:function(z){if(CreditCardProvider.validate(z)){return true}s=true;return false}},errorId:"error_invalid_card"},{rule:{method:function(z){if(CreditCardProvider.identify(z)==q){return true}s=true;return false}},errorId:"error_mismatched_card"}]},{fieldId:"card_holder",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"}]},{fieldId:"card_cvv",rules:[{rule:{method:function(z){return z!==""||!t}},errorId:"error_mandatory"},{rule:{method:function(z){if(!isNaN(z)){switch(q){case h:return u.length==4||!t;case d:case j:case e:return u.length==3||!t;default:return u.length<=4}}return false}},errorId:"error_invalid_cvv"}]},{fieldId:"card_expiration_date_month",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"},{rule:{method:function(){return parseInt(v,10)>w.getFullYear()||(parseInt(v,10)===w.getFullYear()&&parseInt(x,10)>=w.getMonth()+1)}},errorId:"error_invalid_expiration"}]},{fieldId:"card_expiration_date_year",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"}]}],true);r=false;if(!y&&s){o--;if(o==-1){r=true}}if(!y){if(r){window.location.replace($("#cancelPayment").attr("href"))}}else{$("#main_content_payment").find(".alternative_button").addClass("disabled").find("a").on("click",function(){return false});$("#payment_form").submit()}};return{init:function(q){o=q.nbrAllowFailed;p=q.cvvLabel;f=q.nipLabel;g=q.cvvToolTipText;$("#payNow").on("click",function(r){i();r.preventDefault()});$(".card_type input").on("click",function(){var r=$(this).val();a(r);l(r);n(r)});a(q.firstPaymentMethod);l(q.firstPaymentMethod);n(q.firstPaymentMethod)}}});tools.module("listOtherProductsFilter",function(){var p={},b="button_product_type_",t=null,v="button_filter_on",r="button_filter_off",h="data-product-type",m="",n="TYPE",f="",g=null,c=null,d=7,i=[],o=function(){var w=0;$.each(p,function(x,y){if(y){w++}});return w},k=function(x,w){return $.trim(x).toUpperCase().localeCompare($.trim(w).toUpperCase())},u=function(x,w){return k($(x).find(".title").text(),$(w).find(".title").text())},a=function(x,w){return k($(x).find(".title").text(),$(w).find(".title").text())*-1},l=function(x,w){var z=jQuery.inArray($(x).attr("id"),i),y=jQuery.inArray($(w).attr("id"),i);if(!z||!y){return}if(z<y){return -1}else{return 1}},s=function(){$(".product_type_container").each(function(){var w=$(this);if(!w.hasClass("group_closed")&&w.find(".product:visible").length===0){w.hide()}})},j=function(){t.find(".product").show();if(m===n){$(".product_type_container").show()}g.hide();$(".product_type_container").each(function(){tools.toggleGroup($(this),false,true)})},q=function(){var w=0;w=t.find(".product_type_container:visible .product").length;w+=$("#merged_products_container .product:visible").length;$("#product_counter").text(f.replace("{0}",w))},e=function(){var y=$(".filters_activation .selected_product_types"),x="",w=0;$.each(p,function(z,A){if(A){if(w<d){if(w!==0){x+=", "}x+=c[z];w++}else{x+=", ...";return false}}});if(w===0){x=c["-all-"]}y.html(x)};return{init:function(w,y,z){var x=[];p=w;t=$("#main_content_list_products_OTHER_PRODUCTS");g=$(".filters .alternative_button.filter_reset, .filters .button_container .cancel");$.each(p,function(A,B){if(B){x.push(A);p[A]=false}});t.find(".product").each(function(){i.push($(this).attr("id"))});$("#filter_type_desktop").on("change",function(){listOtherProductsFilter.orderProductsBy(this.value)});$(".button_filter").on("click",function(){listOtherProductsFilter.filterProductType($(this).attr(h));return false});g.on("click",function(){listOtherProductsFilter.resetFilter();return false});$(".filters_activation").on("click",function(){listOtherProductsFilter.toggleFilterPanel()});$(".filters_activation .alternative_button, .filters .button_container .button").on("click",function(){listOtherProductsFilter.toggleFilterPanel();return false});m=n;f=y;c=z;listOtherProductsFilter.orderProductsBy(m);$.each(x,function(A,B){listOtherProductsFilter.filterProductType(B)})},filterProductType:function(y){var w=$("#"+b+y),x;if(w.hasClass(r)){w.removeClass(r).addClass(v);tools.toggleGroup($("#product_type_container_"+y),false,true);if(o()===0){t.find(".product").hide();g.show()}x=t.find(".product["+h+'="'+y+'"]');x.show();if(m===n&&x.length>0){x.first().parent().parent().show()}p[y]=true}else{w.removeClass(v).addClass(r);if(o()===1){j()}else{x=t.find(".product["+h+'="'+y+'"]');x.hide();if(m===n){x.parent().parent().hide()}}p[y]=false}e();s();q();tools.triggerLazyImagesRefresh()},orderProductsBy:function(x){var w=t.find(".product").toArray();if(w.length>0){switch(x){case n:w.sort(l);break;case"PRODUCT_NAME_AZ":w.sort(u);break;case"PRODUCT_NAME_ZA":w.sort(a);break;default:return}$.each(w,function(){var z=$(this),y;if(x===n){z.find(".inline_season_addon").hide();y=z.attr(h);if(y==="TIMESLOT_PASS"){y="PASS"}$("#product_type_container_"+y).show().find(".group_content").append(z);$("#merged_products_container").hide()}else{z.find(".inline_season_addon").show();$("#merged_products_container").show().find(".group_content").append(z)}});s();tools.triggerLazyImagesRefresh()}m=x},resetFilter:function(){t.find(".filters .button_filter."+v).removeClass(v).addClass(r);$.each(p,function(w,x){if(x){p[w]=false}});j();q()},toggleFilterPanel:function(){var x=t.find(".filters"),w=$(".filters_activation .alternative_button");if(w.hasClass("plus")){x.slideDown();w.removeClass("plus").addClass("less")}else{x.slideUp();w.removeClass("less").addClass("plus")}}}}());tools.module("productFilter",function(){var f=null,d=[],c={},g=function(){$(f).each(function(l,m){m.change(h)})},h=function(){var n,p,l,r=[],o=true,m=null,q;for(n=0;n<f.length;n++){p=f[n];a(p);l=b(p);m=j(m,l)}m=$.unique(m);for(n=0;n<f.length;n++){r=r.concat(e(f[n].attr("id")))}r=$.unique(r);for(n=0;n<r.length;n++){q='div[id="prod_'+r[n]+'"]';if($.inArray(r[n],m)>=0){$(q).removeClass("hidden")}else{$(q).addClass("hidden")}}$(".main_content > .content_element > .content > .group:visible").each(function(){var t=$(this).find(".product"),s=$(t).filter(".hidden");if(s.length<t.length){o=false;$(this).show()}else{$(this).hide()}});if(o){$("#filterMsgNoResult").show()}else{$("#filterMsgNoResult").hide()}},a=function(m){var l;if(typeof d[m.attr("id")]!="undefined"){l=d[m.attr("id")];return l(m,c)}},i=function(){var l;for(l=0;l<f.length;l++){$(f[l]).prop("selectedIndex",0)}h()},b=function(l){if(typeof c[l.attr("id")]=="undefined"){return null}if(typeof c[l.attr("id")][l.val()]=="undefined"){return e(l.attr("id"))}return c[l.attr("id")][l.val()]},e=function(l){return k(c[l])},k=function(n){var m=null,l=[];for(m in n){if(typeof m!="undefined"){l=l.concat(n[m])}}return l},j=function(m,l){if(m===null&&l===null){return null}if(m===null){return l}if(l===null){return m}return $.map(m,function(n){if($.inArray(n,l)<0){return null}else{return n}})};return{init:function(l){f=l;g()},data:function(l,m){if(typeof c[l]=="undefined"){c[l]=m}else{c[l]=$.extend(c[l],m)}},addSpecialHandler:function(m,l){d[m.attr("id")]=l},resetFilter:function(){i()}}}());tools.module("membershipVerificationCommon",function(){var a=600,b=function(c){var d=c.filter(function(){return($.trim(this.value)==="")&&($(this).is(":visible"))});if(d.length===0){$(".button.addWithValidation").removeClass("disabled")}else{$(".button.addWithValidation").addClass("disabled")}};return{init:function(c){var d=c?$("#emptyMemberCardMobile"):$("#emptyMemberCard");d.addClass("hidden");$("#externalVerificationDialog").on("dialogclose",function(e){$("#add-to-cart").parent().removeClass("disabled")});$("#verification_panel").on("click",".close_expand_panel",function(e){e.preventDefault();membershipVerificationCommon.hideVerificationDialog(true)})},getVerificationContainer:function(c){return c?$("#verification_panel"):$("#externalVerificationDialog")},showVerificationDialog:function(c){var d=membershipVerificationCommon.getVerificationContainer(c);if(c){$("#seat-map-sub-container").slideUp(a);$("#total_button_container").addClass("verification_expanded");$("#pre-cart").addClass("verification_expanded");$("#total_button_container .triangle_expand_panel").show();$("#verification_panel").slideDown(a)}else{tools.dialog.showDialog("externalVerificationDialog",true)}b(d.find("input"))},hideVerificationDialog:function(c){if(c){$("#verification_panel").slideUp(a);$("#total_button_container .triangle_expand_panel").hide();$("#total_button_container").removeClass("verification_expanded");$("#pre-cart").removeClass("verification_expanded");$("#seat-map-sub-container").slideDown(a);$("#add-to-cart").parent().removeClass("disabled")}else{tools.dialog.hideDialog("externalVerificationDialog")}},handleKeyUp:function(d){var c=d.find("input");c.keyup(function(){b(c)})}}});tools.module("memberships",function(){var d=null,k=null,i="membershipsFormRow",l="group_end",m=null,j=null,b="movementsMembershipsOverride",g="membership",f=false,c=function(p){var o=k.hasClass(l),n=k.prev();if(o){k.removeClass(l)}d.slideUp("fast",function(){k.prev().find(".membership_unselected .alternative_button").removeClass("disabled");k.detach();if(typeof p!=="undefined"){e(p)}if(o){n.addClass(l)}})},e=function(n){if(n.hasClass(l)){n.removeClass(l);k.addClass(l)}n.find(".membership_unselected .alternative_button").addClass("disabled");k.insertAfter(n);d.appendTo(k.find("td"));d.slideDown("fast",function(){tools.scrollToElement(n,"fast")})},a=function(q,r,s){var o=j.find(".membership_unselected"),n=j.find(".membership_selected"),t,p=j.attr("data-movement-id");t=$("<input />",{type:"hidden",id:b+p,name:"movementsMembershipsOverride["+p+"]",value:r});t.appendTo(m);o.hide();n.find(".membership_name").html(q);n.find(".membership_contact").html(s);n.find(".membership_number").html(r);n.show()},h=function(){$("#validateMembershipsForm2").toggleClass("disabled",$(".membership_unselected:visible").length>0)};return{init:function(o,n){d=$("#membershipsFormContainer");m=$("#membershipsForm");f=n;k=$("<tr></tr>",{id:i});k.append($("<td></td>",{colspan:$("td."+g).first().siblings().length+1}));$.each(o,function(p,q){j=$(".membership[data-movement-id='"+p+"']");a(q.membershipName,q.membershipNumber,q.contact.individualFirstname+" "+q.contact.individualLastname)});h();$(".membership_unselected .alternative_button a").click(function(q){var p=$(this);q.preventDefault();if(!p.parent().hasClass("disabled")){memberships.showForm(p)}else{memberships.closeForm()}});$(".membership_selected .alternative_button a").click(function(p){p.preventDefault();memberships.deleteMembership($(this).parents("."+g))});$(".submit_membership_form").click(function(q){q.preventDefault();var r=$("#noMembershipWarning"),p=$("#noMembershipError");if(!$(this).hasClass("disabled")){m.submit()}else{if(r.is(":visible")){tools.scrollToElement(r,"fast");r.slideUp("fast",function(){p.slideDown("fast")})}else{tools.scrollToElement(p,"fast")}}});$("#addMembership").click(function(q){var p=$("#newMembershipNumber").val();q.preventDefault();if(p!==""){memberships.addMembership(p,true)}});$("#newMembershipNumber").bind("enterKey",function(q){var p=$("#newMembershipNumber").val();if(p!==""){memberships.addMembership(p,true)}});$("#newMembershipNumber").keypress(function(p){if(p.keyCode==13){p.preventDefault();$(this).trigger("enterKey")}});$(".selectMembership").click(function(p){p.preventDefault();memberships.addMembership($(this).parents(".membership_card").find(".membership_number").text(),false)});$("#membershipsSeizeOtherCards").click(function(p){p.preventDefault();$("#main_content_memberships").slideDown("fast");$("#membershipsSeizeOtherCards").hide();tools.displayLazyImages()});d.find(".close_expand_panel").click(function(){memberships.closeForm()})},showForm:function(n){var o=n.parents("tr");j=n.parents("."+g);if(k.is(":visible")){c(o)}else{e(o)}},addMembership:function(n,o){n=$.trim(n).replace(/-/g,"");tools.dialog.showWaitingPopupDelayed("membershipsProcessingDialog",true,null,200);$.ajax({url:contextPath+"/ajax/memberships/addMembership",type:"POST",data:{movementId:j.attr("data-movement-id"),membershipNumber:n},cache:false,success:function(r){var p,q;tools.dialog.hideDialog("membershipsProcessingDialog");if(r.ajaxStatus=="MEMBERSHIP_NUMBER_ALREADY_USED"){tools.dialog.showDialog("membershipAlreadyEnteredDialog",true);return}else{if(r.ajaxStatus=="MEMBERSHIP_NOT_FOUND"){tools.dialog.showDialog("invalidMembershipCardDialog",true);return}}q=r.contact.individualFirstname+" "+r.contact.individualLastname;a(r.membershipName,r.membershipNumber,q);if(o&&$(".membership_card").find(".membership_number:contains("+r.membershipNumber+")").length===0){p=$("#template_membership_card").clone();p.find(".membership_name").html(r.membershipName);p.find(".membership_contact").html(q);p.find(".membership_number").html(r.membershipNumber);p.find(".selectMembership").click(function(s){s.preventDefault();memberships.addMembership($(this).parents(".membership_card").find(".membership_number").text(),false)});p.removeClass("hidden").appendTo($("#template_membership_card").parent());$("#membership_list").not(":visible").show()}$("#newMembershipNumber").val("");c();if(f){h()}},error:function(){tools.dialog.hideDialog("membershipsProcessingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},deleteMembership:function(n){tools.dialog.showWaitingPopupDelayed("membershipsProcessingDialog",true,null,200);$.ajax({url:contextPath+"/ajax/memberships/removeMembership",type:"POST",data:{movementId:j.attr("data-movement-id")},cache:false,success:function(){tools.dialog.hideDialog("membershipsProcessingDialog");$("#"+b+n.attr("data-movement-id")).remove();n.find(".membership_selected").hide();n.find(".membership_unselected").show();if(f){h()}},error:function(){tools.dialog.hideDialog("membershipsProcessingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},closeForm:function(){c()}}});tools.module("option.event",function(){var a=null,b=null,c=function(){if(!option.general.isMainPerformanceSelected()){option.general.showNotification("notification-select_performance");return false}if(!option.general.isAtLeastOneQuantitySelected("seatCategoryQuantityInput")){option.general.showNotification("notification-select_tickets");return false}if(!option.general.isMinGaugeRespected("seatCategoryQuantityInput")){option.general.showNotification("notification-respect_min_gauge_per_seatcat");option.general.validateQuantity("seatCategoryQuantityInput");return false}if(!option.general.isMaxGaugeRespected("seatCategoryQuantityInput")){return false}return option.general.isMaxLengthRequestRemarkRespected("remark")};return{init:function(d){option.general.setConfig(d);a=d.perfIdToConfigIdMap;b=d.previousConfigId;jQuery(function(){tools.registerAsIntegerInput("seatCategoryQuantityInput")})},checkSubmit:function(){option.general.doSubmitOption(c)},refreshPerformanceData:function(d){if(a[d]!==b){b=a[d];option.general.refreshPerformanceData()}}}});OPT_SELECTOR_REMOVE_FORM="#optionRemoveForm";OPT_SELECTOR_REQUEST_FORM="#optionRequestForm";OPT_SELECTOR_DEPENDENT_LINE=".dependent_line";OPT_SELECTOR_DEPENDENT_PERF=".dependent_performance-";OPT_SELECTOR_PERFORMANCE_SELECT=".select_fallback";OPT_SELECTOR_PERFORMANCE_DATA=".performance_option";OPT_SELECTOR_MIN_GAUGE_CONTAINTER=".min_gauge_container";OPT_SELECTOR_CATEGORIES_TABLE_CONTAINTER=".categories_table_container";OPT_SELECT_NO_VALUE="";OPT_REMARK_MAX_LENGTH=2000;tools.module("option.general",function(){var p=undefined,k=undefined,h=undefined,l="",o=null,g=false,m=function(r){var s;if(r.length===0){s=0}else{s=parseInt(r,10);if(isNaN(s)||!/^[0-9]+$/.test(r)){s=-1}}return s},b=function(r){r.each(function(){$(this).tipsy("hide");$(this).removeClass("error")})},q=function(r){if(!r){r=0}return o.find(OPT_SELECTOR_PERFORMANCE_SELECT+"-"+r)},a=function(s){var r=(s.length?s.val():OPT_SELECT_NO_VALUE);return(r!==OPT_SELECT_NO_VALUE)},d=function(r){if(!r){r=0}return a(q(r))},c=function(){$(OPT_SELECTOR_PERFORMANCE_DATA).hide()},e=function(){$(OPT_SELECTOR_PERFORMANCE_DATA).show()},f=function(r,s){var t;if(s){t=function(w,u){return($.inArray($(u).val(),s)==-1)}}else{t=function(w,u){return(w===0)}}o.find(OPT_SELECTOR_PERFORMANCE_SELECT+"-"+r+" option").each(function(u){if(t(u,this)){$(this).removeAttr("disabled")}else{var v=q(r);if(v.val()==$(this).val()){v.val(OPT_SELECT_NO_VALUE)}$(this).attr("disabled",true)}})},i=function(s,r){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/ajax/option/getPerformanceCategoriesTable",data:{performanceId:s,productId:h},success:function(t){$(OPT_SELECTOR_CATEGORIES_TABLE_CONTAINTER).html(t);if(r){r(t)}tools.dialog.hideDialog("loadingDialog")},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},j=function(){return $(OPT_SELECTOR_DEPENDENT_LINE+"_"+l)},n=function(){j().each(function(){$(this).find(OPT_SELECTOR_PERFORMANCE_SELECT).each(function(r){var s=q(r);if(a(s)){$(this).children().hide();$(this).find(OPT_SELECTOR_DEPENDENT_PERF+s.val()).show();$(this).parent().show()}else{$(this).parent().hide()}})})};checkMandatoryRemark=function(){var r=$("#remark");if(g&&(!r.length||!r.val())){$("#field_remark").addClass("error");option.general.showNotification("notification-mandatory-fields");return false}return true};return{setConfig:function(r){if(typeof r.minGauge!="undefined"){p=r.minGauge}if(typeof r.maxGauge!="undefined"){k=r.maxGauge}if(typeof r.productId!="undefined"){h=r.productId}if(typeof r.mandatoryRemark!="undefined"){g=r.mandatoryRemark}$(function(){o=$(OPT_SELECTOR_REQUEST_FORM);$(OPT_SELECTOR_MIN_GAUGE_CONTAINTER).html(p)})},setCurrentContainerId:function(r){l=r;o=$(l?"#"+l:OPT_SELECTOR_REQUEST_FORM)},getCurrentContainer:function(){return o},removeOption:function(){tools.dialog.showWaitingPopup("requestProcessingDialog",true);$(OPT_SELECTOR_REMOVE_FORM).submit()},doSubmitOption:function(r){$("#field_remark").removeClass("error");$('div[id^="notification"]').hide();if(r()&&checkMandatoryRemark()){tools.dialog.showWaitingPopup("requestProcessingDialog",true);var t=$(OPT_SELECTOR_REQUEST_FORM),s=function(){if($(this).val()===OPT_SELECT_NO_VALUE){$(this).removeAttr("name")}};t.find("select").each(s);t.find('input[type="hidden"]').each(s);t.submit()}},isAtLeastOneQuantitySelected:function(r){var s=false;$("."+r).each(function(){var t=m($.trim($(this).val()));if(t>0){s=true;return false}});return s},isMaxLengthRequestRemarkRespected:function(r){var s={maxLength:OPT_REMARK_MAX_LENGTH,tooltipError:validationErrors.textTooLong};return validation.validateField(r,s,null,true)},isMinGaugeRespected:function(r){var s=true;$("."+r).each(function(){var t=m($.trim($(this).val()));if(t>0&&t<p){s=false;return false}});return s},isMaxGaugeRespected:function(r){var s=true;$("."+r).each(function(){var t=m($.trim($(this).val()));if(t>0&&t>k){s=false;return false}});return s},validateQuantity:function(r){var t,s,u;t=true;s=[{rule:validation.numericRule()},{rule:validation.numericBoundsRule(p,0)},{rule:validation.numericBoundsRule(0,k)}];if(typeof(r)!="object"){u=$("."+r);b(u)}else{u=$(r)}u.each(function(){var v=m($.trim($(this).val()));if(v!==0&&!validation.validateField(this.id,s,null,true)){t=false}});return t},showNotification:function(r){$("#"+r).show();window.scrollTo(0,0)},isMainPerformanceSelected:function(){return d()},refreshPerformanceData:function(){if(d()){i(q().val(),e)}else{c()}},selectChanged:function(r,t){for(var s=0,u=[];s<=t;s++){if(s>r){if(d(s-1)){f(s,u)}else{f(s)}}if(d(s)){u.push(q(s).val())}}n()},hideFallbacks:function(r){o.find(".select_fallback_container").slice(r).parent().hide()},showFallbacks:function(s){var r=o.find(".select_fallback_container").slice(1),t=r.length;r.each(function(u){if($(this).parent().is(":hidden")){$(this).parent().show();if(u>=(t-1)){$(s).hide()}return false}})},getProductId:function(){return h}}});OPT_SELECTOR_PKG_LINE_CONTENT=".package_line_content";OPT_SELECTOR_ITEM_SELECT=".select_item";OPT_SELECTOR_MAIN_PERF_SELECT=".select_fallback-0";OPT_SELECTOR_QUANTITY_SUMMARY=".total_package_content .value";OPT_QUANTITY_JOIN_CHAR="+";tools.module("option.pkg",function(){var d={},e=function(f){var g=true;$(OPT_SELECTOR_PKG_LINE_CONTENT).find(f).each(function(){if($(this).val()===OPT_SELECT_NO_VALUE){g=false;return false}});return g},c=function(){return e(OPT_SELECTOR_MAIN_PERF_SELECT)},b=function(){return e(OPT_SELECTOR_ITEM_SELECT)},a=function(){if(!c()||!b()){option.general.showNotification("notification-select_pkg_line_info");return false}if(!option.general.isAtLeastOneQuantitySelected("seatCategoryQuantityInput")){option.general.showNotification("notification-select_tickets");return false}if(!option.general.isMinGaugeRespected("seatCategoryQuantityInput")){option.general.showNotification("notification-respect_min_gauge");option.general.validateQuantity("seatCategoryQuantityInput");return false}return option.general.isMaxLengthRequestRemarkRespected("remark")};return{init:function(f){option.general.setConfig(f);$(function(){tools.registerAsIntegerInput("seatCategoryQuantityInput")})},makeQuantitySummary:function(){$(function(){option.pkg.refreshQuantitySummary()})},checkSubmit:function(){option.general.doSubmitOption(a)},addLineQuantityData:function(i,f,h){var g=f+","+h;if(!d[g]){d[g]=0}d[g]+=i},refreshQuantitySummary:function(){var f=[];$.each(d,function(h,i){var g=h.split(",");f.push(i+" "+(i==1?g[0]:g[1]))});$(OPT_SELECTOR_QUANTITY_SUMMARY).text(f.join(" "+OPT_QUANTITY_JOIN_CHAR+" "))}}});tools.module("requestEdit",function(){var b={},d=function(i,g){var e,f,h;e=i.data("maxQuantity");f=i.data("minQuantity");if(typeof e==="undefined"){e=10000000}if(typeof f==="undefined"){f=0}h=[{rule:validation.numericRule(true)},{rule:validation.numericBoundsRule(f,e,true,true)}];return validation.validateFieldAndHandleTooltip(true,i,h,null,g,false,true)},c=false,a=function(h,k,g){var e,j,i,f;e=k-h;j=$("td.other_cat_quantity div.wrapper_other_cat_quantity",g);i=$("td.other_cat_quantity input",g);f=$("span.max_other_cat_qty",g);prevQty=i.val();if(e>0){if(j.hasClass("hidden_input")){j.removeClass("hidden_input")}i.val(Math.min(prevQty,e));$(f).html(" / "+e)}else{j.addClass("hidden_input");i.val(0)}};return{init:function(e){b.labels=e.labels;b.withPreRequestedQuantity=e.withPreRequestedQuantity;b.isEditingRequest=e.isEditingRequest;b.performanceId=e.performanceId;$(".request_content").hide();requestEdit.bindFilters();$("#addToCartButton a").on("click",function(g){g.preventDefault();if(!$(this).parent().hasClass("disabled")&&requestEdit.validateQuantities()&&requestEdit.onFallbackChange()){tools.dialog.showWaitingPopup("loadingDialog",true);$("#request_edit_form").submit()}});var f=function(g){return function(h){var k=$(this).find(".button"),j=k.parents(".performance_SPORTING_EVENT").first(),i=j.find(".buttons .button.requestDrawerBtn.hidden").length===0;j.toggleClass("expanded",i);j=k.parents(".request_performance").first();j.toggleClass("expanded",i);j.toggleClass("collapsed",!i);if(j.hasClass("collapsed")!=i){k.siblings(".requestDrawerCloseBtn, .requestDrawerBtn").toggleClass("hidden");k.toggleClass("hidden")}j.find(".request_content").first().slideToggle(400);$.each($(".quantity input"),function(l,m){$(m).tipsy("hide")});if(typeof h.type!=="undefined"&&h.type==="click"){return false}}};$(".performance_SPORTING_EVENT").on("click",f());if($(".request_content").length==1){$(".matches_toggle").addClass("hidden");$(".performance_SPORTING_EVENT").trigger("click");setTimeout(function(){$(".filters").removeClass("hidden");$("#performance_container").removeClass("hidden")},400)}else{$(".filters").removeClass("hidden");$("#performance_container").removeClass("hidden")}$(".toggle_button").on("click",function(){$round=$(this).parents(".round");$round.toggleClass("collapsed");$round.find(".round_content").slideToggle()});$("#toggle_all_matches").on("click",function(){var h=function(){$(".request_performance.collapsed",$(this)).each(f())},g=function(){$(".request_performance.expanded",$(this)).each(f())};if($(this).is(":checked")){$(".round").each(function(){var i=$(this);if(i.hasClass("collapsed")){i.removeClass("collapsed");$(".round_content",this).slideDown(openPerformances)}else{h.call(i)}})}else{$(".round").each(function(){g.call($(this))})}});if(b.performanceId){$(".request_performance").filter(function(g,h){return $(h).data("performance-id")==b.performanceId}).each(function(g,h){if($(h).hasClass("collapsed")){$(".performance_SPORTING_EVENT",$(h)).click()}})}},onQuantityChange:function(){var f=0,e;$(".table_container").each(function(){var i,l,h,n,m=0,g=0,k=false,j;$(this).find("tr").each(function(){var v,u,t=0,p,r,o=true,q,s;u=$('td.quantity.review_quantity input[type="text"]',this);if(u.length>0){if($(u).val()){o=d(u,true)}}v=$(this).find(".unit_price .amount").last();if(u.length>0&&o){if($(u).val()){t=parseInt($(u).val(),10)}r=v.data("amount");p=t*r;$(this).find(".subtotal .amount").html(functions.generateAmount(p));m+=p;f+=t;g+=t;s=$("input.hidden_initial_quantity",this);if(s.length>0){q=$(s).val();a(q,t,this);if(!k){k=!(isNaN(q)&&t===0)&&!(q==t)}}}else{$(this).find(".subtotal .amount").html(functions.generateAmount(0))}});$(this).find("tr.subtotal td.reservation_amount .amount").html(functions.generateAmount(m));i=$(this).parent().siblings().first().find(".tickets");if(i.length==1){if(k){l=i.find(".ticket_icon").first();n=i.find(".ticket_state").first();h=i.find(".ticket_quantity").first();l.removeClass("inactive");l.addClass("active");n.html("");h.html(g)}else{l=i.find(".ticket_icon").first();n=i.find(".ticket_state").first();h=i.find(".ticket_quantity").first();l.removeClass("active");l.addClass("inactive");n.html(b.labels.ticketStatePreRequest)}h.html(g);if(g>0){i.addClass("hasTickets")}else{i.removeClass("hasTickets")}j=$(this).parent().siblings().first().find(".button");j.find(".modify_text").toggleClass("hidden",g===0);j.find(".request_text").toggleClass("hidden",g>0)}});e=f+" "+(f>1?b.labels.ticketPlural:b.labels.ticketSingle);if(f>0){if($("#summary").hasClass("collapsed")){$(".total_ticket").html(e);$("#summary").removeClass("collapsed")}else{if($(".total_ticket").html()!==e){$(".total_ticket").fadeOut(200,function(){if(b.isEditingRequest&&!c){$("#buy_order").attr("onclick","");$("#buy_order").click(function(g){tools.dialog.showWaitingPopup("confirmationDialog",true);g.stopPropagation()});c=true}$(".total_ticket").html(e);$(".total_ticket").fadeIn(200)})}}$("#addToCartButton").removeClass("disabled")}else{$(".total_ticket").html(e);$("#addToCartButton").addClass("disabled")}},validateQuantities:function(){var e=true,f=false;$(".table_container").each(function(){$(this).find("tr").each(function(){var g;g=$('td.quantity.review_quantity input[type="text"]',this);if(g.length>0){if(!$(g).val()){g.val(0)}else{if(e){e=d(g,false)}}if(parseInt(g.val(),10)>0){f=true}}})});if(!e){$("#notification-reselect_tickets.hidden").removeClass("hidden")}if(!f&&!b.withPreRequestedQuantity){$("#notification-select_tickets.hidden").removeClass("hidden");e=false}return e},onFallbackChange:function(){var e=true;$(".table_container").each(function(){$(this).find("tr").each(function(){var k,j,i,h,g,f;j=$('td.quantity.review_quantity input[type="text"]',this);if(j.length>0){i=parseInt($(j).val(),10)}h=$("input.hidden_initial_quantity",this);if(h.length>0){initQuantityValue=$(h).val()}k=$('td.quantity.other_cat_quantity input[type="text"]',this);if(k.length>0&&initQuantityValue>0&&i>initQuantityValue){g=i-initQuantityValue;if(g>0){f=[{rule:validation.numericRule(true)},{rule:validation.numericBoundsRule(0,g,true,true)}];if(!$(k).val()){k.val(0)}e=validation.validateFieldAndHandleTooltip(true,k,f,null,true,false,true)}}});if(!e){return false}});return e},bindFilters:function(){requestEdit.bindVenueFilter();requestEdit.bindTeamFilter()},bindVenueFilter:function(){var e=$("#venue"),f=e.parent().find(".label .filterToolReset");e.change(requestEdit.applyFilters);f.hide();f.click(function(){e.val("");requestEdit.applyFilters()})},bindTeamFilter:function(){var e=$("#team"),f=e.parent().find(".label .filterToolReset");e.change(requestEdit.applyFilters);f.hide();f.click(function(){e.val("");requestEdit.applyFilters()})},filterVenue:function(){var f=$("#venue").val(),e=$("#venue").parent().find(".label .filterToolReset");if(typeof f!=="undefined"&&f!==""){e.show();$("#performance_container .request_performance:visible").each(function(){var g=this;$(g).toggle(f===$(g).data("venue-id"))});requestEdit.togglePerformanceContainerHeading()}},filterTeam:function(){var f=$("#team").val(),e=$("#team").parent().find(".label .filterToolReset");if(typeof f!=="undefined"&&f!==""){e.show();$("#performance_container .request_performance:visible").each(function(){var g=this;$(g).toggle(f===String($(g).data("host-team-id"))||f===String($(g).data("opposing-team-id")))});requestEdit.togglePerformanceContainerHeading()}},togglePerformanceContainerHeading:function(){var e=$("#performance_container");$(".date",e).each(function(){var f=this,g=$(f).nextUntil(".date",".request_performance:visible").length>0;$(f).toggle(g)});$(".round",e).each(function(){var f=this;$(f).toggle(($(f).find(".request_performance:visible").length>0))})},applyFilters:function(){var g=$("#venue").parent().find(".label .filterToolReset"),e=$("#team").parent().find(".label .filterToolReset"),f=$("#performance_container");$(".round",f).show();$(".round_content",f).show();$(".date",f).show();$(".request_performance",f).show();g.hide();e.hide();requestEdit.filterVenue();requestEdit.filterTeam()}}});tools.module("optionReview",function(){var a,b;b=function(c,f,e){var d=f;for(d;d<e;d++){c.options.remove(0)}};a=function(c,g,f){var e,d=0;for(d;d<=g;d++){e=document.createElement("option");e.text=d;e.value=d;e.selected=d==f;c.options.add(e)}};return{updateQuantityDelta:function(){$(".table_container").each(function(){$(this).find("tr").each(function(){var j,i,f,c,d,h,g,e;j=$('td.quantity select, td.quantity input[type="text"]',this);f=$('td.hidden_initial_quantity input[type="hidden"]',this);g=$("td.other_cat_quantity select",this);h=g[0]!==undefined?g[0]:null;if(j.length>0&&f.length>0&&h!==null){i=parseInt($(j).val(),10);c=parseInt($(f).val(),10);d=i-c;e=parseInt(h.value,10);b(h,0,h.options.length);if(g.hasClass("hidden_select_box")&&d>0){g.removeClass("hidden_select_box");a(h,d,0)}else{if(d>0){a(h,d,e>d?d:e)}else{if(d<=0){g.addClass("hidden_select_box")}}}}})})},updateTotalAmountOfAllTables:function(d){var c;c=$(".total .amount");if(c.length>0){c.html(functions.generateAmount(d))}},submitForm:function(d,c){tools.dialog.showWaitingPopup("loadingDialog",true);$.post(contextPath+"/ajax/request/summary/submit",{preRequestedFileId:c}).done(function(e){if(e.status==="ERR_TOO_MANY_TICKETS"){var f=$("#tooManyRequestTickets");if(e.parameters){$(".message-content",f).html(e.parameters.message);$("#edit_request_btn",f).attr("href",e.parameters.redirectUrl)}if(c){$("#cancel_request_btn",f).attr("href",contextPath+"/request/summary/cancel")}else{$("#cancel_request_btn",f).attr("href","")}$("#cancel_request_btn",f).unbind("click").on("click",function(){if(!c){tools.dialog.hideDialog("tooManyRequestTickets");return false}});tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("tooManyRequestTickets",true,true)}else{if(e.status==="ERR_AVAILABILITY"){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("availabilityError",true)}else{if(e.status==="INVALID_REQUESTED_QUANTITY"){tools.dialog.hideDialog("loadingDialog");tools.message.show(e.messageTitle,e.message)}else{window.location=e.parameters.updatedCheckoutUrl?contextPath+e.parameters.updatedCheckoutUrl:d}}}}).fail(function(e){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)})},checkAndSubmit:function(c,e,d){if(!c&&(typeof d==="undefined"||d===null)){tools.dialog.showDialog("cancel_file_request_popup",true)}else{this.submitForm(e,d)}}}});OPT_SELECTOR_SUBJECT_EVENTS_CONTAINTER="#sstk_subject_events_container-";OPT_SELECTOR_OPTIONAL_EVENT=".season_ticket_line_optional";OPT_SELECTOR_LINE_CONTAINTER="#season_ticket_line-";OPT_SELECTOR_ADD_FALLBACK="a[href$=add_choice]";OPT_SELECTOR_REMOVE_FALLBACK="a[href$=remove_choice]";OPT_SELECTOR_ADD_EVENT="a[href$=add_event]";OPT_SELECTOR_MAIN_PERF_SELECT=".select_fallback-0";OPT_SELECTOR_SPECIFY_FALLBACK_DYNAMIC_CLOSED="#specifyFallbackForDynamicClosed";OPT_SELECTOR_SPECIFY_FALLBACK_DYNAMIC_OPEN="#specifyFallbackForDynamicOpen";OPT_SEASONTICKET_AJAX_COUNT=2;tools.module("option.seasonTicket",function(){var s=true,f=null,k=null,o=0,m="",l=null,h={},g=function(x){m=OPT_SELECTOR_LINE_CONTAINTER+x;l=$(m)},i=function(){return l.find(OPT_SELECTOR_ADD_FALLBACK).parent()},t=function(x){return x.find(OPT_SELECTOR_ADD_EVENT).parent()},u=function(){return l.find(OPT_SELECTOR_PERFORMANCE_SELECT)},q=function(x){return $(x.length?OPT_SELECTOR_SUBJECT_EVENTS_CONTAINTER+x:OPT_SELECTOR_REQUEST_FORM)},w=function(y,A){var x=A?A.id:"",z=A?jQuery.datepicker.formatDate("dd MM yy",A.jsDate,datePickerConfig)+" "+A.time:"";y.find("span").html(z);y.find('input[type="hidden"]').val(x);if(A){y.parent().show()}else{y.parent().hide()}},r=function(x,y){y.find("span").html(x.find("span").html());y.find('input[type="hidden"]').val(x.find('input[type="hidden"]').val())},v=function(y){var x=u().filter(":hidden");if(!x.length){return}w(x.first(),y);if(x.length<=1){i().hide()}},d=function(z,y,x){var B=null,A=u().filter(":visible");if(!x&&A.length<=1){tools.dialog.showWaitingPopup("confirmationDialog_removeSsTkLine_"+z,true)}else{A.slice(y).each(function(){if(B){r($(this),B)}B=$(this)});w(B,null);i().show()}},b=function(){t(q("").parent()).show();$.each(h,function(B,A){var z=q(B),y=A.maxOptional,C=z.find(OPT_SELECTOR_OPTIONAL_EVENT).length,x=t(z.parent());if(y!==null&&C>=y){x.hide();if(!B.length){return false}}})},j=function(){var z,y=$(OPT_SELECTOR_SPECIFY_FALLBACK_DYNAMIC_OPEN),A=$(OPT_SELECTOR_SPECIFY_FALLBACK_DYNAMIC_CLOSED),x=$(OPT_SELECTOR_REQUEST_FORM);x.find(".hidden").hide();z=x.find(OPT_SELECTOR_ADD_EVENT).filter(":visible").length>0||x.find(OPT_SELECTOR_ADD_FALLBACK).filter(":visible").length>0||x.find(OPT_SELECTOR_REMOVE_FALLBACK).filter(":visible").length>0;if(z){A.hide();y.show()}else{y.hide();A.show()}},a=function(){var x=true;$(OPT_SELECTOR_REQUEST_FORM).find(OPT_SELECTOR_MAIN_PERF_SELECT+' input[type="hidden"]').each(function(){if($(this).val()===OPT_SELECT_NO_VALUE){x=false;return false}});return x},p=function(){var x=true;$.each(h,function(C,B){var z=q(C),A=B.minOptional,y=B.maxOptional,D=z.find(OPT_SELECTOR_OPTIONAL_EVENT).length;if((A!==null&&D<A)||(y!==null&&D>y)){x=false;return false}});return x},n=function(){if(!p()){option.general.showNotification("notification-select_events");return false}if(!a()){option.general.showNotification("notification-select_sstk_line_info");return false}if(!option.general.isAtLeastOneQuantitySelected("seatCategoryQuantityInput")){option.general.showNotification("notification-select_tickets");return false}if(!option.general.isMinGaugeRespected("seatCategoryQuantityInput")){option.general.showNotification("notification-respect_min_gauge_per_seatcat");option.general.validateQuantity("seatCategoryQuantityInput");return false}return option.general.isMaxLengthRequestRemarkRespected("remark")},e=function(){$("html body").removeClass("disable_scrolling")},c=function(){$("html body").addClass("disable_scrolling");tools.dialog.showDialog("sstk_option_add_event_popup",true,false,e,"content_bloc main_content alternative_content");if(k!==null){option.seasontickets.performances.prefillSubject(k)}else{if(f){option.seasontickets.performances.showOnlyEvent(f)}else{option.seasontickets.performances.showAllEvent()}}if(f){$("#ui-dialog-title-sstk_option_add_event_popup").html(option.seasontickets.performances.messages.title.addFallBackPerformance)}else{$("#ui-dialog-title-sstk_option_add_event_popup").html(option.seasontickets.performances.messages.title.addAnEvent)}if($("td.showPerformances a.showPerformances").length===1){$("td.showPerformances a.showPerformances").click()}};return{init:function(x){option.general.setConfig(x);$(function(){tools.registerAsIntegerInput("seatCategoryQuantityInput");j()})},addSubjectData:function(z,y,x){h[z]={minOptional:y,maxOptional:x}},checkSubmit:function(){option.general.doSubmitOption(n)},unselectEvent:function(x,y){g(x);l.remove();$("#confirmationDialog_removeSsTkLine_"+x).remove();b()},unselectPerformance:function(z,y,x){g(z);d(z,y,x)},selectPerformance:function(A,x){var y=(A.event.subject.code==option.seasontickets.performances.Subject.NO_SUBJECT_CODE?"":A.event.subject.code),z=A.event.id;tools.dialog.hideDialog("sstk_option_add_event_popup");g(x);if(!l.length){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+"/option/seasonticket/detail/ajax/getNewSeasonTicketLine",data:{productId:option.general.getProductId(),subjectCode:y,seasonTicketLineId:x,eventId:z},success:function(B){$(OPT_SELECTOR_SUBJECT_EVENTS_CONTAINTER+y).append(B);tools.dialog.hideDialog("loadingDialog");g(x);w(u().first(),A);b();tools.displayLazyImages();tools.triggerLazyImagesRefresh()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}else{v(A)}},getSelectedPerformances:function(){return $(OPT_SELECTOR_REQUEST_FORM).find(OPT_SELECTOR_PERFORMANCE_SELECT+' input[type="hidden"]').not('[value="'+OPT_SELECT_NO_VALUE+'"]').map(function(){return parseInt($(this).val(),10)})},isFirstChoice:function(x){return $(OPT_SELECTOR_REQUEST_FORM).find(OPT_SELECTOR_MAIN_PERF_SELECT+' input[type="hidden"][value="'+x+'"]').length>0},isFirstChoiceDefined:function(x){g(x);return l.length&&l.find(OPT_SELECTOR_MAIN_PERF_SELECT+' input[type="hidden"]').val()!==OPT_SELECT_NO_VALUE},initializeAndShowAddEventDialog:function(x,y){f=y;k=x;if(s){option.seasontickets.performances.init(null,false,option.general.getProductId());s=false}else{c()}},dataInitializedCallBack:function(){o++;if(o==OPT_SEASONTICKET_AJAX_COUNT){c()}}}});tools.module("option.seasontickets.performances",function(){var t=null,G=null,k=null,H=null,C=null,g=null,y=null,i=null,e=null,d=null,h=null,r=null,D=null,n=null,A=null,s=null,I=0,o=false,c=null,u=null,K=null,E={},b=null,z=null,p=null,a=null,l=null,f=null,J=false,j=1,m=function(){if(!J){tools.dialog.showWaitingPopup("loadingDialog",true);J=true}},F=function(){if(J){tools.dialog.hideDialog("loadingDialog");J=false}},w=function(M,L,N){$(N).html(Mustache.render(M,L,{performanceTpl:u}))},B=function(){f={page:1,displayWindow:2,nbPerPage:5}},x=function(N){var P=$(window).height(),L=$("#sstk_option_add_event_popup").parent(),O=L.height(),M=L.offset().top-(P-O)/2;$("html,body").animate({scrollTop:M},300)},q=function(L){var M=$("tr[data-eventid="+L+"]").parents("table").position().top;$("#performances_and_events").animate({scrollTop:M},300)},v=function(N){var L={},M=null;for(M in N){if(N.hasOwnProperty(M)){L[M]={id:""+M,name:N[M]}}}return L};return{messages:null,init:function(L,M,O){var Q=null,R=null,S=this,P=function(){if(R&&Q){S.loadEvents(Q);S.loadConfiguration(R);S.updatePerformanceList();F()}},T=seasontickets.performances.errors,N=T.ajaxErrorDialog;m();B();fixedPrice=M;Selection=option.seasontickets.performances.Selection;z=seasontickets.performances.Event;p=seasontickets.performances.Performance;a=option.seasontickets.performances.Subject;l=seasontickets.performances.filters;c=$("#performancesListTpl").html();u=$("#performanceTpl").html();mainTitle=$("#main_content_seasonticket_performances > .content_title > .title");css3PieEnabled=$("body").hasClass("ie_lte_9");this.bindEvents();$.ajax({url:contextPath+"/option/seasonticket/detail/SeasonTicketCatalog.json?productId="+O+(L?"&devCookieHost="+L:""),dataType:"json"}).done(function(U){Q=U;P();option.seasonTicket.dataInitializedCallBack()}).fail(N);$.ajax({url:contextPath+"/option/seasonticket/detail/SeasonTicketConfiguration.json?productId="+O,dataType:"json"}).done(function(U){if(U&&U.status===T.ERR_INSUFFICIENT_AVAIL_EVENTS){T.cantBookErrorDialog()}else{R=U}P();option.seasonTicket.dataInitializedCallBack()}).fail(N)},bindEvents:function(){var L=this;$("#performances").on("click","#showGroup",function(M){B();b=1;E={};L.updatePerformanceList();M.preventDefault()}).on("click","#showAll",function(M){B();b=0;L.updatePerformanceList();M.preventDefault()}).on("click",".event_performance .button a",function(P){if(!$(this).parent().hasClass("disabled")){var O=$(P.target).parents(".event_performance"),M=O.data("perfid"),Q=C[M],N;N=Q.event.subject.getFreeMatch(Q);option.seasonTicket.selectPerformance(Q,N.seasonTicketLineId);L.updatePerformanceList()}P.preventDefault()}).on("click","a.showPerformances",function(N){var M=""+$(this).parents(".event").data("eventid");E[M]=!E[M];L.updatePerformanceList();if(E[M]){q(M)}N.preventDefault()}).on("click","a.seatmap",function(O){var N=$(this).parents(".event_performance"),M=N.data("perfid"),Q=C[M],P=" ("+Q.venue.name+")";viewer.seatView($(this).attr("href"),option.seasontickets.performances.messages.seatMapTitle+P);O.preventDefault()}).on("click",".pagination span.page",function(M){var N=$(this);if(!N.hasClass("current")){if(N.hasClass("previous")){f.page--}else{if(N.hasClass("next")){f.page++}else{f.page=parseInt(N.text(),10)}}L.updatePerformanceList()}M.preventDefault()});seasontickets.performances.filters.bind(function(){f.page=1;L.updatePerformanceList()});$(".last .button.disabled").tipsy({live:true,delayIn:1000,offset:8,gravity:"se",title:function(){return option.seasontickets.performances.messages.thisPerformanceIsSelected}})},loadEvents:function(L){var R=v(L.topicNames),Q=L.topicSubTopics,O=L.firstTopicCodes,N,P,M;e=v(L.subTopicNames);y={};N=null;for(N in L.venueNames){if(L.venueNames.hasOwnProperty(N)){y[N]={id:""+N,name:L.venueNames[N],space:L.spaceNames[N],spaceCode:N.split("_")[1],site:L.siteNames[N],siteCode:N.split("_")[0],showSpace:L.spaceNames[N]!=L.siteNames[N]}}}i=v(L.subjectNames);r=L.seatCategoryNames;d=L.blockNames;h=L.areaNames;t={};C={};G=[];g=[];for(N in Q){if(Q.hasOwnProperty(N)){P=Q[N];M=P.length;while(M--){e[""+P[M]].topic=R[N]}}}$.each(L.events,function(){var S=new z(this,e,O),T;T=S.id;G.push(S);t[T]=S});$.each(L.performances,function(){var T=new p(this,t,y,r,d,h,true,null,null,null),S;S=T.id;g.push(T);C[S]=T})},loadConfiguration:function(R){var T,O=R.performanceAvailabilities,L=R.maxTicketPerPerformance||1,Q=R.maxTicketPerEvent||1,N=R.subjects,P=N.length===1,M=0,S=this.messages.selection;if(R.success===false){if(!seasontickets.performances.errors.handleError(R.status)){seasontickets.performances.errors.ajaxErrorDialog()}}T=R.subscribers;if(!R.orderedSubcribers){A=[];$("#secondary_content_seasonticket .quantity_line").each(function(){var V=$(this).data("audiencesubcategory"),U=T[V];A.push({id:V,quantity:U});M+=U})}else{A=R.orderedSubcribers}if(M===1){labelResume=S.chosenPerformances;labelResumeSingular=S.chosenPerformance}else{labelResume=S.chosenPerformancesMultiple.replace("{0}",M);labelResumeSingular=S.chosenPerformanceMultiple.replace("{0}",M)}$.each(G,function(){this.available=Q;this.noTopics=!P});$.each(g,function(){this.setAvailability(O[this.id],L)});D={};n=[];s=R.maxOptional;if(!s&&s!==0){s=null}I=R.minOptional||0;if(P){P=N[0];if(I){P.minOptional=I}if(s||s===0){P.maxOptional=s}}o=true;$.each(N,function(){var U=new a(this,t,C,i,r);if(!U.allFixed){allFixed=false}n.push(U);D[U.code]=U;o=o&&U.allOptional});if(n.length===1){o=false}if(o){K=null}$.each(G,function(){this.subject=D[this.subjectCode]})},updatePerformanceList:function(){$(".last .button.disabled").tipsy("hide");$(".buy_unavailable.last span").tipsy("hide");if(b===null){b=k?0:1}var L={showAll:k?false:true,showAllSelected:b===0,showGroup:k?false:true,showGroupSelected:b===1,canBook:true,multipleViews:true,isOptionMode:true},N=K!==null?n[K]:null,M=null,O=null,P;if(k){P=k;L.eventName=P.name;O=[P];E={};E[P.id]=true}else{if(b===1){O=[];for(M in t){if(t.hasOwnProperty(M)&&t[M].subject===H){O.push(t[M])}}}}if(!k){$(G).each(function(){var Q=this;$(this.subject.selections).each(function(){if(this.event==Q){if(option.seasonTicket.isFirstChoiceDefined(this.seasonTicketLineId)){Q.available=0}else{Q.available=1}}})})}else{$(G).each(function(){this.available=1})}if(O){L.multipleEvents=!k;L=$.extend(L,z.getViewFromList(O,N,l,f,E))}else{L.allPerformances=true;L.multipleEvents=true;L=$.extend(L,p.getViewFromList($(g).filter(function(){return(this.event.subject==H)}),N,l,f))}if(n.length>1){L.displaySubjects=true}L.hasFilterSubjects=false;if(!L.hasFilterSubjects&&!L.hasFilterTopics&&!L.hasFilterEvents&&!L.hasFilterVenue&&!L.hasFilterDates){L.hasFilters=false}else{L.hasFilters=true}w(c,L,"#performances");selectedPerformances=option.seasonTicket.getSelectedPerformances();this.disableSelectedPerformanceForOption(selectedPerformances);if(j===0){x()}else{j--}},resetFilterAndPagination:function(L){l.filterSubject=(typeof L==="undefined"?null:L);l.filterEvent=null;l.filterDay=null;l.filterMonth=null;l.filterSubtopic=null;l.filterVenue=null;f.page=1},showOnlyEvent:function(L){k=t[L];this.resetFilterAndPagination();this.updatePerformanceList()},prefillSubject:function(L){k=null;var M=seasontickets.performances.filters.getId(L);$(n).each(function(){if(this.name==L){H=this}});this.resetFilterAndPagination(M);E={};this.updatePerformanceList()},showAllEvent:function(){k=null;this.resetFilterAndPagination();E={};this.updatePerformanceList()},disableSelectedPerformanceForOption:function(L){$(".event_performance").each(function(){var M,N;M=$(this).data("perfid");N=$("tr[data-perfid="+M+"]");if($.inArray(M,L)>=0){if(option.seasonTicket.isFirstChoice(M)){N.addClass("selected");N.find("span.button").hide();N.find("td.last span.highlighted_text").show()}else{N.removeClass("selected");N.find("span.button").show();N.find("td.last span.highlighted_text").hide()}N.find("span.button").addClass("disabled")}else{N.find("span.button").removeClass("disabled")}})}}});(function(){tools.makePath("option.seasontickets.performances.Selection");option.seasontickets.performances.Selection=function(f,d,b,a,c){var e=f.eventId;this.event=null;this.performance=null;this.seatCategory=null;this.areaBlockId=null;this.seasonTicketLineId=f.seasonTicketLineId;this.fixed=f.fixed===true;this.booked=f.booked===true;this.optional=f.optional===true;this.mandatory=f.mandatory!==false;this.categoryOnly=f.categoryOnly===true;this.hasSelection=(!this.fixed&&!this.booked)||this.categoryOnly;this.onGoingBooking=false;this.failed=false;this.selected=false;this.price=null;this.subject=c;this.block={name:null,seatCategory:{name:null}};this.index=f.index;if(e){this.event=d[e]}this.oldSelection=null;this.modifyPerformance=null}})();tools.makePath("option.seasontickets.performances.Subject");option.seasontickets.performances.Subject=function(i,k,c,m,j,a){var l=option.seasontickets.performances.Selection,b=[],h=0,f=0,g=this,d,e;this.code=i.subjectCode;this.minOptional=i.minOptional||0;this.maxOptional=i.maxOptional;this.selectedIndex=0;this.name=this.code?m[this.code].name:"";this.allFixed=true;this.cannotBookMessages={};this.undefinedSelections=0;this.canHaveOptional=true;if(!this.code){this.code=option.seasontickets.performances.Subject.NO_SUBJECT_CODE}jQuery.each(i.configuration,function(){var n=new l(this,k,c,j,g,a);n.index=b.length;b.push(n);if(n.optional){h++;if(h>g.minOptional){n.mandatory=false}}else{f++}if(!n.fixed){this.allFixed=false}});this.selections=b;if(this.maxOptional!==0){d=!this.minOptional?1:this.minOptional;while(d>h){e=this.minOptional>h;this.addOptionalSelection(e);if(e){h++}else{break}}}this.included=f;this.optional=h;this.allOptional=f===0};option.seasontickets.performances.Subject.prototype.getFreeMatch=function(e,d){var b=0,a=this.selections.length,c=null;if(this.undefinedSelections===0){return null}for(;b<a;b++){c=this.selections[b];if(!c.seatCategory&&!c.onGoingBooking){if((c.optional&&(c.mandatory||this.canHaveOptional))||c.event&&c.event===e.event){return c}}}return null};option.seasontickets.performances.Subject.prototype.addOptionalSelection=function(a){this.undefinedSelections++;this.selections.push(new option.seasontickets.performances.Selection({optional:true,index:this.selections.length,mandatory:a},null,null,null,this))};option.seasontickets.performances.Subject.prototype.checkCanAdd=function(a){return true};option.seasontickets.performances.Subject.prototype.sync=function(){};option.seasontickets.performances.Subject.prototype.getMaxAllowedTickets=function(){return null};option.seasontickets.performances.Subject.NO_SUBJECT_CODE="__NO_SUBJECT__";tools.module("option.service",function(){var a=function(){if(!option.general.isAtLeastOneQuantitySelected("itemQuantityInput")){option.general.showNotification("notification-select_items");return false}if(!option.general.isMinGaugeRespected("itemQuantityInput")){option.general.showNotification("notification-respect_min_gauge");option.general.validateQuantity("itemQuantityInput");return false}return option.general.isMaxLengthRequestRemarkRespected("remark")};return{init:function(b){option.general.setConfig(b);jQuery(function(){tools.registerAsIntegerInput("itemQuantityInput")})},checkSubmit:function(){option.general.doSubmitOption(a)}}});tools.module("option.visit",function(){var a={},c=false,h=function(l,k){var j=l.parseDate(k);l.updateCalendarConfiguration(j.getFullYear(),j.getMonth()+1,false)},e=function(k,j,n,m){var l=a[k];if(typeof l==="undefined"){tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",async:false,url:contextPath+"/ajax/option/event/calendar",data:{productId:k,packageId:m,packageLineId:n,month:"",year:""},success:function(p){var q="/ajax/option/event/calendar",o=p;if(n&&m){q+="?packageLineId="+n+"&packageId="+m}l=new tools.date.DatePicker(o,true,false,q);l.productId=k;if(o.length){l.setMaxDate(o[o.length-1].performanceDate)}a[k]=l;tools.dialog.hideDialog("loadingDialog")},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})}if(j){h(l,j)}return l},i=function(k,j){return $("#"+k.substr(0,k.length-1)+(parseInt(k.substr(-1),10)+j))},b=function(j){j.find("option").slice(1).remove()},f=function(m){var j=$("#date_picker_input-"+m),l=$("#time_select-"+m),k;for(k=1;j.length&&l.length;k++){j.val("");b(l.val(""));j=i("date_picker_input-"+m,k);l=i("time_select-"+m,k)}},d=function(o,k,l,n,q,r){var m=e(o,null,q,r).getPerformanceForDate(l),s=$("#time_select-"+k),p;$("#date_picker_input-"+k).val(l);b(s);for(p=0;p<m.length;p++){s.append('<option value="'+m[p].performanceId+'">'+m[p].performanceTime+"</option>");if(n===m[p].performanceId||p===0){s.val(m[p].performanceId).trigger("change")}}},g=function(){if(!option.general.isMainPerformanceSelected()){option.general.showNotification("notification-visit-select_performance");return false}if(!option.general.isAtLeastOneQuantitySelected("seatCategoryQuantityInput")){option.general.showNotification("notification-select_tickets");return false}if(!option.general.isMinGaugeRespected("seatCategoryQuantityInput")){option.general.showNotification("notification-visit-respect_min_gauge_per_seatcat");option.general.validateQuantity("seatCategoryQuantityInput");return false}if(!option.general.isMaxGaugeRespected("seatCategoryQuantityInput")){return false}return option.general.isMaxLengthRequestRemarkRespected("remark")};return{init:function(j){option.general.setConfig(j);c=j.isPerfDataLoaded;$(function(){tools.registerAsIntegerInput("seatCategoryQuantityInput")})},refreshPerformanceData:function(j){if(!c){c=true;option.general.refreshPerformanceData()}},checkSubmit:function(){option.general.doSubmitOption(g)},selectChanged:function(k){var j=$("#time_select-"+k).val();if(!j){f(k)}},setPerformance:function(o,r,n,m,q,p){var k=e(o,m,q,p).getPerformanceForDate(m),l;for(l=0;l<k.length;l++){if(k[l].performanceId===n){$("#date_picker_input-"+r).val(k[l].performanceDate);d(o,r,k[l].performanceDate,k[l].performanceId,q,p);break}}},showDatePickerPopup:function(k,j,q,p,n){var o=i("time_select-"+q,-1),m,l;if(o.length&&!o.val()){return}m=e(k,null,p,n);tools.dialog.showDialog(j,true,false,false,"date_picker_popup");m.selectedDateText=$("#date_picker_input-"+q).val();l=!m.selectedDateText;if(l){m.selectedDateText=null}m.showDatePicker("#"+j,function(r){d(k,q,r,null,p,n);tools.dialog.hideDialog(j)});if(l){m.selectedDateText=null}}}});tools.module("orderContactSelection",{DIST_SEARCH_MIN_LENGTH:3,saveButtonSelector:"",contactSelectionType:"",searchContactAjax:function(b,c){var a=null;switch(this.contactSelectionType){case"BUYER":a="/pro/ajax/contactSearch/buyerContact";break;case"INVOICING":a="/pro/ajax/contactSearch/billingContact";break;case"SHIPPING":a="/pro/ajax/contactSearch/shippingContact";break}tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+a,data:{searchText:b,from:c},success:function(d){tools.dialog.hideDialog("loadingDialog");$("#contact_lookup_result").append(d)},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},reset:function(){this.enableSearch(false);this.enableContactIdLookup(false);$("#contact_lookup_text").val("");$("#contact_lookup_result").empty();$("#reset_lookup").hide();$("#contact_create").hide();$("#contact_link").hide();if(this.contactSelectionType=="INVOICING"){$(".contact_structure_selection").removeClass("hidden")}},checkContactName:function(a,b){if(a&&b&&(a.firstName.toUpperCase()!==b.firstName.toUpperCase()||a.lastName.toUpperCase()!==b.lastName.toUpperCase())){tools.dialog.showDialog("warning_contact_existed",true)}},selectContact:function(a,b){var c=$("#contact_selection");orderContactSelection.checkContactName(a,b);$("#selected_contact").val(a.contactNumber);$("#selected_first_name").val(a.firstName);$("#selected_last_name").val(a.lastName);$("#selected_email").val(a.email);$("#selected_structureName").val(a.structureName);if(this.contactSelectionType==="SHIPPING"){$("#shipping_contact_form").submit()}else{c.find(".contact_first_name").html(a.firstName);c.find(".contact_last_name").html(a.lastName);c.find(".contact_email").html(a.email);c.find(".contact_structure").html(a.structureName);if(a.structureName===""){c.find(".contact_structure").hide()}else{c.find(".contact_structure").show()}$("#contact_search").hide();$("#contact_create").hide();$("#info_message_contact").hide();c.show();if(orderContactSelection.saveButtonSelector!==null){$(orderContactSelection.saveButtonSelector).parent().removeClass("disabled")}$("#btn_continue").parent().removeClass("disabled");orderContactSelection.reset()}},enableSearch:function(c){var a=$("#lookup_members"),b=!a.hasClass("disabled");if(b==c){return}if(c){a.removeClass("disabled");a.parent().removeClass("disabled");a.on("click",function(){orderContactSelection.search()})}else{a.addClass("disabled");a.parent().addClass("disabled");a.off("click")}},enableContactIdLookup:function(c){var b=$("#submit_contactId"),a=!b.parent().hasClass("disabled");if(a==c){return}if(c){b.parent().removeClass("disabled");b.on("click",function(){orderContactSelection.submitContactId()})}else{b.parent().addClass("disabled");b.off("click")}},init:function(b,a){if(b!==null){this.saveButtonSelector=b}this.contactSelectionType=a;$("#contact_lookup_text").on({keyup:function(){orderContactSelection.enableSearch(validation.validateField($(this),[{rule:validation.rules.email}],null,false,false))},keypress:function(c){if(c.keyCode===13){$("#lookup_members").click()}}});$("#contact_id_text").on({keyup:function(){orderContactSelection.enableContactIdLookup($(this).val().length>=1)},keypress:function(c){if(c.keyCode===13){$("#submit_contactId").click()}}});this.reset()},search:function(b){var a=$("#contact_lookup_text").val();if(!b){$("#contact_lookup_result").empty()}$("#show_more").detach();this.searchContactAjax(a,b)},afterSearch:function(a){if($(".contact_result_item").length>0){$("#contact_create").hide();$("#reset_lookup").hide();$("#contact_link").hide()}else{if(a){$("#contact_create").hide();$("#contact_link").show()}else{$("#contact_create").show();$("#contact_link").hide()}}},submitContactId:function(){var a=null;switch(this.contactSelectionType){case"BUYER":a="/pro/ajax/contactSearch/buyerContactWithNumber";break;case"INVOICING":a="/pro/ajax/contactSearch/billingContactWithNumber";break;case"SHIPPING":a="/pro/ajax/contactSearch/shippingContactWithNumber";break}tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({type:"GET",url:contextPath+a,data:{searchText:$("#contact_lookup_text").val(),contactNumber:$("#contact_id_text").val()},success:function(b){if(orderContactSelection.contactSelectionType!=="SHIPPING"){tools.dialog.hideDialog("loadingDialog")}$("#contact_lookup_message_container").html(b)},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},selectContactFromList:function(a){this.selectContact({contactNumber:a,firstName:$.trim($("#result_first_name_"+a).text()),lastName:$.trim($("#result_last_name_"+a).text()),email:$.trim($("#result_email_"+a).text()),structureName:$.trim($("#result_structure_"+a).text())})},cancelContact:function(){if(this.saveButtonSelector!==null){$(this.saveButtonSelector).parent().addClass("disabled")}$("#btn_continue").parent().addClass("disabled");$("#contact_search").show();$("#contact_create").hide();$("#contact_link").hide();$("#contact_selection").hide();$("#selected_contact").val("");$("#contact_id_text").val("");$("#info_message_contact").show()},return2ContactSearch:function(){jQuery("#search_type_contact_radio").prop("checked",true);$("#info_message_contact").show();$("#contact_link").hide()},showEditContactForm:function(){distribution.editContact.showEditContactForm({email:$("#contact_lookup_text").val()})},validateContact:function(a){var b=$("#selected_contact").val();if(!b){validation.showErrorTooltip($(a),$("#contact-selection-msg .content").html())}return b}});tools.module("orderSummary",function(){var o=false,c=false,j=false,h=false,m=false,d=false,k=false,e=false,n=false,i=false,p=null,g=function(){m=$("#unauthorizedOverPaymentNotification").is(":visible");d=$("#notification_split_payment").is(":visible")||$("#notification_split_payment_finish").is(":visible")||$("#warning_voucher_split_payment").is(":visible")||$("#warning_credit_note_split_payment").is(":visible");k=$("#wa_not_enough").is(":visible");e=$("#conditionsAccepted").is(":checked");n=!$("#visibility_checkbox").length||$("#visibility_checkbox").is(":checked");i=!m&&!d&&!k&&e&&n},f=function(s,r){var q=undefined;$("#"+s).closest("tbody").find(".beneficiary").each(function(){var t=$(this).find('input[type="checkbox"]');if(t.is(":checked")){q=t.attr("id")}});return q},a=function(s,q){var u,t,r;u=tools.getAmount("#dueAmount_amount");t=parseInt($("#cancellation_insurance_amount").val(),10);if(!s){t=-t}tools.dialog.showWaitingPopup("loadingDialog",true);$.ajax({url:contextPath+"/ajax/checkout/applyCancellationInsurance",type:"POST",data:{insuranceAmount:t},cache:false,success:function(v){r=v.dueAmount;$("#dueAmount_amount").html(functions.generateAmount(u+t));$("#final_amount").html(functions.generateAmount(r));creditNote.updateCreditNoteAmount();tools.dialog.hideDialog("loadingDialog");if(q){q()}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},b=function(){if(p){var q=$("#accept_cancellation_insurance").is(":checked");if(!q&&p.suggestByPopup===true){window.scrollTo(0,0);tools.dialog.showDialog("subscribe_cansins_popup",true,false);return true}}return false},l=function(q,s){var t,z,u,r,A,v={},y,w,x=$("#billingAddressRequired").length>0&&!$("[name=billingAddressId]").val();if(q){q.preventDefault()}$("#error_same_beneficiary").hide();if(!$("#buyNow").parent().hasClass("disabled")&&!$("#buyNowNoDue").parent().hasClass("disabled")){$("#notification_terms_and_conditions").hide();$("#reduced_visibility_terms_and_conditions_notification").hide();if(x){$("#billing_address_required").show();window.scrollTo(0,0);return}if(h){$("#error_audsubcat_not_satisfied").show();window.scrollTo(0,0);return}if(!$("#conditionsAccepted").is(":checked")){$("#notification_terms_and_conditions").show();window.scrollTo(0,0);return}if(o&&!$("#visibility_checkbox").is(":checked")){$("#reduced_visibility_terms_and_conditions_notification").show();return}if(window.voucher&&!voucher.canSubmit()){return}t=$("input[name^='beneficiaries']","#order_validation_form");if(t.length){u=[];t.each(function(){var G=$(this),F=G.parent(),H=F.parent(),C=G.attr("name"),E=G.val(),D,B;F.removeClass("error");r=H.attr("class");if($(this).closest(".product_container").children().first().hasClass("product_PACKAGE")){A=$(this).closest(".product_container").children().first().attr("id")}else{A=""}if(r.length>21){r=r.substring(r.indexOf("product_")+8,r.length)}r+="_"+A;if(C.indexOf("email")!=-1&&E.length>=1&&r.length>0){y=[];if(v[r]){y=v[r].slice(0);v[r].push(E)}else{v[r]=[E]}u.push({fieldId:G,rules:{maxLength:validation.rules.email.maxLength,regExp:validation.rules.email.regExp,tooltipError:validationErrors.email,blackList:H.find('input[type="checkbox"]').is(":checked")?y.slice(0):[]}})}else{if(C.indexOf("createLogin")==-1&&G.hasClass("mandatory_beneficiary")){u.push({fieldId:$(this),rules:validation.mandatoryRule()})}else{D=H.find('input[name$="firstName"]');B=H.find('input[name$="lastName"]');if((C.indexOf("firstName")!=-1&&B.val())||(C.indexOf("lastName")!=-1&&D.val())){u.push({fieldId:$(this),rules:{minLength:1,tooltipError:validationErrors.fullName}})}}}});if(!validation.validateFields(u,true,true)){window.scrollTo(0,0);return}else{$("td.error","#order_validation_form").removeClass(".error")}}t={};duplicatedBeneficiary=false;$("td[class*=product_]","#order_validation_form").each(function(B,C){r=$(C).attr("class");if($(C).closest(".product_container").children().first().hasClass("product_PACKAGE")){A=$(C).closest(".product_container").children().first().attr("id")}else{A=""}if(r.length>21){r=r.substring(r.indexOf("product_")+8,r.length)}r+="_"+A;firstNameInput=$(C).find('input[name$="firstName"]');lastNameInput=$(C).find('input[name$="lastName"]');emailInput=$(C).find('input[name$="email"]');z=t[r];if(z){for(w=0;w<z.length;w++){if((z[w].firstName&&z[w].firstName===$(firstNameInput).val())&&(z[w].lastName&&z[w].lastName===$(lastNameInput).val())&&(z[w].email&&z[w].email===$(emailInput).val())){duplicatedBeneficiary=true;$(firstNameInput).addClass("error");$(lastNameInput).addClass("error");$(emailInput).addClass("error")}}}else{z=[]}z.push({firstName:$(firstNameInput).val(),lastName:$(lastNameInput).val(),email:$(emailInput).val()});t[r]=z});if(duplicatedBeneficiary){$("#error_same_beneficiary").show();window.scrollTo(0,0);return}if(!s&&b()){return}tools.form.submitWithProcessing($("#order_validation_form"));tools.countdown.stopCountdown()}};return{init:function(q){var r;o=q.containsReducedVisibleSeats;c=q.isAndroidTabletOrMobile;j=q.noPaymentMethodAvailable;h=q.ascDependencyNotSatisfied;p=q.cancellationInsuranceData;g();$("#buyNow").on("click",l).tipsy({className:"tipsy-hover",delayIn:200,gravity:"ne",title:function(){if(i){return""}if(m){return q.message.overPayment}if(d){return q.message.splitPayment}if(k){return q.message.waitingAccount}if(!n){return q.message.visibility}if(!e){return q.message.acceptConditions}return""}});$("#visibility_checkbox, #conditionsAccepted").on("click",this.changeProceedButtonState);if($("#error_same_contact").is(":visible")){$(".beneficiary_input").addClass("error")}$(".beneficiary_input input").on("change",function(){$(this).parent().removeClass("error")});r=$("#accept_cancellation_insurance");if(r!==null){r.on("click",function(){a(this.checked)})}if(q.cancellationInsuranceData!==null){$("#cancel_subscribe_cansins").unbind("click").on("click",function(){tools.dialog.hideDialog("subscribe_cansins_popup");l(null,true);return false});$("#subscribe_cansins").unbind("click").on("click",function(){tools.dialog.hideDialog("subscribe_cansins_popup");a(true,function(){l(null,true)});return false})}},changeProceedButtonState:function(){if(!j){g();$("#buyNowButton").toggleClass("disabled",!i);if(c){$("#buyNowButton").hide();$("#buyNowButton").show()}}},handleCreateLoginShowHide:function(t,s,r){var q=f(s,r);if(t&&t.length>=1&&(!r||t!==r)){$("#"+s).parent().show();$("#"+s).prop("checked",false);if(q===s){$("#"+s).closest("tbody").find(".beneficiary").each(function(){if($(this).find('input[type="email"]').val()===r){var u=$(this).find('input[type="checkbox"]').attr("id");$("#"+u).prop("checked",true);return false}})}}else{$("#"+s).parent().hide();if(t==r&&q===undefined){$("#"+s).prop("checked",true)}}}}});function NS_Packages(){this.SELECTION_CHANGE="selectionChange";this.mandatorySeatCategory=false;this.referencePackageLineId=null;this.linesToSync=[];this.mappingTable={};this.priceCatalog={};this.parentChildRelationship={};this.dummySeatCatForServices="SERVICES";this.dummyTablePrefix="NO_TABLE";this.uniqueLogicalConfiguration=false;this.packageLines=[];this.datePickers={};this.audienceSubCategories={};this.allowedSubCategories=[];this.totalPrices=null;this.dateForId={};this.visitLanguages={};this.performancesForVisit={};this.optionalLineQty={};this.packageLinesToLoad=[];this.previousSelections={};this.duration=1;this.addDatePicker=function(b,a){this.datePickers[b]=a};this.getDatePicker=function(a){return this.datePickers[a]};this.addPrice=function(f,a,d,e,g,c){var b;if(!this.priceCatalog[f]){this.priceCatalog[f]={}}b=this.priceCatalog[f];if(!b[a]||c){b[a]=[]}b[a].push({audienceSubCatId:d,price:e});if(g){this.audienceSubCategories[d]=g}};this.registerDateForId=function(b,a){this.dateForId[b]=a};this.initSelectedCategories=function(b){var a=$("table[id='"+b+"']").find("input:radio").filter(function(){return $(this).css("visibility")!=="hidden"}).first();if(a.length>0){a.prop("checked",true);this.categorySelectionChanged(a)}};this.disableOptionalLines=function(c){var a=this,b;$(".package_line_container").each(function(){b=$(this).find(".package_line_optional_checkbox input");if(b.length>0){a.toggleDisableLine(b,c)}})};this.toggleDisableLine=function(d,e){var b=$(d).closest(".package_line_container"),c=b.find(".package_line_content"),f=$(d).closest(".package_line_container").find("input[id*='packageLineId']").val(),a;if($(d).is(":checked")){$(c).find("input").removeAttr("disabled");$(c).find(".package_line_item_selector select").removeAttr("disabled");$(c).find(".package_line_performance_selector select").removeAttr("disabled");$(c).removeClass("disabled");$(c).find("table select").each(function(){var g=$(this);if($(this).closest("tr").find("input:checked").length>0){g.removeAttr("disabled")}});$(c).find(".datepicker_element").removeClass("disabled");if(packages.mandatorySeatCategory){packages.syncMultiLogicConfLines()}b.removeClass("disabled");b.addClass("enabled");if(!e){a=$(".total_package_content span.tpq_"+packages.optionalLineQty[f].enhancedFamilyType);a.text(parseInt(a.text(),10)+packages.optionalLineQty[f].quantity)}}else{$(c).find("input").attr("disabled","disabled");$(c).find("select").attr("disabled","disabled");$(c).find(".datepicker_element").addClass("disabled");$(c).addClass("disabled");b.removeClass("enabled");b.addClass("disabled");if(!e){a=$(".total_package_content span.tpq_"+packages.optionalLineQty[f].enhancedFamilyType);a.text(parseInt(a.text(),10)-packages.optionalLineQty[f].quantity)}}if(packages.uniqueLogicalConfiguration){packages.updateSubtotalsForSingleTable()}else{packages.updateTotalPrices()}};this.categorySelectionChanged=function(a){var b=$(a).closest(".package_line_container").find("input[id*='packageLineId']").val();this.synchronizeSeatCatTwins($(a).val(),Number(b));$(a).closest("tbody").find("td.area select").each(function(){$(this).attr("disabled","disabled")});if(!$(a).attr("disabled")){$(a).closest("tr").find("td.area select").removeAttr("disabled")}if(this.mandatorySeatCategory===true&&Number(b)===this.referencePackageLineId){this.syncMultiLogicConfLines()}};this.updateSubtotalsForSingleTable=function(){var d,a=0,c=this,b=$("#uc_table"),e=0;b.find("tbody tr").each(function(){var l=$(this).find("td.quantity select"),k,f,i,h,j,g=true;if(l.length===0){l=$(this).find("td.quantity input[type='text']");if(l.length>0){g=functions.validateQuantityInputField(l)}}if(l.length>0&&g){$(this).find("input[type='hidden']").each(function(){if($(this).attr("id").indexOf("logicalSeatCategory")!==-1){j=Number($(this).val())}else{if($(this).attr("id").indexOf("audienceSubCategory")!==-1){h=Number($(this).val())}}});i=c.getPriceForAudSubCat("uc_table",h,j);$(".package_line_optional_checkbox input:checked").each(function(){var m=$(this).parent().siblings("input[id*='packageLineId']").val();i+=c.getPriceForAudSubCat("ulc_opt_"+m,h,j)});k=Number(l.val());if(k>0){f=i*k;e+=k}else{f=0}d=$(this).find(".unit_price span.amount");d.html(functions.generateAmount(i));d=$(this).find(".subtotal span.amount");d.html(functions.generateAmount(f));a+=f}else{d=$(this).find(".subtotal span.amount");d.html(functions.generateAmount(0))}});d=b.find("tbody .subtotal .reservation_amount");d=d.find(".amount");d.html(functions.generateAmount(a));functions.updateSelectedQuantityIndicator(e,b)};this.getSelectionConfiguration=function(){var c=[],b="",a=this.dummySeatCatForServices;$("td.category input:radio:checked").each(function(){var d,e,f=$(this).closest(".package_line_container").find("input[type='checkbox']");if((f.length===0||$(f).is(":checked"))&&!$(this).attr("disabled")){e=$(this).attr("value");d=$(this).closest("table").attr("id");c.push({tableId:d,seatCategoryId:Number(e)})}});$(".visit_table").each(function(){var d=$(this).attr("id"),e,f=$(this).closest(".package_line_container").find("input[type='checkbox']");if(f.length===0||$(f).is(":checked")){$(this).find("tr input:hidden").each(function(){e=$(this).attr("value");c.push({tableId:d,seatCategoryId:Number(e)})})}});$(".services_table").each(function(){var d,e=$(this).closest(".package_line_container").find("input[type='checkbox']");if(e.length===0||$(e).is(":checked")){d=$(this).attr("id");c.push({tableId:d,seatCategoryId:a})}});for(b in this.priceCatalog){if(this.priceCatalog.hasOwnProperty(b)&&b.indexOf(this.dummyTablePrefix)>-1){c.push({tableId:b,seatCategoryId:a})}}return c};this.getTotalPrice=function(d){var c=0,e=this.getSelectionConfiguration(),b=0,a=e.length;for(;b<a;b++){c+=this.getPriceForAudSubCat(e[b].tableId,d,e[b].seatCategoryId)}return c};this.updateTotalPrices=function(){var f=this,b=0,d=0,h,e=0,c,a,j,k,g;if($("#quantity_table").length===0){a=this.getSelectionConfiguration();this.selectionConfiguration={};for(c=a.length;e<c;e++){j=a[e];k=j.tableId.replace(/[^\d]*(\d+)$/g,"$1");g=j.seatCategoryId==this.dummySeatCatForServices?null:j.seatCategoryId;this.selectionConfiguration[k]=g}this.events.trigger(this.SELECTION_CHANGE)}else{$("#quantity_table tbody tr").each(function(){var l,m,n,o,i=$(this).find('.quantity input[id*="audienceSubCategory"]').val();if(i){l=f.getTotalPrice(i);m=$(this).find(".unit_price span.amount");m.html(functions.generateAmount(l));m=$(this).find(".subtotal span.amount");o=$(this).find(".quantity select");if(o.length===0){o=$(this).find(".quantity input");if(functions.validateQuantityInputField(o)){n=Number(o.val())}else{n=0}}else{n=Number(o.val())}m.html(functions.generateAmount(l*n));b+=l*n;d+=n}});h=$("#quantity_table tbody tr.subtotal .reservation_amount .amount");h.html(functions.generateAmount(b));functions.updateSelectedQuantityIndicator(d,"#quantity_table")}};this.getPriceForAudSubCat=function(h,f,a){var g=this.priceCatalog[h],c=g[a],e=0,b=c?c.length:0,d=0;for(;e<b;e++){if(c[e].audienceSubCatId===Number(f)||c[e].audienceSubCatId===-1){d+=c[e].price}}return d};this.getAudienceSubCat=function(g,a){var f=this.priceCatalog[g],d=f[a],e=0,c=d?d.length:0,b=[],h;for(;e<c;e++){h=d[e].audienceSubCatId;b.push({id:h,name:this.audienceSubCategories[h]})}return b};this.serviceChanged=function(f,d,c,a,b){var e=function(){packages.synchronizeItemTwins($(f).val(),d);packages.storePreviousSelection(d)};this.loadTable(f,"/ajax/selection/package/serviceUpdate",{advantageId:c,ppid:a,crossSellId:b},e)};this.eventOrTimeslotPassChanged=function(a,h,b,g){var e=function(){var j=$(a).closest(".package_line_header").siblings(".table_container").find("table"),k=(j.length>0)?j.attr("id"):"uc_table";if(b===true){b=packages.dateForId[$(a).val()]}if(b){packages.dates.setCurrentDate(b,k)}packages.synchronizePerformanceTwins(packages.getPackageLineIdFromLineNumber(h));packages.storePreviousSelection(packages.getPackageLineIdFromLineNumber(h))},c={},f=$("#reservationIdx").val(),d=$("#crossSellBaseProductId").val(),i=$("#crossSellId").val();if(typeof(g)!="undefined"&&g!="undefined"){c={lineNb:h,advantageId:g,ppid:d,crossSellId:i,reservationIdx:f}}else{c={lineNb:h,ppid:d,crossSellId:i,reservationIdx:f}}this.loadTable(a,"/ajax/selection/package/eventOrTimeslotPassUpdate",c,e)};this.eraseStoredPricesForUpdatedLines=function(d){var c=packages.parentChildRelationship[d],b=$(".package_line_container[id=pl_"+d+"]").find(".table_container table"),a;if(b.length>0){delete packages.priceCatalog[b.attr("id")]}else{delete packages.priceCatalog[packages.dummyTablePrefix+"_"+d]}if(c){for(a=0;a<c.length;a++){b=$(".package_line_container[id=pl_"+c[a].packageLineId+"]").find(".table_container table");if(b.length>0){delete packages.priceCatalog[b.attr("id")]}else{delete packages.priceCatalog[packages.dummyTablePrefix+"_"+c[a].packageLineId]}}}};this.replaceTableContent=function(d,b){var c=$(".package_line_container[id=pl_"+d+"]"),a=c.find(".table_container");if(a.length>0){a.replaceWith(b)}else{c.append(b)}};this.replacePackageLine=function(b,a){$(".package_line_container[id=pl_"+b+"]").replaceWith(a)};this.performSuccessActions=function(b){var a=null;for(a in b){if(b[a].updateWholeLine){packages.replacePackageLine(b[a].packageLineId,b[a].updatedContent)}else{packages.eraseStoredPricesForUpdatedLines(b[a].packageLineId);packages.replaceTableContent(b[a].packageLineId,b[a].updatedContent)}}tools.triggerLazyImagesRefresh()};this.storePreviousSelection=function(d){var c=$(".package_line_container[id=pl_"+d+"]"),a,b;if(c.find(".package_line_performance_selector").length>0){b=c.find(".package_line_performance_selector");a={selectorClass:"package_line_performance_selector",selectedDate:b.find(".datepicker_element input").val(),performanceCombo:b.find(".time_selection").clone(),selectedPerformance:b.find(".time_selection").val(),languageCombo:b.find(".language_selection").clone(),selectedLanguage:b.find(".language_selection").val()};packages.previousSelections[d]=a}else{packages.previousSelections[d]={selectorClass:"package_line_item_selector",value:c.find(".package_line_item_selector select").val()}}};this.restorePreviousSelection=function(f){var e=packages.previousSelections[f],d=$(".package_line_container[id=pl_"+f+"]").find("."+e.selectorClass),b,a,c;if(e.selectorClass==="package_line_performance_selector"){b=d.find(".datepicker_element");if(b.length>0){b.find("input").val(e.selectedDate)}b=d.find(".time_selection");if(b.length>0){a=e.performanceCombo.clone();b.replaceWith(a);if(e.selectedPerformance){a.val(e.selectedPerformance)}}b=d.find(".language_selection");if(b.length>0){c=e.languageCombo.clone();b.replaceWith(c);if(e.selectedLanguage){c.val(e.selectedLanguage)}}}else{d.find("select").val(e.value)}};this.loadTable=function(d,a,c,e){var b=[];tools.dialog.showWaitingPopup("loadingDialog",true);if($(d).is("select")){c.selectedItem=$(d).find("option:selected").attr("value")}else{c.selectedItem=$(d).find("input").val()}c.productId=$(d).closest("form").find("input[name='productId']").attr("value");c.packageLineId=$(d).closest(".package_line_container").find("input[name$='.packageLineId']").attr("value");$.ajax({type:"GET",url:contextPath+a,data:c,success:function(h){var j,f,g;b.push({updateWholeLine:false,packageLineId:c.packageLineId,updatedContent:h});if(packages.parentChildRelationship[c.packageLineId]){j=packages.parentChildRelationship[c.packageLineId];for(g=0;g<j.length;g++){f=j[g];packages.packageLinesToLoad.push({productId:c.productId,packageLineId:f.packageLineId,parentPackageLineId:c.packageLineId,lineNb:f.lineNb-1,parentItemOrPerformanceId:c.selectedItem,parentYear:0,parentMonth:0,parentDay:0})}}packages.performNextStepInTableUpdate(c.productId,c.advantageId,e,b)},error:function(f){tools.dialog.hideDialog("loadingDialog");if(f.status===400){packages.restorePreviousSelection(c.packageLineId);tools.dialog.showDialog("plAvailabilityErrorDialog",true)}else{tools.dialog.showDialog("ajaxErrorDialog",true)}}})};this.performNextStepInTableUpdate=function(b,a,e,c){var d;if(packages.packageLinesToLoad.length>0){d=packages.packageLinesToLoad.pop();packages.loadPackageLine(d.productId,a,d.packageLineId,d.parentPackageLineId,d.lineNb,d.parentItemOrPerformanceId,d.parentYear,d.parentMonth,d.parentDay,e,c)}else{if(packages.uniqueLogicalConfiguration){packages.updateULCTable(b,a,e,c)}else{if(e){e.call(packages)}packages.performSuccessActions(c);packages.finalizeLinesUpdateChain()}}};this.loadPackageLine=function(d,h,f,b,j,c,l,g,i,k,a){var e=$("#crossSellBaseProductId").val(),m=$("#crossSellId").val();this.priceCatalog["sel_table_"+f]=[];$.ajax({type:"GET",url:contextPath+"/ajax/selection/package/lineUpdate",data:{productId:d,advantageId:h,packageLineId:f,ppid:e,crossSellId:m,lineNb:j,parentItemOrPerformanceId:(typeof c!="undefined"?c:0),year:(typeof l!="undefined"?l:0),month:(typeof g!="undefined"?g:0),day:(typeof i!="undefined"?i:0)},success:function(n){a.push({updateWholeLine:true,packageLineId:f,updatedContent:n});packages.performNextStepInTableUpdate(d,h,k,a)},error:function(n){packages.packageLinesToLoad=[];tools.dialog.hideDialog("loadingDialog");if(n.status===400){packages.restorePreviousSelection(b);tools.dialog.showDialog("plAvailabilityErrorDialog",true)}else{tools.dialog.showDialog("ajaxErrorDialog",true)}}})};this.updateULCTable=function(d,g,i,a){var h={},e,c,f=$("#crossSellBaseProductId").val(),j=$("#crossSellId").val(),b=false;$(".package_line_container").each(function(){e=$(this).find("input[id*='packageLineId']").val();c=$(this).find("[id*='itemOrPerformanceId']").val();h[e]=c;e=$(this).find("input[id*='mergedPackageLinesId']");if(e.length){h[e.val()]=c}});$.ajax({type:"POST",url:contextPath+"/ajax/selection/package/ulcUpdate",data:{productId:d,advantageId:g,baseProductId:f,crossSellId:j,itemOrPerformancesId:h},success:function(k){packages.priceCatalog.uc_table={};$("#uc_table").closest(".table_container").replaceWith(k);if(i){i.call(packages)}packages.performSuccessActions(a);packages.finalizeLinesUpdateChain()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}});return b};this.finalizeLinesUpdateChain=function(){if(packages.mandatorySeatCategory&&!packages.uniqueLogicalConfiguration){packages.syncMultiLogicConfLines()}if(packages.uniqueLogicalConfiguration){packages.updateSubtotalsForSingleTable()}else{packages.updateTotalPrices()}tools.dialog.hideDialog("loadingDialog")};this.validateSubmission=function(e,c,f){var b=false,d,a;$("#error_noProductSelected").addClass("hidden");$("#error_missingSelection").addClass("hidden");d=$("#uc_table");if(d.length===0){d=$("#quantity_table")}a=$("input[id*='optionalSelected']");if(!a.length||$(".package_line_container").length>a.length){b=true}else{a.each(function(){if($(this).is(":checked")){b=true}})}if(!b){$("#error_noProductSelected.hidden").removeClass("hidden");$("#notification.hidden").removeClass("hidden");window.scrollTo(0,0);return}functions.validateQuantities(true,e,c,f,function(g){if(!g){$("#error_missingSelection.hidden").removeClass("hidden")}if(b&&g){$("#notification").addClass("hidden")}})};this.updateComboOptions=function(d,b,k,j,c,g){var e=0,f,l,a=$(d).parent(),h;if(b.length>1){if(!$(d).is("select")){f=$(d).find("input").attr("id");l=$(d).find("input").attr("name");$(d).remove();g='"'+g+'"';$("<select class='time_selection' id='"+f+"' name='"+l+"' onchange='packages.eventOrTimeslotPassChanged(this, "+k+", "+!j+", "+g+")'>").insertAfter(a.find(".datepicker_element"));d=a.find(".time_selection")}else{$(d).find("option").remove()}for(e in b){if(b.hasOwnProperty(e)){h=b[e].performanceName?"&nbsp;- "+b[e].performanceName:"";$(d).append("<option value='"+(c?b[e].id:b[e].performanceId)+"'>"+(c?b[e].startTime:b[e].performanceTime)+h+"</option>")}}$(d).children().first().attr("selected","selected")}else{h=b[0].performanceName?"&nbsp;- "+b[0].performanceName:"";if($(d).is("select")){f=$(d).attr("id");l=$(d).attr("name");$(d).remove();$("<span class='time_selection'>"+(c?b[0].startTime:b[0].performanceTime)+h+"<input type='hidden' id='"+f+"' name='"+l+"' value='"+(c?b[0].id:b[0].performanceId)+"'></span>").insertAfter(a.find(".datepicker_element"));d=a.find(".time_selection")}else{f=$(d).find("input").attr("id");l=$(d).find("input").attr("name");$(d).html((c?b[0].startTime:b[0].performanceTime)+h+"<input type='hidden' id='"+f+"' name='"+l+"' value='"+(c?b[0].id:b[0].performanceId)+"'>")}}return d};this.languageChanged=function(a,j,d,f){this.synchronizePerformanceTwins(d);var b=packages.performancesForVisit[$(a).closest(".package_line_container").attr("id")],e=$(a).val(),g=[],h,c=0;if(e!=="all"){for(c in b){if(packages.visitLanguages[b[c].performanceLanguageName]===e){g.push(b[c])}}}else{g=b}h=$(a).siblings(".time_selection");h=packages.updateComboOptions(h,g,j,true,false,f);packages.eventOrTimeslotPassChanged(h,j,null,f)};this.showDatePickerPopup=function(d,b,c,a,f){var g=d.parseDate($(c).find("input").val()),e=$("#"+b).datepicker("getDate");if($(c).hasClass("disabled")){return false}if(e&&g.getTime()!==e.getTime()){$("#"+b).datepicker("setDate",g);d.selectedDateText=$.datepicker.formatDate(datePickerConfig.dateFormat,$("#"+b).datepicker("getDate"))}d.showDatePicker("#"+b+" .datepicker_content",function(i){var j,h;if(f=="TIMESLOT_PASS"){packages.getTimeslots(d,c,i,b,a)}else{if(f=="VISIT"){packages.getVisitPerformances(d,c,i,b,a)}else{h=d.getPerformanceForDate(i);j=$(c).siblings(".time_selection");$(c).find("input").val(h[0].performanceDate);j=packages.updateComboOptions(j,h,a,false,false,d.advantageId);tools.dialog.hideDialog(b);packages.eventOrTimeslotPassChanged(j,a,i,d.advantageId)}}});tools.dialog.showDialog(b,true,false,false,"date_picker_popup")};this.setAvailableLanguages=function(h,b){var d={},j=[],k,l,a,f,c,e=0,g=false;for(e in b){if(b.hasOwnProperty(e)){k=b[e].performanceLanguageName;if($.inArray(k,j)===-1){l=packages.visitLanguages[k];d[k]=l;j.push(k)}}}a=$(h).closest("div").find("select[class='language_selection']");f=a.val();a.find("option[value!='all']").remove();for(e in j){if(j.hasOwnProperty(e)){l=d[j[e]];c="";if(l===f){g=true;c='selected = "selected"'}$(a).append('<option value="'+l+'" '+c+">"+visitInLabel.replace("{0}",j[e])+"</option>")}}if(!g){a.find("option[value='all']").attr("selected","selected");f="all"}return f};this.getVisitPerformances=function(j,f,a,h,l){var o=j.parseDate(a),n=$("form").find("input[name='productId']").attr("value"),c=$(f).closest(".package_line_container").find("input[name$='.packageLineId']").attr("value"),e,b=$("#crossSellBaseProductId").val(),m=$("#crossSellId").val(),g=[],k,d=0;$.ajax({type:"GET",url:contextPath+"/ajax/selection/package/visitPerformances",data:{packageProductId:n,advantageId:j.advantageId,packageLineId:c,ppid:b,crossSellId:m,year:o.getFullYear(),month:o.getMonth()+1,day:o.getDate()},success:function(i){k=$(f).siblings(".time_selection");packages.performancesForVisit[$(f).closest(".package_line_container").attr("id")]=i;$(f).find("input").val(i[0].performanceDate);e=packages.setAvailableLanguages(f,i);if(e!=="all"){for(d in i){if(packages.visitLanguages[i[d].performanceLanguageName]===e){g.push(i[d])}}}else{g=i}k=packages.updateComboOptions(k,g,l,true,false,j.advantageId);tools.dialog.hideDialog(h);packages.eventOrTimeslotPassChanged(k,l,a,j.advantageId)},error:function(){tools.dialog.hideDialog(h);tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.getTimeslots=function(f,d,a,e,h){var k=f.parseDate(a),j=$("form").find("input[name='productId']").attr("value"),c=$("#crossSellBaseProductId").val(),i=$("#crossSellId").val(),b=$(d).closest(".package_line_container").find("input[name$='.packageLineId']").attr("value"),g;$.ajax({type:"GET",url:contextPath+"/ajax/selection/package/timeslots",data:{packageProductId:j,advantageId:f.advantageId,ppid:c,crossSellId:i,packageLineId:b,year:k.getFullYear(),month:k.getMonth()+1,day:k.getDate()},success:function(l){g=$(d).closest(".package_line_performance_selector").find(".time_selection");$(d).find("input").val(l[0].startDate);g=packages.updateComboOptions(g,l,h,false,true,f.advantageId);tools.dialog.hideDialog(e);packages.eventOrTimeslotPassChanged(g,h,a,f.advantageId)},error:function(){tools.dialog.hideDialog(e);tools.dialog.showDialog("ajaxErrorDialog",true)}})};this.updateStagePreview=function(c,b,e){var d=$(c).closest(".package_line_container").find(".stage_preview img"),a=$(c).closest(".package_line_container").find(".dialog-content img");$(d).attr("src",b.source);$(d).attr("width",b.width);$(d).attr("height",b.height);$(a).attr("src",e.source);$(a).attr("width",e.width);$(a).attr("height",e.height)};this.updatePerformancePicture=function(a,b){var c=$(a).closest(".package_line_container").find(".product img");$(c).attr("src",b.source);$(c).attr("width",b.width);$(c).attr("height",b.height)};this.events=$({});this.addParentChildRelationship=function(b,d,c,a){if(!this.parentChildRelationship[b]){this.parentChildRelationship[b]=[]}this.parentChildRelationship[b].push({packageLineId:d,lineProductId:c,lineNb:a})};this.addPackageLine=function(a){this.packageLines.push(a)};this.getPackageLineByPackageLineId=function(c){var d,a,b;for(d=0,a=packages.packageLines.length;d<a;d++){b=packages.packageLines[d];if(b.packageLineId===c){return b}}return null};this.getPackageLineByLineProductId=function(d){var c,a,b;for(c=0,a=packages.packageLines.length;c<a;c++){b=packages.packageLines[c];if(b.lineProductId===d){return b}}return null};this.getPackageLineIdFromLineNumber=function(a){return parseInt($('[id="packageLines\\['+a+'\\].packageLineId"]').val(),10)};this.hasParentLine=function(a){return(typeof a.parentLineId!=="undefined")};this.getPackageLineTwinId=function(d){var c,a,b;if(!packages.hasParentLine(d)){return null}for(c=0,a=packages.parentChildRelationship[d.parentLineId].length;c<a;c++){b=packages.parentChildRelationship[d.parentLineId][c];if(b.packageLineId!==d.packageLineId&&b.lineProductId===d.lineProductId){return b.packageLineId}}return null};this.synchronizeSeatCatTwins=function(b,c){var d,a,f,e;if(typeof c==="undefined"){return}d=packages.getPackageLineByPackageLineId(c);a=packages.getPackageLineTwinId(d);if(a!==null){f=packages.getPackageLineByPackageLineId(a).packageLineNb-1;e="packageLines"+f+".selectedSeatCategory";$('[id^="'+e+'"]').each(function(h,g){if(b===$(this).val()){$(this).prop("checked",true);$(this).closest("tbody").find("select").prop("disabled",true);if(!$(this).attr("disabled")){$(this).closest("tr").find("select").prop("disabled",false)}}})}};this.synchronizeItemTwins=function(f,b){var d,a,e,c;d=packages.getPackageLineByPackageLineId(b);a=packages.getPackageLineTwinId(d);if(a!==null){e=packages.getPackageLineByPackageLineId(a).packageLineNb-1;c="packageLines"+e+".itemOrPerformanceId";$('[id="'+c+'"] option[value="'+f+'"]').attr("selected","selected")}};this.synchronizePerformanceTwins=function(f){var b,e,a,c,h,d,j,i,g;i=packages.getPackageLineByPackageLineId(f).packageLineNb-1;g=$('[id="packageLines'+i+'.itemOrPerformanceId"]').val();if(typeof g!=="undefined"){this.synchronizeItemTwins(g,f);this.synchronizeSeatCatTwins($('input[name="packageLines\\['+i+'\\].selectedSeatCategory"]:checked').val(),f)}else{b=$("#pl_"+f+' input[type="text"]').val();e=$("#pl_"+f+' select[class="language_selection"]').val();a=$("#pl_"+f+' select[class="time_selection"]').val();c=$("#pl_"+f+' select[class="language_selection"]').html();h=$("#pl_"+f+' select[class="time_selection"]').html();d=packages.getPackageLineByPackageLineId(f);j=packages.getPackageLineTwinId(d);if(j!==null){$("#pl_"+j+' select[class="language_selection"]').html(c);$("#pl_"+j+' select[class="time_selection"]').html(h);$("#pl_"+j+' input[type="text"]').val(b);$("#pl_"+j+' select[class="language_selection"]').val(e);$("#pl_"+j+' select[class="time_selection"]').val(a)}}};this.syncMultiLogicConfLines=function(){var e=$("#pl_"+packages.referencePackageLineId).find("input:radio:checked"),h=e.val(),s=packages.linesToSync,q={},g=0,f=0,p="",o="",a,m,l=0,r,c,d,n="",k=false,b={};if(!e.length&&$("#pl_"+packages.referencePackageLineId).hasClass("package_line_container_VISIT")){e=$("#pl_"+packages.referencePackageLineId).find("input[name*='selectedSeatCategory']");h=e.val()}$(".extended_availability_none").removeClass("extended_availability_none");for(g in s){if(s.hasOwnProperty(g)){$("#pl_"+s[g]).find("input[name*='selectedSeatCategory']").each(function(){if($(this).css("visibility")==="hidden"){for(p in packages.mappingTable){for(o in packages.mappingTable[p].logicalSeatCatMapping){if(packages.mappingTable[p].logicalSeatCatMapping[o]===Number($(this).val())){if($("#pl_"+packages.referencePackageLineId).hasClass("package_line_container_VISIT")){a=$("#pl_"+packages.referencePackageLineId).find("input[name*='selectedSeatCategory']")}else{a=$("#pl_"+packages.referencePackageLineId).find("input:radio")}a=a.filter(function(){return $(this).val()===p||$.inArray(Number($(this).val()),packages.mappingTable[p].logicalSeatCatMapping)>-1});for(f=0;f<a.length;f++){n=$(a[f]).attr("id");if(b[n]===undefined){b[n]=false}else{b[n]=b[n]||false}}}}}}else{k=false;for(p in packages.mappingTable){for(o in packages.mappingTable[p].logicalSeatCatMapping){if(packages.mappingTable[p].logicalSeatCatMapping[o]===Number($(this).val())){if($("#pl_"+packages.referencePackageLineId).hasClass("package_line_container_VISIT")){a=$("#pl_"+packages.referencePackageLineId).find("input[name*='selectedSeatCategory']")}else{a=$("#pl_"+packages.referencePackageLineId).find("input:radio")}a=a.filter(function(){return $(this).val()===p||$.inArray(Number($(this).val()),packages.mappingTable[p].logicalSeatCatMapping)>-1});for(f=0;f<a.length;f++){n=$(a[f]).attr("id");if(b[n]===undefined){b[n]=true}else{b[n]=b[n]||true}m=$(a[f]).closest("tr");if(m.hasClass("availability_NONE")){k=k||false}else{k=true}}}}}if(!k){$(this).closest("tr").addClass("availability_NONE")}}if(packages.matchMappingTable(h,Number($(this).val()))){if($(this).closest(".package_line_container").find(".package_line_optional_checkbox").length===0||$(this).closest(".package_line_container").find(".package_line_optional_checkbox input[type='checkbox']").is(":checked")){$(this).removeAttr("disabled");if(!q[s[g]]){$(this).parent().siblings(".area").find("select").removeAttr("disabled")}}if(!q[s[g]]){$(this).prop("checked",true);q[s[g]]=true}}else{$(this).attr("disabled","disabled");$(this).parent().siblings(".area").find("select").attr("disabled","disabled")}});for(n in b){if(b[n]===false){m=$(n).closest("tr");if(!m.hasClass("extended_availability_none")){m.addClass("extended_availability_none");for(l in packages.mappingTable[p].logicalSeatCatMapping){r=$("input:radio").filter(function(){return Number($(this).val())===packages.mappingTable[p].logicalSeatCatMapping[l]}).closest("tr");if(!r.hasClass("availability_NONE")){r.addClass("extended_availability_none")}}if(e.css("visibility")==="hidden"){c=e.closest("#pl_"+packages.referencePackageLineId).find("input:radio").filter(function(){return $(this).css("visibility")!=="hidden"}).first();c.prop("checked",true);h=c.val()}}}}}}d=packages.mappingTable[h];if(packages.mappingTable[h]===undefined){for(o in packages.mappingTable){if($.inArray(parseInt(h,10),packages.mappingTable[o].logicalSeatCatMapping)>-1){d=packages.mappingTable[o];break}}}if(d===undefined){packages.modifyAvailabilityInQuantityTable("NONE");return}$("input").filter(function(){return this.id.match(/packageQuantities\[\d+\].itemId/)}).val(d.packageItemId);$("input").filter(function(){return this.id.match(/packageQuantities\[\d+\].physicalSeatCategory/)}).val(d.institutionSeatCategoryId);packages.modifyAvailabilityInQuantityTable(d.availabilityLevel)};this.matchMappingTable=function(b,c){var e,a,d=0;e=packages.mappingTable[b];if(e===undefined){for(value in packages.mappingTable){a=packages.mappingTable[value].logicalSeatCatMapping;if($.inArray(parseInt(b,10),a)>-1&&$.inArray(c,a)>-1){return true}}}else{a=e.logicalSeatCatMapping;if(a!==undefined){for(d in a){if(a.hasOwnProperty(d)&&a[d]===c){return true}}}}return false};this.registerAllowedSubCategory=function(b,a){this.allowedSubCategories.push({id:b,rank:a})};this.modifyAvailabilityInQuantityTable=function(d){var c="available",a="available",b=true;switch(d){case"GOOD":a="limited";c="available";break;case"LIMITED":a="available";c="limited";break;case"NONE":b=false;break}if(b){$("#quantity_table span.availability_bullet").removeClass(a).addClass(c);$("#quantity_table .no_availability").hide();$("#quantity_table .sufficient_availability").show()}else{$("#quantity_table .no_availability").show();$("#quantity_table .sufficient_availability").hide()}};this.disableWholeContainer=function(){$("#main_content_container input").attr("disabled",true);$("#main_content_container select").attr("disabled",true);$("#main_content_container .datepicker_element").addClass("disabled");$("#main_content_container .button").addClass("disabled");$("#main_content_container .button a").unbind("click");$("#main_content_container .button a").attr("onclick","return false;");$("#main_content_container .alternative_button").addClass("disabled");$("#main_content_container .alternative_button a").unbind("click");$("#main_content_container .alternative_button").unbind("click");$("#main_content_container .alternative_button a").attr("onclick","return false;");$("#ticketholders td.rate .alternative_button.delete").hide()}}var packages=new NS_Packages();tools.module("packages.dates",function(){var c={},b={},a={},f="NO_ID",g="",d=function(j){var i=/\d*$/.exec(j);if(!i||!i.length){return f}return i[0]},e=function(i,j){return i[j]||i[g]},h=function(i){return $.datepicker.parseDate(datePickerConfig.dateFormat,i)};return{DATE_CHANGE:"dateChange",setCurrentDate:function(i,j){g=d(j);c[g]=h(i);this.events.trigger(this.DATE_CHANGE)},setCurrentValidity:function(i,j,k){g=d(g);b[g]=h(i);a[g]=h(j);this.events.trigger(this.DATE_CHANGE)},getCurrentDate:function(i){return e(c,i)},getCurrentValidityFrom:function(i){return e(b,i)},getCurrentValidityTo:function(i){return e(a,i)},events:$({})}});tools.module("pagination",{update:function(b,a){tools.dialog.showWaitingPopup("loadingDialog",true);jQuery.ajax({type:"GET",url:contextPath+a,cache:false,success:function(c){jQuery(b).closest(".content").html(c);tools.triggerLazyImagesRefresh();tools.dialog.hideDialog("loadingDialog")},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},paginate:function(f,k){var b=[],g=k.page,l=k.displayWindow,e=k.nbPerPage,j=null,h,d,a,c;if(f.length>e){h=Math.floor(f.length/e);if(h!==f.length/e){h++}if(g<1){g=1}else{if(g>h){g=h}}k.page=g;a=Math.max(1,Math.min(g-l,h-2*l));c=Math.min(h,Math.max(g+l,a+2*l));for(d=a;d<=c;d++){b.push({index:d,selected:d===g})}j={pages:b,hasPrevious:g!==1,hasNext:g!==h,remainBefore:a!==1,remainAfter:c!==h};f=f.splice((g-1)*e,e)}return{list:f,view:j}},updatePaginationWidget:function(b,a){if(!a){$(b).hide();return}$(b).show();$(".page.previous",b).toggle(a.hasPrevious);$(".page.next",b).toggle(a.hasNext);$(".separator-before").toggleClass("remaining",a.remainBefore);$(".separator-after").toggleClass("remaining",a.remainAfter);$(".page-link",b).remove();a.pages.forEach(function(d){var c=$('<span class="page page-link"><a href="#">'+d.index+"</a></span>");c.data("page",d.index);if(d.selected){c.addClass("current")}$(".separator-after",b).before(c)})}});function NS_pass(){this.passDatePickers=[];this.addPassDatePicker=function(a){this.passDatePickers.push(a)};$(function(){for(var a=0;a<pass.passDatePickers.length;a++){pass.passDatePickers[a].addClickListener()}})}var pass=new NS_pass();function Pass(){this.datePickerDialog="#datePickerDialog";this.datePicker=undefined;this.isPackage=false;this.productId=0;this.advantageId=undefined;this.baseProductId=undefined;this.crossSellId=undefined;this.reservationIdx=undefined;this.showAdvantageLegend=false;this.packageLineId=0;this.maxDate=undefined;this.calendarConfiguration=undefined;this.updateUrl="/ajax/selection/pass/update";this.dateUpdateUrl="/ajax/selection/pass/range";this.trigger="#date_picker_trigger";this.container="#pass_selected_date";this.datePickerContainerDiv=".datepicker_content";this.legendContainerDiv="#datePickerDialog .datepicker_legend";this.initDatePicker=function(){this.datePicker=new tools.date.DatePicker(this.calendarConfiguration,true,false);this.datePicker.isPackage=this.isPackage;this.datePicker.packageLineId=this.packageLineId;this.datePicker.productId=this.productId;this.datePicker.advantageId=this.advantageId;this.datePicker.baseProductId=this.baseProductId;this.datePicker.crossSellId=this.crossSellId;this.datePicker.legendType=this.datePicker.LEGEND_TYPE_RATE;this.datePicker.setMaxDate(this.maxDate);this.datePicker.dateUpdateUrl=this.dateUpdateUrl;this.datePicker.legendContainer=this.legendContainerDiv;this.datePicker.showAdvantageLegend=this.showAdvantageLegend};this.addClickListener=function(){var a=this;$(this.trigger).click(function(){if($(a.trigger).hasClass("disabled")){return false}a.datePicker.showDatePicker("#"+a.datePickerDialog+" "+a.datePickerContainerDiv,function(b){tools.dialog.hideDialog(a.datePickerDialog);a.updateTable(b)});tools.dialog.showDialog(a.datePickerDialog,true,false,false,"date_picker_popup");a.lastDate=$("#"+a.datePickerDialog).datepicker("getDate");return false})};this.updateTable=function(b){var a=this.datePicker.parseDate(b),d,c=this;tools.dialog.showWaitingPopup("loadingDialog",true);d={productId:this.productId,advantageId:this.advantageId,ppid:this.baseProductId,crossSellId:this.crossSellId,reservationIdx:this.reservationIdx,year:a.getFullYear(),month:a.getMonth()+1,day:a.getDate()};if(this.isPackage){d.packageLineId=this.packageLineId}$.ajax({type:"GET",url:contextPath+this.updateUrl,data:d,success:function(g){var f,e,h=[],j=null;if(c.isPackage){j=packages.parentChildRelationship[d.packageLineId];if(j){for(e=0;e<j.length;e++){childObject=j[e];packages.packageLinesToLoad.push({productId:d.productId,packageLineId:childObject.packageLineId,parentPackageLineId:d.packageLineId,lineNb:childObject.lineNb-1,parentItemOrPerformanceId:0,parentYear:a.getFullYear(),parentMonth:a.getMonth()+1,parentDay:a.getDate()})}}packages.performNextStepInTableUpdate(d.productId,d.advantageId,null,h);f=$("#pl_"+c.packageLineId+" .table_container");if(f.length>0){packages.priceCatalog[f.find("table").attr("id")]=[];f.replaceWith(g)}else{packages.priceCatalog.uc_table={};packages.priceCatalog[packages.dummyTablePrefix+"_"+c.packageLineId]={};if(j){for(e=0;e<j.length;e++){packages.priceCatalog[packages.dummyTablePrefix+"_"+j[e].packageLineId]={}}}$("#pl_"+c.packageLineId).append(g)}packages.updateTotalPrices()}else{$(".legend").remove();$(".table_container").replaceWith(g)}tools.triggerLazyImagesRefresh();$(c.trigger).find("input").val(b);if(c.isPackage){packages.dates.setCurrentDate(b,c.packageLineId)}tools.dialog.hideDialog("loadingDialog");c.lastDate=$("#"+c.datePickerDialog).datepicker("getDate")},error:function(e){tools.dialog.hideDialog("loadingDialog");if(e.status===400){tools.dialog.showDialog("plAvailabilityErrorDialog",true);$("#"+c.datePickerDialog).datepicker("setDate",c.lastDate)}else{tools.dialog.showDialog("ajaxErrorDialog",true)}}})}};tools.module("payment",function(){var v=-1,D=null,a=null,p=null,t=false,B="alias_",h="pay_with_alias_form_",j=null,x=null,f=null,l=null,m=null,b=function(E){return paymentMethods[E].cvvMandatory},k=function(E){if(b(E)){$("#card_cvv_field label span.mandatory").html("*")}else{$("#card_cvv_field label span.mandatory").html("")}},q=function(E){if(E=="JCB"){$("#card_cvv_field label").html(a)}else{$("#card_cvv_field label").html(D)}$("#card_cvv_field .tooltip_icon").remove();$("#card_cvv_field input").after(" <span class='tooltip_icon'><span class='icon' /></span>");$("#card_cvv_field .tooltip_icon .icon").tipsy({gravity:"sw",className:"tipsy-information tipsy-hover",title:function(){return p}})},n=function(E){$("#card_cvv").attr("maxLength",paymentMethods[E].cvvLength)},z=function(F){var G,E;E="";for(G=0;G<F.length;G++){if(F.charAt(G).match(/[0-9]/)){E=E.concat(F.charAt(G))}}return E},e=function(E,H){var F=z(H),G=new RegExp(E);return F.match(G)},s=function(E,H){var G=z(H),J="",F,I=0;if(!e(paymentMethods[E].cardValidationRegex,H)){return false}for(F=0;F<G.length;++F){J+=(F%2)?G.charAt(G.length-1-F)*2:G.charAt(G.length-1-F)}for(F=0;F<J.length;++F){I+=parseInt(J.charAt(F),10)}return(I%10)?false:true},w=function(N){var S,H,G=null,F=x.val(),R=f.val(),M=l.val(),Q=new Date(),J=false,I,U,P,T,O,L,E,K;$.each(paymentMethods,function(V,W){if(e(W.cardValidationRegex,F)){G=V}});if(!G&&$("#card_types input:checked").attr("id")){G=$("#card_types input:checked").attr("id")}if(G!==null){K=b(G)}U={fieldId:"card_number",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"},{rule:{method:function(V){if(G!==null&&s(G,V)){return true}J=true;return false}},errorId:"error_invalid_card"}]};P={fieldId:"card_holder",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"}]};T={fieldId:"card_cvv",rules:[{rule:{method:function(V){return V!==""||!K}},errorId:"error_mandatory"},{rule:{method:function(V){if(G!==null){return r(G,V,K)}return false}},errorId:"error_invalid_cvv"}]};O={fieldId:"card_expiration_date_month",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"},{rule:{method:function(){return parseInt(M,10)>Q.getFullYear()||(parseInt(M,10)===Q.getFullYear()&&parseInt(R,10)>=Q.getMonth()+1)}},errorId:"error_invalid_expiration"}]};L={fieldId:"card_expiration_date_year",rules:[{rule:validation.rules.mandatory,errorId:"error_mandatory"}]};I=[U,P,T,O,L];if(!N){S=validation.validateFields(I,true);H=false;if(!S&&J){v--;if(v==-1){H=true}}if(!S){if(H){window.location.replace($("#cancelPayment").attr("href"))}}else{$("#main_content_payment").find(".alternative_button").addClass("disabled").find("a").on("click",function(){return false});c();A();notifyPaymentInProgress();tools.form.submitWithProcessing($("#payment_form"))}}else{E={validationOk:validation.validateFieldsSilent(I),isCardNumberValid:validation.validateFieldsSilent([U]),isCardHolderValid:validation.validateFieldsSilent([P]),isCVVValid:validation.validateFieldsSilent([T]),isExpMonthValid:validation.validateFieldsSilent([O]),isExpYearValid:validation.validateFieldsSilent([L])};return E}},A=function(){var E=$("#card_types input:checked");if($(E).attr("name")==="_card_type"){$(E).attr("name","")}},c=function(){var E=$("#page_checkout_payment");$("span.button, span.alternative_button",E).addClass("disabled").find("a").prop("disabled",true)},r=function(E,G,F){if(G.length===0&&!F){return true}if(paymentMethods[E].cvvLength>0){return G.length===paymentMethods[E].cvvLength&&!isNaN(G)}return false},g=function(){if(f.hasClass("modified")&&l.hasClass("modified")){var G=w(true),E=!G.isExpMonthValid||!G.isExpYearValid,F=$("#card_expiration_field_error");$("#card_expiration_field").toggleClass("error",E);if(f.find(":selected").attr("value")&&l.find(":selected").attr("value")){if(E){$(F).html(payment._MSG_EXP_DATE_ERROR)}else{$(F).html("")}}else{if(E){$(F).html(payment._MSG_EMPTY_FIELD)}else{$(F).html("")}}}},o=function(F,I){var E=F.data("card-type"),G=$("#main_content_payment_saved_cards .button"),H=F.find(".cvv input").val(),J=F.find(".cvv");isCVVValid=r(E,H,t);G.toggleClass("disabled",!isCVVValid);$(J).toggleClass("error",I?isNaN(H):!isCVVValid)},y=function(F){var E=F.data("card-type"),H=F.find(".cvv .text"),I=F.find(".cvv input"),G=$("#main_content_payment_saved_cards .button");$("#payment_card_form:visible").slideUp("fast");if(!F.hasClass("selected")){$(".card, #add_card").removeClass("selected");F.addClass("selected");G.removeClass("hidden")}if(t&&paymentMethods[E].cvvLength>0){I.prop("maxlength",paymentMethods[E].cvvLength);H.html(H.data("text-template").replace("{0}",paymentMethods[E].cvvLength));H.parent().toggleClass("mandatory",t).removeClass("hidden");G.toggleClass("disabled",!r(E,I.val(),t))}else{H.parent().addClass("hidden");G.removeClass("disabled")}F.find(".cvv input").focus()},i=function(){$(".card").removeClass("selected");$("#add_card").addClass("selected");$("#payment_card_form").slideDown("fast");$("#main_content_payment_saved_cards .button").removeClass("hidden");$("#main_content_payment_saved_cards .button").addClass("disabled");tools.scrollToElement($("#payment_card_form"),"fast")},d=function(E){if(E.card_type===null){$("#card_types input:checked").prop("checked",false)}else{var F=$("#card_types .card_type_"+E.card_type.name.toUpperCase()+" input");if(!$(F).prop("checked")){$(F).prop("checked",true);$(F).triggerHandler("click")}k(E.card_type.name.toUpperCase())}},C=function(E){return $.trim(E).length>0},u=function(G){if(C(m.val())&&$("#card_types input:checked").attr("id")){var E=!G.isCVVValid,F=$("#card_cvv_field_error");$("#card_cvv_field").toggleClass("error",E);if(E){if($("#card_cvv_field_error").html()!==payment._MSG_CVV_NaN_ERROR){$(F).html(payment._MSG_CVV_WRONG_LENGTH_ERROR)}}else{$(F).html("")}}};notifyPaymentInProgress=function(){jQuery.ajax({type:"GET",url:contextPath+"/ajax/payment/inProgress",cache:false})};return{init:function(E){v=E.nbrAllowFailed;D=E.cvvLabel;a=E.nipLabel;p=E.cvvToolTipText;t=E.isAliasCVVMandatory;j=$("#card_holder");x=$("#card_number");f=$("#card_expiration_date_month");l=$("#card_expiration_date_year");m=$("#card_cvv");$("#payNow").on("click",function(H){H.preventDefault();if(!$(this).closest(".button").hasClass("disabled")){$("#error_cvv_mandatory").hide();var I=$("#cards_container .card.selected"),G,F;if($("#payment_card_form:visible").length>0){w(false)}else{if(I){F=I.data("card-type");if(t&&I.find(".cvv input").val().length!=paymentMethods[F].cvvLength){$("#error_cvv_mandatory").show()}else{G=I.attr("id").substring(B.length);c();notifyPaymentInProgress();tools.form.submitWithProcessing($("#"+h+G))}}}}});j.on("blur",function(H){H.preventDefault();var G=w(true),F=!G.isCardHolderValid;$(this).parent().toggleClass("error",F);if(F&&!C($(this).val())){$("#card_holder_field_error").html(payment._MSG_EMPTY_FIELD)}});x.on("blur",function(I){I.preventDefault();var H=w(true),F=!H.isCardNumberValid,G=$("#card_number_field_error");$(this).parent().toggleClass("error",F);if(C($(this).val())){if(F){$(G).html(payment._MSG_CARD_NUMBER_INVALID_ERROR)}else{$(G).html("")}}else{if(F){$(G).html(payment._MSG_EMPTY_FIELD)}else{$(G).html("")}}});m.on("blur",function(I){I.preventDefault();var H=w(true),F=!H.isCVVValid,G=$("#card_cvv_field_error");if(C($(this).val())){if($(G).html()!==payment._MSG_CVV_NaN_ERROR){u(H)}}else{$("#card_cvv_field").toggleClass("error",F);if(F){$(G).html(payment._MSG_EMPTY_FIELD)}else{$(G).html("")}}});$.each([f,l],function(){$(this).on("focus",function(F){F.preventDefault();$(this).parent().removeClass("error")})});$.each([f,l],function(){$(this).on("blur",function(F){F.preventDefault();g()})});$.each([f,l],function(){$(this).on("change",function(G){G.preventDefault();$(this).addClass("modified");g();var F=w(true);$("#main_content_payment_saved_cards .button").toggleClass("disabled",!F.validationOk)})});$.each([j,x,m],function(){$(this).on("input",function(I){I.preventDefault();var G=w(true),F=false,H=$("#card_cvv_field_error");$("#main_content_payment_saved_cards .button").toggleClass("disabled",!G.validationOk);$(this).parent().removeClass("error");$(this).parent().next().html("");if(C($(this).val())){if($(this).attr("id")==="card_cvv"){F=isNaN($(this).val());$(this).parent().toggleClass("error",F);if(F){$(H).html(payment._MSG_CVV_NaN_ERROR)}else{$(H).html("")}}else{if($(this).attr("id")==="card_number"){if($(H).html()!==payment._MSG_CVV_NaN_ERROR){$("#card_cvv_field").removeClass("error");$(H).html("")}u(G)}}}})});$(".card_type input").on("click",function(){var F=$(this).val();q(F);n(F);k(F)});$(".card").on("click",function(G){var F;G.preventDefault();F=$(G.target);if(!F.hasClass("card")){F=F.closest(".card")}y(F)});$(".card .cvv input").on("input",function(F){$(this).addClass("modified");o($(this).parent().closest(".card"),true)});$(".card .cvv input").on("blur",function(F){if($(this).hasClass("modified")){o($(this).parent().closest(".card"),false)}});$("#add_card").on("click",function(G){G.preventDefault();i();var F=w(true);$("#main_content_payment_saved_cards .button").toggleClass("disabled",!F.validationOk)});x.validateCreditCard(d);$("#save_card_checkbox").on("change",function(G){var F=$(this),H=$("#save_card_value");if(F.is(":checked")){H.val(F.data("yes-value"))}else{H.val(F.data("no-value"))}});q(E.firstPaymentMethod);n(E.firstPaymentMethod);k(E.firstPaymentMethod)}}});tools.module("performanceSelectionSort",function(){return function(){var a=null,g=$("#performance_container .performances_container"),e={date:1,venue:1,minPrice:1,available:1},f=function(){if(a){return}a=[];$("div.performance, h4","#performance_container").not(".header").each(function(){var h={id:$(this).attr("id")};if($(this).data("date")){h.date=new Date($(this).data("date"))}$("div",this).each(function(){var i,j;if($(this).data("date")){h.date=new Date($(this).data("date"))}if(typeof $(this).data("min-price")!=="undefined"){h.minPrice=parseInt($(this).data("min-price"),10)}if(typeof $(this).data("available")!=="undefined"){h.available=parseInt($(this).data("available"),10)}if($(this).hasClass("location")){j=$(".space",this).html();i=$(".site",this).html();h.venue=j+i}});a.push(h)})},d=function(h,i){h.fadeTo("fast",0,function(){var k,j;for(k=0,j=a.length;k<j;k++){h.append($("#"+a[k].id))}if(i){$("h4",g).show()}else{$("h4",g).hide()}h.fadeTo("fast",1)})},b=function(i,h){$(".sort","#performance_container").removeClass("asc desc");if(h){$(i).addClass("asc")}else{$(i).addClass("desc")}},c=function(i,k,j,h){f();a.sort(k);d(g,j);e[i]=-e[i];b(h,e[i]===1)};$("#sort_on_date").on("click",function(h){h.preventDefault();c("date",function(k,j){var m=new Date(k.date),l=new Date(j.date),i=m.getMonth(),n=l.getMonth();if((i===n)&&(typeof k.available==="undefined")){return -1}else{if((i===n)&&(typeof j.available==="undefined")){return 1}else{return m<l?e.date:-e.date}}},true,this)});$("#sort_on_min_price").on("click",function(h){h.preventDefault();c("minPrice",function(j,i){if(isNaN(j.minPrice)&&isNaN(i.minPrice)){return 0}if(isNaN(j.minPrice)){return 1}if(isNaN(i.minPrice)){return -1}return e.minPrice*(i.minPrice-j.minPrice)},false,this)});$("#sort_on_venue").on("click",function(h){h.preventDefault();c("venue",function(j,i){if(!("venue" in j)){return -1}if(!("venue" in i)){return 1}return j.venue<i.venue?e.venue:-e.venue},false,this)});$("#sort_on_available").on("click",function(h){h.preventDefault();c("available",function(j,i){if(!j.available&&!i.available){return 0}if(!j.available){return 1}if(!i.available){return -1}return e.available*(i.available-j.available)},false,this)})}});tools.module("pesel",function(){return{needsPeselValidation:function(a){return a=="PL"},isValidPesel:function(a){a=jQuery.trim(a);if(!/^\d{11}$/.test(a)){return false}var e=a.split(""),d=[1,3,7,9,1,3,7,9,1,3],c=0,b;for(b=0;b<11;b++){if(d[b]){c+=parseInt(e[b],10)*d[b]}}return(10-c%10)%10==e[10]}}});tools.module("quickBooking",function(){var a="prod_",e={PARKING:"eventFormData",EVENT:"eventFormData",SERVICE:"serviceFormData",VOUCHER:"serviceFormData",GOODS:"serviceFormData"},d=function(h){var i=0,j;for(j in h){if(h.hasOwnProperty(j)){i++}}return i},g=function(i,h){var k=i!==""?Number(i):0,j=h!==""?Number(h):0;if(k===j){return 0}else{return k>j?1:-1}},c=function(h){h.sort(function(j,i){if((j.advantageId===""&&i.advantageId==="")||(j.advantageId!==""&&i.advantageId!=="")){return g(j.rank,i.rank)}else{if(j.advantageId!==""){return -1}else{return 1}}})},f=function(i){for(var h in i.tariffs){if(i.tariffs[h].availability!="NONE"){return true}}return false},b=function(h){for(var i in h.audienceSubCategories){if(f(h.audienceSubCategories[i])){return true}}return false};onSuccess=function(j,h,i){$.ajax({url:i,type:"GET",processData:false,context:h,success:function(k){$("#secondary_content_cart").replaceWith(k)},error:function(l,k){$("#crossSellAjaxErrorDialog .message").hide();$("#crossSellAjaxErrorDialog .generic").show();tools.dialog.showDialog("crossSellAjaxErrorDialog",true)}})};onNotLoggedIn=function(k,n,j){var m,i,h,l;m=window.location.pathname.split("/");i=m[m.length-1];l=i.indexOf("?");if(l==-1){h=i}else{h=i.substring(0,l)}window.location.href=n+j+"&ridx="+h};updateCancelOperationOnclick=function(h,i){if(!jQuery.isEmptyObject(quickBooking.addedOperationIdsOfProduct)&&quickBooking.addedOperationIdsOfProduct[i]){h=quickBooking.addedOperationIdsOfProduct[i]+"_"+h}$("#confirmationDialog_"+i+" .button").first().find("a").attr("onclick","updatedCancelOperationFunction('"+h+"','"+i+"')");quickBooking.addedOperationIdsOfProduct[i]=h};updatedCancelOperationFunction=function(h,i){$("#confirmationDialog_"+i).hide();functions.cancelOperations("#cancel_"+i,h);return false};initAddedOperationIdsOfProduct=function(i,h){quickBooking.addedOperationIdsOfProduct[i]=h};return{products:{},initRows:{},isInited:{},addedOperationIdsOfProduct:{},addItems:function(i,h){this.products[i]=h},sortItemsByRank:function(i){var h=[];for(itemId in i){h.push(i[itemId])}h.sort(function(k,j){return k.rank-j.rank});return h},init:function(){for(var h in this.products){this.initProduct(h)}},disableAllForms:function(){$("span.button, span.alternative_button").addClass("disabled").find("a").prop("disabled",true);$("input, select").prop("disabled",true)},enableAllForms:function(){$("span.button, span.alternative_button").removeClass("disabled").find("a").prop("disabled",false);$("input, select").prop("disabled",false)},initProduct:function(q,s){if(jQuery.isEmptyObject(this.isInited)||!this.isInited[q]){var t=this,r=this.products[q].items,k,n,o=$("."+q+" .quick_booking .item .article.column"),m,l=false,v,h,w=e[this.products[q].type],p=(this.products[q].type=="PARKING"||this.products[q].type=="EVENT")?w+"[0].seatCategory":w+"[0].itemId",u,j=d(r);o.empty();this.products[q].maxCrossSellQuantity=s;if(j<2){for(u in r){o.append($("<input/>").attr("type","hidden").attr("name",p).val(u)).append(r[u].name);this.itemSelected(q,u,0)}if(j==1&&d(r[u].audienceSubCategories)<2){$("#quick_booking_form_"+q).find(".alternative_button.add").remove()}t.initActionButtons(q)}else{m=$("<select/>").attr("name",p);o.append(m);k=this.sortItemsByRank(r);for(n=0;n<k.length;n++){v=k[n].availability!="NONE"&&b(k[n]);h=$("<option/>").val(k[n].id).text(k[n].name);m.append(h);if(!v){h.attr("disabled","disabled")}if(v&&!l){m.val(k[n].id);this.itemSelected(q,k[n].id,0);l=true}}m.change(function(){t.itemSelected(q,m.val(),0)});t.initActionButtons(q);if(!l){$("#"+a+q+" .quick_booking").hide()}}t.initRows[q]=$("."+q+" .quick_booking .item").first().clone();t.updateFormDataIndexes(q);this.isInited[q]=true;$("#cs_product_brief_view_"+q).trigger("isInited")}},initActionButtons:function(k){var j,i,h=$("."+k+" .quick_booking .item .action.column");i=$("<a/>").attr("title",quickBooking.messages.deleteLine).attr("onclick",'quickBooking.deleteRow(this, "'+k+'"); return false;').attr("href","#").append($('<span class="icon"></span>')).append($('<span class="symbol"></span>'));j=$("<span/>").attr("class","alternative_button cancel").append(i);h.append(j)},updateFormDataIndexes:function(o){var k=$("."+o+" .quick_booking .item"),r=e[this.products[o].type],p,q,n,h,m,l;n=0;for(m=0;m<k.length;m++){p=$("input,select",k[m]);for(l=0;l<p.length;l++){q=p[l];h=$(q).attr("name");if(h&&h.indexOf(r)===0){h=r+"["+n+"]"+h.substring(h.indexOf("]",r.length)+1);$(q).attr("name",h)}}if(n===0&&k.length<2){$("span.alternative_button",k[m]).hide()}else{$("span.alternative_button",k[m]).show()}this.updateRowEventHandlers(o,k[m],n);n++}return --n},updateRowEventHandlers:function(n,l,m){var j=this,i,k,h;h=$("select",$(".article.column",l));tariffElement=$("select",$(".tariff.column",l));if(h.length>0){h=$(h[0]);h.unbind("change");h.on("change",function(){j.itemSelected(n,$(this).val(),m)});k=h.val()}else{k=$(l).find(".article input").val()}if(tariffElement.length>0){tariffElement=$(tariffElement[0]);tariffElement.unbind("change");tariffElement.on("change",function(){i=j.products[n].items[k];var o=$("option:selected",$(this));o=$(o[0]);j.audienceSubCategorySelected(n,i.audienceSubCategories[o.attr("data-id")].tariffs,i.audienceSubCategories[o.attr("data-id")].advantageId,m)})}},resetValues:function(h){articleElement=$("select",$(".article.column",h));tariffElement=$("select",$(".tariff.column",h));quantityElement=$("select",$(".quantity.column",h));if(articleElement.length>0){$(articleElement).prop("selectedIndex",0)}if(tariffElement.length>0){$(tariffElement).prop("selectedIndex",0)}if(quantityElement.length>0){$(quantityElement).prop("selectedIndex",0)}},deleteRow:function(h,i){$(h).closest(".item").remove();this.updateFormDataIndexes(i);crossSellingUtils.updatePrices($("#quick_booking_form_"+i))},addRow:function(m){var l=this,h=$("."+m+" .quick_booking .service"),i=l.initRows[m],j,k=$("#quick_booking_form_"+m);if(i&&h){j=$(i).clone();$(h[0]).append(j);l.updateFormDataIndexes(m);crossSellingUtils.updatePrices(k);crossSellingUtils.updateQuantitySelectionBox(k)}},resetRow:function(j){var i=this,h=$("#quick_booking_form_"+j).find(".item");h.each(function(k,l){if(k===0){i.resetValues(l)}else{$(l).remove()}});i.updateFormDataIndexes(j);crossSellingUtils.updatePrices($("#quick_booking_form_"+j))},itemSelected:function(s,v,u){var t=this,x=this.products[s].items[v],p=$("."+s+" .quick_booking .item .tariff.column"),j,k,l=false,w,h,y=e[this.products[s].type],r=(this.products[s].type=="PARKING"||this.products[s].type=="EVENT")?y+"["+u+"].audienceSubCategory":y+"["+u+"].audienceSubCategoryId",m,o,n=[],q=$("#quick_booking_form_"+s);p=$(p[u]);if(d(x.audienceSubCategories)<2){for(m in x.audienceSubCategories){p.empty().append($("<input/>").attr("type","hidden").attr("name",r).attr("data-id",x.audienceSubCategories[m].id).attr("data-advantageId",x.audienceSubCategories[m].advantageId).val(x.audienceSubCategories[m].value)).append($("<span/>").addClass("audienceSubCatLabel").append(x.audienceSubCategories[m].name));this.audienceSubCategorySelected(s,x.audienceSubCategories[m].tariffs,x.audienceSubCategories[m].advantageId,u)}}else{p.parent(".item").addClass("audienceSubCatMoreThan1");j=$("<select/>").attr("name",r);p.empty().append(j);for(m in x.audienceSubCategories){n.push(x.audienceSubCategories[m])}c(n);for(o=0;o<n.length;o++){m=n[o].id;k=x.audienceSubCategories[m];h=$("<option/>").attr("data-id",k.id).attr("data-advantageId",k.advantageId).val(k.value).text(k.name);if(k.advantageId){h.addClass("advantage-option")}w=f(k);j.append(h);if(!w){h.attr("disabled","disabled")}if(w&&!l){j.val(k.id);this.audienceSubCategorySelected(s,k.tariffs,k.advantageId,u);l=true}}j.change(function(){var i=$("option:selected",$(this));i=$(i[0]);t.audienceSubCategorySelected(s,x.audienceSubCategories[i.attr("data-id")].tariffs,x.audienceSubCategories[i.attr("data-id")].advantageId,u)})}crossSellingUtils.updateQuantitySelectionBox(q)},audienceSubCategorySelected:function(s,h,r,u){var p=$("."+s+" .quick_booking .item .unit_price.column"),n=$("."+s+" .quick_booking .item .quantity.column"),v=e[this.products[s].type],o=$("<select/>").attr("name",v+"["+u+"].quantity"),i=v+"["+u+"].advantageId",l,m,t,j=h[0],k,q=$("#quick_booking_form_"+s);p=$(p[u]);n=$(n[u]);p.empty().html(functions.generateAmount(j.amount)).append($("<input/>").attr("type","hidden").attr("name",v+"["+u+"].priceLevelId").val(j.priceLevelId));p.parent().find('input[name="'+i+'"]').remove();p.parent().append($("<input/>").attr("type","hidden").attr("name",i).val(r));l=Number(j.maxQuantity>0?j.maxQuantity:defaultMaxItemQuantity);m=Number(j.minQuantity>0?j.minQuantity:1);if(this.products[s].maxAllowedSeatsPerPerformance&&Number(this.products[s].maxAllowedSeatsPerPerformance)<l){l=Number(this.products[s].maxAllowedSeatsPerPerformance)}if(this.products[s].maxCrossSellQuantity>0){t=this.products[s].maxCrossSellQuantity;l=t<l?t:l}n.empty().append(o);o.append($("<option/>").val(0).text(0));for(k=m;k<=l;k++){if(k==m){o.append($("<option/>").val(k).text(k).attr("selected","selected"))}else{o.append($("<option/>").val(k).text(k))}}crossSellingUtils.updateQuantitySelectionBox(q)},validateQuantity:function(h,o){var A=this,C=$("."+o+" .quick_booking .item"),k=0,s={},m,v,z,x,n,p,B,y,u,j=true,w,l,r,q,t;r=A.products[o].type;if(r=="PARKING"||r=="EVENT"){w='.article.column select[name*="seatCategory"],input[name*="seatCategory"]';l='.tariff.column select[name*="audienceSubCategory"],input[name*="audienceSubCategory"]'}else{w='.article.column select[name*="itemId"],input[name*="itemId"]';l='.tariff.column select[name*="audienceSubCategoryId"],input[name*="audienceSubCategoryId"]'}for(v=0;v<C.length;v++){z=$(w,C[v]);x=$(l,C[v]);n=$('input[name*="advantageId"]',C[v]);p=$('.quantity.column select[name*="quantity"]',C[v]);k+=Number($(p).val());B=$(z).val()+"_"+$(x).val()+"_"+$(n).val();if(!s[B]){s[B]={quantity:0,itemId:$(z).val(),audienceSubCatId:$(x).val(),advantageId:$(n).val(),itemElements:[],tariffElements:[],quantityElements:[]}}s[B].quantity+=Number($(p).val());s[B].itemElements.push(z);s[B].tariffElements.push(x);s[B].quantityElements.push(p)}m=A.products[o].maxAllowedSeatsPerPerformance;m=m?Number(m):0;maxCrossSellQuantity=A.products[o].maxCrossSellQuantity;if(k===0){j=false;quickBooking.showCSErrorTooltip($("#buyNow",h),quickBooking.messages.missingTickets)}else{if(m>0&&k>m){j=false;q=quickBooking.messages.exceedMaxQuantity.replace("{0}",quickBooking.messages.ticketsText);q=q.replace("{1}",m);quickBooking.showCSErrorTooltip($("#buyNow",h),q)}else{if(maxCrossSellQuantity>0&&k>maxCrossSellQuantity){j=false;q=quickBooking.messages.exceedMaxCrossSellQuantity.replace("{0}",quickBooking.messages.ticketsText);q=q.replace("{1}",maxCrossSellQuantity);quickBooking.showCSErrorTooltip($("#buyNow",h),q)}}}if(j){for(B in s){y=A.products[o].items[s[B].itemId];u=null;for(t in y.audienceSubCategories){if(s[B].audienceSubCatId===y.audienceSubCategories[t].value&&s[B].advantageId===y.audienceSubCategories[t].advantageId){u=y.audienceSubCategories[t].tariffs[0];break}}if(u&&s[B].quantity>u.maxQuantity&&$.isNumeric(u.maxQuantity)){for(v=0;v<s[B].quantityElements.length;v++){$(s[B].quantityElements[v]).addClass("error")}if(u.maxQuantity>0){quickBooking.showCSErrorTooltip($("#buyNow",h),quickBooking.messages.limitWithValues.replace("{0}",u.maxQuantity))}else{quickBooking.showCSErrorTooltip($("#buyNow",h),quickBooking.messages.limitWithoutValues)}j=false}}}return j},submitForm:function(k,m,h,i,l){var j=this;if(j.validateQuantity(k,m)){j.ajaxSubmit(m,k,j,h,i,l);j.disableAllForms()}},ajaxSubmit:function(r,j,k,x,s,w){$("#cs_product_expand_view_prod_"+r+" .st_overlay").css("line-height",$("#cs_product_expand_view_prod_"+r).outerHeight()+"px");$("#cs_product_expand_view_prod_"+r+" .wait_overlay").show();var l,p,n,m,v,q,t=-1,u=false,o,i="",h;m=j.serialize();$.ajax({url:x,type:"POST",data:m,processData:false,dataType:"json",context:k,success:function(y){$("#crossSellAjaxErrorDialog .message").hide();if(y.error){if(y.status=="NOT_LOGGED_IN"){onNotLoggedIn(k,w,y.message)}else{if(y.status=="TOO_MANY_TICKETS"){l=y.message.split(",");p=l[0];n=l[1];$("#crossSellAjaxErrorDialog .tooManyTickets .productType").html(p);$("#crossSellAjaxErrorDialog .tooManyTickets .limit").html(n);$("#crossSellAjaxErrorDialog .tooManyTickets").show();tools.dialog.showDialog("crossSellAjaxErrorDialog",true)}else{if(y.status=="TOO_FEW_TICKETS"){l=y.message.split(",");p=l[0];n=l[1];$("#crossSellAjaxErrorDialog .tooFewTickets .productType").html(p);$("#crossSellAjaxErrorDialog .tooFewTickets .limit").html(n);$("#crossSellAjaxErrorDialog .tooFewTickets").show();tools.dialog.showDialog("crossSellAjaxErrorDialog",true)}else{if(y.status=="ADVANTAGE_ALREADY_USED"){n=y.message.substring(1,y.message.length-1);$("#crossSellAjaxErrorDialog .advantageAlreadyUsed .limit").html(n);$("#crossSellAjaxErrorDialog .advantageAlreadyUsed").show();tools.dialog.showDialog("crossSellAjaxErrorDialog",true)}}}}}else{onSuccess(r,k,s);u=true;o=y.message.split(",");t=parseInt(o[0],10);i=o[1];$("#cs_product_expand_view_prod_"+r+" .wait_overlay").hide();$("#cs_product_expand_view_prod_"+r+" .success_overlay").show();$("#cs_product_expand_view_prod_"+r).delay(500).slideUp(600,function(){$("#triangle_tip_"+r).fadeOut(100);if(u&&t!=-1){$("#cs_product_brief_view_"+r+" .priceLabel").hide();$("#cs_product_brief_view_"+r+" .addedQuantityLabel").contents().show();v=$("#cs_product_brief_view_"+r+" .addedQuantity");if(v.is(":empty")){q=0}else{q=v.html()}q=parseInt(q,10)+t;v.hide();v.html(q).fadeIn("slow");if(q===1){$("#cs_product_brief_view_"+r+" .addedQuantityLabel .typeSingularLabel").show();$("#cs_product_brief_view_"+r+" .addedQuantityLabel .typePluralLabel").hide()}else{$("#cs_product_brief_view_"+r+" .addedQuantityLabel .typeSingularLabel").hide();$("#cs_product_brief_view_"+r+" .addedQuantityLabel .typePluralLabel").show()}$("#cs_product_brief_view_"+r+" .st_overlay").fadeIn("slow");$("#expandQuickShopButton_"+r).hide();$("#modifyButton_"+r).parent().show();if(i){updateCancelOperationOnclick(i,r);$("#cs_product_expand_view_prod_"+r+" .deleteAllSection").show().css("display","inline-block")}$("#cs_product_expand_view_prod_"+r+" .addedQuantity").html(q);$("#cs_product_expand_view_prod_"+r+" .addMoreLabel").show();if(q===1){$("#cs_product_expand_view_prod_"+r+" .addedQuantityLabel .typeSingularLabel").show();$("#cs_product_expand_view_prod_"+r+" .addedQuantityLabel .typePluralLabel").hide()}else{$("#cs_product_expand_view_prod_"+r+" .addedQuantityLabel .typeSingularLabel").hide();$("#cs_product_expand_view_prod_"+r+" .addedQuantityLabel .typePluralLabel").show()}k.resetRow(r);$("#cs_product_expand_view_prod_"+r+" .success_overlay").hide();$("#cs_product_expand_view_prod_"+r+" .viewDetails").hide();$(this).removeClass("open");h=$("#cs_product_brief_view_"+r).find(".mobileButton");if(typeof(h)!=="undefined"&&h!==null&&h.is(":visible")){h.removeClass("collapse");h.addClass("expand")}}})}},error:function(){$("#crossSellAjaxErrorDialog .message").hide();$("#crossSellAjaxErrorDialog .generic").show();tools.dialog.showDialog("crossSellAjaxErrorDialog",true)},complete:function(z,y){$("#cs_product_expand_view_prod_"+r+" .wait_overlay").hide();k.enableAllForms()}})},showCSErrorTooltip:function(i,h){i.tipsy({className:"tipsy-validation cross-sell-tipsy",delayIn:1000,html:true,offset:0,trigger:"manual",gravity:"se",opacity:1,title:function(){return h}}).tipsy("show");setTimeout(function(){i.tipsy("hide")},5000)}}});var proceed2CheckoutFromCart={nextPageUriForcedByBuyerDelete:"",forceNextPageUri:function(a){nextPageUriForcedByBuyerDelete=""+a},validateCartForReducedVisibilityAgrmnt:function(f,e,d,c,b){var a=typeof nextPageUriForcedByBuyerDelete!="undefined"&&nextPageUriForcedByBuyerDelete!==""?nextPageUriForcedByBuyerDelete:""+d,g=c+"/ajax/cart/reservation/visibilityConditionsAgreed";if(b||b===0){g+="?index="+b}if(e){if(f){if(!$("#visibility_checkbox").is(":checked")){$("#reduced_visibility_terms_and_conditions_notification").show();return}}if($("#visibility_checkbox").is(":checked")){$.ajax({url:g,type:"POST",cache:false,dataType:"json",contentType:"application/json",success:function(i,j,h){window.location=a},error:function(h,j,i){tools.dialog.showDialog("ajaxErrorDialog",true)}})}else{window.location=a}}else{window.location=a}}};(function(){var b=null,e=true,d=[],c=function(){var f=b?b.delayAfter:null;if(f){b.delayAfter=null;return setTimeout(c,f)}b=null;a()},a=function(){var h,g,f;if(!e||b||!d.length){return}h=d.splice(0,1)[0];if(h.before){h.before.call(h)}b=h;g=h.fail;if(!g){g=seasontickets.performances.errors.ajaxErrorDialog}f=function(){h.xhr=jQuery.ajax({url:h.url,type:h.method,data:h.data}).fail(g).done(h.done).always(h.always).always(c)};if(h.delay){setTimeout(f,h.delay)}else{f()}};tools.module("requestQueuing",{addRequest:function(f,g){if(g){d.splice(0,0,f)}else{d.push(f)}a()},stop:function(){e=false},start:function(){e=true;a()}});jQuery(window).on("beforeunload",function(){if(!b){return}if(b.xhr){b.xhr.abort();tools.dialog.showWaitingPopup("loadingDialog",true)}})})();tools.module("resale.ajax",function(){var c=null,e,a=null,b=null,d=null;jQuery(window).on("beforeunload",function(){if(d){d.abort()}});return{init:function(){c=$.Callbacks();b=$.Callbacks();e=seasontickets.performances.errors;a=e.ajaxErrorDialog},onCatalogReady:function(g){c.add(g)},onTicketItemsReady:function(g){b.add(g)},loadCatalog:function(){d=$.ajax({url:contextPath+"/list/resale/resaleProductCatalog.json?",dataType:"json"}).done(function(f){c.fire(f)}).fail(a)},loadTicketItems:function(h,g,f){var i;if(h){i="productId="+h}else{if(g){i="performanceId="+g}}tools.dialog.showWaitingPopup("loadingDialog",true);d=$.ajax({url:contextPath+f,data:i,dataType:"json"}).done(function(j){b.fire(j)}).fail(a)}}});tools.module("resale.filter",function(){var e=true,s=$.Callbacks(),d=false,j={},g=null,h=function(){return{dateFrom:j.dateFrom.val(),dateTo:j.dateTo.val(),searchText:j.searchText.val(),topicKey:j.topic.val()}},n=function(x,w){if(x.val()!==w){x.val(w);$(x).parent().find(".filterToolReset").show()}},v=function(){n(j.dateFrom,resale.history.getParam("dateFrom"));n(j.dateTo,resale.history.getParam("dateTo"));n(j.searchText,resale.history.getParam("searchText"));u()},f=function(y){var z,w;try{z=$.datepicker.parseDate(datePickerConfig.dateFormat,j.dateFrom.val());w=$.datepicker.parseDate(datePickerConfig.dateFormat,j.dateTo.val());if(z!==null&&w!==null&&z>w){validation.showErrorTooltip(y,resale.messages.startDateEndDate);return false}}catch(x){validation.showErrorTooltip(y,resale.messages.invalidDate);$(y).focus();return false}return true},u=function(){if(!d){d=true;s.fire(h());d=false}},m=function(){$(".filterToolReset").on("click",function(){$(this).hide().parents(".criteria").find("input, select").val("");u()});$([j.dateFrom,j.dateTo,j.searchText,j.topic]).each(function(){$(this).parent().find(".filterToolReset").hide();$(this).change(function(){if($(this).val()!==""){$(this).closest(".criteria").find(".filterToolReset").show()}else{$(this).closest(".criteria").find(".filterToolReset").hide()}u()})});$([j.dateFrom,j.dateTo]).each(function(){$(this).keydown(function(w){$(this).datepicker("hide");if(w.which===13){w.preventDefault();$(this).trigger("change")}});$(this).change(function(){f($(this))})});j.searchText.keyup(function(w){if(w.which===13){w.preventDefault()}resale.view.showSearchBoxSpinner();clearTimeout(g);resale.view.setFadeDuration(0);g=setTimeout(u,1000);if($(this).val()===""){$(this).closest(".criteria").find(".filterToolReset").hide()}else{$(this).closest(".criteria").find(".filterToolReset").show()}})},i=function(y,C,B){var w,x,A,z;if("OPEN_PASS"===y.productFamilySubType){if("PERIOD"!==y.validityRule){return true}z=tools.date.fromJodaDateTime(y.validTo);A=tools.date.fromJodaDateTime(y.validFrom);if((!C||C<=z)&&(!B||B>=A)){return true}}else{if(!y.availablePerfDate||y.availablePerfDate.length===0){return false}for(w=0;w<y.availablePerfDate.length;w++){x=tools.date.fromJodaDateTime(y.availablePerfDate[w]);if((C===null||C<=x)&&(B===null||x<=B)){return true}}}return false},b=function(x,y){var A=false,z,w;if(y===""){A=true}else{if(x.topicId){z=y.indexOf("-")>0;if(z){w=y.substr(y.indexOf("-"));$.each(x.subTopicIds,function(C,B){if(w.indexOf(B)>=0){A=true;return false}})}else{A=x.topicId.toString()===y}}else{A=false}}return A},t=function(B,C){var y,x=[],A,z,w;if(C===null||typeof C==="undefined"){return true}A=C.replace(/\W/g,"");if(e){x=[A]}else{x=A.split(/\s+/)}for(y=0;y<x.length;y++){z=B.name.replace(/\W/g,"");if(z.toLowerCase().indexOf(x[y].toLowerCase())!==-1){return true}if(B.complement){w=B.complement.replace(/\W/g,"");if(w.toLowerCase().indexOf(x[y].toLowerCase())!==-1){return true}}}return false},r=function(){j.dateFrom=$("#date_from");j.dateTo=$("#date_to");j.searchText=$("#search_text");j.topic=$("#topic")},p=function(){d=true;v();d=false},a=function(x,w){return $("<option></option>").attr("value",x).html(w)},c=function(z,x,w,y){return{topicId:z,key:x,name:w,products:y,visible:y.length>0,showHeader:w!==null&&w!==""}},l=function(x){try{$.datepicker.parseDate(datePickerConfig.dateFormat,x);return true}catch(w){return false}},o=function(){if($(j.searchText).val()!==""){$(j.searchText).val("").trigger("change")}},q=function(w){if(w){$([j.dateFrom,j.dateTo,j.topic]).each(function(){$(this).val("")});resale.sliderFilter.reset();$(j.dateFrom).trigger("change");$(".filterToolReset").hide()}},k=function(){var w=$(".filterToolReset:visible").length>0;$("#search_button").addClass("active");$("#filter_button").removeClass("active");$("#search_box_container").show();$("#filter_container").hide();if(j.searchText.val()===""){$(j.searchText).closest(".criteria").find(".filterToolReset").hide()}else{$(j.searchText).closest(".criteria").find(".filterToolReset").show()}q(w);$(j.searchText).focus()};handleFilterButtonClick=function(){$("#search_button").removeClass("active");$("#filter_button").addClass("active");$("#search_box_container").hide();$("#filter_container").show();o();$(j.topic).focus()};addHandlerToElements=function(w){r();j.dateFrom.placeholder();j.dateTo.placeholder();m();datePickerConfig.onSelect=function(){$(this).trigger("change")};j.dateFrom.datepicker(datePickerConfig);j.dateTo.datepicker(datePickerConfig);$("#search_button").click(k);$("#filter_button").click(handleFilterButtonClick);handleFilterButtonClick()};return{init:function(){var w=$("#list_all_tickets");addHandlerToElements(w);v();resale.history.onHistoryStateChange(p)},initTopics:function(y){for(var w=0,x=y.length;w<x;w++){$("#topic").append(a(y[w].key,y[w].name))}if(resale.history.getParam("topicKey")!==""){j.topic.find("option").filter(function(){return $(this).attr("value")===resale.history.getParam("topicKey")}).attr("selected","selected")}},doFilter:function(z,w){var C=null,B=null,y,A,x;if(j.dateFrom.val()!==null&&j.dateFrom.val()!==""&&l(j.dateFrom.val())){C=$.datepicker.parseDate(datePickerConfig.dateFormat,j.dateFrom.val())}if(j.dateTo.val()!==null&&j.dateTo.val()!==""&&l(j.dateTo.val())){B=$.datepicker.parseDate(datePickerConfig.dateFormat,j.dateTo.val())}if(C!==null&&B!==null&&C>B){C=null;B=null}y=j.searchText.val();x=j.topic.val();w.topicsWithProducts=[];w.products=[];A=[];$.each(z,function(F,E){var D=$.grep(E.products,function(I,K){var J=i(I,C,B),G=t(I,y),H=b(I,x);return(J&&G&&H)});$.merge(A,D);if(D.length>0){w.topicsWithProducts.push(c(E.topicId,E.key,E.name,D))}});w.products=A},doFilterAfterPagination:function(y){var z,x,w,A,C=[],B;for(z=0;z<y.topicsWithProducts.length;z++){w=y.topicsWithProducts[z];B=[];for(x=0;x<y.products.length;x++){A=y.products[x];if(w.topicId===A.topicId){B.push(A)}}if(B.length>0){C.push(c(w.topicId,w.key,w.name,B))}}y.topicsWithProducts=C},onFilterChange:function(w){s.add(w)}}});tools.module("resale.history",function(){var b=$.Callbacks(),e=false,d={},c=false,a=function(){var g,k,h,j,f={};h=window.location.search.substring(1);if(h===""){return f}j=h.split("&");for(g=0;g<j.length;g++){k=j[g].split("=");f[decodeURIComponent(k[0])]=decodeURIComponent(k[1]).replace("+"," ")}return f};return{init:function(){d=a();resale.pagination.onPageChange(this.addParamToUrl);History.Adapter.bind(window,"statechange",function(){if(!c&&!e){e=true;b.fire();e=false}c=false})},getParam:function(f){var g=new RegExp("[\\?&]"+f+"=([^&#]*)").exec(window.location.href);if(g!==null){return g[1]}else{return""}},addParamToUrl:function(g){var f=0;d=$.extend(d,g);for(param in d){if(d[param]===null||d[param]===""){delete d[param]}else{f++}}c=true;if(!e){History.pushState(null,resale.messages.pageTitle,"?"+$.param(d))}},onHistoryStateChange:function(g){b.add(g)}}});tools.module("resale.itemGeneral",function(){var a,b=function(c){c.displayPrice=functions.generateAmount(c.price)};return{SINGLE_ENTRY:"SINGLE_ENTRY",OPEN_PASS:"OPEN_PASS",OPEN_PASS_SHOW_VALIDITY:"OPEN_PASS_SHOW_VALIDITY",UNSPECIFIED_AREA_ID:"unknow",init:function(c){a=c},enhencingItems:function(c,e){var f,d,k,h,g;k=[];for(f=0;f<c.length;f++){h=c[f];b(h);h.frozen=false;h.orderQuantity=0;h.availilities=[];if(e&&e.isTicketsGrouped){h.availilities.push({quantity:0,selected:'selected="selected"'});h.subTotal=functions.generateAmount(0)}for(d=h.minQuantity===0?1:h.minQuantity;d<=h.quantity;d++){h.availilities.push({quantity:d})}if(this.SINGLE_ENTRY===a){if(h.block||h.remark){h.seatPath=h.block+" - "+h.remark}else{h.seatPath=" - "}g=$.map(h.resaleSeats,function(j,i){return j.seatId});h.seatIdString=g.join(";");if(h.areaId){h.isWithoutSeatTicket=false}else{h.isWithoutSeatTicket=true;h.areaId=this.UNSPECIFIED_AREA_ID}h.showAudSubCatLine=h.audienceCategoryKind&&(h.audienceCategoryKind!=="FULL"||h.audienceSubCategoryRank!==1);if(e&&e.isTicketsGrouped){if(k.indexOf(h.seatCategoryId)<0){k.push(h.seatCategoryId);h.hideSeatCat=false;if(c[f-1]){c[f-1].lastInSeatCatGroup=true}}else{h.hideSeatCat=true}if(f==c.length-1){h.lastInSeatCatGroup=true}}}if(this.OPEN_PASS_SHOW_VALIDITY===a){h.showDateColumns=true;h.startValidityDateString=$.datepicker.formatDate(datePickerConfig.dateFormatLong,tools.date.fromJodaDateTime(h.startValidityDate),datePickerConfig);h.endValidityDateString=$.datepicker.formatDate(datePickerConfig.dateFormatLong,tools.date.fromJodaDateTime(h.endValidityDate),datePickerConfig)}if(!(e&&e.isTicketsGrouped)){h.key=h.key+"__"+f}}}}});tools.module("resale.itemSorter",function(){var e=null,d={},a=null,c=function(g,f,h){return(g>f?1:-1)*h},b=function(g,f,h){if(g===f){return 0}else{return(g>f?1:-1)*h}};return{init:function(f){e=jQuery.Callbacks();d.sortColumns=f},updateModel:function(f){d.items=f;if(a!==null){resale.itemSorter.doSort(a,false)}},getSortColumns:function(){return d.sortColumns},sortColumn:function(k,j,g,f,h,i){return{id:k,sortable:j,cssClass:g,linkCssClass:"sort",linkCssDirectionClass:"",sortFunction:f,sortDirection:h,text:i}},doSort:function(j,f){a=j;var g,h;for(g=0;g<d.sortColumns.length;g++){h=d.sortColumns[g];if(h.sortable===false){continue}if(g===a){h.sortDirection.sorted=true;if(f===true){h.sortDirection.direction=-h.sortDirection.direction}h.linkCssDirectionClass=d.sortColumns[a].sortDirection.direction>0?"asc":"desc"}else{h.sortDirection.sorted=false;h.linkCssDirectionClass=""}}if(d.items!==null){d.items.sort(d.sortColumns[a].sortFunction);e.fire(d.items)}},defaultSortDirection:function(){return{sorted:false,direction:1}},zoneSortFunc:function(h,g,m,i){var f,l,k,j;l=m||d.sortColumns[a].sortDirection.direction;k=h.isWithoutSeatTicket?h.seatCatName:h.seatArea;j=g.isWithoutSeatTicket?g.seatCatName:g.seatArea;f=b(k,j,l);if(f===0&&!i){f=resale.itemSorter.subCategorySortFunc(h,g,1)}if(f===0&&!i){f=resale.itemSorter.priceSortFunc(h,g,1)}if(f===0&&!i){f=resale.itemSorter.seatPathSortFunc(h,g,1,true)}return f},subCategorySortFunc:function(g,f,i){var h=i||d.sortColumns[a].sortDirection.direction;return b(g.audienceSubCategory,f.audienceSubCategory,h)},availabilitySortFunc:function(g,f){return(g.quantity-f.quantity)*d.sortColumns[a].sortDirection.direction},seatPathSortFunc:function(m,k,l,j){var h,o,g,f,n;n=l||d.sortColumns[a].sortDirection.direction;if(m.seatPath===" - "&&k.seatPath===" - "){o=0}else{if(m.seatPath===" - "){o=1}else{if(k.seatPath===" - "){o=-1}else{g=m.seatPath.split(" - ");f=k.seatPath.split(" - ");o=0;for(h=0;h<g.length;h++){if(!f[h]){o=1;break}else{if(f[h]!==g[h]){if(!isNaN(g[h])&&!isNaN(f[h])){o=Number(g[h])-Number(f[h])}else{o=b(g[h],f[h],1)}break}}}}}}o=o*n;if(o===0&&!j){o=resale.itemSorter.zoneSortFunc(m,k,1,true)}if(o===0&&!j){o=resale.itemSorter.priceSortFunc(m,k,1)}return o},priceSortFunc:function(g,f,i){var h=i||d.sortColumns[a].sortDirection.direction;return(g.price-f.price)*h},startValidityFunc:function(g,f){var i,h;i=tools.date.fromJodaDateTime(g.startValidityDate);h=tools.date.fromJodaDateTime(f.startValidityDate);return c(i,h,d.sortColumns[a].sortDirection.direction)},endValidityFunc:function(i,g){var h,f;h=tools.date.fromJodaDateTime(i.endValidityDate);f=tools.date.fromJodaDateTime(g.endValidityDate);return c(h,f,d.sortColumns[a].sortDirection.direction)},registerSortCompletedCallback:function(g){e.add(g)}}});tools.module("resale.itemView",function(){var b=null,e=null,c=null,a=null,d=function(f,g){g.html(Mustache.render(b,f,{itemTpl:e}));a.fire(g)};return{init:function(){a=$.Callbacks();$(this);b=$("#itemsTpl").html();e=$("#itemTpl").html();c=$("#seatCategoriesTpl").html()},registerViewRenderedCallbacks:function(g){a.add(g)},render:function(f,g){d(f,g)},renderSeatCategory:function(f,g){g.html(Mustache.render(c,f))}}});tools.module("resale.main",function(){var e=[],g={},d=jQuery.datepicker.formatDate,b=function(){var i={},j;if(e.length>0){resale.filter.doFilter(e,i);resale.pagination.doPaginate(i);resale.filter.doFilterAfterPagination(i);if(i.products.length===0){i.searchResultEmpty=true}}else{i.noTicketsOnSales=true}j=jQuery("#list_all_tickets");resale.view.render(i,j)},h=function(j){var i;if(j.firstPerformanceDate.length>0){i=tools.date.fromJodaDateTime(j.firstPerformanceDate);j.firstPerformanceDate=d(datePickerConfig.dateFormatLong,i,datePickerConfig)}if(j.lastPerformanceDate.length>0){i=tools.date.fromJodaDateTime(j.lastPerformanceDate);j.lastPerformanceDate=d(datePickerConfig.dateFormatLong,i,datePickerConfig)}if(j.validFrom.length>0){i=tools.date.fromJodaDateTime(j.validFrom);j.validFromString=d(datePickerConfig.dateFormatLong,i,datePickerConfig)}if(j.validTo.length>0){i=tools.date.fromJodaDateTime(j.validTo);j.validToString=d(datePickerConfig.dateFormatLong,i,datePickerConfig)}},f=function(i){i.displayMinPrice=functions.generateAmount(i.minPrice)},a=function(){var m,l,k,n;for(m=0;m<e.length;m++){k=e[m];for(l=0;l<k.products.length;l++){n=k.products[l];h(n);f(n);n.singleDatePerformace=(n.firstPerformanceDate&&n.lastPerformanceDate&&n.firstPerformanceDate===n.lastPerformanceDate);n.showPassValidity=("OPEN_PASS"===n.productFamilySubType&&"PERIOD"===n.validityRule);n.singleDatePass=(n.validFromString&&n.validToString&&n.validFromString===n.validToString);n.displayPrice=n.availableQuantity>0;n.productFamilyEvent=jQuery.inArray(n.productFamilySubType,["SIMPLE_TICKET","SPORTING_EVENT"])>-1;n.productFamilyNonDatedPass="OPEN_PASS"===n.productFamilySubType}}},c=function(p){e=p.topicWithProductsList;a();resale.filter.initTopics(p.topics);var o=null,k=null,n,m,q,l,r;for(n=0,q=e.length;n<q;n++){l=e[n];for(m=0;m<l.products.length;m++){r=l.products[m];if(o===null||o>r.minPrice){o=r.minPrice}if(k===null||k<r.minPrice){k=r.minPrice}}}};return{init:function(){resale.history.init();resale.filter.onFilterChange(resale.history.addParamToUrl);resale.ajax.init();resale.filter.init();resale.pagination.init("#list_all_tickets",true);resale.view.init();resale.ajax.onCatalogReady(function(i){jQuery("#loading_mark").hide();c(i);b();tools.triggerLazyImagesRefresh()});resale.filter.onFilterChange(b);resale.pagination.onPageChange(b);resale.ajax.loadCatalog()},pushParam:function(i,j){if(j===null||j===""){delete g[i]}else{g[i]=j}}}});tools.module("resale.openPass.item",function(){var c=[],f={},r=[],d,b,l,t,u={products:null,totalItems:0,totalItemsText:"",totalPrice:0,totalPriceText:functions.generateAmount(0)},i=function(){var v,y,w,x;v=u;v.products=r;for(w=0,x=v.products.length;w<x;w++){v.products[w].odd=(w%2===0)}resale.pagination.doPaginate(v);v.sortColumns=resale.itemSorter.getSortColumns();y=$("#list_open_pass_ticket_items");resale.itemView.render(v,y)},j=function(A){var x,z,y,w=null,v=null;for(x=0,z=c.length;x<z;x++){y=c[x];if(w===null||w>y.price){w=y.price}if(v===null||v<y.price){v=y.price}}$("#item_price_filter").parents(".criteria").find(".filterToolReset").hide().on("click",function(){$(this).hide();resale.sliderFilter.reset();resale.openPass.item.doFilter({minPrice:w,maxPrice:v,dateFrom:d,dateTo:b})});if(w!==null&&v!==null){resale.sliderFilter.init("#item_price_filter",w,v);resale.sliderFilter.registerSlideCallback(function(C,B){if(C!==w||B!==v){$("#item_price_filter").parents(".criteria").find(".filterToolReset").show()}resale.openPass.item.doFilter({minPrice:C,maxPrice:B,dateFrom:d,dateTo:b})})}if(w===v){if(A){$("#item_price_filter_container").hide()}else{$("#item_filters").hide()}}},n=function(v,z,y){var x,w;x=tools.date.fromJodaDateTime(v.startValidityDate);w=tools.date.fromJodaDateTime(v.endValidityDate);if((!z||z<=w)&&(!y||y>=x)){return true}return false},p=function(w,v,x){if((!v||w.price>=v)&&(!x||w.price<=x)){return true}return false},m=function(w){try{$.datepicker.parseDate(datePickerConfig.dateFormat,w);return true}catch(v){return false}},o=function(v,w){c=v.resaleItems;resale.itemGeneral.enhencingItems(c);r=c;resale.itemSorter.updateModel(r);j(w);if(w){resale.validityFilter.updateFilterValuesFromUrl()}if(c.length<=0){$("#controls").hide();$("#no_ticket_on_sale").show()}},s=function(v){r=v;i()},g=function(w){var v=$("#list_open_pass_ticket_items");if(w){v.find("input, a").attr("disabled","disabled");$("#addOtherProducts, #book").attr("disabled","disabled")}else{v.find("input, a").removeAttr("disabled");$("#addOtherProducts, #book").removeAttr("disabled")}},a=function(w,z){var v,y,x=null;for(v=0,y=c.length;v<y;v++){x=c[v];if(x.key===w){x.orderQuantity=z;x.frozen=(z>0);break}}q()},q=function(){var v,x,w=null;u.totalItems=0;u.totalPrice=0;for(v=0,x=c.length;v<x;v++){w=c[v];if(w.orderQuantity>0){u.totalItems+=w.orderQuantity;u.totalPrice+=w.orderQuantity*w.price}}if(u.totalItems===0){u.totalItemsText=""}else{if(u.totalItems===1){u.totalItemsText=resale.messages.singularTicket}else{u.totalItemsText=resale.messages.pluralTickets;u.totalItemsText=u.totalItemsText.replace("{0}",u.totalItems)}}u.totalPriceText=functions.generateAmount(u.totalPrice)},k=function(C,B,x){var z,w,A,v,y;z=h("resaleItemData["+x+"].audienceSubCategoryId",C.audienceSubCategoryId);w=h("resaleItemData["+x+"].itemId",C.itemId);A=h("resaleItemData["+x+"].quantity",C.orderQuantity);v=h("resaleItemData["+x+"].unitAmount",C.price);B.append(z);B.append(w);B.append(A);B.append(v);for(y=0;y<C.movementIds.length;y++){B.append(h("resaleItemData["+x+"].movementIds["+y+"]",C.movementIds[y]))}},h=function(x,w){var v=$('<input type="hidden"></input>');v.attr("id",x).attr("name",x);v.val(w);return v},e=function(v){$("#sort_on_audience_subCat").on("click",function(w){w.preventDefault();w.stopImmediatePropagation();resale.itemSorter.doSort(0,true)});if(v){$("#sort_on_valid_from").on("click",function(w){w.preventDefault();w.stopImmediatePropagation();resale.itemSorter.doSort(1,true)});$("#sort_on_valid_to").on("click",function(w){w.preventDefault();w.stopImmediatePropagation();resale.itemSorter.doSort(2,true)})}$("#sort_on_price").on("click",function(w){w.preventDefault();w.stopImmediatePropagation();resale.itemSorter.doSort(v?3:1,true)})};return{init:function(x,w,y){var v;resale.history.init();u.showDateColumns=y;resale.itemGeneral.init(y?resale.itemGeneral.OPEN_PASS_SHOW_VALIDITY:resale.itemGeneral.OPEN_PASS);resale.ajax.init();resale.pagination.init("#list_open_pass_ticket_items",false);resale.pagination.setPaginationConfiguration({page:1,displayWindow:2,nbPerPage:w});resale.pagination.updatePageNumberFromUrl();resale.itemView.init();resale.itemView.registerViewRenderedCallbacks(function(z){e(y)});resale.ajax.onTicketItemsReady(function(z){tools.dialog.hideDialog("loadingDialog");o(z,y);i()});resale.pagination.onPageChange(i);v=[];v.push(resale.itemSorter.sortColumn("sort_on_audience_subCat",true,"tariff",resale.itemSorter.subCategorySortFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.subCategory));if(y){v.push(resale.itemSorter.sortColumn("sort_on_valid_from",true,"valid_from",resale.itemSorter.startValidityFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.validFrom));v.push(resale.itemSorter.sortColumn("sort_on_valid_to",true,"valid_to",resale.itemSorter.endValidityFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.validTo))}v.push(resale.itemSorter.sortColumn("sort_on_price",true,"unit_price",resale.itemSorter.priceSortFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.price));v.push(resale.itemSorter.sortColumn("sort_on_action",false,"",null,null,""));resale.itemSorter.init(v);resale.itemSorter.registerSortCompletedCallback(s);resale.ajax.loadTicketItems(x,null,"/selection/resale/passResaleItems.json")},pushParam:function(v,w){if(w===null||w===""){delete f[v]}else{f[v]=w}},selectItem:function(y,z,w){if($(w).attr("disabled")=="disabled"){return false}var x,A=0,v;v=$(w).closest("tr");x=v.find(".hidden-quantity select");A=x.val()===""?0:Number(x.val());if(A<=0||A>z){x.addClass("error");return false}a(y,A);i();$("#notification").addClass("hidden")},unselectItem:function(w,v){a(w,0);i()},toggleItem:function(v,w){if(!$(w).hasClass("selected")){this.selectItem(v,1,$("#"+v).find("a"))}else{this.unselectItem(v,$("#"+v).find("a"))}},updateOrderQuantity:function(v,x,w){if(w===true){var y=Number($(v).val());a(x,y);i()}},addToCart:function(x){g(true);var A,w,z,y=null,v=0;A=$(x).parents("form:first");for(w=0,z=c.length;w<z;w++){y=c[w];if(y.orderQuantity>0){k(y,A,v++)}}if(v===0){$("#notification.hidden").removeClass("hidden");g(false)}else{A.submit()}},getTickets:function(){return c},doFilter:function(y){var v,x,w,A=null,z=null;if(y.dateFrom!==null&&y.dateFrom!==""&&m(y.dateFrom)){A=$.datepicker.parseDate(datePickerConfig.dateFormat,y.dateFrom)}if(y.dateTo!==null&&y.dateTo!==""&&m(y.dateTo)){z=$.datepicker.parseDate(datePickerConfig.dateFormat,y.dateTo)}if(A!==null&&z!==null&&A>z){A=null;z=null}else{d=y.dateFrom;b=y.dateTo}if(y.minPrice){l=y.minPrice}if(y.maxPrice){t=y.maxPrice}r=[];for(v=0,x=c.length;v<x;v++){w=c[v];if(n(w,A,z)&&p(w,l,t)){r.push(w)}}resale.itemSorter.updateModel(r);i()}}});tools.module("resale.validityFilter",function(){var d=false,b=$.Callbacks(),n,f,i,k,l,h,a,g,m=function(q,p){p.on("click",function(){$(this).hide();q.val("");e()});p.hide();q.change(function(){if($(this).val()!==""){p.show()}else{p.hide()}if(c($(this))){e()}});q.keydown(function(r){$(this).datepicker("hide");if(r.which===13){r.preventDefault();$(this).trigger("change")}})},c=function(r){var s,p;try{s=$.datepicker.parseDate(datePickerConfig.dateFormat,n.val());p=$.datepicker.parseDate(datePickerConfig.dateFormat,l.val());if(s!==null&&p!==null&&s>p){validation.showErrorTooltip(r,resale.messages.startDateEndDate);return false}}catch(q){validation.showErrorTooltip(r,resale.messages.invalidDate);$(r).focus();return false}return true},j=function(r,p,q){if(r.val()!==q){r.val(q);p.show()}},o=function(){d=true;updateFilterValuesFromUrl();d=false},e=function(){if(!d){d=true;b.fire({dateFrom:n.val(),dateTo:l.val()});d=false}};return{init:function(p){resale.validityFilter.onFilterChange(resale.history.addParamToUrl);resale.validityFilter.onFilterChange(resale.openPass.item.doFilter);resale.history.onHistoryStateChange(o);i=p.validFromId;k=p.validFromParam;a=p.validToId;g=p.validToParam;n=$("#"+i);n.placeholder();f=$("#"+i+"_filterToolReset");l=$("#"+a);l.placeholder();h=$("#"+a+"_filterToolReset");m(n,f);m(l,h);datePickerConfig.onSelect=function(){$(this).trigger("change")};n.datepicker(datePickerConfig);l.datepicker(datePickerConfig)},updateFilterValuesFromUrl:function(){j(n,f,resale.history.getParam(k));j(l,h,resale.history.getParam(g));e()},onFilterChange:function(p){b.add(p)}}});tools.module("resale.pagination",function(){var c={page:1,displayWindow:4,nbPerPage:5},b=$.Callbacks(),a=function(e){if(c.page!==e){c.page=e;b.fire({page:c.page===1?null:c.page})}},d=function(e){e.on("click",".pagination span.page",function(f){var g=$(this);if(!g.hasClass("current")){if(g.hasClass("previous")){a(c.page-1)}else{if(g.hasClass("next")){a(c.page+1)}else{a(parseInt(g.text(),10))}}}f.preventDefault()})};return{init:function(f,e){var g;this.updatePageNumberFromUrl();g=$(f);d(g);if(e){resale.filter.onFilterChange(function(){a(1)})}resale.history.onHistoryStateChange(this.updatePageNumberFromUrl)},goToPage:function(e){a(e)},setPaginationConfiguration:function(e){c=e},updatePageNumberFromUrl:function(){var e=resale.history.getParam("page");if(e===null||e===""){e=1}else{e=parseInt(e,10)}a(e)},onPageChange:function(e){b.add(e)},doPaginate:function(l){var f=[],m=c.page,p=c.displayWindow,k=c.nbPerPage,o=null,n,j,e,g,h;if(l.products.length>k){n=Math.floor(l.products.length/k);if(n!==l.products.length/k){n++}if(m<1){m=1}else{if(m>n){m=n}}c.page=m;e=Math.max(1,Math.min(m-p,n-2*p));g=Math.min(n,Math.max(m+p,e+2*p));for(j=e;j<=g;j++){f.push({index:j,selected:j===m})}o={nbPages:n,page:m,pages:f,hasPages:f.length!==0,hasPrevious:m!==1,hasNext:m!==n,remainBefore:e!==1,remainAfter:g!==n};h=(m-1)*k;l.products=l.products.slice(h,h+k);l.pagination=o}else{o={nbPages:l.products.length>0?1:0,pages:[],hasPages:false};l.pagination=o}}}});tools.module("resale.resell",function(){var g,d,e,b=null,f=function(h){var j=h.indexOf("."),l=0,k;if(j!==-1){l=Math.min(h.length-j-1,secutixAmountDecimalSize);h=h.substring(0,j)+h.substring(j+1,j+1+l)}for(k=l;k<secutixAmountDecimalSize;k++){h+="0"}return parseInt(h,10)},a=function(h){if(h%currencyMinimumAmount===0){return h}return currencyMinimumAmount*Math.floor(h/currencyMinimumAmount)},c=function(i){var h=$("#rawPrice");h.val(functions.getIntPartFromAmount(i.toString())+"."+functions.getMantissaFromAmount(i.toString()))};return{typingTimer:null,init:function(i,j,h){g=i;d=j;e=h;$("#conditionsAccepted").change(function(){resale.resell.formFieldsChanged(true)});$("#rawPrice").blur(function(){resale.resell.formFieldsChanged(true)}).keydown(function(){clearTimeout(resale.resell.typingTimer)}).keyup(function(k){if(k.which!=13){resale.resell.typingTimer=setTimeout(resale.resell.formFieldsChanged,1000)}});$("#submitButton").click(function(){if(resale.resell.validatePrice(true,true)&&resale.resell.validateConditionsCheckbox(true)){$("#resell_tickets_form").submit()}return false});$("#resell_tickets_form").submit(function(){return resale.resell.validatePrice(true,true)&&resale.resell.validateConditionsCheckbox(true)});if(d==e){c(d);resale.resell.validatePrice(false,true)}},formFieldsChanged:function(h){h=h||false;var i=$("#submitButton"),j=resale.resell.validatePrice(h,false)&&resale.resell.validateConditionsCheckbox(false);clearTimeout(resale.resell.typingTimer);if(j){i.removeClass("disabled")}else{i.addClass("disabled")}return j},validatePrice:function(m,l){var o=$("#rawPrice"),p,i,k,n=$("#resale_summary"),j=n.clone(),h,q=$("#main_content_resale_parameters");o.parent().removeClass("error");o.parent().parent().find(".min_max").removeClass("error");$("#nonIntUnitPriceError").hide();$("#amountOutOfBounds").hide();$("#noAmount").hide();if(o.val().length===0){if(l){o.parent().addClass("error");$("#noAmount").show()}resale.resell.closeTicket();return false}if(!$.isNumeric(o.val())||o.val().length>10){o.parent().addClass("error");$("#nonIntUnitPriceError").show();resale.resell.closeTicket();return false}k=f(o.val());k=a(k);if(m){c(k)}if(k<parseInt(d,10)||k>parseInt(e,10)){o.parent().addClass("error");o.parent().parent().find(".min_max").addClass("error");$("#amountOutOfBounds").show();resale.resell.closeTicket();return false}p=functions.generateAmount(k*g);i=functions.generateAmount(k);$("#you_will_receive_amount_top_amount").html(p);$("#summary_price_per_ticket_amount").html(i);$("#summary_subtotal_price_amount").html(p);$("#summary_total_price_amount").html(p);$("#amountPrice").val(k);if(b===null||b!=k){resale.resell.closeTicket();j.attr("id","resale_summary_clone").css({width:n.width()+"px",height:"auto"}).appendTo($("#resale_summary_container"));h=$("#resale_summary_clone").height();$("#resale_summary_clone").remove();n.css({height:h+"px"});q.addClass("summary_displayed");b=k}return true},validateConditionsCheckbox:function(j){var h=$("#conditionsAccepted"),i=h.is(":checked");if(i){h.parent().removeClass("error");$("#conditionsCheckboxUnchecked").hide()}else{if(j){h.parent().addClass("error");$("#conditionsCheckboxUnchecked").show()}}return i},closeTicket:function(){var i=$("#resale_summary"),h=$("#main_content_resale_parameters");if(h.hasClass("summary_displayed")){i.css({height:"0"});h.removeClass("summary_displayed");b=null}}}});tools.module("resale.singleEntry.item",function(){var f=[],l={},x=[],A={products:null,totalItems:0,totalItemsText:"",totalPrice:0,totalPriceText:functions.generateAmount(0)},B=[],t=[],c=[],g=function(){if(TNTS.VISU.visualizer){$("#list_ticket_items tbody tr").hover(function(){var D,C;C=$(this).attr("data-block-id");if(C===""){D=$(this).attr("data-area-id");if(resale.itemGeneral.UNSPECIFIED_AREA_ID!=D){TNTS.VISU.visualizer.highLightBlocks([D])}}else{TNTS.VISU.visualizer.highLightBlocks([C])}},function(){if($("#seat_categories_table").find("input:checked").length>0){d()}else{TNTS.VISU.visualizer.highLightBlocks([])}})}},n=function(E){var C=[],D,F;if(t.length>0||c.length>0){for(i=0,length=E.products.length;i<length;i++){if(E.products[i].blockId===null){D=E.products[i].areaId.toString()}else{D=E.products[i].blockId.toString()}F=E.products[i].seatCategoryId.toString();if((t.length>0&&$.inArray(D,t)>-1)||(c.length>0&&$.inArray(F,c)>-1)){C.push(E.products[i])}}E.products=C}},p=function(){var C,F,D,E;C=A;C.products=x;n(C);for(D=0,E=C.products.length;D<E;D++){C.products[D].odd=(D%2===0)}resale.pagination.doPaginate(C);C.sortColumns=resale.itemSorter.getSortColumns();F=$("#list_ticket_items");resale.itemView.render(C,F)},y=function(C,H){var I=parseInt(C.slice(1),16),D=H<0?0:255,J=H<0?H*-1:H,F=I>>16,E=I>>8&255,K=I&255;return"#"+(16777216+(Math.round((D-F)*J)+F)*65536+(Math.round((D-E)*J)+E)*256+(Math.round((D-K)*J)+K)).toString(16).slice(1)},k=function(){var E=[],F,D,C;$("#seat_categories_table").find("input:checked").each(function(){F=$(this).parent(".seat_category_item").attr("data-blockids");if(F===""){F=$(this).parent(".seat_category_item").attr("data-areaids")}if(F===""){throw"Seat category table does not linked to any block or area"}D=F.split(";");C=D.indexOf(resale.itemGeneral.UNSPECIFIED_AREA_ID);if(C>-1){D.splice(C,1)}E=E.concat(D)});return E},d=function(){var C=[];C=k();if(C.length>0){TNTS.VISU.visualizer.highLightBlocks(C)}},b=function(G){var D,F,C=[],H,E=true;D=A;F=jQuery("#seat_categories_table");$(f).each(function(){if(!B[this.seatCategoryId]){B[this.seatCategoryId]={seatCatColor:this.seatBgColor,seatCatBorder:y(this.seatBgColor,-0.25),seatCatText:this.seatCatName,seatCatTextColor:this.seatCatTextColor,seatCategoryRank:this.seatCategoryRank,seatCatId:this.seatCategoryId,blockIds:[],areaIds:[]}}if(!this.blockId&&!this.areaId){throw"Strange! item has neither blockId nor areaId"}if(this.blockId&&$.inArray(this.blockId,B[this.seatCategoryId].blockIds)===-1){B[this.seatCategoryId].blockIds.push(this.blockId)}else{if(this.areaId&&this.seatCategoryId&&$.inArray(this.areaId,B[this.seatCategoryId].areaIds)===-1){B[this.seatCategoryId].areaIds.push(this.areaId)}}});for(H in B){B[H].blockIdsString=B[H].blockIds.join(";");B[H].areaIdsString=B[H].areaIds.join(";");C.push(B[H])}D.seatCategories=C;D.seatCatSelectionTitle=resale.messages.seatCatSelectionTitle;resale.itemView.renderSeatCategory(D,F);$(".seat_category_item").each(function(){if(E){$(this).addClass("odd")}E=!E;$(this).click(function(K){var I,J;if(K.target.tagName==="INPUT"){t=[];TNTS.VISU.blockManager.resetFilteredBlocks();J=$(this).find("input:checked");I=$(this).attr("data-catids");if(J.length===0){c=c.filter(function(L){return L!=I})}else{c.push(I)}if($("#seat_categories_table").find("input:checked").length>0){if(TNTS.VISU.visualizer){d()}$("#resetSeatCategoryButton").show()}else{if(TNTS.VISU.visualizer){TNTS.VISU.visualizer.highLightBlocks([])}$("#resetSeatCategoryButton").hide()}p()}})});if(C.length<=1){$("#seat_categories_table").hide();$("#seat_categories_table").siblings(".criteria").css("width","100%")}$("#resetSeatCategoryButton").on("click",function(){$(this).closest(".reset_button_wrapper").addClass("invisible");e()}).closest(".reset_button_wrapper").addClass("invisible")},e=function(){c=[];TNTS.VISU.blockManager.resetBlocks()},h=function(C){$(".seat_category_item").each(function(){var D,H,E,F,G;if($(this).attr("data-blockids")!==""){H=$(this).attr("data-blockids").split(";")}else{H=$(this).attr("data-areaids").split(";")}G=$(this).attr("data-catids");F=$(this).find('input[type="checkbox"]');E=false;if(C.length>0){E=true;for(D=0;D<H.length;D++){if($.inArray(H[D],C)<0){E=false;break}}}$(F).prop("checked",E);if(E&&c.indexOf(G)<0){c.push(G)}});if($("#seat_categories_table").find("input:checked").length>0){$("#resetSeatCategoryButton").show()}else{$("#resetSeatCategoryButton").hide()}},q=function(){var E,G,F,D=null,C=null;for(E=0,G=f.length;E<G;E++){F=f[E];if(D===null||D>F.price){D=F.price}if(C===null||C<F.price){C=F.price}}$("#item_price_filter").parents(".criteria").find(".filterToolReset").hide().on("click",function(){$(this).hide();resale.sliderFilter.reset();p()});if(D!==null&&C!==null){resale.sliderFilter.init("#item_price_filter",D,C);resale.sliderFilter.registerSlideCallback(function(L,K){if(L!==D||K!==C){$("#item_price_filter").parents(".criteria").find(".filterToolReset").show()}x=[];var H,J,I;for(H=0,J=f.length;H<J;H++){I=f[H];if(I.price>=L&&I.price<=K){x.push(I)}}resale.itemSorter.updateModel(x);p()})}if(D===C){$("#item_filters").hide()}},z=function(C){x=C;p()},m=function(D){var C=$("#list_ticket_items");if(D){C.find("input, a, select").attr("disabled","disabled");$("#addOtherProducts, #book").attr("disabled","disabled")}else{C.find("input, a, select").removeAttr("disabled");$("#addOtherProducts, #book").removeAttr("disabled")}},a=function(D,G){var C,F,E=null;for(C=0,F=f.length;C<F;C++){E=f[C];if(E.key===D){E.orderQuantity=G;E.frozen=(G>0);break}}w()},w=function(){var C,E,D=null;A.totalItems=0;A.totalPrice=0;for(C=0,E=f.length;C<E;C++){D=f[C];if(D.orderQuantity>0){A.totalItems+=D.orderQuantity;A.totalPrice+=D.orderQuantity*D.price}}if(A.totalItems===0){A.totalItemsText=""}else{if(A.totalItems===1){A.totalItemsText=resale.messages.singularTicket}else{A.totalItemsText=resale.messages.pluralTickets;A.totalItemsText=A.totalItemsText.replace("{0}",A.totalItems)}}A.totalPriceText=functions.generateAmount(A.totalPrice)},s=function(){var C,E,D=null;for(C=0,E=f.length;C<E;C++){D=f[C];if(D.orderQuantity>0){$("select[id="+D.key+"]").val(""+D.orderQuantity)}}},r=function(J,I,E){var G,D,H,C,F;G=o("resaleItemData["+E+"].audienceSubCategoryId",J.audienceSubCategoryId);D=o("resaleItemData["+E+"].seatCategoryId",J.seatCategoryId);H=o("resaleItemData["+E+"].quantity",J.orderQuantity);C=o("resaleItemData["+E+"].unitAmount",J.price);$key=o("resaleItemData["+E+"].key",J.key);I.append(G);I.append(D);I.append(H);I.append(C);I.append($key);for(F=0;F<J.movementIds.length;F++){I.append(o("resaleItemData["+E+"].movementIds["+F+"]",J.movementIds[F]))}},o=function(E,D){var C=$('<input type="hidden"></input>');C.attr("id",E).attr("name",E);C.val(D);return C},u=function(C){f=C.resaleItems;resale.itemGeneral.enhencingItems(f);x=f;resale.itemSorter.updateModel(x);q();if(f.length<=0){$("#controls").hide();$("#no_ticket_on_sale").show()}},v=function(){$("#seat_visualize_column > .content_title").on("click",function(C){var E,D=$(this);E=D.children().children(".block_show_hide");if(E.is(":visible")){E.off("click");if(this.state===undefined||this.state===0){this.state=1;E.removeClass("plus");E.addClass("less");D.parent().addClass("content_shown");D.parent().removeClass("content_hidden")}else{this.state=0;E.removeClass("less");E.addClass("plus");D.parent().addClass("content_hidden");D.parent().removeClass("content_shown")}}})},j=function(){$("#sort_on_zone").on("click",function(C){C.preventDefault();C.stopImmediatePropagation();resale.itemSorter.doSort(0,true)});$("#sort_on_availability").on("click",function(C){C.preventDefault();C.stopImmediatePropagation();resale.itemSorter.doSort(1,true)});$("#sort_on_seat_path").on("click",function(C){C.preventDefault();C.stopImmediatePropagation();resale.itemSorter.doSort(2,true)});$("#sort_on_price").on("click",function(C){C.preventDefault();C.stopImmediatePropagation();resale.itemSorter.doSort(3,true)})};return{init:function(D,C,F,G){var E=0;resale.history.init(false);resale.itemGeneral.init(resale.itemGeneral.SINGLE_ENTRY);resale.ajax.init();resale.pagination.init("#list_ticket_items",false);resale.pagination.setPaginationConfiguration({page:1,displayWindow:2,nbPerPage:C});resale.pagination.updatePageNumberFromUrl();resale.itemView.init();resale.itemView.registerViewRenderedCallbacks(function(H){j();g();for(E;E<G.length;E++){a(G[E],1);p()}s(f)});resale.ajax.onTicketItemsReady(function(H){tools.dialog.hideDialog("loadingDialog");u(H);p();b(F);if(F){initSeatMap();v()}TNTS.VISU.blockManager.onBlockSelection(function(I){c=[];h(I);t=I;resale.pagination.goToPage(1);p()})});resale.pagination.onPageChange(p);resale.itemSorter.init([resale.itemSorter.sortColumn("sort_on_zone",true,"category",resale.itemSorter.zoneSortFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.zone),resale.itemSorter.sortColumn("sort_on_availability",true,"hidden-quantity",resale.itemSorter.availabilitySortFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.availability),resale.itemSorter.sortColumn("sort_on_seat_path",true,"seatPath",resale.itemSorter.seatPathSortFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.seat),resale.itemSorter.sortColumn("sort_on_price",true,"unit_price",resale.itemSorter.priceSortFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.price),resale.itemSorter.sortColumn("sort_on_action",false,"",null,null,"")]);resale.itemSorter.registerSortCompletedCallback(z);resale.ajax.loadTicketItems(null,D,"/selection/resale/resaleItems.json")},pushParam:function(C,D){if(D===null||D===""){delete l[C]}else{l[C]=D}},selectItem:function(F,G,D){if($(D).attr("disabled")=="disabled"){return false}var E,H=0,C;C=$(D).closest("tr");E=C.find(".hidden-quantity select");H=E.val()===""?0:Number(E.val());if(H<=0||H>G){E.addClass("error");return false}a(F,H);p();$("#notification").addClass("hidden")},unselectItem:function(D,C){a(D,0);p()},toggleItem:function(C,D){if(!$(D).hasClass("selected")){this.selectItem(C,1,$("#"+C).find("a"))}else{this.unselectItem(C,$("#"+C).find("a"))}},updateOrderQuantity:function(C,E,D){if(D===true){var F=Number($(C).val());a(E,F);p()}},addToCart:function(E){m(true);var H,D,G,F=null,C=0;H=$(E).parents("form:first");for(D=0,G=f.length;D<G;D++){F=f[D];if(F.orderQuantity>0){r(F,H,C++)}}if(C===0){$("#notification.hidden").removeClass("hidden");m(false)}else{H.submit()}},getTickets:function(){return f},extractDataForSeatmap:function(){var E,C={},G={},D={},F=[];$(f).each(function(){if(this.blockId){if(!G[this.blockId]){G[this.blockId]={color:this.seatBgColor,seatCategory:this.seatArea,availableQuantity:this.quantity,minPrice:this.price,seatCatRank:this.seatCategoryRank}}else{G[this.blockId].availableQuantity+=this.quantity;if(G[this.blockId].minPrice>this.price){G[this.blockId].minPrice=this.price}if(G[this.blockId].seatCatRank>this.seatCategoryRank){G[this.blockId].color=this.seatBgColor;G[this.blockId].seatCategory=this.seatArea;G[this.blockId].seatCatRank=this.seatCategoryRank}}}if(this.areaId&&!this.blockId){if(!D[this.areaId]){D[this.areaId]={color:this.seatBgColor,seatCategory:this.seatArea,availableQuantity:this.quantity,minPrice:this.price}}else{D[this.areaId].availableQuantity+=this.quantity;if(D[this.areaId].minPrice>this.price){D[this.areaId].minPrice=this.price}if(D[this.areaId].seatCatRank>this.seatCategoryRank){D[this.areaId].color=this.seatBgColor;D[this.areaId].seatCategory=this.seatArea;D[this.areaId].seatCatRank=this.seatCategoryRank}}}if(this.resaleSeats.length>0){for(E=0;E<this.resaleSeats.length;E++){seat=this.resaleSeats[E];seat.color=this.seatBgColor;F.push(seat)}}});C.areas=D;C.blocks=G;C.seats=F;return C}}});tools.module("resale.singleEntry.itemWithoutSeating",function(){var a=[],j=[],g={products:null,hasTicketWithReducedTariff:false,totalItems:0,totalItemsText:"",totalPrice:0,totalPriceText:functions.generateAmount(0)},i=function(){var m,p,n,o;m=g;m.products=j;for(n=0,o=m.products.length;n<o;n++){m.products[n].odd=(n%2===0)}m.sortColumns=resale.itemSorter.getSortColumns();p=$("#list_ticket_items");resale.itemView.render(m,p)},b=function(){var o,q,p,n=null,m=null;for(o=0,q=a.length;o<q;o++){p=a[o];if(n===null||n>p.price){n=p.price}if(m===null||m<p.price){m=p.price}}$("#item_price_filter").parents(".criteria").find(".filterToolReset").hide().on("click",function(){$(this).hide();resale.sliderFilter.reset();i()});if(n!==null&&m!==null){resale.sliderFilter.init("#item_price_filter",n,m);resale.sliderFilter.registerSlideCallback(function(v,u){if(v!==n||u!==m){$("#item_price_filter").parents(".criteria").find(".filterToolReset").show()}j=[];var r,t,s;for(r=0,t=a.length;r<t;r++){s=a[r];if(s.price>=v&&s.price<=u){j.push(s)}}resale.itemSorter.updateModel(j);i()})}if(n===m){$("#item_filters").hide()}},f=function(n){var m=$("#list_ticket_items");if(n){m.find("input, a, select").attr("disabled","disabled");$("#addOtherProducts, #book").attr("disabled","disabled")}else{m.find("input, a, select").removeAttr("disabled");$("#addOtherProducts, #book").removeAttr("disabled")}},c=function(n,q){var m,p,o=null;for(m=0,p=a.length;m<p;m++){o=a[m];if(o.key===n){o.orderQuantity=q;o.subTotal=functions.generateAmount(o.orderQuantity*o.price);break}}h()},h=function(){var m,o,n=null;g.totalItems=0;g.totalPrice=0;for(m=0,o=a.length;m<o;m++){n=a[m];if(n.orderQuantity>0){g.totalItems+=n.orderQuantity;g.totalPrice+=n.orderQuantity*n.price}}if(g.totalItems===0){g.totalItemsText=""}else{if(g.totalItems===1){g.totalItemsText=resale.messages.singularTicket}else{g.totalItemsText=resale.messages.pluralTickets;g.totalItemsText=g.totalItemsText.replace("{0}",g.totalItems)}}g.totalPriceText=functions.generateAmount(g.totalPrice)},l=function(){var m,o,n=null;for(m=0,o=a.length;m<o;m++){n=a[m];if(n.orderQuantity>0){$("select[id="+n.key+"]").val(""+n.orderQuantity)}}},k=function(t,s,o){var q,n,r,m,p;q=e("resaleItemData["+o+"].audienceSubCategoryId",t.audienceSubCategoryId);n=e("resaleItemData["+o+"].seatCategoryId",t.seatCategoryId);r=e("resaleItemData["+o+"].quantity",t.orderQuantity);m=e("resaleItemData["+o+"].unitAmount",t.price);s.append(q);s.append(n);s.append(r);s.append(m);for(p=0;p<Math.min(t.movementIds.length,Math.max(t.orderQuantity*10,20));p++){s.append(e("resaleItemData["+o+"].movementIds["+p+"]",t.movementIds[p]))}},e=function(o,n){var m=$('<input type="hidden"></input>');m.attr("id",o).attr("name",o);m.val(n);return m},d=function(m){g.hasTicketWithReducedTariff=m.hasTicketWithReducedTariff;a=m.resaleItems;resale.itemGeneral.enhencingItems(a,{isTicketsGrouped:true});j=a;resale.itemSorter.updateModel(j);b();if(a.length<=0){$("#controls").hide();$("#no_ticket_on_sale").show()}};return{init:function(n,m){resale.history.init(false);resale.itemGeneral.init(resale.itemGeneral.SINGLE_ENTRY);resale.ajax.init();resale.itemView.init();resale.itemView.registerViewRenderedCallbacks(function(o){l(a)});resale.ajax.onTicketItemsReady(function(p){var o;tools.dialog.hideDialog("loadingDialog");d(p);o=[resale.itemSorter.sortColumn("sort_on_seatCat",false,"category",null,null,resale.messages.headers.seatCategory),resale.itemSorter.sortColumn("sort_on_quantity",false,"quantity",null,null,resale.messages.headers.quantity),resale.itemSorter.sortColumn("sort_on_price",false,"unit_price",null,null,resale.messages.headers.price),resale.itemSorter.sortColumn("sort_on_subtotal",false,"subtotal",null,null,resale.messages.headers.subtotal)];if(g.hasTicketWithReducedTariff){o.splice(1,0,resale.itemSorter.sortColumn("sort_on_audience_subCat",true,"reducedTariff",resale.itemSorter.subCategorySortFunc,resale.itemSorter.defaultSortDirection(),resale.messages.headers.reducedTariff))}else{o.splice(1,0,resale.itemSorter.sortColumn("dummy",true,"dummy",null,null,""))}resale.itemSorter.init(o);i()});resale.ajax.loadTicketItems(null,n,"/selection/resale/resaleItemsWithoutSeating.json")},updateOrderQuantity:function(m,n){var o=Number($(m).val());c(n,o);i()},addToCart:function(o){f(true);var r,n,q,p=null,m=0;r=$(o).parents("form:first");for(n=0,q=a.length;n<q;n++){p=a[n];if(p.orderQuantity>0){k(p,r,m++)}}if(m===0){$("#notification.hidden").removeClass("hidden");f(false)}else{r.submit()}}}});tools.module("resale.sliderFilter",function(){var b=null,e=null,d=null,c=null,a=null;return{init:function(g,h,f){h=(h===null)?0:h;f=(f===null)?0:f;b=h;e=f;c=$.Callbacks();d=$(".slider_range",g).slider({range:true,min:h,max:f,values:[h,f],create:function(i,j){$(".ui-slider-handle:first").addClass("handle-left");$(".ui-slider-handle:last").addClass("handle-right");a=$('<div class="tooltip"><div class="tooltip-inner"></div><div class="tooltip-arrow"></div></div>');$(".ui-slider-handle").append(a)},change:function(i,j){c.fire(j.values[0],j.values[1])},stop:function(i,j){if(j.values[0]===h){$(".handle-left > .tooltip").hide()}if(j.values[1]===f){$(".handle-right > .tooltip").hide()}},slide:function(i,j){$(".slider_range").closest(".criteria").find(".filterToolReset").hide();var k;if($(".ui-slider-handle.ui-state-active").hasClass("handle-left")){k=functions.generateAmount(j.values[0]);a=$(".handle-left > .tooltip")}else{k=functions.generateAmount(j.values[1]);a=$(".handle-right > .tooltip")}a.children(".tooltip-inner").html(k);a.show()}});d.append($('<div class="slider_info"></div>').append($('<span class="amount min"></span>').html(functions.generateAmount(h))).append($('<span class="amount max"></span>').html(functions.generateAmount(f))))},reset:function(){d.slider({values:[b,e]});$(".ui-slider-handle > .tooltip").hide()},registerSlideCallback:function(g){c.add(g)}}});tools.module("resale.tickets",function(){var a="field_checkbox_ticket_",b="aud_sub_category_container_content",c=".content.to_resale",e=".button.resell",d=function(f){var g="";if(f.hasClass(b)){f.find(c).each(function(k){var j=jQuery(this).find('input[type="checkbox"]'),h=j.attr("id");if(j.is(":checked")&&h.indexOf(a)!==-1&&h.length>a.length){g+=g!==""?",":"";g+=h.substring(a.length)}})}return g};return{resell:function(g,h){var f=g.parent().parent(),i=d(f);if(i.length>0){window.location.href=h+"?ticketIds="+i}},handleResellButton:function(g){var f=g.parent().parent().parent().parent(),h=d(f),i=f.find(e);if(h.length>0){i.removeClass("disabled")}else{if(!i.hasClass("disabled")){i.addClass("disabled")}}}}});tools.module("resale.view",function(){var e,a,d,b=function(i,h){if(h){$("#"+i).show()}else{$("#"+i).hide()}},c=200,g=function(){c=200},f=function(h,i){i.fadeTo(c,0,function(){i.html(Mustache.render(e,h,{eventTpl:a,nonDatedPassTpl:d}));i.fadeTo(c,1,function(){g();$("#search_box_container .spinner").addClass("invisible")})});b("notification_no_ticket_on_sales",h.noTicketsOnSales);b("notification_search_result_empty",h.searchResultEmpty)};return{init:function(){e=$("#productsListTpl").html();a=$("#eventTpl").html();d=$("#nonDatedPassTpl").html()},render:function(h,i){f(h,i)},setFadeDuration:function(h){c=h},showSearchBoxSpinner:function(){$("#search_box_container .spinner").removeClass("invisible")}}});$(function(){var a=function(){if($.trim($("#search_field").val())){setTimeout(function(){$("#searchForm").submit()},10)}return false};$("#submitSearch").click(a);$("#search_field").keypress(function(b){if(b.keyCode===13){return a()}})});tools.module("seasontickets.category",{performancesPageUrl:"/selection/subscription/performances",validationPageUrl:"/selection/subscription/validation",itemIdMapping:{},redirectToNextStep:function(b,e,c,a){var d=contextPath;if(c){d+=this.performancesPageUrl}else{d+=this.validationPageUrl}if($("#select_category").val()==="0"){$("#notification").show();$("#select_category").addClass("error");window.scrollTo(0,0);return false}d+="?productId="+b+"&subscribers="+e;if(a){d+="&advantageId="+a}d+="&itemId="+this.itemIdMapping[$("#select_category").val()];if($("#select_location").length){d+="&preferredBlockId="+$("#select_location").val()}window.location=d}});tools.module("seasontickets.general",{abandonSeasonTicketConfiguration:function(a){tools.dialog.hideDialog("subscriptionConfigOngoing");tools.dialog.showWaitingPopup("loadingDialog",true);jQuery.ajax({type:"POST",url:contextPath+"/ajax/subscription/abandon",cache:false,success:function(){if(a){location.replace(a)}else{location.reload()}},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},startAssistantCountdown:function(a){jQuery("#configurationAssistant #continueButton").click(function(){tools.dialog.hideDialog("configurationAssistant")});setTimeout(function(){$("select").hide();tools.dialog.showDialog("configurationAssistant",true,false,null,"");$("select").show()},a*1000)}});tools.module("seasontickets.introduction",{showAdditionalEvents:function(a){var b=jQuery(a).closest(".events");b.find(".more_events").remove();b.parent().find(".alternative_button.next").remove();b.find(".additional_events").slideToggle()}});tools.module("seasontickets.performances",function(){var B=null,X=null,S=null,j=null,L=null,o=null,h=null,g=null,k=null,z=null,U=null,u=null,D=false,O=null,I=true,A=null,aa=0,v=false,M=true,P=null,ae=0,W={},f=null,Z=0,J=null,N=null,x=null,c=null,r=null,e=null,i=null,K=false,H=true,s=null,w=function(){},y=0,G=null,t=null,ad=null,C=null,V=false,Y=0,p=0,R={},T=function(ak){var ah=0,ag=u.length,aj=0,af=0,al=false,am=ae===null?0:ae,ai;if(v&&!ak){ae=null}for(;aj<ag;aj++){ah+=u[aj].getNbOptional()}M=A===null||ah<A;aj=am;while(true){if(aj===am){if(af===1){al=M}else{if(af===2){break}}af++}ai=u[aj];if(ai.getNextSelectIndex(al,M)){if(!v&&!ak){ae=aj}else{ai.selections[ai.selectedIndex].selected=false;if(!ak){ae=null}}return true}if(aj===ag-1){aj=0}else{aj++}}if(!ak){e.showWaitingDialog();ae=null}return false},q=function(ah,ag){var ai=true,af=0;if(ah!==false){P=""}$.each(u,function(){var aj;ai=ai&&this.checkCanBook(ah);af+=this.getNbOptional();if(ah!==false&&!ai&&!P){aj=this.cannotBookMessages;if(aj.failedRequest){P=seasontickets.performances.messages.failedRequest;return}if(aj.minimumNotReached){if(u.length===1||this.code===seasontickets.performances.Subject.NO_SUBJECT_CODE){P=seasontickets.performances.messages.minimumNotReached}else{P=seasontickets.performances.messages.minimumNotReachedOnSubject.replace("{0}",this.name)}return}if(aj.missingPerformance){P=seasontickets.performances.messages.missingPerformance;return}if(aj.missingSeatCategory){P=seasontickets.performances.messages.missingSeatCategory;return}if(aj.ongoingRequest){P=seasontickets.performances.messages.ongoingRequest;return}}});if(ai&&ah!==false&&af<aa){ai=false;P=seasontickets.performances.messages.minimumNotReached}return ai},Q=function(){i={page:1,displayWindow:2,nbPerPage:20};if(j){$.each(j,function(){this.selectAreaBlock()})}},F=function(ah){var af={},ag=null;for(ag in ah){if(ah.hasOwnProperty(ag)){af[ag]={id:""+ag,name:ah[ag]}}}return af},E=function(){var af;if(ae!==null){af=u[ae].getSelection();af.selected=false}},a=function(af){return af.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},ac=function(){if(!A){return null}var ah=0,af=u.length,ai=0,ag;for(;ah<af;ah++){ag=u[ah];ai+=ag.getNbSelections()-ag.included}return A-ai},n=function(ag,ao,ah){var an=S[ag],aj=ao.val(),am=parseInt(aj,10),aq=$("tr.additional_seats_audsubcats[data-perfid="+ag+"]"),al=null,af=null,ak=0,ai=$("tr.event_performance[data-perfid="+ag+"]").find("p.add_seats"),ap=an.selectedSeatCategoryId;additionalPrices=l(an.additionalSeatsPrices,an.selectedSeatCategoryId);if(ap&&additionalPrices.length>0){if(ah){b(aq,additionalPrices)}if(aj!=="0"){al=aq.slice(0,am);al.each(function(ar,at){af=$(at).find("select.additional_seats_audsubcat").val();ak=an.getAdditionalSeatPrice(ap,af);$(at).find(".price").html(an.getAdditionalPriceDisplay(ak));$(at).removeClass("hidden");if(ar===0){$(at).find(".additional_seats_count").html(am)}});aq.slice(am).addClass("hidden");al.removeClass("hidden")}else{aq.addClass("hidden")}ai.removeClass("hidden")}else{ao.val("0");aq.addClass("hidden");ai.addClass("hidden")}},l=function(af,ag){if(af){return jQuery.grep(af,function(ah){return ah.seatCategoryId===parseInt(ag,10)})}else{return[]}},b=function(ah,ag){var af="";jQuery.each(ag,function(ai,aj){af+="<option value="+aj.audienceSubCategoryId+">"+aj.audienceSubCategory+"</option>"});jQuery.each(ah,function(ai,aj){$(aj).find("select.additional_seats_audsubcat").html(af);if(ag.length>1){$(aj).find(".audsubcat_select").removeClass("hidden")}else{$(aj).find(".audsubcat_select").addClass("hidden")}})},d=function(){var af=0,ag;for(key in S){ag=S[key].selectedAdditionalSeats;if(ag){af+=ag.length}}return af},m=function(af){var ag=Y;if(!jQuery.isEmptyObject(R)){for(key in R){if(parseInt(key,10)===af){ag=R[key];break}}}return ag},ab=function(){if(!v){return ae!==null}return H&&T(true)};return{messages:null,init:function(ag,ah,ak,ao){seasontickets.performances.errors.init();seasontickets.performances.viewHelper.init();var am=null,ap=null,aq=this,al=function(){if(ap&&am){aq.loadEvents(am);aq.loadConfiguration(ap);T();aq.updateConfDisplay();aq.updatePerformanceList();e.scrollToTop();e.hideWaitingDialog();if(q()){aq.allowBook();if(!ab()||ak){e.showWaitingDialog();aq.finalize()}}}},af=a(window.location.search),ar=seasontickets.performances.errors,ai=ar.ajaxErrorDialog,aj,at,an;J=seasontickets.performances.Selection;N=seasontickets.performances.Event;x=seasontickets.performances.Performance;c=seasontickets.performances.Subject;r=seasontickets.performances.filters;e=seasontickets.performances.viewHelper;D=ah;J.fixedPrice=D;x.fixedPrice=D;t=$("#main_content_seasonticket_performances > .content_title > .title");e.showWaitingDialog();Q();s=$("body").hasClass("ie_lte_9");this.bindEvents();if(ao){af+="&advantageId="+ao}an=D?"fixedPrice/":"";aj=contextPath+"/selection/subscription/"+an+"SeasonTicketCatalog.json";aj+=af+(ag?"&devCookieHost="+ag:"");at=contextPath+"/selection/subscription/"+an+"SeasonTicketConfiguration.json";at+=af;$.ajax({url:aj,dataType:"json"}).done(function(au){if(!au){ar.ajaxErrorDialog();return}am=au;al()}).fail(ai);$.ajax({url:at,dataType:"json"}).done(function(au){if(!au){ar.ajaxErrorDialog();return}if(au.status===ar.ERR_INSUFFICIENT_AVAIL_EVENTS){ar.cantBookErrorDialog()}else{if(au.status===ar.ERR_CART_NOT_EMPTY){ar.emptyCartDialog()}else{if(au.status===ar.ERR_ALREADY_FULL){ar.alreadyFull()}else{ap=au;al()}}}}).fail(ai)},bindEvents:function(){var ag=this,ah=function(ap){var an=$(ap).data("scode"),aj=parseInt($(ap).data("index"),10),am=0,ak=u.length,al,ao=null;E();ag.removeValidationState();for(;am<ak;am++){al=u[am];if(al.code===an){ae=am;al.selectedIndex=aj;ao=al.getSelection();ao.selected=true;break}}return ao},af=function(al,aj){var ak,an,am=q();y--;if(am){ag.allowBook()}else{ag.preventBook()}if(y>0){ag.preventCancelSubscription()}else{ag.allowCancelSubscription()}if(!am||aj){if(aj||!q(false)){e.hideWaitingDialog()}if(ae===null&&!v){ae=0;T()}}else{if(!ab()){ag.finalize()}}if(!al||aj){ag.updatePerformanceList();ag.updateConfDisplay()}else{ak=$("#perf_selection_"+al.id);if(ak.length){ak.removeClass("ongoing").addClass("selected").find(".button").removeClass("invisible")}an=$("#selection_"+al.id);an.addClass("defined modify").removeClass("ongoingbooking");an.find(".wait_overlay").remove();an.find(".success_overlay").removeClass("hidden").each(function(){var ap=$(this),ao=ap.parent().outerHeight();ap.height(ao).css("line-height",ao+"px")});setTimeout(function(){$("#selection_"+al.id).find(".success_overlay").fadeOut("slow");al=null},1000);if(al.optional){an.find("a.remove").removeClass("hidden")}}},ai=function(ak,al,aj){ag.confirmRemoval=function(am){ag.confirmRemoval=w;if(al){aj=ah(al.parents(".event"))}if(aj.mandatory){ag.preventBook()}if(aj){y++;ag.preventCancelSubscription();aj.remove(af)}T();ag.updateConfDisplay();ag.updatePerformanceList();am.preventDefault()};tools.dialog.showWaitingPopup("confirmationDialog_remove",true);ak.stopPropagation();ak.preventDefault()};$("#performances").on("click","#showGroup",function(aj){Q();f=1;W={};ag.updatePerformanceList();e.scrollToTop();aj.preventDefault()}).on("click","#showAll",function(aj){Q();f=0;ag.updatePerformanceList();e.scrollToTop();aj.preventDefault()}).on("click",".event_performance .button a",function(aj){var aw=$(aj.target).parents(".event_performance"),an=aw.data("perfid"),al=aw.data("selectionindex"),au=S[an],ax=$("tr.additional_seats_audsubcats[data-perfid="+an+"]:visible"),aq=ax.length,ay=au.getSubscriberQuantity()*p,ap=au.selectedAdditionalSeats,at=0,ao,am,av,ar,ak;if($(this).parent().hasClass("disabled")){aj.preventDefault();return}if(ap){at=ap.length}if((aq>0)&&((d()-at+aq)>ay)){seasontickets.performances.errors.additionalSeatsFullDialog("additionalSeatsFullDialog",ay);return}if(al||al===0){av=S[an].selections[al];if(!av.selected){E();ar=av.subject;for(ao=0,am=u.length;ao<am;ao++){if(u[ao]===ar){ae=ao}}ar.selectedIndex=av.index;if(av.optional){M=true}av.selected=true;ag.updateConfDisplay();ag.updatePerformanceList();e.scrollToTop();aj.preventDefault();return}}else{au.selectedAdditionalSeats=[];if(aq>0){ax.each(function(){ak=$(this).find("select.additional_seats_audsubcat").val();au.addSelectedAdditionalSeat(au.selectedSeatCategoryId,ak)})}}y++;ag.bookPerformance(an,af);aj.preventDefault()}).on("change","select.category",function(aj){var at=$(aj.target),au=at.parents(".event_performance"),al=au.data("perfid"),ak=at.val(),ap=S[al],an,am,ao,ar=$("tr.additional_seats_audsubcats[data-perfid="+al+"]"),aq=au.find("p.add_seats");if(ak){$("select.category").each(function(){var av=$(this);if(this!==at[0]&&av.val()&&!av.hasClass("single")){av.val("");if(!av.val()){av.change()}}})}ap.selectAreaBlock(ak);am=ap.priceDisplay;au.find(".price").html(am?"<span class='amount'>"+am+"</span>":"").append(aq);an=au.find(".button");ao=ar.find("select.additional_seats_quantity");n(al,ao,true);if(ap.selectedBlockId){an.removeClass("disabled")}else{an.addClass("disabled")}if(s){an.find("*").hide().show()}}).on("change","select.quantity",function(am){var aj=$(am.target),al=aj.parents(".event_performance"),ak=al.data("perfid"),an=parseInt(aj.val(),10),ao=S[ak];ao.selectQuantity(an)}).on("click","a.showPerformances",function(ak){var aj=""+$(this).parents(".event").data("eventid");W[aj]=!W[aj];ag.updatePerformanceList();ak.preventDefault()}).on("click","a.seatmap",function(al){var ak=$(this).parents(".event_performance"),aj=ak.data("perfid"),an=S[aj],am=" ("+an.venue.name+")";viewer.seatView($(this).attr("href"),seasontickets.performances.messages.seatMapTitle+am);al.preventDefault()}).on("click",".pagination span.page",function(aj){var ak=$(this);if(!ak.hasClass("current")){if(ak.hasClass("previous")){i.page--}else{if(ak.hasClass("next")){i.page++}else{i.page=parseInt(ak.text(),10)}}ag.updatePerformanceList();e.scrollToTop()}aj.preventDefault()}).on("click",".add_seats a",function(an){var am=$(an.target),aj=am.parents(".event_performance"),ak=aj.data("perfid"),ao=$("tr.additional_seats_audsubcats[data-perfid="+ak+"]"),al=ao.find(".additional_seats_quantity");if(!ao.is(":visible")){if(al.val()==="0"){al.val("1")}n(ak,al,true)}an.preventDefault()}).on("change","select.additional_seats_quantity",function(am){var aj=$(am.target),al=aj.parents(".additional_seats_audsubcats"),ak=al.data("perfid");n(ak,aj,false)}).on("change","select.additional_seats_audsubcat",function(ao){var aj=$(ao.target),an=aj.parents(".additional_seats_audsubcats"),ak=an.data("perfid"),aq=S[ak],al=aj.val(),ap=aq.selectedSeatCategoryId,am=aq.getAdditionalSeatPrice(ap,al);an.find(".price").html(aq.getAdditionalPriceDisplay(am))});seasontickets.performances.filters.bind(function(){i.page=1;ag.updatePerformanceList();e.scrollToTop()});$("#eventConfiguration").on("click",".event.can_select",function(){Q();ah(this);ag.updateConfDisplay();ag.updatePerformanceList();e.scrollToTop()}).on("click",".modify, .failed",function(al){Q();var am=$(this),ak=am.hasClass("event")?am:am.parents(".event"),aj=ah(ak);if(aj){if(aj.optional){M=true}aj.selected=true}ag.updateConfDisplay();ag.updatePerformanceList();e.scrollToTop();al.preventDefault()}).on("click","a.remove",function(aj){var ak=$(this);ai(aj,ak)});$("#performances").on("click","a.remove",function(al){var aj=ae!==null?u[ae]:null,ak=aj?aj.getSelection():null;ai(al,null,ak)});$(".button.validate").tipsy({html:true,delayIn:200,title:function(){return P}});$(".last .button.disabled").tipsy({live:true,delayIn:200,offset:8,gravity:"se",title:function(){return seasontickets.performances.messages.chooseCategory}});$(".buy_unavailable.last span, .showPerformances div.buy_unavailable").tipsy({live:true,delayIn:200,gravity:"se",title:function(){return seasontickets.performances.messages.performanceIsFull}});$("#eventConfiguration .included").tipsy({live:true,delayIn:200,gravity:"s",title:function(){return seasontickets.performances.messages.included}});$("#eventConfiguration .event .name").tipsy({live:true,delayIn:200,gravity:"s",html:true,title:function(){if(this.offsetWidth>=this.scrollWidth){return""}var al=$(this).parent(),ak=$(this).html(),aj=al.find(".subtitle").html();return"<div class='tipsyName'>"+ak+"</div><div>"+aj+"</div>"}});$(document).on("click",".button.book a",function(aj){if(!$(this).parent().hasClass("disabled")){$("#addToCartForm").submit();$(".button.book").addClass("disabled");tools.dialog.showWaitingPopup("requestProcessingDialog",true)}aj.preventDefault()}).on("click",".button.validate a",function(aj){if(!$(this).parent().hasClass("disabled")){e.showWaitingDialog();ag.finalize(true)}aj.preventDefault()}).on("click",".step.subscribers a, .step.categories a",function(aj){G=$(this).attr("href");tools.dialog.showWaitingPopup("confirmationDialog_edit",true);aj.preventDefault()}).on("click",".step.performances a, #validation_edit_btn",function(ao){var am,an,aj,al,ak;if(ae===null){for(al=0,ak=u.length;al<ak;al++){am=u[al];aj=am.getSelectionToModifyIndex();if(aj!==null){ae=al;am.selectedIndex=aj;an=am.getSelection();an.selected=true;break}}}ag.removeValidationState();ag.updatePerformanceList();ao.preventDefault()});$("#cancelSeasonTicket").on("click",function(aj){if(!$(this).parent().hasClass("disabled")){tools.dialog.showWaitingPopup("confirmationDialog_abandon",true)}aj.preventDefault()})},confirmRemoval:null,confirmEdit:function(af){window.location=G},bookPerformance:function(af,aj){var ag,ai=S[af],ah;if(ae!==null){ag=u[ae].getSelection()}else{ag=ai.event.subject.getFreeMatch()}ag.book(ai,aj);this.preventBook();this.preventCancelSubscription();T();i.target=ai;this.updateConfDisplay();this.updatePerformanceList();ah=$(".event_performance.new");if(ah.length){ah.focus().blur()}else{e.scrollToTop()}i.target=null},loadEvents:function(al){var af=F(al.topicNames),am=al.topicSubTopics,ao,aj,ak,ai,ag,an,ah;h=F(al.subTopicNames);L={};ao=null;for(ao in al.venueNames){if(al.venueNames.hasOwnProperty(ao)){L[ao]={id:""+ao,name:al.venueNames[ao],space:al.spaceNames[ao],spaceCode:ao.split("_")[1],site:al.siteNames[ao],siteCode:ao.split("_")[0],showSpace:al.spaceNames[ao]!=al.siteNames[ao]}}}o=F(al.subjectNames);z=al.seatCategoryNames;g=al.blockNames;k=al.areaNames;V=al.allowAdditionalSeats;Y=al.additionalSeatsMaxQuantityPerPerformance;p=al.additionalSeatsMaxQuantity;R=al.overrrideMaxAdditionalSeatsForSeasonTicketLine;B={};S={};X=[];j=[];for(ao in am){if(am.hasOwnProperty(ao)){aj=am[ao];ak=aj.length;while(ak--){h[""+aj[ak]].topic=af[ao]}}}for(ak=0,ai=al.events.length;ak<ai;ak++){ag=new N(al.events[ak],h);ah=ag.id;X.push(ag);B[ah]=ag}for(ak=0,ai=al.performances.length;ak<ai;ak++){an=new x(al.performances[ak],B,L,z,g,k,null,V,m(al.performances[ak].eventId));ah=an.id;j.push(an);S[ah]=an}Z=j.length/X.length},loadConfiguration:function(al){var an,ai=al.performanceAvailabilities,af=al.maxTicketPerPerformance||10000,ak=al.maxTicketPerEvent||10000,ah=al.subjects,aj=ah?ah.length===1:false,ag=0,am=this.messages.selection;if(al.success===false){if(!seasontickets.performances.errors.handleError(al.status)){seasontickets.performances.errors.ajaxErrorDialog()}}an=al.subscribers;if(!al.orderedSubcribers){O=[];$("#secondary_content_seasonticket .quantity_line").each(function(){var ap=$(this).data("audiencesubcategory"),ao=an[ap];O.push({id:ap,quantity:ao});ag+=ao})}else{O=al.orderedSubcribers}if(ag===1){ad=am.chosenPerformances;C=am.chosenPerformance}else{ad=am.chosenPerformancesMultiple.replace("{1}",ag);C=am.chosenPerformanceMultiple.replace("{1}",ag)}J.setVersion(al.version);$.each(X,function(){this.available=ak;this.noTopics=!aj});$.each(j,function(){this.buildPrices(O);this.setSubscriberQuantity(ag);this.setAvailability(ai[this.id],af)});U={};u=[];A=al.maxOptional;if(!A&&A!==0){A=null}aa=al.minOptional||0;if(aj){aj=ah[0];if(aa&&!aj.minOptional){aj.minOptional=aa}if((A||A===0)&&!aj.maxOptional){aj.maxOptional=A}}v=true;$.each(ah,function(ao){var ap=new c(this,B,S,o,z);if(!ap.allFixed){I=false}u.push(ap);U[ap.code]=ap;ap.index=ao;v=v&&ap.allOptional});if(u.length===1){v=false}if(v){ae=null}$.each(X,function(){this.subject=U[this.subjectCode]})},updateConfDisplay:function(){var af={subjects:[],allFixed:I};$(".included, .name").each(function(){$(this).tipsy("hide")});$.each(u,function(){af.subjects.push(this.getView(!v,M,K))});e.renderConfiguration(af);if(ae!==null){e.adjustCursor()}else{e.hideCursor()}this.updatePrice();q()},updatePerformanceList:function(){$(".last .button.disabled, .buy_unavailable.last span").each(function(){$(this).tipsy("hide")});if(f===null){f=Z>3?1:0}var am=q(false),af={showAll:true,showAllSelected:f===0,showGroup:true,showGroupSelected:f===1,canBook:am,multipleViews:true,categoryOnly:false,areaOnly:false},ah=ae!==null?u[ae]:null,aj=null,ai=ah?ah.getSelection():null,ak,ag,al;this.allowedTicketsNumber=ac();if(!ai&&(!v||v&&!T(true))){$("#performances").html("");e.showWaitingDialog();return}if(ai&&ai.event){ak=ai.event;W={};W[ak.id]=true;if(!ai.categoryOnly){af.eventName=ak.name;aj=[ak]}}else{if(f===1){aj=X.slice(0)}}if(ai&&ai.block){af.isModify=true;af.isRemovable=ai.optional;al=ai.adjustForModify();if(A!==null){A+=al}}if(ai&&ai.categoryOnly){af.events=[ai.event.getView()];ak=af.events[0];ak.performances=ai.performance.getView();ak.selected=true;ak.singleVenue=ak.performances[0].venue;af.categoryOnly=true;if(ak.performances[0].singleCategory){af.areaOnly=true}af.available=ai.event.available&&ai.performance.available}else{if(aj){af.multipleEvents=aj.length>1;af=$.extend(af,N.getViewFromList(aj,ah,r,i,W));if(!af.multipleEvents){af.multipleViews=!ai||!ai.event;if(af.events&&af.events.length){ak=af.events[0];ak.selected=true;if(ak.performances.length===1){af.categoryOnly=true;if(ak.performances[0].singleCategory){af.areaOnly=true}}}}}else{af.allPerformances=true;af.multipleEvents=true;af=$.extend(af,x.getViewFromList(j,ah,r,i))}}if(v&&u.length>1){af.displaySubjects=true}else{af.hasFilterSubjects=false}if(!af.hasFilterSubjects&&!af.hasFilterTopics&&!af.hasFilterEvents&&!af.hasFilterVenue&&!af.hasFilterDates){af.hasFilters=false}else{af.hasFilters=true}if(af.isModify){if(af.categoryOnly){if(af.areaOnly){t.html(this.messages.title.modifyAreas)}else{t.html(this.messages.title.modifySeatCategories)}}else{t.html(this.messages.title.modifyPerformances)}}else{if(af.categoryOnly){if(af.areaOnly){t.html(this.messages.title.areas)}else{t.html(this.messages.title.seatCategories)}}else{t.html(this.messages.title.performances)}}e.renderPerformances(af);ag=!r.hasFiltering(!ai||!ai.event);if(ag){if(af.soldout||!af.available){if(!am){seasontickets.performances.errors.cantBookErrorDialog()}else{e.showWaitingDialog();ae=null;H=false;this.finalize()}}else{H=true}}if(ai&&ai.block){al=ai.adjustForModify(true);if(A!==null){A+=al}}},allowBook:function(){$(".validate.disabled.button","#secondary_content_seasonticket").removeClass("disabled");$(".validate.button").each(function(){$(this).tipsy("hide")});if(s){$(".validate.button","#secondary_content_seasonticket").find("*").hide().show()}},preventBook:function(){$(".validate.button","#secondary_content_seasonticket").addClass("disabled");if(s){$(".validate.button.disabled","#secondary_content_seasonticket").find("*").hide().show()}},allowCancelSubscription:function(){$(".cancel_subscription .cancel").removeClass("disabled")},preventCancelSubscription:function(){$(".cancel_subscription .cancel").addClass("disabled")},updatePrice:function(){var aj=0,ak={},ag=O.length,ah=0,af=$("#secondary_content_seasonticket"),ai;if(D){return}$.each(u,function(){var ap=this.getPrice(O),am=0,an,ao,al;for(;am<ag;am++){an=O[am];ao=an.id;if(!ak[ao]){ak[ao]=0}if(ap[ao]){al=ap[ao]*an.quantity}else{al=0}ak[ao]+=al;aj+=al}aj+=this.getTotalAdditionalSeatsPrice();ah+=this.getNbSelections()});$(".amount",af).html(functions.generateAmount(aj));if(!ah){ai=""}else{if(ah===1){ai=C}else{ai=ad.replace("{0}",ah)}}$(".nb-performances",af).html(ai);$("#secondary_content_seasonticket .quantity_line").each(function(){var al=$(this).data("audiencesubcategory"),am=ak[al]||0;$("span.price",this).html(functions.generateAmount(am))})},finalize:function(ah){var af=u.length-1,ag=this;if(y>0&&!ah){return}while(af--){if(u[af].hasFailure()){return}}requestQueuing.addRequest({url:contextPath+"/ajax/subscription/"+(D?"fixedPrice/":"")+"validation"+a(window.location.search),method:"GET",done:function(ai){ag.setValidationState(ai);tools.displayLazyImages();tools.triggerLazyImagesRefresh();e.hideWaitingDialog()}})},setValidationState:function(af){if(!K){K=true;this.updateConfDisplay();$("#performances").html("");$(".step.performances").removeClass("current").addClass("done");$(".step.validation").addClass("current");$(".button.book").show();$(".button.validate").hide();$(".breadcrumb .current .text").html(this.messages.title.validation);$("#main_content_seasonticket_performances").hide().after(af);$(".button.validate").tipsy("hide");e.scrollToTop()}},removeValidationState:function(){if(K){K=false;this.updateConfDisplay();$("#main_content_seasonticket_performances").show();$("#main_content_seasonticket_validation").remove();$(".step.performances").addClass("current").removeClass("done");$(".step.validation").removeClass("current");$(".button.book").hide();$(".button.validate").show();$(".breadcrumb .current .text").html(this.messages.title.current)}}}});tools.makePath("seasontickets.performances.Event");seasontickets.performances.Event=function(f,a,d){var c,b,e=f.subTopicIds;this.id=""+f.id;this.name=f.name;this.description=f.description;this.logo=f.logo?contextPath+f.logo:null;this.subjectCode=f.subjectCode||seasontickets.performances.Subject.NO_SUBJECT_CODE;this.subtitle=f.subtitle;this.multiplePerformances=f.multiplePerformances;this.uniquePerformance=null;this.performanceList=[];this.performances={};this.available=0;this.selectedPerformances=0;if(e){this.subtopics=[];for(c=0,b=e.length;c<b;c++){this.subtopics.push(a[e[c]])}}this.firstTopicCode=(typeof d!=="undefined"?d[f.id]:null);this.noTopics=false};seasontickets.performances.Event.prototype.addPerformance=function(a){this.performanceList.push(a);this.performances[a.id]=a};seasontickets.performances.Event.prototype.getView=function(b,h){var d=null,a=null,g,f,j,c,e,k;if(b){k=true;c=seasontickets.performances.Performance;j=c.getViewFromList(this.performanceList,h,b,null,true);e=j.performances;for(g=0,f=e.length;g<f;g++){a=e[g].venue;if(!d){d=a}else{if(d.id!==a.id){k=false;break}}}j.onePerformance=f===1;if(k){j.singleVenue=d}}else{j={}}j.name=this.name;j.subtitle=this.subtitle;j.logo=this.logo;j.eventId=this.id;j.available=this.available>0;j.subject=this.subject;if(this.subtopics&&!this.noTopics){j.hasTopics=true;j.subtopics=[];for(g=0,f=this.subtopics.length;g<f;g++){j.subtopics.push({name:this.subtopics[g].name,topic:this.subtopics[g].topic,isLast:g===f-1})}}j.firstTopicCode=this.firstTopicCode;return j};seasontickets.performances.Event.getViewFromList=function(s,o,b,r,k){var q=null,f=[],d=[],a=seasontickets.performances.filters.getName,n=null,h,e,g,p,m,c,j;$.each(s,function(){d=d.concat(this.performanceList)});q=seasontickets.performances.Performance.getViewFromList(d,o,b,null);delete q.performances;n=b.filterEvent?a(b.filterEvent):null;s.sort(function(u,t){var l=u.subject,i=t.subject;if(!l&&!i){return 0}if(!l){return -1}if(!i){return 1}return l.index-i.index});$.each(s,function(){if(!n||n===this.name){if(o&&this.subject!==o){return}g=this.getView(b,o);if(g.performances&&g.performances.length>0){if(g.soldout){g.performances=[]}f.push(g);if(k[this.id]){g.selected=true}}}});if(r){if(r.target){m=r.target.event.id;c=r.target.id;for(h=0,e=f.length;h<e;h++){g=f[h];if(g.eventId===m){r.page=Math.floor(h/r.nbPerPage)+1;r.target=null;g.selected=true;for(h=0,e=g.performances.length;h<e;h++){p=g.performances[h];if(p.id===c){p.isTarget=true;break}}break}}if(r.target){r.page=1;r.target=null}}j=seasontickets.performances.filters.paginate(f,r);f=j.list;q.pagination=j.view}q.events=f;k.nbEvents=f.length;return q};(function(){var a=null,c=function(e){var d=e.getHours(),f=e.getMinutes();d=d<10?"0"+d:""+d;f=f<10?"0"+f:""+f;return d+":"+f},b=function(e,d){return{id:e.id,seatMapImage:e.seatMapImage,venue:e.venue,time:e.time,date:e.date,available:true,defined:true,logo:e.logo,maxTickets:d,quantity:1,multipleTickets:a.fixedPrice,noPriceDisplay:a.fixedPrice}};tools.makePath("seasontickets.performances.Performance");seasontickets.performances.Performance=function(n,f,u,q,w,j,h,t,o){var k=n.start,e=new Date(k[0],k[1]-1,k[2],k[3],k[4],k[5]),g=n.seatCategories,p=jQuery.datepicker.formatDate,d=seasontickets.performances.SeatCategory,v,s,r,m;this.isOptionMode=h;this.id=n.id;this.venue=u[n.venueCode];this.event=f[n.eventId];this.prices=this.getPriceList(false,n.prices);this.seatMapImage=n.seatMapImage?contextPath+n.seatMapImage:null;this.logo=n.logo?contextPath+n.logo:null;this.jsDate=e;this.time=c(e);this.date=p(datePickerConfig.dateFormatLong,e,datePickerConfig);this.dateShort=p(datePickerConfig.dateFormat,e,datePickerConfig);this.dateMedium=p(seasonTicketPerformanceMediumDatePattern,e,datePickerConfig);this.event.addPerformance(this);this.priceDisplay="";this.price=0;this.available=0;this.availability=a.AVAIL_GOOD;this.seatCategories=[];this.allblocks=[];this.blocksMap={};this.selectedSeatCategoryId=null;this.selectedAreaBlockId=null;this.selectedBlockId=null;this.selectedQuantity=1;this.selections=[];for(s=0,r=g.length;s<r;s++){v=g[s];v=new d(v.seatCategoryId,v.areas,q,w,j);this.allblocks=this.allblocks.concat(v.allblocks);this.seatCategories.push(v)}for(s=0,r=this.allblocks.length;s<r;s++){m=this.allblocks[s];this.blocksMap[m.id]=m}if(t!==null){this.allowAdditionalSeats=t;if(t){this.additionalSeatsMaxQuantityPerPerformance=o;this.additionalSeatsPrices=this.getPriceList(true,n.prices)}}};a=seasontickets.performances.Performance;a.prototype.buildPrices=function(k){var g,e,j,d,h,f=this.prices,m=null;if(f){m={};for(g=0,e=f.length;g<e;g++){j=this.prices[g];d=j.audienceSubCategoryId;h=j.seatCategoryId;if(!m[h]){m[h]={}}m[j.seatCategoryId][d]=j.amount}this.priceMap=m}for(g=0,e=this.seatCategories.length;g<e;g++){this.seatCategories[g].buildPrices(m,k)}this.selectAreaBlock()};a.prototype.getPriceList=function(d,e){if(e!==null){return jQuery.grep(e,function(g,f){return g.additionalSeatPrice===d})}else{return null}};a.prototype.setAvailability=function(d,k){var j=d?d.availability:seasontickets.performances.Performance.AVAIL_GOOD,g=d?d.seatCategoryAvailabilities:null,f,h,e;this.availability=j;if(this.availability===seasontickets.performances.Performance.AVAIL_NONE){this.available=0}else{if(k!==null){this.available=k}}if(!g){return}for(h=0,e=this.seatCategories.length;h<e;h++){f=this.seatCategories[h];f.setAvailability(g[f.id])}};a.prototype.selectAreaBlock=function(h){var e=0,d=this.allblocks.length,f=null,g;if(h){h=h.replace(/_\d+$/gi,"")}this.selectedBlockId=null;this.selectedSeatCategoryId=null;this.selectedAreaBlockId=null;this.price=null;this.priceDisplay=null;for(;e<d;e++){g=this.allblocks[e];if(g.id===h){f=g}else{g.selected=false}}if(f){f.selected=true;this.selectedBlockId=f.id;this.selectedSeatCategoryId=f.seatCategoryId;this.selectedAreaBlockId=f.areaBlockId;this.priceDisplay=f.seatCategory.priceDisplay;this.price=this.priceMap?this.priceMap[this.selectedSeatCategoryId]:null}};a.prototype.selectQuantity=function(d){this.selectedQuantity=d};a.prototype.setBooked=function(d){var f=d.quantity,e=this.event;this.available-=f;e.available-=f;e.selectedPerformances+=f;e.uniquePerformance=this.id;this.selections.push(d);this.selectAreaBlock()};a.prototype.setFree=function(e){var d=this.selections.length-1,f=this.event,g;for(;d>=0;d--){g=this.selections[d];if(g===e){quantity=e.quantity;this.available+=quantity;f.available+=quantity;f.selectedPerformances-=quantity;this.selections.splice(d,1)}}if(!f.selectedPerformances){f.uniquePerformance=null}this.selectedQuantity=1};a.prototype.setFailed=function(d){if(d){d.seatCategory.setFailed(d)}};a.prototype.getSelectedBlock=function(){return this.blocksMap[this.selectedBlockId]};a.prototype.getSelectedQuantity=function(){return this.selectedQuantity};a.prototype.getSubscriberQuantity=function(){return this.subscriberQuantity};a.prototype.setSubscriberQuantity=function(d){this.subscriberQuantity=d};a.prototype.getAdditionalPriceDisplay=function(d){return"<span class='plus'>+</span>"+functions.generateAmount(d)};a.prototype.getAdditionalSeatPrice=function(g,f){var e,h=null,d=null;for(e=0;e<this.additionalSeatsPrices.length;e++){h=this.additionalSeatsPrices[e];if(h.seatCategoryId===parseInt(g,10)&&h.audienceSubCategoryId===parseInt(f,10)){d=h;break}}return d.amount};a.prototype.getTotalAdditionalSeatsPrice=function(){var d=0;if(this.selectedAdditionalSeats){jQuery.each(this.selectedAdditionalSeats,function(e,f){d+=f.price})}return d};a.prototype.addSelectedAdditionalSeat=function(f,e){var d=this.getAdditionalSeatPrice(f,e),g={seatCategoryId:f,audienceSubCategoryId:e,price:d};this.selectedAdditionalSeats.push(g)};a.prototype.getView=function(){var h=this.selections,B,m=[],p,q=[],j=[],t,k=null,n,v=this.event.getView(),u=0,A=true,s=this.seatCategories.length,g=null,d=seasontickets.performances.viewHelper,e=this.getMaxTickets(),x=0,z=this.additionalSeatsPrices&&this.additionalSeatsPrices.length>0,w=this.additionalSeatsMaxQuantityPerPerformance&&this.additionalSeatsMaxQuantityPerPerformance>0,f,o,y,r;for(;u<s;u++){t=this.seatCategories[u];if(t.id===this.selectedSeatCategoryId){this.priceDisplay=t.priceDisplay||""}if(t.block.isAvailable){j.push(t)}q.push(t)}for(u=0,s=h.length;u<s;u++){B=h[u];if(B.selected){g=B;break}p=b(this,e);p.event=v;p.selection=true;p.selectionIndex=u;p.selectionId=B.id;p.singleCategory=j.length===1&&!!j[0].getSingleBlock();p.canModify=B.hasSelection&&!B.onGoingBooking;p.onGoingBooking=B.onGoingBooking;p.quantity=B.quantity;p.quantitySingular=B.quantity===1;A=A&&B.booked;n=B.block;if(n){t=n.seatCategory;p.priceDisplay=t.priceDisplay;p.singleBlock={id:n.id,seatCategoryName:t.name,blockName:n.areaBlockId?n.name:""};m.push(p)}}if(g){m=[];this.selectQuantity(g.quantity);if(g.block){this.selectAreaBlock(g.block.id)}}if(this.availability===seasontickets.performances.Performance.AVAIL_NONE){j=[]}if((!this.event.available||(m.length&&!this.available))&&!g){return m}if(m.length&&q.length==1&&!A){return m}if(j.length===1){k=j[0].getSingleBlock();if(k){this.selectAreaBlock(k.id)}else{this.selectAreaBlock(j[0].block.id)}}for(u=0,s=q.length;u<s;u++){q[u]=q[u].getView()}p=b(this,e);p.event=v;p.available=this.available>0;p.defined=!!this.selectedBlockId;p.singleBlock=k;p.singleCategory=j.length===1;p.seatCategories=q;p.priceDisplay=this.priceDisplay;p.soldout=j.length===0&&!this.isOptionMode;p.allowAdditionalSeats=this.allowAdditionalSeats&&w&&z;if(p.allowAdditionalSeats){if(this.selectedAdditionalSeats){x=this.selectedAdditionalSeats.length}f=[];r=j.length===1?j[0].id:this.selectedSeatCategoryId;if(r){y=jQuery.grep(this.additionalSeatsPrices,function(i){return i.seatCategoryId===parseInt(r,10)});jQuery.each(y,function(i,l){o={id:l.audienceSubCategoryId,name:l.audienceSubCategory};f.push(o)})}if(f.length>0||!r){p.additionalSeatsInfo=this.getAdditionalSeatsInfo(this.selectedAdditionalSeats,this.additionalSeatsMaxQuantityPerPerformance,this.getSubscriberQuantity(),f,p.defined,r);p.additionalSeatsQuantity=x}else{p.allowAdditionalSeats=false}}if(g){p.modify=true;p.selection=true;p.quantity=g.quantity}if(p.multipleTickets&&p.maxTickets>1){p.quantityStruct=d.getSelectNumberStructure(p.quantity,1,p.maxTickets);p.hasQuantityStruct=true}if(q.length>0||!a.fixedPrice){m.push(p)}return m};a.prototype.getAdditionalSeatsInfo=function(q,h,o,e,v,n){var p=[],k=0,f=false,w=false,u=false,m=null,l=[],d=null,r="",t=0,s=0,g=false;if(q){k=q.length}for(t=0;t<h*o;t++){r="";if(t<k){f=false}else{f=true}if(k===(t+1)){w=true}else{w=false}l=[];for(s=0;s<e.length;s++){d=e[s];if(q&&t<k&&d.id===parseInt(q[t].audienceSubCategoryId,10)){u=true}else{u=false}m={id:d.id,name:d.name,selected:u&&v};l.push(m)}if(q&&t<k){r=this.getAdditionalPriceDisplay(q[t].price)}g=t===0;p.push({quantity:t+1,selected:w&&v,hidden:f||!v,audSubCatOptions:l,showAudSubCatSelect:l.length>1||!n,price:r,isFirst:g})}return p};a.prototype.getMaxTickets=function(){var d=[this.event.available,this.available,a.MAX_TICKETS],e=this.event.subject.getMaxAllowedTickets(),f=seasontickets.performances.allowedTicketsNumber;if(f){d.push(f)}if(e){d.push(e)}return Math.min.apply(null,d)};a.getViewFromList=function(f,o,e,t,n){var q=null,d=null,m=null,k=true,j,g,p,r,s,h;for(j=0,g=f.length;j<g;j++){r=f[j].getView();if(r.length&&!r[r.length-1].soldout){k=false;break}}q=e.filterAndExtractPerformances(f,o,n);d=q.performances;for(j=0,g=d.length;j<g;j++){d[j]=d[j].getView()}q.soldout=k;d=Array.prototype.concat.apply([],d);h=false;for(j=0,g=d.length;j<g;j++){p=d[j];if(!p.selection){if(!p.soldout&&p.available){h=true;break}}else{if(p.modify){h=true;break}}}q.available=h;if(t){if(t.target){s=t.target.id;for(j=0,g=d.length;j<g;j++){if(d[j].id===s){t.page=Math.floor(j/t.nbPerPage)+1;t.target=null;d[j].isTarget=true;break}}if(t.target){t.page=1;t.target=null}}m=e.paginate(d,t);q.performances=m.list;q.pagination=m.view}else{q.performances=d}return q};a.AVAIL_GOOD="GOOD";a.AVAIL_NONE="NONE";a.AVAIL_LIMITED="LIMITED";a.MAX_TICKETS=20})();(function(){var b=function(d,c){if(c){d.availability=c;if(c===seasontickets.performances.Performance.AVAIL_NONE){d.isAvailable=false}}},a=function(d,c){return d.name>c.name?1:d.name<c.name?-1:0};tools.makePath("seasontickets.performances.SeatCategory");seasontickets.performances.SeatCategory=function(k,f,p,d,m){var n=[],e=[],h,o,g,q,c,j;this.id=""+k;this.name=p[k];this.areas=null;this.allblocks=null;this.blocksMap={};j=this.createBlock("",this.name);e.push(j);this.block=j;for(o=0,h=f.length;o<h;o++){g=f[o];q=g.areaId;j=this.createBlock(q,m[g.areaId]);n.push(j);e.push(j);c=[];j.blocks=c}n.sort(a);this.areas=n;this.allblocks=e};seasontickets.performances.SeatCategory.prototype.createBlock=function(c,d){var e=this.id;return{id:c?""+e+"#"+c:""+e,name:d,selected:false,seatCategory:this,seatCategoryId:e,areaBlockId:""+c,isAvailable:true,availability:seasontickets.performances.Performance.AVAIL_GOOD}};seasontickets.performances.SeatCategory.prototype.setAvailability=function(f){var n,d,o,h,e,m,g,k,c;if(!f){return}b(this.block,f.availability);n=f.areaBlockAvailabilities;if(!n){return}for(m=0,g=this.areas.length;m<g;m++){d=this.areas[m];e=n[d.areaBlockId]||{};b(d,e.areaAvailability);o=e.blockAvailabilities;if(!o){continue}for(k=0,c=d.blocks.length;k<c;k++){h=d.blocks[k];b(h,o[h.areaBlockId])}}};seasontickets.performances.SeatCategory.prototype.getView=function(){var c=this.areas,m=seasontickets.performances.Performance,j=[],k=null,e,d,g,h,f;for(h=0,f=c.length;h<f;h++){d=c[h];g=d.availability;if(k&&k.name===d.name){e=k.availability;if(e!=m.AVAIL_GOOD&&(g=m.AVAIL_GOOD||(e==m.AVAIL_NONE&&g==m.AVAIL_NONE))){j[j.length-1]=d}else{continue}}else{j.push(d)}k=d}return{id:this.id,name:this.name,areas:j,block:this.block,available:!!this.block.isAvailable}};seasontickets.performances.SeatCategory.prototype.getSingleBlock=function(){var e=null,f,d,c;for(d=0,c=this.areas.length;d<c;d++){f=this.areas[d];if(f.isAvailable){if(!e){e=f}else{e=null;break}}}if(e){return{id:e.id,seatCategoryName:this.name,blockName:e.name}}return null};seasontickets.performances.SeatCategory.prototype.buildPrices=function(k,h){var c=[],j=0,e=0,d=h.length,f,g;if(k){for(;e<d;e++){f=h[e];g=k[this.id][f.id];j+=f.quantity*g;g=functions.generateAmount(g);c.push(f.quantity+"<span class='multiplicator'>x</span>"+g)}this.priceDisplay=c.join("<br/>");this.simplePriceDisplay=functions.generateAmount(j)}};seasontickets.performances.SeatCategory.prototype.setFailed=function(f){var e=0,c=this.areas.length,d=false;if(f){f.isAvailable=false;for(;e<c;e++){if(this.areas[e].isAvailable){d=true;break}}}if(!d||!f.areaBlockId){b(this.block,seasontickets.performances.Performance.AVAIL_NONE)}}})();(function(){var d=null,b=0,c=null,e=function(){this.data.version=c},a=new Date(0),h=20000,g=function(){if(new Date()-a<h){return}a=new Date();if(!d){d=$(".countdown_box").length>0}requestQueuing.addRequest({url:contextPath+"/ajax/countdown",method:"GET",delay:1000,delayAfter:1000,done:function(i){if(!$.trim(i)){return}var j=$(i);if(!d){$("#secondary_content_seasonticket .button.validate:first").after(j.find(".countdown_box"))}else{j.find(".countdown_box").remove()}$("#secondary_content_seasonticket").after(j);d=true}},true)},f;tools.makePath("seasontickets.performances.Selection");seasontickets.performances.Selection=function(r,s,l,q,o){var j=r.eventId,m=r.performanceId,k,p,n;this.id=""+b++;this.event=null;this.performance=null;this.seatCategory=null;this.areaBlockId=null;this.fixed=r.fixed===true;this.booked=r.booked===true;this.optional=r.optional===true;this.mandatory=r.mandatory!==false;this.categoryOnly=r.categoryOnly===true;this.hasSelection=(!this.fixed&&!this.booked)||this.categoryOnly;this.onGoingBooking=false;this.failed=false;this.selected=false;this.price=null;this.subject=o;this.block=null;this.index=r.index;this.quantity=r.seatQuantity?r.seatQuantity:0;if(j){this.event=s[j]}if(m){this.performance=l[m];if(!this.performance){seasontickets.performances.errors.cantBookErrorDialog();return}if(r.seatCategoryId&&this.performance){k=r.areaBlockId?r.seatCategoryId+"#"+r.areaBlockId:""+r.seatCategoryId;this.performance.selectAreaBlock(k);this.performance.selectQuantity(this.quantity);p=r.additionalSeatQuantitiesByAudSubCat;if(p&&!jQuery.isEmptyObject(p)){this.performance.selectedAdditionalSeats=[];for(key in p){for(n=0;n<p[key];n++){this.performance.addSelectedAdditionalSeat(r.seatCategoryId,key)}}}this.updateFromPerformance(this.performance);this.performance.setBooked(this)}}};f=seasontickets.performances.Selection;f.prototype.updateFromPerformance=function(i){this.performance=i;this.price=i.price;this.event=i.event;this.quantity=i.getSelectedQuantity();this.block=i.getSelectedBlock();if(this.block){this.seatCategory=this.block.seatCategory;this.areaBlockId=this.block.areaBlockId}if(i.selectedAdditionalSeats){this.selectedAdditionalSeats=i.selectedAdditionalSeats}};f.prototype.setFailed=function(i,j,k){this.onGoingBooking=false;if(this.performance){if(i){this.performance.setAvailability(i,null)}if(!j){this.performance.setFailed(this.block)}}this.reset(true);if(k){this.performance=k.performance;this.performance.selectAreaBlock(k.block.id);this.performance.selectQuantity(k.quantity);this.updateFromPerformance(this.performance);this.performance.setBooked(this);this.subject.sync();return}this.failed=true;if(this.optional){this.subject.removeSelection(this)}};f.prototype.reset=function(i){if(this.performance){this.performance.setFree(this)}if(this.optional&&i){this.event=null}if(!this.categoryOnly){if(this.performance){this.performance=null}}this.seatCategory=null;this.block=null;this.price=null;this.failed=false;this.quantity=0;this.subject.sync()};f.prototype.getView=function(o){var k={optional:this.optional,selected:this.selected,mandatory:this.mandatory,id:this.id,index:this.index,code:this.subject.code,unlock:!this.selected&&!this.isBooked()&&!this.failed&&(this.mandatory&&!this.optional||o&&this.subject.checkCanBook(false)),failed:this.failed,remove:false},n=this.performance,m=1,j;if(this.quantity>1){k.quantity=this.quantity;k.tickets=[];for(j=this.quantity;m<j;m++){k.tickets.push({value:m})}}if(this.event){k.name=this.event.name;k.subtitle=this.event.subtitle;if(n&&!this.selected||this.categoryOnly){k.venue=n.venue.name;k.date=n.dateMedium;k.time=n.time;k.fixed=this.fixed;k.booked=this.booked;if(this.seatCategory&&!this.selected){k.defined=!this.onGoingBooking&&!this.booked;k.category=this.seatCategory.name;k.price=this.seatCategory.simplePriceDisplay;if(n.selectedAdditionalSeats){k.additionalSeatsQuantity=n.selectedAdditionalSeats.length;k.additionalSeatsPrice=functions.generateAmount(n.getTotalAdditionalSeatsPrice());k.singleAdditionalSeat=k.additionalSeatsQuantity===1}}if(k.defined&&this.hasSelection&&!this.onGoingBooking){k.modify=true;k.remove=this.optional}}}k.onGoingBooking=this.onGoingBooking;return k};f.prototype.getPrice=function(i){if(this.price){return this.price[i]*this.quantity}return 0};f.prototype.book=function(r,u){var m=r.selectedSeatCategoryId,p=r.selectedAreaBlockId,l=r.selectedQuantity,q=this,t=this.subject.code,n={performanceId:r.id,eventId:r.event.id,seatCategoryId:m,areaBlockId:p},s=false,o=null,j=[],i=false,k=0;if(t&&t!=seasontickets.performances.Subject.NO_SUBJECT_CODE){n.subjectCode=t}if(l>1){n.quantity=l}if(this.selected&&this.block){if(this.performance===r&&r.getSelectedBlock()===this.block&&this.quantity==l&&this.selectedAdditionalSeats===r.selectedAdditionalSeats){setTimeout(function(){u(q,false)},10);return}o={performance:this.performance,block:this.block,quantity:this.quantity};this.reset(true);s=true}if(s||this.event){n.index=this.index}if(r.selectedAdditionalSeats){$.each(r.selectedAdditionalSeats,function(v,w){j.push(w.audienceSubCategoryId)});n.additionalSeatsAudSubCatIds=j}this.updateFromPerformance(r);this.quantity=l;r.setBooked(this);this.subject.sync();this.failed=false;this.onGoingBooking=true;requestQueuing.addRequest({data:n,url:contextPath+"/ajax/subscription/"+(f.fixedPrice?"fixedPrice/":"")+"createOperation"+window.location.search,method:"POST",done:function(v){if(v.version){c=v.version}if(v.success){g();q.onGoingBooking=false;q.failed=false}else{if(v.status){if(!seasontickets.performances.errors.handleError(v.status)){if(v.status===seasontickets.performances.errors.ERR_AVAILABILITY){k=v.availability-q.performance.subscriberQuantity;if(q.performance.selectedAdditionalSeats&&q.performance.selectedAdditionalSeats.length>0&&k>0){i=true;seasontickets.performances.errors.additionalSeatsFullDialog("additionalSeatsAvailabilityErrorDialog",k)}else{seasontickets.performances.errors.bookingFailedErrorDialog(q)}q.setFailed(v.updatedAvailability,i,o)}else{q.setFailed(null,false,o)}}}else{if(typeof v==="string"){return seasontickets.performances.errors.sessionExpiredErrorDialog()}}}u(q,q.failed)},fail:function(v){if(seasontickets.performances.errors.ajaxErrorDialog(v)){q.setFailed();requestQueuing.stop()}u(q,true)},before:e})};f.prototype.remove=function(k){var i=this.subject.code,j={index:this.index};if(i===seasontickets.performances.Subject.NO_SUBJECT_CODE){i=null}if(i){j.subjectCode=i}if(this.seatCategory){this.seatCategory.available+=this.quantity;this.performance.setFree(this);if(this.performance.selectedAdditionalSeats){this.performance.selectedAdditionalSeats=[]}}this.price=null;this.subject.removeSelection(this);requestQueuing.addRequest({data:j,url:contextPath+"/ajax/subscription/"+(f.fixedPrice?"fixedPrice/":"")+"cancelOperation"+window.location.search,method:"POST",done:function(l){if(l.version){c=l.version}k()},fail:function(l){if(seasontickets.performances.errors.ajaxErrorDialog(l)){requestQueuing.stop()}k(null,true)},before:e})};f.prototype.isBooked=function(){return this.block||this.booked};f.prototype.adjustForModify=function(i){if(!this.performance){return 0}var l=i?-this.quantity:this.quantity,k=this.event,j=k.subject;k.available+=l;this.performance.available+=l;if(this.optional){if(j.maxOptional!==null){j.maxOptional+=l}}else{j.included+=l}if(i){k.uniquePerformance=this._tempUniquePerformance}else{this._tempUniquePerformance=k.uniquePerformance;k.uniquePerformance=null}return l};f.setVersion=function(i){c=i}})();tools.makePath("seasontickets.performances.Subject");seasontickets.performances.Subject=function(f,h,c,j,g,a){var i=seasontickets.performances.Selection,b=[],d=0,e=this;this.code=f.subjectCode;this.minOptional=f.minOptional||0;this.maxOptional=f.maxOptional;this.selectedIndex=0;this.name=this.code?j[this.code].name:"";this.allFixed=true;this.cannotBookMessages={};this.index=0;this.optional=0;this.canHaveOptional=this.maxOptional!==0;if(!this.code){this.code=seasontickets.performances.Subject.NO_SUBJECT_CODE}jQuery.each(f.configuration,function(){var k=new i(this,h,c,g,e,a);k.index=b.length;b.push(k);if(!k.optional){d+=k.quantity}if(!k.fixed){this.allFixed=false}});this.selections=b;this.sync();this.included=d;this.allOptional=d===0};seasontickets.performances.Subject.prototype.getSelection=function(){return this.selections[this.selectedIndex]};seasontickets.performances.Subject.prototype.getNextSelectIndex=function(f,h){var b=this.selections.length,c=0,d=this.selections[this.selectedIndex],e=false,a=false,g=0;h=h&&this.maxOptional>0;this.canHaveOptional=h;if(d){d.selected=false}if(b===0){if(this.maxOptional!==0){this.addOptionalSelection(false);b++}}for(;c<b;c++){d=this.selections[c];g+=d.quantity;if(c===this.selectedIndex&&a){break}if(!d.isBooked()){if(f||d.mandatory){e=true;break}return false}if(c===b-1){if(!h||this.maxOptional&&g===this.included+this.maxOptional){c=-1;a=true}else{this.addOptionalSelection(false);if(f){e=true}else{c=-1;a=true;b++}}}}if(!e){return false}this.selectedIndex=c;this.selections[this.selectedIndex].selected=true;return true};seasontickets.performances.Subject.prototype.getView=function(b,k,d){var g={subjectName:this.name,subjectCode:this.code},a=[],j=[],e=[],f=0,c=this.selections.length,h;this.canHaveOptional=k;if(!d){for(;f<c;f++){h=this.selections[f].getView(b);if(h.unlock||h.selected){b=false}if(h.optional){if(h.mandatory||k||h.defined||h.onGoingBooking||h.selected){e.push(h)}}else{if(h.booked){j.push(h)}else{a.push(h)}}g.mandatory=f<this.minOptional}g.bookedEvents=j;g.hasBookedEvents=j.length>0;g.hasOneBookedEvent=j.length===1;g.events=a;g.hasEvents=a.length>0;g.hasOneEvent=a.lengh===1;g.optionalEvents=e;g.hasOptionalEvents=e.length>0}else{g.validation=true;g.totalSelected=this.getNbSelections();g.hasOneSelectedEvent=g.totalSelected===1}g.hasMinOnly=!!this.minOptional&&!this.maxOptional;g.hasMaxOnly=!!this.maxOptional&&!this.minOptional;if(this.minOptional&&this.maxOptional){g.isFixed=this.minOptional===this.maxOptional;g.hasMinMax=!g.isFixed}g.noMinNoMax=!this.minOptional&&!this.maxOptional;if(g.hasMinOnly&&this.minOptional===1){g.hasMinOnly=false;g.hasMinOnlySingular=true}if(g.hasMaxOnly&&this.maxOptional===1){g.hasMaxOnly=false;g.hasMaxOnlySingular=true}if(g.isFixed&&this.maxOptional===1){g.isFixed=false;g.isFixedSingular=true}g.minOptional=this.minOptional;g.maxOptional=this.maxOptional;return g};seasontickets.performances.Subject.prototype.getPrice=function(c){var b={},a=c.length;$.each(this.selections,function(){var d=0,e,f;for(;d<a;d++){e=c[d];f=e.id;if(!b[f]){b[f]=0}b[f]+=this.getPrice(f)}});return b};seasontickets.performances.Subject.prototype.getTotalAdditionalSeatsPrice=function(){var b=0,a=null;$.each(this.selections,function(){a=this.performance;if(a!==null){b+=a.getTotalAdditionalSeatsPrice()}});return b};seasontickets.performances.Subject.prototype.checkCanBook=function(a){var c=true,b={};$.each(this.selections,function(){if(a!==false&&this.onGoingBooking){b.ongoingRequest=true;c=false}if(this.mandatory){if(this.failed){b.failedRequest=true;c=false}else{if(!this.isBooked()&&!this.oldSelection){if(this.optional){b.minimumNotReached=true}else{if(this.performance){b.missingSeatCategory=true}else{b.missingPerformance=true}}c=false}}}});this.cannotBookMessages=b;return c};seasontickets.performances.Subject.prototype.removeSelection=function(d){var c=0,a=this.selections.length,b;for(;c<a;c++){b=this.selections[c];if(b===d){this.selections.splice(c,1);if(this.selectedIndex>c){this.selectedIndex--}}}this.sync();if(d.selected){this.selectedIndex=0}};seasontickets.performances.Subject.prototype.checkCanAdd=function(a){return this.getFreeMatch(a,true)!==null};seasontickets.performances.Subject.prototype.getFreeMatch=function(e,d){var b=0,a=this.selections.length,c=null;for(;b<a;b++){c=this.selections[b];if(!c.isBooked()&&!c.onGoingBooking){if((c.optional&&(c.mandatory||this.canHaveOptional))||c.event&&c.event===e.event){return c}}}return null};seasontickets.performances.Subject.prototype.addOptionalSelection=function(a){this.selections.push(new seasontickets.performances.Selection({optional:true,index:this.selections.length,mandatory:a},null,null,null,this))};seasontickets.performances.Subject.prototype.hasFailure=function(){var b=0,a=this.selections.length;for(;b<a;b++){if(this.selections[b].failed){return true}}return false};seasontickets.performances.Subject.prototype.getNbSelections=function(){var c=0,b=0,a=this.selections.length;for(;b<a;b++){c+=this.selections[b].quantity}return c};seasontickets.performances.Subject.prototype.getNbOptional=function(){return this.optional};seasontickets.performances.Subject.prototype.getSelectionToModifyIndex=function(){var b=0,a=this.selections.length,c;for(;b<a;b++){c=this.selections[b];if(c.block&&c.hasSelection){return b}}return null};seasontickets.performances.Subject.prototype.sync=function(){var c=0,e=this.selections,a=e.length,b=0,h=0,g=1,d,f;for(;c<a;c++){d=e[c];d.index=c;g=d.quantity;if(d.optional){f=b<this.minOptional;if(f){d.mandatory=true;b+=g||1;h+=g||1}else{h+=g;if(d.mandatory){if(!d.isBooked()){e.splice(c,1);a--;c--}else{d.mandatory=false}}else{if(h==this.maxOptional&&!g){e.splice(c,1);a--;c--}}}}}while(b<this.minOptional){this.addOptionalSelection(true);b++;h++;g=0}if(this.canHaveOptional&&g&&(this.maxOptional===null||h<this.maxOptional)){this.addOptionalSelection(false)}this.optional=h};seasontickets.performances.Subject.prototype.getMaxAllowedTickets=function(){if(this.maxOptional===null){return null}return this.maxOptional+this.included-this.getNbSelections()};seasontickets.performances.Subject.NO_SUBJECT_CODE="__NO_SUBJECT__";tools.module("seasontickets.performances.errors",{ERR_CONCURRENT_MODIFICATION:"ERR_CONCURRENT_MODIFICATION",ERR_CONFIGURATION_NOT_FOUND:"ERR_CONFIGURATION_NOT_FOUND",ERR_TOO_MANY_TICKETS:"ERR_TOO_MANY_TICKETS",ERR_TOO_FEW_TICKETS:"ERR_TOO_FEW_TICKETS",ERR_AVAILABILITY:"ERR_AVAILABILITY",ERR_INSUFFICIENT_AVAIL_EVENTS:"ERR_INSUFFICIENT_AVAIL_EVENTS",ERR_CART_NOT_EMPTY:"ERR_CART_NOT_EMPTY",ERR_ALREADY_FULL:"ERR_ALREADY_FULL",ADVANTAGE_ALREADY_USED_ATTRIBUTE:"ADVANTAGE_ALREADY_USED_ATTRIBUTE",handleError:function(a){if(a===this.ERR_CONCURRENT_MODIFICATION||a===this.ERR_CONFIGURATION_NOT_FOUND){tools.dialog.showDialog("orderLockError",true,true,null,"message_dialog")}else{if(a===this.ERR_TOO_MANY_TICKETS){tools.dialog.showDialog("tooManyTickets",true,true,null,"message_dialog")}else{if(a===this.ERR_TOO_FEW_TICKETS){tools.dialog.showDialog("tooFewTickets",true,true,null,"message_dialog")}else{if(a===this.ERR_CART_NOT_EMPTY){this.emptyCartDialog()}else{if(a===this.ADVANTAGE_ALREADY_USED_ATTRIBUTE){tools.dialog.showDialog("advantageAlreadyUsed",true,true,null,"message_dialog")}else{return false}}}}}return true},ajaxErrorDialog:function(a){if(a.statusText!=="abort"){tools.dialog.showDialog("ajaxErrorDialogReload",true,true)}},cantBookErrorDialog:function(){tools.dialog.showDialog("cantBookSeasonTicket",true,true)},additionalSeatsFullDialog:function(b,a){var d=$("#"+b).find(".message"),c=d.html().replace("{0}",a);d.html(c);tools.dialog.showDialog(b,true,false)},sessionExpiredErrorDialog:function(){tools.dialog.showDialog("sessionExpiredDialog",true,true)},bookingFailedErrorDialog:function(a){var c=a.performance,b;if(c){b=c.event;$("#bookingFailedDialog .event").html(b.name);$("#bookingFailedDialog .day").html(c.date);$("#bookingFailedDialog .time").html(c.time);$("#bookingFailedDialog .category").html(a.block.name);tools.dialog.showDialog("bookingFailedDialog",true,true)}},emptyCartDialog:function(){tools.dialog.showDialog("emptyCartDialog",true,true);$("#emptyCartDialogAbandon").click(function(){tools.dialog.hideDialog("emptyCartDialog");tools.dialog.showWaitingPopup("loadingDialog",true);$.post(contextPath+"/ajax/subscription/fixedPrice/clearShoppingCart").done(function(){window.location.reload()}).fail(seasontickets.performances.errors.ajaxErrorDialog)});$("#emptyCartDialogFinalize").click(function(){window.location.href=contextPath+"/cart/shoppingCart"})},alreadyFull:function(){var a=window.location.href;a=a.replace(/selection\/subscription.*performances/,"account/subscription/detail");a=a.replace("movementIds","movementId");a=a.replace("parentOrderId","orderId");window.location.href=a},init:function(){$("#bookingFailedContinue").on("click",function(a){tools.dialog.hideDialog("bookingFailedDialog");a.preventDefault()})}});tools.module("seasontickets.performances.filters",function(){var c={},h={},d=1,a={},e=function(i){return jQuery.datepicker.formatDate("MM yy",i,datePickerConfig)},b=function(j){var k=a[j],i;if(k){return k}i=j.split("/");k=e(new Date(i[1],i[0]-1,1));a[j]=k;return k},g=function(j,i){var l=j.name?j.name.toLowerCase():"",k=i.name?i.name.toLowerCase():"";return l>k?1:l<k?-1:0},f=function(l,k){var j=null,i=[];for(j in l){if(l.hasOwnProperty(j)){i.push(k(j,l[j]))}}return i};return{filterSubtopic:null,filterSubject:null,filterEvent:null,filterVenue:null,filterDay:null,filterMonth:null,reset:function(){this.filterSubtopic=null;this.filterEvent=null;this.filterVenue=null;this.filterDay=null;this.filterMonth=null;this.filterSubject=null},hasFiltering:function(i){var j=this.filterSubtopic||this.filterVenue||this.filterDay||this.filterMonth||this.filterSubject;if(i){j=j||this.filterEvent}return !!j},bind:function(j){var i=this;$("#performances").on("change","#filterEvent",function(){i.filterEvent=$(this).val();j()}).on("change","#filterVenue",function(){i.filterVenue=$(this).val();j()}).on("change","#filterTopic",function(){i.filterSubtopic=$(this).val();j()}).on("change","#filterSubject",function(){i.filterSubject=$(this).val();j()}).on("change","#filterDate",function(){var k=$(this).val();if(/^\d+$/.test(k)){i.filterDay=k;i.filterMonth=null}else{i.filterDay=null;i.filterMonth=k}j()}).on("click","#filterEventToolbar .filterToolReset",function(k){i.filterEvent=null;k.preventDefault();j()}).on("click","#filterVenueToolbar .filterToolReset",function(k){i.filterVenue=null;k.preventDefault();j()}).on("click","#filterTopicToolbar .filterToolReset",function(k){i.filterSubtopic=null;k.preventDefault();j()}).on("click","#filterSubjectToolbar .filterToolReset",function(k){i.filterSubject=null;k.preventDefault();j()}).on("click","#filterDateToolbar .filterToolReset",function(k){i.filterDay=null;i.filterMonth=null;k.preventDefault();j()})},sortPerNames:function(i){return i.sort(g)},getId:function(i){if(!c[i]){c[i]=d;h[d]=i;d++}return""+c[i]},getName:function(i){return h[i]},paginate:function(j,i){return pagination.paginate(j,i)},filterAndExtractPerformances:function(N,U,u){var n={},o=[],r=datePickerConfig.dayNames,z=this,T=false,p=null,S,Q,R,A,V,D,w,C,E,Y,v,Z,t,q,P,k={},J={},I={},x={},W={},y={},H={},m=[],G=[],L=[],O=[],s=[],F=[],K=[],X=false,B=0,M=0;for(S=0,Q=N.length;S<Q;S++){E=N[S];Y=E.event;w=Y.noTopics?null:Y.subtopics;v=E.venue;Z=E.jsDate;t=Y.subject;P=false;q=E.selections;if(q&&q.length){R=q.length;while(R--){P=q[R].selected;if(P){break}}}if(!Y.multiplePerformances&&Y.uniquePerformance&&Y.uniquePerformance!==E.id){continue}X=E.availability!==seasontickets.performances.Performance.AVAIL_NONE&&E.available!==0;X=X&&Y.available!==0;if(X){B++}if(!P){B+=E.selections.length}if(!U){if(!t.checkCanAdd(E)){continue}}else{if(t!==U){continue}}H[this.getId(t.name)]=t.name;J[this.getId(v.name)]=v.name;I[Z.getDay()]=true;x[(Z.getMonth()+1)+"/"+Z.getFullYear()]=Z;if(p===null){p=Y.id}else{if(p&&p!==Y.id){p=false}}C=false;if(w){for(R=0,V=w.length;R<V;R++){D=w[R];y[D.id]=D;if(D.id===this.filterSubtopic){C=true}}}if(this.filterSubject&&this.getName(this.filterSubject)!==t.name||this.filterSubtopic&&!C){continue}k[this.getId(Y.name)]=Y.name;if(this.filterEvent&&this.getName(this.filterEvent)!==Y.name||this.filterVenue&&v.name!==this.getName(this.filterVenue)||this.filterDay&&""+Z.getDay()!==this.filterDay||this.filterMonth&&(Z.getMonth()+1)+"/"+Z.getFullYear()!==this.filterMonth){continue}if(X){M++}if(P){if(!X){M+=1}}else{M+=E.selections.length}o.push(E)}if(!u){if(this.filterSubject&&!(this.filterSubject in H)){this.filterSubject=null;T=true}if(this.filterSubtopic&&!y[this.filterSubtopic]){this.filterSubtopic=null;T=true}if(this.filterEvent&&!k[this.filterEvent]){this.filterEvent=null;T=true}if(this.filterVenue&&!J[this.filterVenue]){this.filterVenue=null;T=true}if(this.filterDay&&!I[this.filterDay]){this.filterDay=null;T=true}if(this.filterMonth&&!x[this.filterMonth]){this.filterMonth=null;T=true}if(T){return this.filterAndExtractPerformances(N,U,true)}}n.performances=o;n.filters=this;n.filteredNbPerformances=M;n.totalNbPerformances=B;n.filterResultCountAll=(M===B&&M>1);n.filterResultCountAllOne=(M===B&&M===1);n.filterResultCountOne=(M!==B&&M===1);n.filterResultCountNone=(B===0||M===0);n.filterResultCountSome=!(n.filterResultCountAll||n.filterResultCountAllOne||n.filterResultCountOne||n.filterResultCountNone);m=f(J,function(i,j){return{name:j,id:i,selected:i===z.filterVenue}});this.sortPerNames(m);n.filterVenues=m;n.hasFilterVenues=m.length>1;n.hasFilterVenue=!!this.filterVenue;if(p===false){O=f(k,function(i,j){return{name:j,id:i,selected:i===z.filterEvent}});this.sortPerNames(O);n.filterEvents=O;n.hasFilterEvents=O.length>1;n.hasFilterEvent=!!this.filterEvent;F=f(y,function(i,j){return{name:j.name,id:i,topic:j.topic,selected:i===z.filterSubtopic}});this.sortPerNames(F);$.each(F,function(){var i=this.topic.id;if(!W[i]){W[i]=[]}W[i].push(this)});for(A in W){if(W.hasOwnProperty(A)){s.push({name:W[A][0].topic.name,subtopics:W[A]})}}this.sortPerNames(s);n.filterTopics=s;n.hasFilterSubtopics=F.length>1;n.hasFilterSubtopic=!!this.filterSubtopic;K=f(H,function(i,j){return{name:j?j:null,id:i,selected:i===z.filterSubject}});this.sortPerNames(K);n.filterSubjects=K;n.hasFilterSubjects=K.length>1;n.hasFilterSubject=!!this.filterSubject}G=f(I,function(i,j){return{name:r[i],id:i,selected:i===z.filterDay,dayIndex:parseInt(i,10)}});if(G.length){G.sort(function(j,i){return j.dayIndex>i.dayIndex?1:-1});if(!G[0].dayIndex){G.push(G.shift())}}n.filterDays=G;L=f(x,function(i,j){return{name:b(i),id:i,selected:i===z.filterMonth,jsDate:j}});L.sort(function(i,j){return i.jsDate>j.jsDate?1:-1});n.filterMonths=L;n.hasFilterDates=G.length>1||L.length>1;n.hasFilterDate=!!this.filterDay||!!this.filterMonth;n.hasFilter=n.hasFilterSubjects||n.hasFilterTopics||n.hasFilterEvents||n.hasFilterDates||n.hasFilterVenues;return n}}});tools.module("seasontickets.performances.viewHelper",function(){var g=false,c=null,d=null,f=null,b=null,e=null,a=function(i,h,j){$(j).html(Mustache.render(i,h,{performanceTpl:b,selectionTpl:f,eventConfigurationTpl:c}))};return{init:function(){c=$("#eventConfigurationTpl").html();d=$("#performancesListTpl").html();f=$("#selectionTpl").html();b=$("#performanceTpl").html();e=$("#seasonticket_cursor")},renderPerformances:function(h){a(d,h,"#performances")},renderConfiguration:function(h){a(c,h,"#eventConfiguration");$(".wait_overlay").each(function(){var j=$(this),i=j.parent().outerHeight();j.height(i).css("line-height",i+"px")})},showWaitingDialog:function(){if(!g){tools.dialog.showWaitingPopup("loadingDialog",true);g=true}},hideWaitingDialog:function(){if(g){tools.dialog.hideDialog("loadingDialog");g=false}},scrollToTop:function(){var l=$(".step.performances, .step.categories"),m=l.length?l.offset().top:0,i=$("#main_content_seasonticket_performances"),j=i.length?i.offset().top:0,k=Math.min(m,j),h=$(window).scrollTop();if(h>k){$(window).scrollTop(k)}},adjustCursor:function(){var j=$(".event.selected","#eventConfiguration"),i,k,h,l;if(j.length){l=(j.outerHeight()-j.innerHeight())/2;i=j.position();k=(i.top-(2.5+l))+"px";h=j.outerHeight()+"px";if(e.is(":visible")){e.stop(true).animate({top:k,height:h},1000,"easeInOutExpo")}else{e.show().css("top",k);e.css("height",h)}}else{e.hide()}},hideCursor:function(){e.hide()},getSelectNumberStructure:function(l,k,m){var h=[],j=k;for(;j<=m;j++){h.push({label:j,value:j,selected:j==l,singular:j==1})}return h}}});tools.module("seasontickets.subscribers",{quantityIdPrefix:"select_rate_",categoryPageUrl:"/selection/subscription/category",performancesPageUrl:"/selection/subscription/performances",validateAndRedirect:function(b,f,g){var a=null,c=null,i=false,e=false,d=f?this.categoryPageUrl:this.performancesPageUrl,j="",h=this;if(g){j="&advantageId="+g}c=$("#main_content_seasonticket_subscribers select");if(c.length===0){c=$("#main_content_seasonticket_subscribers input");i=true}c.each(function(){if(i&&!functions.validateQuantityInputField(c)){e=true}else{var k=parseInt($(this).val(),10);if(k>0){if(!a){a=""}else{a+=","}a+=$(this).attr("id").replace(h.quantityIdPrefix,"")+"x"+k}}});if(a){window.location=contextPath+d+"?productId="+b+"&subscribers="+a+j}else{if(!e){$("#notification.hidden").removeClass("hidden");$("#main_content_seasonticket_subscribers select").addClass("error");window.scrollTo(0,0);return false}}}});tools.module("seatmap.seatBlock",function(){var d=false,f=[],e={},h=function(j){if(j.indexOf("-full")!=-1){j=j.replace("-full","-hover")}else{if(j.indexOf("-hover")==-1){j+="-hover"}}return j},g=function(){if($("#seat_info_filter_categories_input").is(":checked")){$("#venue-preview").hide();$("#venue-categories").show();$("#seat_info_filter_categories_table").fadeIn()}else{$("#venue-categories").hide();$("#seat_info_filter_categories_table").fadeOut()}},b=function(k){var l=k.attr("id"),j=h(l);$("#seat_info_filters").hide();$(".block-info-content").hide();$("#seat_info_instructions_container").hide();$("#seat-info-"+j).show();if(d){$('[id^="P"][id$="-hover"]').css("opacity",0);$('[id^="P"].stx_hover').css("opacity","1.0");if(l.indexOf("-hover")!=-1){k.css("opacity",e[l])}else{if(k.hasClass("stx_hover")){k.css("opacity","0.8")}}}},a=function(j){return j.length&&(j.attr("id").indexOf("-hover")!=-1||j.hasClass("stx_hover"))},i=function(j){var l=$("#seat-map svg"),k=[];if(l.length){if(j){k=j.split("#")}$('[id^="P"]').each(function(){var n=false,q=$(this),m=q.attr("id"),p=m,o=false;if(p.indexOf("-")>-1){p=p.split("-")[0]}if($("#seat-info-"+p+"-hover").length){n=k.some(function(r){return p===r});if(!n){if(m.indexOf("-full")>-1){o=true}else{if(m.indexOf("-hover")==-1&&!$("#"+p+"-hover").length){q.addClass("stx_hover")}}}else{if(m.indexOf("-hover")>-1||(m.indexOf("-full")==-1&&$("#"+p+"-full").length)){o=true}else{if(m.indexOf("-full")===-1&&!$("#"+p+"-full").length){q.addClass("stx_full")}}}}else{o=true}if(o){q.remove()}if(a(q)&&!o){e[m]=q.css("opacity");q.css("opacity",0);f.push("#"+m)}})}},c=function(){if(!$("#venue-preview").length){return}var j=false,k=function(){$("#venue-preview").css("opacity",1).animate({opacity:0},200,function(){$(this).hide()})};setTimeout(function(){if(j){k()}j=true},1000);$("#seat-map").on("mousemove",function(){$("#seat-map").off("mousemove");if(j){k()}else{j=true}})};return{init:function(k,l,j){d=k;i(j);if($("#venue-categories").length){$("#seat_info_filter_categories").removeClass("hidden");$("#seat_info_filter_categories_input").change(function(){g()})}else{$("#seat_info_filter_title").hide()}if(!d){$('[id^="P"]').hover(function(){var n=$(this),m=h(n.attr("id"));b(n);$("#"+m).css("opacity",e[m])},function(){var m=h($(this).attr("id"));$("#"+m).css("opacity",0);$("#seat-info-"+m).hide();$("#seat_info_filters").show();$("#seat_info_instructions_container").show()});$(".polygon_navigation_container .polygon_arrow").each(function(){$(this).hide()})}$('[id^="P"]').click(function(){var n=$(this),o=n.attr("id"),m=null;if(!d){if(o.indexOf("-full")==-1||n.hasClass("stx_full")){o=h(o);m=$("#seat-info-"+o).find(".btn_go_step2 > a");if(m.length){window.location.href=m.attr("href")}}}else{b(n)}});if(d&&$("#venue-categories").length){$("#seat_info_filter_categories_input").prop("checked",true);g()}if(l){b($(l))}c()},nextArea:function(j){var k=f.indexOf(j);if(k==f.length-1){k=0}else{k=k+1}b($(f[k]))},previousArea:function(j){var k=f.indexOf(j);if(!k){k=f.length-1}else{k=k-1}b($(f[k]))}}});SeatCache=function(a,b){this.cache=[];this.fromProjection=a;this.toProjection=b};SeatCache.prototype={_revertYChange:function(a){var b;b=a.top;a.top=a.bottom;a.bottom=b;return a},clearCache:function(){this.cache=[]},getFromCache:function(b,e){var a=null,c,d;e.transform(this.fromProjection,this.toProjection);e=this._revertYChange(e);for(c=0;c<this.cache.length;c++){d=this.cache[c];if(d.bounds.containsBounds(e)){a=d}}return a},pushInCache:function(d,c){var b=this._revertYChange(c.filter.value),a=this.cache.length-1;while(a>=0){if(!b.containsBounds(this.cache[a].bounds)){this.cache.splice(a,1)}a--}this.cache.push({bounds:b,olResponse:d})}};tools.module("SeatDetails",function(){var L=null,G=null,K=null,h=null,d=0,u=null,m={},o=null,F=null,B=null,E={},D=null,C=null,x=null,c=null,l=null,N=function(){var R=[];$(".nnseat-rate-select").each(function(){R.push($(this).val())});return R},r=function(S){var R=0;for(;R<L.data.prices.length;R++){if(jQuery.inArray(R.toString(),S)===-1){break}}return R.toString()},O=function(S,R){var T="";if(S.externalVerification!==null){T=S.externalVerification.name+": "+SeatDetails._LABEL_NOTE;R.attr("title",T);R.show()}else{if(S.isMemberCategory&&S.priceLevelCode!==null){T=S.audienceSubCategory+" / "+S.priceLevelCode+": "+SeatDetails._LABEL_NOTE;R.attr("title",T);R.show()}else{R.hide()}}},j=function(R){var T=0,S=false;$(".nnseat-rate-select").each(function(){if($(this).val()===R){T++;if(T>1){S=true;return false}}});return S},e=function(){if($(".nnseat-rate-select").length===L.data.prices.length){$("#add-rate").parent().addClass("disabled")}else{$("#add-rate").parent().removeClass("disabled")}},A=function(af,ac,ad){var S=L,Y=S.data.prices[af],Z=S.priceIdx===af,W=functions.generateAmount(Y.amount),ae=0,ab=false,X=ac?"nn":"",aa=ac?$("#nnselect-seat"):$("#select-seat"),ag=$("#nnseat-rate-selection-"+ad),R=ag.find(".nnseat-rate-pre-price"),U=ag.find(".nnseat-rate-price"),T=".external_verification_indicator",V=ac?ag.find(T):$(T),ah=null;af=""+af;if(Y.advantageId){$("#"+X+"seat-info-adv").html(Y.advantage);$("#"+X+"seat-info-price").addClass("advantage");U.addClass("advantage");if(Y.amountWithoutAdvantage&&Y.amountWithoutAdvantage!=Y.amount){ae=functions.generateAmount(Y.amountWithoutAdvantage);if(!ac){$("#seat-info-pre-price").html(ae)}else{R.html(ae)}}$("#"+X+"seat-info-price-adv .advantage").addClass("advantage_"+Y.advantageType).show();$("#"+X+"seat-info-price-adv .advantage_container").addClass("advantage_"+Y.advantageType);$("#"+X+"seat-info-price-adv .advantage .catchword .text").html(SeatDetails._ADV_LABELS[Y.advantageType])}else{$("#"+X+"seat-info-adv").html("");$("#"+X+"seat-info-price-adv .advantage").hide();if(!ac){$("#seat-info-price").removeClass("advantage");$("#seat-info-pre-price").html("")}else{U.removeClass("advantage");R.html("")}}if(!ac){$("#"+X+"seat-info-price").html(W);if(!Z){ah=SeatList.checkAddPrice(S,af,1);ab=ah!==true;if(ah===true){$("#seat_info_full, #seat_info_price_full").hide()}else{$("#seat_info_full").toggle(ah=="OVER_GLOBAL_MAX");$("#seat_info_price_full").toggle(ah=="OVER_PRICE_MAX")}}else{$("#seat_info_full, #seat_info_price_full").hide()}ab=ab||Z;if(ab){aa.parent().addClass("disabled")}else{aa.parent().removeClass("disabled")}}else{$("#nnseat-rate-selection-"+ad).find(".nnseat-rate-price").html(functions.generateAmount(Y.amount))}O(Y,V)},a=function(){var R=[];$(".seat-cat-checkbox:checked").each(function(){R.push(parseInt($(this).val(),10))});return R},q=function(){if(!d){$("#seat-info-loading-bg, #seat-info-loading").show()}d++},f=function(){d--;if(d<1){$("#seat-info-loading-bg, #seat-info-loading").hide()}},P=function(S){var R=S?"nn":"";$("#"+R+"seat-info-added").show();$("#"+R+"seat-info-added-bg").show();h=setTimeout(function(){$("#"+R+"seat-info-added").fadeOut(function(){$("#"+R+"seat-info-added-bg").hide();$(".seat-booking").addClass("selected")})},500)},n=function(){window.clearTimeout(h);$("#seat-info-added, #seat-info-added-bg").hide()},b=function(S,R,T){if(!R){$(".seat-booking").toggleClass("selected",S)}if(T){$("#nndelete-seat").parent().toggle(S);$("#nnseat_info_booking_title").html(SeatDetails[S?"_LABEL_BOOK_EXISTING":"_LABEL_BOOK_NNAREA_CHOOSE"]);$("#nnselect-seat span.text").html(SeatDetails[S?"_LABEL_BUTTON_UPDATE":"_LABEL_BUTTON_SELECT"])}else{$("#delete-seat").parent().toggle(S);$("#seat_info_booking_title").html(SeatDetails[S?"_LABEL_BOOK_EXISTING":"_LABEL_BOOK_CHOOSE"]);$("#select-seat span.text").html(SeatDetails[S?"_LABEL_BUTTON_UPDATE":"_LABEL_BUTTON_SELECT"])}},M=function(T,R,X,V){var Y=$("#nnseat-rate-selection-"+V+" .nnseat-rate-price"),W=$("#nnseat-rate-selection-"+V+" .nnseat-rate-pre-price"),U=T[R],S=null;w(T,R,V);i(V,U,X);Y.html(functions.generateAmount(U.amount));if(U.advantageId){Y.addClass("advantage");if(U.amountWithoutAdvantage&&U.amountWithoutAdvantage!=U.amount){S=functions.generateAmount(U.amountWithoutAdvantage);W.html(S)}}else{Y.removeClass("advantage");W.html("")}},w=function(V,W,S){var R=0,T=null,U="",Y="",Z="",X=null;if(typeof S!=="undefined"){X=$("#nnseat-rate-selection-"+S+" .nnseat-rate-select")}else{X=$("#seat-info-prices")}for(;R<V.length;R++){T=V[R];if(T.advantageId){U=T.advantage}else{U=""}if(T.priceLevelCode){Y=" / "+T.priceLevelCode}else{Y=""}if(W===R){Z=' selected="selected"';O(T,$(".external_verification_indicator"))}else{Z=""}X.append('<option value="'+R+'"'+Z+">"+T.audienceSubCategory+Y+" "+U+"</option>")}},i=function(V,U,R){$("#nnseat-rate-selection-"+V+" .nnseat-rate-quantity option").remove();var T=(R===0)?' selected="selected"':"",S=0;$("#nnseat-rate-selection-"+V+" .nnseat-rate-quantity").append('<option value="0"'+T+">"+0+"</option>");for(S=U.minQuantity;S<=U.maxQuantity;S++){if(R===S){T=' selected="selected"'}else{T=""}$("#nnseat-rate-selection-"+V+" .nnseat-rate-quantity").append('<option value="'+S+'"'+T+">"+S+"</option>")}},y=function(R,S){var T=jQuery.grep(R,function(V,U){return(V.priceIdx===S)});return(T.length===0)?0:T[0].quantity},z=function(){var R=true;$(".nnseat_info_price_full, .nnseat_info_rate_exist").each(function(){if($(this).is(":visible")){R=false;return false}});return R},I=function(T){var R=!!T.scenePhotoLink,U=!!T.scenePanoLink,S=false;$("#seat-info-img").off("click");$("#krpano_seat_description_seat").html(SeatList.getSeatDescriptionFromData(T));if(U){if(R){$("#seat-info-img").attr("src",D+T.scenePhotoLink+"&qualifier=MEDIUM")}else{$("#seat-info-img").attr("src",c+T.scenePanoLink)}$("#seat-info-img-full img").hide();$("#pano_info").show();$("#krpano").show();$("#seat-info-img").on("click",function(){if(!S){SeatPano.displayPanel(l+T.scenePanoLink)}S=true;tools.dialog.showDialog("seat-info-img-full",true)});$("#seat-info-img").parent().show()}else{if(R){$("#seat-info-img").attr("src",D+T.scenePhotoLink+"&qualifier=MEDIUM");$("#seat-info-img-full img").attr("src",D+T.scenePhotoLink);$("#seat-info-img-full img").show();$("#pano_info").hide();$("#krpano").hide();$("#seat-info-img").on("click",function(){tools.dialog.showDialog("seat-info-img-full",true)});$("#seat-info-img").parent().show()}else{$("#seat-info-img").parent().hide();$("#seat-info-img").attr("src","")}}},v=function(S){var R=false;$("#seat-info-category .color").css("background-color","#"+S.color);$("#seat-info-category .name").html(S.seatCategory);$("#seat-info-areaname").html(S.area);if(S.block&&S.block!==null){$("#seat-info-blockname").html(" - "+SeatDetails.getSeatBlockLabel(S.areaId)+" "+S.block)}else{$("#seat-info-blockname").html("")}if(S.row&&S.row!==null){$("#seat-info-rowname").html(SeatDetails.getSeatRankLabel(S.block,S.areaId)+" "+S.row)}else{$("#seat-info-rowname").html("")}if(S.number&&S.number!==null){$("#seat-info-text").html(SeatDetails.getSeatNumberLabel(S.areaId));if(S.row&&S.row!==null){$("#seat-info-text").addClass("with_row")}else{$("#seat-info-text").removeClass("with_row")}$("#seat-info-seat").html(S.number);$("#seat-info-seat-container").show()}else{$("#seat-info-seat-container").hide()}if(!B){if(S.externalRemark&&S.externalRemark!==null){$("#seat-info-remark-text").html(S.externalRemark);$("#seat-info-remark").show();$("#seat-info-titling-vis").hide();$("#seat-info-stage-vis").hide();R=true}else{$("#seat-info-remark-text").html("");$("#seat-info-remark").hide();if(S.titlingVisibilityType&&S.titlingVisibilityType!=="VISIBLE"){$("#seat-info-titling-vis").show();R=true}else{$("#seat-info-titling-vis").hide()}if(S.stageVisibilityType&&S.stageVisibilityType!=="VISIBLE"){$("#seat-info-stage-vis").show();R=true}else{$("#seat-info-stage-vis").hide()}}if(S.seatQuality&&S.seatQuality!==null){$("#seat-info-quality").html(S.seatQuality);R=true}$("#seat-details .seat-info-content .seat-quality-remarks").toggle(R)}I(S)},k=function(T,R){var S=R.data;T.seatId=S.id;T.color=T.color?T.color:S.color;T.row=S.row;T.number=S.number;T.seatCentroid=R.geometry.getCentroid()},H=function(U,W,R,T){var S=null,V=o+"_"+W;if(G===W){return}G=W;window.clearTimeout(K);S=m[V];if(S){SeatDetails.displaySeatDetails(U,S);return}q();$.ajax({url:R,type:"GET",cache:false,data:T,error:function(X){tools.dialog.showDialog("ajaxErrorDialog",true)},success:function(X){m[V]=X;f();if(!U.feature||!U.feature.data){u=X}else{SeatDetails.displaySeatDetails(U,X)}}})},g=function(){SeatMap.blocksLayer.events.on({beforefeatureadded:function(W){var V=SeatMap.additionalBlockInfo[W.feature.data.id],T=null,U=false,S=a(),R;if(V){T=V.gradientIdentifier.split("_");for(R=0;R<T.length;R++){if($.inArray(parseInt(T[R],10),S)>=0){U=true}}if(!U){return false}if(V.available){W.feature.attributes.fillColor="url(#"+V.gradientIdentifier+")";return true}}return false}})},p=function(R){return function(T){var S=T.feature,U=S.data.id;if(SeatList.isSeatSelected(U)){R(S)}G=null;K=setTimeout(function(){$("#seat-details .seat-info-content").hide();$("#seat-details .seat-info-placeholder").show();L=null},10)}},t=function(){SeatMap.nnAreasLayer.events.on({beforefeatureadded:function(T){var S=T.feature,R=S.attributes,U=S.data.id;R.nnAreaColor=SeatMap.getAreaColor(U);R.nnAreaInCartColor=util.color.changeColorLuminance(R.nnAreaColor,-0.2);return true},featureselected:function(S){var T=S.feature.data.id,R={perfId:o,areaId:T,advantageId:F?F:"",seatCategoryId:SeatMap.getAreaSeatCategory(T)};H(S,T,x,R)},featureunselected:p(function(R){SeatMap.redrawArea(R.data.id,"addedToCart")})})},Q=function(){SeatMap.seatsLayer.events.on({beforefeatureadded:function(T){var S=T.feature,U=S.data.id,R;if(SeatList.getSeat(U)){T.feature.renderIntent="addedToCart";return true}R=a();if($.inArray(T.feature.data.seatCategoryId,R)<0){return false}return true},featureselected:function(S){var T=S.feature.data.id,R={perfId:o,seatId:T,advantageId:F?F:""};SeatList.preselectSeat(T);H(S,T,C,R)},featureunselected:p(function(R){SeatMap.redrawSeat(R.fid,"addedToCart")}),featureadded:function(R){if(G===R.feature.fid){SeatMap.selectControl.select(R.feature);if(u&&G===u.seatId){displaySeatDetails(R,u);u=null}}}})},J=function(R){if(R){if($(".nnseat-rate-select option").length===1){$(".nnseat-rate-select").hide();$("#add-rate").hide()}else{$(".nnseat-rate-select").show();$("#add-rate").show()}}else{if($("#seat-info-prices option").length===1){$("#seat-info-prices").hide();if($(".seat-booking").hasClass("selected")){$("#select-seat").hide()}else{$("#select-seat").show()}}else{$("#seat-info-prices").show();$("#select-seat").show()}}},s=function(S){var T=$("#select-seat").parent(),R={priceIdx:S,data:L.data};if(T.hasClass("disabled")){return false}L.priceIdx=S;T.addClass("disabled");if($("#seat-info-prices option").length===1){$("#select-seat").hide()}b(true,true,false);SeatList.addSeat(R);SeatSessionStorage.storeSelectedSeat(o,R,true);P(false);tools.scrollElementInViewport("#pre-cart",400,12);return true};return{init:function(R){C=R.seatDetailsUrl;o=R.performanceId;F=R.partnerAdvantageId;D=R.seatImageUrl;c=R.panoPreviewUrl;l=R.panoConfigUrl;x=R.areaDetailsUrl;B=R.isMobile;E=R.areaIsLogeMap;$("#seat-details").on("click","#select-seat",function(S){S.preventDefault();s(parseInt($("#seat-details #seat-info-prices").val(),10))});$("#seat-details").on("click","#nnselect-seat",function(V){V.preventDefault();if($(this).parent().hasClass("disabled")){return}var U=[],X=[],T,W,S;jQuery.each($("#seat-details .nnseat-rate-select"),function(Y,Z){W=parseInt($(Z).parent().find(".nnseat-rate-quantity").val(),10);if(W!==0){X=jQuery.map(U,function(ab,aa){return ab.priceIdx});T=jQuery.inArray($(Z).val(),X);if(T===-1){U.push({priceIdx:$(Z).val(),quantity:W})}else{U[T].quantity=U[T].quantity+W}}});if(U.length===0&&!SeatList.isSeatSelected(L.data.seatId)){$("#notification").show();return}$("#notification").hide();L.priceQty=U;$(this).parent().addClass("disabled");b(true,true,true);S={priceQty:U,data:L.data};SeatList.addNonNumberedSeat(S);SeatSessionStorage.storeSelectedSeat(o,S,false);P(true);tools.scrollElementInViewport("#pre-cart",400,12)});$("#seat-details").on("change","#seat-info-prices",function(){var U=parseInt($(this).val(),10),T=L.data,V=L.priceIdx,S=SeatList.getSeat(L.data.seatId);if(S){SeatList.deleteSeat(L,true)}A(U,false);if(S){SeatList.addSeat({data:T,priceIdx:V},true)}}).on("change",".nnseat-rate-select",function(){var V=$(this).parent(),Y=parseInt(/\d+/.exec(V.attr("id"))[0],10),U=L.data.prices,S=$(this).val(),T=parseInt(S,10),X=U[T],W=j(S);A(T,true,Y);i(Y,X,0);V.find(".nnseat-rate-quantity").prop("disabled",W);V.find(".nnseat_info_rate_exist").toggle(W)}).on("click","#delete-seat, #nndelete-seat",function(S){S.preventDefault();if($(this).parent().hasClass("disabled")){return}SeatList.deleteSeat(L)}).on("change",".nnseat-rate-quantity",function(){var U=$(this).parent().parent().siblings(".nnseat-rate-select").val(),X=parseInt(U,10),W=SeatList.getSeat(L.data.seatId),S=parseInt($(this).val(),10),T=SeatList.checkAddPrice(L,X,S),V=$(this).parent().parent();if(W){S-=y(W.priceQty,U)}$("#nnselect-seat").parent().toggleClass("disabled",T!==true);if(T===true){V.siblings(".nnseat_info_price_full, .nnseat_info_full").hide()}else{V.siblings(".nnseat_info_price_full").toggle(T=="OVER_PRICE_MAX");V.siblings(".nnseat_info_full").toggle(T=="OVER_GLOBAL_MAX")}});$(".seat-cat-checkbox").on("click",function(){var Z=this,T=SeatMap.getAreasBySeatCategory(this.value),S=SeatMap.blocks,aa,U,Y,W,V=a(),X;SeatMap.refreshSeatLayer();jQuery.each(T,function(ab,ac){if(Z.checked){SeatMap.addArea(ac.id.toString())}else{SeatMap.removeArea(ac.id.toString())}});if(S){for(X in S){aa=SeatMap.additionalBlockInfo[X];W=false;if(aa){U=aa.gradientIdentifier.split("_");for(Y=0;Y<U.length;Y++){if($.inArray(parseInt(U[Y],10),V)>=0){W=true}}if(!W){SeatMap.hideBlock(X)}else{SeatMap.showBlock(X)}}}}});$("#add-rate").on("click",function(){if(!$("#add-rate").parent().hasClass("disabled")){var X="nnseat-rate-selection-",T=$("<div></div>").addClass("nnseat-rate-selection"),Z=$(".nnseat-rate-selection").length,V=N(),W=r(V),Y=L.data.prices[parseInt(W,10)],aa=null,U=null,S=null,ab=null;T.attr("id",X+Z);T.append($("#nnseat-rate-selection-0").html());T.find(".nnseat-rate-select").val(W);$("#nnseat-rate-selection-"+(Z-1)).after(T);i(Z,Y,0);ab=$("#nnseat-rate-selection-"+Z);U=ab.find(".nnseat-rate-price");U.html(functions.generateAmount(Y.amount));ab.find(".nnseat_info_price_full").hide();ab.find(".nnseat_info_rate_exist").hide();S=ab.find(".nnseat-rate-pre-price");if(Y.advantageId){U.addClass("advantage");if(Y.amountWithoutAdvantage&&Y.amountWithoutAdvantage!=Y.amount){aa=functions.generateAmount(Y.amountWithoutAdvantage);S.html(aa)}}else{U.removeClass("advantage");S.html("")}O(Y,ab.find(".external_verification_indicator"));if(z()){$("#nnselect-seat").parent().removeClass("disabled")}e()}return false});SeatMap.events.on("initSeatsLayerDone",Q);SeatMap.events.on("initnnAreasLayerDone",t);SeatMap.events.on("initBlocksLayerDone",g);SeatPano.init({containerId:"seat-info-img-full",krpanoContainerId:"krpano",panoSWFUrl:R.panoSwfUrl,panoJSUrl:R.panoJSUrl,html5Config:"prefer"})},displaySeatDetails:function(V,U){if((!V.feature||!V.feature.data)&&!U.seatId){u=U;return}n();if(!U.seatId){k(U,V.feature)}var Y=U.seatId,X=SeatList.getSeat(Y),R=null,T=U.number?false:true,S=null,W=null;if(L&&L.data.seatId===Y){return}if(T){R=X?parseInt(X.priceQty[0].priceIdx,10):0}else{R=X?parseInt(X.priceIdx,10):0}L={};L.data=U;if(!T&&!X){A(R,false);if(!s(R)){SeatList.cancelPreselectSeat(Y)}else{X=SeatList.getSeat(Y)}}if(X){if(T){L.priceQty=X.priceQty}else{L.priceIdx=X.priceIdx;A(R,false)}}if(T){A(R,true,0);$("#nndelete-seat").attr("data-id","id--"+Y)}else{$("#delete-seat").attr("data-id","id--"+Y)}if(X){b(true,false,T);SeatList.selectSeat(L)}else{b(false,false,T)}v(U);if(!T){$("#seat-info-prices option").remove();w(U.prices,R);$("#seat_booking_with_number").show();$("#seat_booking_no_number").hide();$("#add-rate").parent().hide()}else{$(".nnseat-rate-select option").remove();W=$(".nnseat-rate-selection").first();W.find(".nnseat_info_price_full").hide();W.find(".nnseat_info_rate_exist").hide();S=W.clone();$("#nnseat-rate-selections").empty();if(X){jQuery.each(X.priceQty,function(aa,ac){var ab="nnseat-rate-selection-",Z=S.clone();Z.attr("id",ab+aa);$("#nnseat-rate-selections").append(Z);M(X.data.prices,parseInt(ac.priceIdx,10),ac.quantity,aa)});$("#nnselect-seat").parent().addClass("disabled")}else{S.attr("id","nnseat-rate-selection-0");$("#nnseat-rate-selections").append(S);M(U.prices,R,0,0);$("#nnselect-seat").parent().removeClass("disabled")}$("#add-rate").parent().show();e();$("#seat_booking_with_number").hide();$("#seat_booking_no_number").show()}$("#seat-details .seat-info-content").show();$("#seat-details .seat-info-placeholder").hide();J(T)},preventCategoryDisplay:function(){if(!G){window.clearTimeout(K)}},isAreaKindLoge:function(R){return R&&R!==null&&E[R]},getSeatBlockLabel:function(R){if(SeatDetails.isAreaKindLoge(R)){return SeatDetails._LABEL_SEAT_LOGE}return SeatDetails._LABEL_SEAT_BLOCK},getSeatRankLabel:function(S,R){if(!S||S===null){if(SeatDetails.isAreaKindLoge(R)){return SeatDetails._LABEL_SEAT_LOGE}}else{if(SeatDetails.isAreaKindLoge(R)){return""}}return SeatDetails._LABEL_SEAT_RANK},getSeatNumberLabel:function(R){if(SeatDetails.isAreaKindLoge(R)){return""}return SeatDetails._LABEL_SEAT_NUMBER}}});tools.module("SeatList",function(){var M={},i={},b=0,x={},e=false,l=null,u=null,G=null,T=null,Y=0,j=null,t=null,c=null,o=0,W=0,r=0,m=function(){var ab=null,ac;for(ab in x){ac=x[ab];if(!ac.count){continue}if((ac.minQuantity!==null&&ac.count<ac.minQuantity)||(ac.maxQuantity!==null&&ac.count>ac.maxQuantity)){e=false;l=ac;return}}e=true;l=null;if(R()){e=false}},R=function(){for(var ab in M){if(M[ab]===true){return true}}return false},S=function(ab){return ab.data.seatId},C=function(ac,ab){if(!ab&&ab!==0){ab=ac.priceIdx}return ac.data.prices[ab]},P=function(ai,ah){var af=C(ai,ah),ab=af.audienceSubCategoryId,ae=ai.data.seatCategoryId,ag=af.priceLevelId,ac=af.advantageId,ad=ae+"_"+ab;if(ag){ad+="_"+ag}if(ac){ad+="__"+ac}if(!x[ad]){x[ad]={count:0,minQuantity:af.minQuantity,maxQuantity:af.maxQuantity,audienceSubCategory:af.audienceSubCategory,seatCategory:ai.data.seatCategory,externalVerification:af.externalVerification,isMemberCategory:af.isMemberCategory,priceLevelCode:af.priceLevelCode,key:ad}}return x[ad]},z=function(ab){jQuery.each(ab.priceQty,function(ad,ae){var ac=parseInt(ae.priceIdx,10),ag=ae.quantity,af=P(ab,ac);af.count-=ag;if(af.count<=0){delete x[af.key]}})},O=function(ac,ab){if(ab){z(ab)}jQuery.each(ac.priceQty,function(ae,af){var ad=parseInt(af.priceIdx,10),ah=af.quantity,ag=P(ac,ad);ag.count+=ah})},y=function(){var ab=h("EXTERNAL");if(!jQuery.isEmptyObject(ab)){$("#add-to-cart").text(SeatList._LABEL_BUTTON_PROCEED)}else{$("#add-to-cart").text(SeatList._LABEL_BUTTON_ADDTOCART)}},h=function(ab){var ad={},ac=null;for(ac in x){descriptor=x[ac];if((ab==="EXTERNAL")&&(descriptor.externalVerification!==null)&&(descriptor.count>0)){ad[ac]=descriptor}if((ab==="MEMBERSHIP")&&descriptor.isMemberCategory&&(descriptor.count>0)){ad[ac]=descriptor}}return ad},k=function(ac,ab,ae){var ad=$(document.createElement("input"));ad.attr("type","hidden").attr("name","eventFormData["+ac+"]."+ab).val(ae);$("#EventFormModel").append(ad)},L=function(af,al,ad,aj,ak,ab){var ag=aj.prices[al],ac=ag.audienceSubCategoryId,ai=ag.advantageId,ah=ag.priceLevelId,ae=aj.seatCategoryId;k(af,"audienceSubCategory",ac);k(af,"seatCategory",ae);k(af,"contingentId",aj.contingentId);k(af,"quantity",ad);if(!ak){if(ab){k(af,"physicalSeatId",aj.seatId)}k(af,"areaId",aj.areaId);k(af,"blockId",aj.blockId)}else{k(af,"areaId",aj.seatId)}if(ai){k(af,"advantageId",ai)}if(ah){k(af,"priceLevelId",ah)}},s=function(ac){var ab=a(ac),ad;ad=(ab>1)?ab+" "+SeatDetails._LABEL_NNAREA_SEAT_COUNT_N:ab+" "+SeatDetails._LABEL_NNAREA_SEAT_COUNT_1;return ad},f=function(ac,ah,af){var ae,ai,ad,ag,aj,ab;if(af){ae=functions.generateAmount(af.amount);ai=w(ac);ad=af.audienceSubCategory;ag=af.advantageId?"<div class='advantage advantage_"+af.advantageType+"'><div class='advantage_catchword_container'><span class='catchword'></span></div></div>":"";ab=(af.externalVerification||af.isMemberCategory)?'<div class="pre-cart-price-ext-ver"><span class="external_membership_icon"></span></div>':""}else{priceIdx=parseInt(ac.priceQty[0].priceIdx,10);ae=functions.generateAmount(V(ac.data.prices,ac.priceQty));ai=ac.data.area;ad=s(ac.priceQty);ag=ac.data.prices[priceIdx].advantageId?"<div class='advantage advantage_"+ac.data.prices[priceIdx].advantageType+"'><div class='advantage_catchword_container'><span class='catchword'></span></div></div>":"";ab=(ac.data.prices[priceIdx].externalVerification||ac.data.prices[priceIdx].isMemberCategory)?'<div class="pre-cart-price-ext-ver"><span class="external_membership_icon"></span></div>':""}aj=['<div class="seat-details-item-wrapper">','<div class="pre-cart-cat">','<div class="category-color" style="background-color: #'+ac.data.color+'"></div>',ac.data.seatCategory+"</div>",'<div class="pre-cart-desc">'+ai+"</div>",'<div class="pre-cart-additional-info-wrapper">','<div class="pre-cart-cat-2">'+ad+"</div>",'<div class="pre-cart-adv-sub-wrapper">',ag,ab,'<div class="pre-cart-price">'+ae+"</div>","</div>",'<div class="remove_button_wrapper">','<span class="alternative_button remove"><a title="'+SeatList._LABEL_REMOVE_BUTTON+'" href="" id="id--'+ah+'"><span class="icon"></span><span class="symbol"></span><span class="text"></span></a></span>',"</div>","</div>",'<div class="clear"></div>',"</div>"];$("#pre-cart li#pre-cart-line--"+ah).html(aj.join(""))},K=function(ab){ab.addClass("clickable");ab.removeClass("disabled")},p=function(ab){ab.addClass("disabled");ab.removeClass("clickable")},v=function(){$("#left-arrow, #right-arrow").addClass("display-inline")},I=function(){$("#left-arrow, #right-arrow").removeClass("display-inline")},A=function(){if($("#content").width()>=t){if($(".main_content.seat_selection").hasClass("fullscreen")){return r}else{return o}}else{return W}},E=function(ab,ad){var aj=null,af=ab.data.seatId,ac=parseInt(af,10),ah=null,ai=null,ae=null,ag=ab.data.number?false:true,ak=null;if(!ag){aj=ab.priceIdx;ae=ab.data.prices[aj];ai=ae.amount}else{ak=ab.priceQty;ai=V(ab.data.prices,ak)}if(ad){$("#pre-cart #num-tickets").html(SeatDetails._LABEL_YOUR_SELECTION+" ("+SeatList.getNbSelectedSeats()+")");ah=ag?V(ab.data.prices,ad.priceQty):ab.data.prices[ad.priceIdx].amount;Y-=ah;Y+=ai}else{Y+=ai;$("#pre-cart #num-tickets").html(SeatDetails._LABEL_YOUR_SELECTION+" ("+SeatList.getNbSelectedSeats()+")");$("#pre-cart #details-list li").hide();$("#pre-cart #details-list").append('<li id="pre-cart-line--'+af+'"></li>');$("#pre-cart #ticket-icon-list ul li").removeClass("selected-ticket");$("#pre-cart #ticket-icon-list ul").append('<li id="tid--'+af+'" class="selected-ticket"><span class="icon"></span></li>');B(true)}if(ae!==null){f(ab,af,ae)}else{f(ab,af)}$("#pre-cart #total").html(SeatDetails._LABEL_TOTAL+" "+functions.generateAmount(Y));$("#pre-cart #total").show();N();if(!ad){if(ag){SeatMap.redrawArea(ac,"addedToCart")}else{SeatMap.redrawSeat(ac,"addedToCart",true)}SeatMap.selectSeat(af,ag)}},V=function(ac,ab){var ad=0;jQuery.each(ab,function(ae,af){ad+=(ac[af.priceIdx].amount)*(af.quantity)});return ad},a=function(ab){var ac=0;jQuery.each(ab,function(ad,ae){ac+=ae.quantity});return ac},B=function(ab){var af=SeatList.getFirstVisibleSeatPos(),ag=$("#ticket-icon-list ul"),ad=$("li",ag).length,ac=0,ae=0,aj=0,ak=0,ai=ab?$("#left-arrow"):$("#right-arrow"),ah=ab?$("#right-arrow"):$("#left-arrow");ac=$("li:first-child",ag).width();ak=ab?ac:-ac;ae=A();aj=ab?(ad-(af+ae)):af;if(ad>ae){if(aj>0){SeatList.slideSeatList(aj,ab)}v();K(ai);p(ah)}else{I();$("#ticket-icon-list").css("width",ac*ad)}ag.css("width",ag.width()+ak)},Z=function(ae){var ag=$(".main_content.seat_selection").hasClass("fullscreen"),ad=$("#seat-map-sub-container").parent().width(),af=ag?ad:$("#content").width(),ab,aj=A(),ah=$("#ticket-icon-list"),ak=$("#ticket-icon-list ul"),ai=$("li",ak).length,ac=$("li:first-child",ak).width();if(ae>=t&&af<t||ae>seatMapContainerInitialWidth&&af<=seatMapContainerInitialWidth){if(ai>aj){v();n();ah.css("width",ac*aj);$("#ticket-icon-list .selected-ticket").click()}}if(ae<t&&af>=t||ae<=seatMapContainerInitialWidth&&af>seatMapContainerInitialWidth){if(ai<=aj){I();ah.css("width",ac*ai)}else{ah.css("width",ac*aj)}}ab=af;return ab},n=function(){var ab=A(),ac=$("#ticket-icon-list ul li"),ad=SeatList.getFirstVisibleSeatPos();if($(ac[ad]).prev().length===0){p($("#left-arrow"))}else{K($("#left-arrow"))}if($(ac[ad+ab-1]).next()===0){p($("#right-arrow"))}else{K($("#right-arrow"))}},U=function(){var ab=$("#pre-cart #details-list li").last().find("a").attr("id").replace("id--","");SeatList.selectSeat(SeatList.getSeat(ab),true)},J=function(af){var ae=af.data.seatId,ac=parseInt(ae,10),ad=af.data.number?false:true,ab=ad?V(af.data.prices,af.priceQty):af.data.prices[af.priceIdx].amount;$("#pre-cart #details-list #pre-cart-line--"+ae).remove();$("#pre-cart #ticket-icon-list #tid--"+ae).remove();B(false);Y-=ab;$("#pre-cart #total").html(SeatList._LABEL_TOTAL+functions.generateAmount(Y));$("#pre-cart #num-tickets").html(SeatDetails._LABEL_YOUR_SELECTION+" ("+SeatList.getNbSelectedSeats()+")");if(SeatList.getNbSelectedSeats()){U();$("#delete-seat").parent().removeClass("disabled");$("#select-seat span.text").html(SeatDetails._LABEL_BUTTON_UPDATE)}else{$("#seat-details .seat-info-content").hide();$("#seat-details .seat-info-placeholder").show();$("#total_button_container #total").hide();SeatMap.unselectAllSeats()}N();if(!ad){SeatMap.redrawSeat(ac,"default",true)}else{SeatMap.redrawArea(ae,"default")}},Q=function(ac){var ab=0;for(ab in ac){if(ac[ab].numbered){SeatList.addSeat(ac[ab].seatData)}else{SeatList.addNonNumberedSeat(ac[ab].seatData)}}U()},q=function(ac){var ab="";if(ac.data.area&&ac.data.area!==null){ab=ac.data.area}if(ac.data.block&&ac.data.block!==null){ab+=(ab.length?" - ":"")+SeatDetails.getSeatBlockLabel(ac.data.areaId)+" "+ac.data.block}return ab},D=function(ae,ad,ac){var ab="";if(ae.data.row&&ae.data.row!==null){ab+=(ad?" - ":" ")+(ac?"<strong>":"")+SeatDetails.getSeatRankLabel(ae.data.block,ae.data.areaId)+" "+ae.data.row+(ac?"</strong>":"")}return ab},X=function(ad,ac){var ab="";if(ad.data.number&&ad.data.number!==null){ab+=(ac?" - ":" ")+"<strong>"+SeatDetails.getSeatNumberLabel(ad.data.areaId)+" "+ad.data.number+"</strong>"}return ab},w=function(ac){var ab=q(ac)+D(ac,true,false)+X(ac,true);return ab},H=function(af){var ab=true,ac=true,ag="",ai="",ah="",ae="",ad=null;for(ad in af){ah=q(af[ad]);ae=D(af[ad],false,false);if(ab&&ag.length){ab=ah===ag}if(ac&&ai.length){ac=ae===ai}ag=ah;ai=ae}return{areAreasAndBlocksTheSame:ab,areRowsTheSame:ac}},g=function(af){var ae="",ab="",ac="",ad=H(af);if(ad.areAreasAndBlocksTheSame&&ad.areRowsTheSame){for(ae in af){if(!ab.length){ab=q(af[ae])+D(af[ae],true,false)+" -"}ac+=(ac.length?", ":"")+X(af[ae],false)}}else{if(ad.areAreasAndBlocksTheSame){for(ae in af){if(!ab.length){ab=q(af[ae])+" -"}ac+=(ac.length?", ":"")+D(af[ae],false,true)+X(af[ae],true)}}else{for(ae in af){ac+=(ac.length?", ":"")+w(af[ae])}}}return ab+ac},N=function(){var ab="",ad=SeatList.getFailingMinimum(),ac=$("#add-to-cart").parent();if(!SeatList.canBook()||!SeatList.getNbSelectedSeats()){ac.addClass("disabled");if(ad){ab=SeatDetails._LABEL_CANT_BOOK_NOTIFICATION;ab=ab.replace("{0}",ad.minQuantity);ab=ab.replace("{1}",ad.seatCategory);ab=ab.replace("{2}",ad.audienceSubCategory)}}else{ac.removeClass("disabled")}$("#cant_book_notification").html(ab)},F=function(ah,ag){var ad="",ai=null,ab=null,af=0,ae=ag?SeatList.getNewProposalSeats():SeatList.getSelectedSeats(),ac=function(aj,ak){L(af,parseInt(ak.priceIdx,10),ak.quantity,ab,true,ah);af++};for(ad in ae){ai=ae[ad];if(!ai){continue}ab=ai.data;if(!ai.priceQty){L(af,ai.priceIdx,1,ab,false,ah);af++}else{jQuery.each(ai.priceQty,ac)}}},d=function(ac){var ab=SeatList.getSelectedSeats(),ad=Object.keys(ab);i={};$.each(ac,function(ag,ah){var af={},ae=null;if(ad[ag]){ae=ab[ad[ag]];if(ae!==null&&ah.hasOwnProperty("physicalSeatId")&&ah.hasOwnProperty("seatCategory")&&ah.hasOwnProperty("contingentId")&&ah.hasOwnProperty("areaId")&&ah.hasOwnProperty("area")){af.seatId=ah.physicalSeatId;af.seatCategoryId=ah.seatCategory;af.contingentId=ah.contingentId;af.areaId=ah.areaId;af.area=ah.area;if(ah.hasOwnProperty("block")&&ah.hasOwnProperty("blockId")){af.block=ah.block;af.blockId=ah.blockId}if(ah.hasOwnProperty("row")){af.row=ah.row}if(ah.hasOwnProperty("number")){af.number=ah.number}if(ae.hasOwnProperty("priceIdx")&&ae.data.hasOwnProperty("prices")){af.prices=ae.data.prices;i[ah.physicalSeatId]={};i[ah.physicalSeatId].data=af;i[ah.physicalSeatId].priceIdx=ae.priceIdx}}}})},aa=function(){SeatMap.seatsLayer.events.on({featureadded:function(ab){var ac=ab.feature.data.id;if(j&&j.data.seatId===ac){SeatList.selectSeat(j);j=null}}})};return{handleHolesAndAvailability:function(){var ab=SeatList.getSelectedSeats(),ac=[],ad=false;if(u&&ab){$.each(ab,function(ae,af){if(!af.priceQty){ac.push(ae)}else{ad=true}});if(ac.length){tools.dialog.showWaitingPopup("checkHolesAndAvailabilityDialog",true);$.ajax({url:contextPath+"/ajax/seatMap/checkHolesAndAvailability",type:"GET",cache:false,data:{performanceId:u,selectedSeatsIds:ac,advantageId:T},error:function(ae){tools.dialog.hideDialog("checkHolesAndAvailabilityDialog");tools.dialog.showDialog("ajaxErrorDialog",true)},success:function(af){var ae;if(af.error){tools.dialog.hideDialog("checkHolesAndAvailabilityDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}else{if(af.impossible||(af.newProposal&&(!af.hasOwnProperty("physicalSeats")||af.physicalSeats.length!==SeatList.getNbSelectedSeats()))){tools.dialog.hideDialog("checkHolesAndAvailabilityDialog");if(af.requestHadAvailabilityProb){tools.dialog.showDialog("impossible_selection_holes_popup",true,true)}else{if(af.requestHadHoles){tools.dialog.showDialog("impossible_selection_noAvailability_popup",true,true)}else{tools.dialog.showDialog("impossible_selection_default_popup",true,true)}}}else{if(af.newProposal){tools.dialog.hideDialog("checkHolesAndAvailabilityDialog");if(af.requestHadAvailabilityProb){ae=SeatList._LABEL_EXPLANATION_NOT_AVAILABLE}else{ae=SeatList._LABEL_EXPLANATION_HOLE}$("#new_selection_popup_explanation").html(ae);if(af.physicalSeats.length>4){$("#new_selection_popup_previous").hide()}else{$("#new_selection_popup_previous").show();$("#new_selection_popup_previous .new_selection_popup_values_seats").html(g(ab))}d(af.physicalSeats);if(Object.keys(SeatList.getNewProposalSeats()).length!==SeatList.getNbSelectedSeats()){tools.dialog.showDialog("impossible_selection_default_popup",true,true)}else{$("#new_selection_popup_new .new_selection_popup_values_seats").html(g(SeatList.getNewProposalSeats()));tools.dialog.showDialog("new_selection_popup",true,true)}}else{F(true,false);$("#EventFormModel").submit()}}}}})}else{if(ad){F(true,false);$("#EventFormModel").submit()}}}},getSeat:function(ac){var ab=M[ac];if(ab===true){return null}return ab},isSeatSelected:function(ab){return !!M[ab]},slideSeatList:function(ac,af){var ab=$("#ticket-icon-list ul li:first-child").width()*ac,ae=af?ab:-ab,ad=$("#ticket-icon-list");ad.animate({scrollLeft:"+="+ae},600)},slideInScreen:function(ae){var ah=$("#ticket-icon-list ul li:first-child").width(),ad=$("#ticket-icon-list"),ai=ad.prop("scrollLeft"),af=ad.width(),ag=ae*ah,ac=ag-ai,ab=null;if(ac<0){ab=ag}if(ac>=af){ab=ag-af+ah}if(ab!==null){ad.stop().animate({scrollLeft:ab},600);if(!ae){p($("#left-arrow"))}else{K($("#left-arrow"))}if(ae==b-1){p($("#right-arrow"))}else{K($("#right-arrow"))}}},deleteSeat:function(af,ae){var ac,ad,ab=af.data.number?false:true;SeatSessionStorage.removeStoredSeat(u,af);if(af){ad=S(af);if(!ab){ac=P(af);ac.count--;delete M[ad];b--;m()}else{z(af);delete M[ad];b-=a(af.priceQty);m()}if(!ae){y();J(af)}}},addSeat:function(af,ae){var ad=S(af),ac=P(af),ab=this.getSeat(ad);if(!ab){b++}else{P(ab).count--}M[ad]=af;ac.count++;m();if(!ae){y();E(af,ab)}},addNonNumberedSeat:function(ad){var ac=S(ad),ab=this.getSeat(ac);if(!ab){O(ad);b+=a(ad.priceQty)}else{if(ad.priceQty.length===0){SeatList.deleteSeat(ab);return}O(ad,ab);b-=a(ab.priceQty);b+=a(ad.priceQty)}M[ac]=ad;m();y();E(ad,ab)},preselectSeat:function(ab){if(!M[ab]){M[ab]=true;m();N()}},cancelPreselectSeat:function(ab){if(M[ab]===true){delete M[ab];m();N()}},selectSeat:function(ah,ag){var ae=S(ah),ab=$("#pre-cart #ticket-icon-list #tid--"+ae).index(),ad=ab+1,ac=ah.data.seatCentroid,af=ah.data.number?false:true;$("#pre-cart #details-list li").hide();$("#pre-cart #details-list li:nth-child("+ad+")").show();$("#pre-cart #ticket-icon-list ul li").removeClass("selected-ticket");$("#pre-cart #ticket-icon-list ul li:nth-child("+ad+")").addClass("selected-ticket");SeatList.slideInScreen(ab);SeatMap.selectSeat(ae,af);if(ag){j=ah;SeatMap.panToSeat(ac.x,ac.y);if(!ah.data.number){SeatMap.map.zoomTo(1)}SeatDetails.preventCategoryDisplay()}},getNewProposalSeats:function(){return i},getSelectedSeats:function(){return M},getNbSelectedSeats:function(){return b},getFirstVisibleSeatPos:function(){var ab=$("#ticket-icon-list"),ad=$("#ticket-icon-list ul li"),ae=0,ac=null;jQuery.each(ad,function(af,ag){ac=$(ag);if(ac.offset().left>=ab.offset().left){ae=af;return false}});return ae},checkAddPrice:function(ae,ad,ab){if(c&&ab+b>c){return"OVER_GLOBAL_MAX"}var ac=P(ae,ad);if(ac.maxQuantity===null||ac.count+ab<=ac.maxQuantity){return true}return"OVER_PRICE_MAX"},canBook:function(){return e},getFailingMinimum:function(){return l},getSeatDescriptionFromData:function(ab){var ac={data:ab};return w(ac)+" "+SeatList._LABEL_NOT_CONTRACTUAL_VIEW},handleValidation:function(af,ab){af.preventDefault();var ag=false,ae=ab?$("#emptyMemberCardMobile"):$("#emptyMemberCard"),ad=ab?$("#membership_verification_mobile_block"):$("#membership_verification_block"),ah=membershipVerificationCommon.getVerificationContainer(ab),ac=ah.find(".button.addWithValidation");if(ac.hasClass("disabled")){return}ad.find("input").each(function(){if($(this).val().length===0){ag=true;$(this).parent().addClass("error")}else{$(this).parent().removeClass("error")}});if(ag){ae.removeClass("hidden");return}audSubCatVerification.validateAllQuantities($(af.target),true,function(ai){if(ai){membershipVerificationCommon.hideVerificationDialog(ab);SeatList.handleHolesAndAvailability()}})},restoreSelectedSeats:function(ac){var ab=0,ad;for(ab in ac){if(ac[ab].numbered){if(isChangeSeatMode){ad=ac[ab].seatData.data.seatId;SeatList.addOrUpdateSeatInCartToList(ac[ab].seatData,ad,false)}else{SeatList.addSeat(ac[ab].seatData)}}else{if(!isChangeSeatMode){SeatList.addNonNumberedSeat(ac[ab].seatData)}}}if(!isChangeSeatMode){U()}else{selectFirstSeatAdded(true)}},setSelectedSeat:function(ac,ab){M[ac]=ab},getSelectedSeatId:function(){var ab=$("#pre-cart #icons-and-arrows li.selected-ticket"),ac=null;if(ab.length>0){ac=$(ab).attr("id").replace("tid--","")}return ac},updateSeat:function(ad){var ac=SeatList.getSelectedSeatId(),ab,ae;if(ac===null){return}$("#pre-cart #details-list li:visible").attr("id","pre-cart-line--"+ad);ae=$("#pre-cart #icons-and-arrows li.selected-ticket");$(ae).attr("id","tid--"+ad);$(ae).find("a").attr("id","id--"+ad);ab=SeatList.getSeat(ac);if(ab){delete M[ac];b--;$("#pre-cart #details-list #pre-cart-line--"+ac).remove();$("#pre-cart #ticket-icon-list #tid--"+ac).remove();B(false);$("#pre-cart #num-tickets").html(SeatDetails._LABEL_YOUR_SELECTION+" ("+SeatList.getNbSelectedSeats()+")");if(!SeatList.getNbSelectedSeats()){$("#seat-details .seat-info-content").hide();$("#seat-details .seat-info-placeholder").show();$("#total_button_container #total").hide();SeatMap.unselectAllSeats()}SeatMap.redrawSeat(parseInt(ac,10),"default",true)}},isInSeatList:function(ab){var ac=$("#pre-cart #icons-and-arrows li#tid--"+ab);return ac.length>0},updateSeatListWidget:function(ac,ad,ab){$("#pre-cart #num-tickets").html(SeatDetails._LABEL_YOUR_SELECTION+" ("+SeatList.getNbSelectedSeats()+")");if(!ab){addSeatDetailsIntoList(ac)}B(true);f(ad,ac);SeatMap.redrawSeat(parseInt(ac,10),"addedToCart",true)},init:function(ad){u=ad.performanceId;G=ad.isMobile;T=ad.partnerAdvantageId;c=ad.maxAllowedSeats;SeatMap.events.on("initSeatsLayerDone",aa);var ab={},ac=$("#content").width(),ae=function(ah,af){var ag=parseInt(ah,10);if(isNaN(ag)){return af}return ag};t=ae(ad.mainContentWidth,700);o=ae(ad.maxNumberOfTicketsNonMobile,8);W=ae(ad.maxNumberOfTicketsMobile,5);seatMapContainerInitialWidth=$("#seat-map-sub-container").parent().outerWidth();r=ae(ad.maxNumberOfTicketsFullScreen,16);$(window).resize(function(){clearTimeout(ab);ab=setTimeout(function(){ac=Z(ac)},100)});$("#impossible_selection_default_popup .button.modify").click(function(){N();tools.dialog.hideDialog("impossible_selection_default_popup")});$("#impossible_selection_holes_popup .button.modify").click(function(){N();tools.dialog.hideDialog("impossible_selection_holes_popup")});$("#impossible_selection_holes_popup .button.auto_selection").click(function(){F(false,false);$("#EventFormModel").submit()});$("#impossible_selection_noAvailability_popup .button.modify").click(function(){window.location.reload()});$("#new_selection_popup .button.modify").click(function(){N();tools.dialog.hideDialog("new_selection_popup")});$("#new_selection_popup .button.accept_new").click(function(){tools.dialog.showWaitingPopup("checkHolesAndAvailabilityDialog",true);F(true,true);$("#EventFormModel").submit()});$("#pre-cart").on("click","#ticket-icon-list ul li",function(){var af=$(this).attr("id").replace("tid--","");$("#delete-seat").parent().removeClass("disabled");SeatList.selectSeat(SeatList.getSeat(af),true)}).on("click","#left-arrow, #right-arrow",function(){var ak=(this.id==="left-arrow")?true:false,ag=$("#ticket-icon-list ul li"),ai=null,ah=ak?$("#right-arrow"):$("#left-arrow"),aj=$(this),af=A();if(aj.hasClass("clickable")){if(ak){ai=$(ag[SeatList.getFirstVisibleSeatPos()]).prev().prev()}else{ai=$(ag[SeatList.getFirstVisibleSeatPos()+af-1]).next().next()}SeatList.slideSeatList(1,!ak);K(ah);if(ai.length===0){p(aj)}}}).on("click","#details-list li .alternative_button a",function(ag){ag.preventDefault();var af=$(this).attr("id");SeatList.deleteSeat(SeatList.getSeat(af.replace("id--","")))}).on("click","#add-to-cart",function(ah){ah.preventDefault();var ai=$(this),ag=ai.parent(),af;if(ag.hasClass("disabled")){return}ag.addClass("disabled");if(ai.text()===SeatList._LABEL_BUTTON_ADDTOCART){SeatList.handleHolesAndAvailability()}else{af=h("EXTERNAL");if(!jQuery.isEmptyObject(af)){audSubCatVerification.initVerificationDialog(af,G)}}});SeatMap.events.on("mapLoaded",function(){var ag=SeatSessionStorage.getSelectedSeats(u),af,ah=[];if(ag!==null&&ag.length>0){for(af in ag){if(ag[af].numbered){ah.push(ag[af].seatData.data.seatId)}}if(ah.length>0){tools.dialog.showWaitingPopup("checkHolesAndAvailabilityDialog",true);$.ajax({url:contextPath+"/ajax/seatMap/checkHolesAndAvailability",type:"GET",cache:false,data:{performanceId:u,selectedSeatsIds:ah,advantageId:T},error:function(ai){SeatSessionStorage.clearPerformance(u);tools.dialog.hideDialog("checkHolesAndAvailabilityDialog")},success:function(ai){if(ai.error){SeatSessionStorage.clearPerformance(u);tools.dialog.hideDialog("checkHolesAndAvailabilityDialog")}else{if(ai.requestHadAvailabilityProb){SeatSessionStorage.clearPerformance(u);$("#impossible_selection_avail_message").fadeIn()}else{Q(ag)}}tools.dialog.hideDialog("checkHolesAndAvailabilityDialog")}})}else{Q(ag)}}})}}});var SeatMap={_LABEL_SEAT_RANK:"",_LABEL_YOUR_SELECTION:"",_LABEL_TOTAL:"",_LABEL_SEAT_BLOCK:"",_LABEL_BUTTON_UPDATE:"",_LABEL_BUTTON_SELECT:"",_LABEL_SEAT_NUMBER:"",_ADV_LABELS:{},TILE_SIZE:512,productId:null,performanceId:null,partnerAdvantageId:null,resourcesUrl:null,freeSeatsUrl:null,areasUrl:null,zoomLevels:0,maxZoomScale:0,resolutions:[],map:null,mapProjection:null,blocks:null,miscProperties:{},seatsCache:null,seatsLayer:null,seatProjection:null,closeUpResolutionIndex:null,blocksLayer:null,freeSeatsStyleMap:null,nnAreas:null,nnAreasLayer:null,selectControl:null,nnAreaStyleMap:null,nnAreasInfo:[],mapLayers:[],unSelectedFeatures:[],zoomOnAreaIdArray:[],zoomOnNNAreaIdArray:[],nnAreaIds:[],numberedAreas:null,areasLayer:null,areaStyleMap:null,isAllowMultipleSelection:false,isDistributionSeatMap:false,blocksColor:"#0099FF",fallbackBlocksColor:"#0099FF",selectedSeatBorderColor:"#000",distributionSelectedSeatBorderColor:"#000",tempSelected:null,events:$({}),additionalBlockInfo:{},hiddenBlocks:{},freeSeatsCallInProgress:null,miniMapProperties:{OVERVIEW_SIZE:120,NAVMAP_PATH:"&z=-1&x=0&y=0"},miniMapFeature:null,init:function(j){var k=this,f,a,e,b,c,i,g,d,h;OpenLayers.ImgPath=contextPath+"/resources/themes/base/images/visualizer/"+j.openLayerImagesFolder+"/";i=util.color.hexColor($("#block_color").css("background-color"));if(i==="transparent"){this.blocksColor=this.fallbackBlocksColor}else{this.blocksColor=i}f=[new OpenLayers.Rule({maxScaleDenominator:50,symbolizer:{pointRadius:10}}),new OpenLayers.Rule({minScaleDenominator:50,maxScaleDenominator:105,symbolizer:{pointRadius:5}}),new OpenLayers.Rule({minScaleDenominator:105,maxScaleDenominator:205,symbolizer:{pointRadius:3.5}}),new OpenLayers.Rule({maxScaleDenominator:410,minScaleDenominator:205,symbolizer:{pointRadius:1}}),new OpenLayers.Rule({minScaleDenominator:410,symbolizer:{pointRadius:0.5}}),new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"isComplimentary",value:true}),symbolizer:{graphicName:"square"}}),new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"isDistributed",value:true}),symbolizer:{fillOpacity:0,strokeColor:"#${color}",strokeWidth:2}})];a=[new OpenLayers.Rule({maxScaleDenominator:50,symbolizer:{pointRadius:10}}),new OpenLayers.Rule({minScaleDenominator:50,maxScaleDenominator:105,symbolizer:{pointRadius:5,strokeWidth:2}}),new OpenLayers.Rule({minScaleDenominator:105,maxScaleDenominator:205,symbolizer:{pointRadius:3.5,strokeWidth:1}}),new OpenLayers.Rule({maxScaleDenominator:410,minScaleDenominator:205,symbolizer:{pointRadius:1,strokeWidth:1}}),new OpenLayers.Rule({minScaleDenominator:410,symbolizer:{pointRadius:0.5,strokeWidth:1}})];e=new OpenLayers.Style({fillColor:"#${color}",rotation:"${rotation}",strokeWidth:0,cursor:"pointer"},{rules:f});b=new OpenLayers.Style({fillColor:"#${color}",strokeColor:this.selectedSeatBorderColor,rotation:"${rotation}",strokeWidth:4},{rules:a});c=new OpenLayers.Style({fillColor:this.selectedSeatBorderColor,strokeColor:"#${color}",rotation:"${rotation}",strokeWidth:4},{rules:a});h=new OpenLayers.Style({fillColor:"#${color}",strokeColor:this.distributionSelectedSeatBorderColor,rotation:"${rotation}",strokeWidth:2},{rules:f});this.freeSeatsStyleMap=new OpenLayers.StyleMap({"default":e,select:j.isDistributionSeatMap?h:b,addedToCart:c});d=new OpenLayers.Style({fillColor:"#${nnAreaColor}",fillOpacity:0.8,strokeWidth:0,cursor:"pointer"});g=new OpenLayers.Style({fillColor:"#${nnAreaColor}",strokeColor:this.selectedSeatBorderColor,strokeWidth:2,fillOpacity:0.8,cursor:"pointer"});addedToCartAreaStyle=new OpenLayers.Style({fillColor:"#${nnAreaColor}",strokeColor:"${nnAreaInCartColor}",strokeWidth:2,fillOpacity:0.8,cursor:"pointer"});this.nnAreaStyleMap=new OpenLayers.StyleMap({"default":d,select:g,addedToCart:addedToCartAreaStyle});this.areaStyleMap=new OpenLayers.StyleMap(new OpenLayers.Style({fillColor:"none",strokeColor:"none"}));this.resourcesUrl=j.resourcesUrl;this.freeSeatsUrl=j.freeSeatsUrl;this.container=j.container;this.productId=j.productId;this.performanceId=j.performanceId;this.partnerAdvantageId=j.partnerAdvantageId;this.areasUrl=j.areasUrl;this.additionalBlockInfo=j.blockInfo;this.isAllowMultipleSelection=j.isAllowMultipleSelection;this.isDistributionSeatMap=j.isDistributionSeatMap;OpenLayers.Request.GET({url:j.metadataUrl,callback:function(l){if(l.status!==200||!k.parseMetadata(l.responseText)){tools.dialog.showDialog("ajaxErrorDialogReload",true,true)}else{k.initMap();k.initProjections();k.initBlocksLayer();if(k.nnAreas!==null&&!k.isDistributionSeatMap){k.initNonNumberAreaLayer()}if(k.numberedAreas!==null&&!k.isDistributionSeatMap){k.initNumberAreaLayer()}k.initSeatsLayer();k.initZoomControls();k.initSelectControl();k.initMiniMap();k.initFullScreenControl();var m=k.getZoomOnBlocksAreas(j.zoomOnBlockIds);k.initZoomOnAreaIds(k.getZoomOnBlocksAreas(j.zoomOnAreaIds));if((k.zoomOnAreaIdArray.length>0)&&(k.numberedAreas!==null)){k.zoomOnAreaIdArray=k.zoomMap(k.zoomOnAreaIdArray,"AREA")}else{if((m.length>0)&&(k.blocks!==null)){k.zoomMap(m,"BLOCK")}}if(k.nnAreas===null){k.events.trigger("mapLoaded")}}}})},initZoomOnAreaIds:function(c){var d=this,a,b;for(b in c){a=c[b];if(jQuery.inArray(a,d.nnAreaIds)>-1){d.zoomOnNNAreaIdArray.push(a)}else{d.zoomOnAreaIdArray.push(a)}}},getZoomOnBlocksAreas:function(a){var b=[];if(a!=="null"){b=a.split("_")}return b},zoomMap:function(b,a){if(b.length===1){this.zoomToBlockOrArea(b[0],a)}else{if(b.length>1){this.zoomToBlocksOrAreas(b,a)}}return[]},initSelectControl:function(){this.selectControl=new OpenLayers.Control.SelectFeature(this.mapLayers,{multiple:this.isAllowMultipleSelection?true:false,hover:false,toggle:true,clickout:this.isAllowMultipleSelection?false:true});this.map.addControl(this.selectControl);this.selectControl.activate()},updateDataList:function(b,d,a){var c=b.split("."),e=c[1];if(!a){a={}}if(!a[e]){a[e]={}}if(!a[e].linearRings){a[e].linearRings=[]}if(!isNaN(c[2])&&$.inArray(c[3],["x","y"])>-1){if(!a[e].linearRings[c[2]]){a[e].linearRings[c[2]]={}}a[e].linearRings[c[2]][c[3]]=d}return a},parseMetadata:function(e){var g=e.split(/\n/),f,c,d,b,a;for(b=0;b<g.length;b++){if(g[b].length>0&&g[b].match("^#")!="#"){f=g[b].split("=");if(f.length===2){c=f[0];d=f[1];if(c.indexOf("zoom")!==-1){this.zoomLevels++;if(d>this.maxZoomScale){this.maxZoomScale=d}}else{if(c.indexOf("block")!==-1){this.blocks=this.updateDataList(c,d,this.blocks)}else{if(c.indexOf("nnarea")!==-1&&!this.isDistributionSeatMap){this.nnAreas=this.updateDataList(c,d,this.nnAreas);a=c.split(".")[1];if($.inArray(a,this.nnAreaIds)===-1){this.nnAreaIds.push(a)}}else{if(c.indexOf("area")!=-1){this.numberedAreas=this.updateDataList(c,d,this.numberedAreas)}else{this.miscProperties[c]=d}}}}}}}if(this.zoomLevels===0){return false}for(b=1;b<=this.zoomLevels;b++){this.resolutions.push(Math.pow(2,this.zoomLevels-b)/this.maxZoomScale)}if(this.blocks){this.closeUpResolutionIndex=this.resolutions.length-2}else{this.closeUpResolutionIndex=0}return true},initZoomControls:function(){var a=this.map;$("#zoom-in").click(function(){a.zoomIn()});$("#zoom-out").click(function(){a.zoomOut()})},initFullScreenControl:function(){var d=this.map,c=$(".main_content.seat_selection"),b="fullscreen-mode-background-overlay",a=$("<div></div>"),e=$("#toggle-fullscreen-button");$(e).click(function(f){f.preventDefault();$(c).toggleClass("fullscreen");if(!$("#"+b).length>0){$(a).attr("id",b);$(c).prepend($(a));$("#"+b).click(function(){$(e).trigger("click")})}tools.scrollToElement($(c),800);$(this).toggleClass("selected");d.updateSize();$(window).resize()});$(document).keydown(function(f){if(f.which==27){if($(c).hasClass("fullscreen")){$(e).trigger("click")}}})},initMiniMap:function(){var d=(this.TILE_SIZE*Math.pow(2,this.zoomLevels-1))/this.maxZoomScale,a=new OpenLayers.Bounds(0,0,d,d),c,b;this.miniMapFeature=new OpenLayers.Layer.Vector("miniBlocks",{styleMap:new OpenLayers.StyleMap(new OpenLayers.Style({fillColor:"#000",strokeWidth:1,strokeColor:"#000"}))});b={size:new OpenLayers.Size(this.miniMapProperties.OVERVIEW_SIZE,this.miniMapProperties.OVERVIEW_SIZE),div:$("#mini-map")[0],layers:[new OpenLayers.Layer.Image("smallOverview",this.resourcesUrl+this.miniMapProperties.NAVMAP_PATH,a,new OpenLayers.Size(this.miniMapProperties.OVERVIEW_SIZE,this.miniMapProperties.OVERVIEW_SIZE)),this.miniMapFeature],minRectSize:2,mapOptions:{theme:null}};c=new OpenLayers.Control.OverviewMap(b);c.isSuitableOverview=function(){return true};this.map.addControl(c);$("#toggle-mini-map").click(function(){$(this).toggleClass("selected");$("#mini-map").toggleClass("hidden")})},initMap:function(){var e=(this.TILE_SIZE*Math.pow(2,this.zoomLevels-1))/this.maxZoomScale,a=new OpenLayers.Bounds(0,0,e,e),c,b,d=this;this.mapProjection=new OpenLayers.Projection("mapCoordinates");this.map=new OpenLayers.Map(this.container,{maxExtent:a,resolutions:this.resolutions,restrictedExtent:a,projection:this.mapProjection,units:"cm",theme:null,controls:[new OpenLayers.Control.Navigation()],numZoomLevels:this.zoomLevels,transitionEffect:"resize"});c={type:"png",tileSize:new OpenLayers.Size(this.TILE_SIZE,this.TILE_SIZE),getURL:function(i){var h=this.map.getResolution(),f=Math.round((i.left-this.maxExtent.left)/(h*this.tileSize.w)),l=Math.round((this.maxExtent.top-i.top)/(h*this.tileSize.h)),k=this.map.getZoom(),j="&z="+k+"&x="+f+"&y="+l,g=this.url;if(g instanceof Array){g=this.selectUrl(j,g)}return g+j},opacity:1,styleMap:new OpenLayers.StyleMap(new OpenLayers.Style({fillColor:"none",fillOpacity:0,pointRadius:10,strokeColor:"blue",strokeWidth:1,strokeOpacity:1})),transitionEffect:"resize"};b=new OpenLayers.Layer.TMS("background",this.resourcesUrl,c);this.map.addLayer(b);this.map.setBaseLayer(b);this.map.events.on({zoomend:function(f){if(this.getZoom()<=d.resolutions.length-2){b.setOpacity(0.3)}else{b.setOpacity(1)}}});this.map.setCenter(this.map.getMaxExtent().getCenterLonLat(),1);this.map.zoomTo(0)},addLayerToMap:function(a,b){this.map.addLayer(a);this.transformToFeatures(b,a,true);this.mapLayers.push(a)},initNumberAreaLayer:function(){var a=this;a.areasLayer=new OpenLayers.Layer.Vector("areas",{projection:a.seatProjection,isFixed:true,styleMap:a.areaStyleMap});a.addLayerToMap(a.areasLayer,a.numberedAreas)},filterAreasByAvailability:function(a){var b=this;jQuery.each(a,function(c,d){if(d.seatCategoryId!==null&&d.color!==null){b.nnAreasInfo.push(d)}else{delete b.nnAreas[d.id]}})},initNonNumberAreaLayer:function(){var b=this,a={perfId:b.performanceId,advantageId:b.partnerAdvantageId?b.partnerAdvantageId:"",areaIds:Object.keys(b.nnAreas)};this.showLoadingNotification();$.ajax({url:b.areasUrl,type:"GET",cache:false,data:a,error:function(c){tools.dialog.showDialog("ajaxErrorDialog",true)},success:function(c){b.filterAreasByAvailability(c.areas);b.transformToFeatures(b.nnAreas,b.nnAreasLayer,true);if(b.zoomOnNNAreaIdArray.length>0){b.zoomOnNNAreaIdArray=b.zoomMap(b.zoomOnNNAreaIdArray,"NNAREA")}b.events.trigger("mapLoaded")},complete:function(){b.hideLoadingNotification()}});b.nnAreasLayer=new OpenLayers.Layer.Vector("nnAreas",{projection:b.seatProjection,isFixed:true,styleMap:b.nnAreaStyleMap});b.map.addLayer(b.nnAreasLayer);b.mapLayers.push(b.nnAreasLayer);b.events.trigger("initnnAreasLayerDone")},getAreaColor:function(b){var a=jQuery.grep(this.nnAreasInfo,function(d,c){return(d.id.toString()===b)})[0];return a.color},getAreaSeatCategory:function(b){var a=jQuery.grep(this.nnAreasInfo,function(d,c){return(d.id.toString()===b)})[0];return a.seatCategoryId},getAreasBySeatCategory:function(b){if(!this.nnAreasInfo){return[]}var a=jQuery.grep(this.nnAreasInfo,function(d,c){return(d.seatCategoryId.toString()===b)});return a},initBlocksLayer:function(){var b=this,a=this.resolutions[this.closeUpResolutionIndex-1];if(a===undefined){if(this.resolutions.length>1){a=this.resolutions[0];this.closeUpResolutionIndex++}else{a=10000}}this.blocksLayer=new OpenLayers.Layer.Vector("blocks",{projection:this.seatProjection,minResolution:a,styleMap:new OpenLayers.StyleMap(new OpenLayers.Style({fillColor:"${fillColor}",fillOpacity:0.8,strokeWidth:0,cursor:"pointer"}))});this.blocksLayer.events.on({featureselected:function(d){var c=d.feature.geometry.getCentroid();b.panToSeat(c.x,c.y)}});this.events.trigger("initBlocksLayerDone");b.addLayerToMap(b.blocksLayer,b.blocks)},initSeatsLayer:function(){var a=this,d=new OpenLayers.Protocol.HTTP({url:this.freeSeatsUrl,format:new OpenLayers.Format.GeoJSON(),read:function(f){if(a.freeSeatsCallInProgress){a.freeSeatsCallInProgress.priv._object.abort();a.freeSeatsCallInProgress=null}var e=a.getSeatsFromCache(f);if(!e){e=OpenLayers.Protocol.HTTP.prototype.read.apply(this,arguments);a.freeSeatsCallInProgress=e}else{this.handleRead(e.olResponse,f)}},params:{productId:a.productId,performanceId:a.performanceId,advantageId:a.partnerAdvantageId},handleRead:function(h,g){var f=h.priv.responseText,i=new OpenLayers.Format.JSON(),e=null;if(!f){return}e=i.read(f);if(a.freeSeatsCallInProgress){a.freeSeatsCallInProgress=null}if(e.error){tools.dialog.showDialog("ajaxErrorDialogReload",true)}else{if(!h.isCached){h.isCached=true;a.pushSeatsInCache(h,g)}this.handleResponse(h,g)}}}),b=this.getCustomBBOXStrategy(),c=new b({blocks:this.blocks});this.seatsLayer=new OpenLayers.Layer.Vector("seats",{strategies:[c],projection:this.seatProjection,protocol:d,styleMap:this.freeSeatsStyleMap,maxResolution:this.resolutions[this.closeUpResolutionIndex],alwaysInRange:!this.blocks});this.seatsLayer.events.on({loadstart:a.showLoadingNotification,loadend:a.hideLoadingNotification});this.map.addLayer(this.seatsLayer);this.mapLayers.push(this.seatsLayer);this.events.trigger("initSeatsLayerDone")},initProjections:function(){this.seatProjection=new OpenLayers.Projection("seatsCoordinates");var b=parseFloat(this.miscProperties.xOffset),c=parseFloat(this.miscProperties.yOffset),a=this.map.maxExtent.top;OpenLayers.Projection.addTransform("mapCoordinates","seatsCoordinates",function(d){d.y=Math.floor(a-d.y+c);d.x=Math.floor(d.x+b);return d});OpenLayers.Projection.addTransform("seatsCoordinates","mapCoordinates",function(d){d.y=a-d.y+c;d.x=d.x-b;return d})},transformToFeatures:function(b,h,d){if(!b){return}var m=0,o,k,a=[],f,e,l=[],g,c,n;for(m in b){o=b[m];a=[];for(e=0;e<o.linearRings.length;e++){g=o.linearRings[e];c=g.x.split(",");n=g.y.split(",");l=[];for(f=0;f<c.length-1;f++){k=new OpenLayers.Geometry.Point(c[f],n[f]);OpenLayers.Projection.transform(k,this.seatProjection,this.mapProjection);l.push(k.clone())}a.push(new OpenLayers.Geometry.LinearRing(l))}o.id=m;o.geometry=new OpenLayers.Geometry.Collection(a);h.addFeatures([new OpenLayers.Feature.Vector(o.geometry,o)])}},panToSeat:function(b,a){this.map.setCenter(new OpenLayers.LonLat(b,a),this.zoomLevels-1)},getFeaturesOfLayer:function(a){var b=[];switch(a){case"AREA":b=this.areasLayer.features;break;case"NNAREA":b=this.nnAreasLayer.features;break;default:b=this.blocksLayer.features}return b},zoomToBlockOrArea:function(e,d){var a=0,c,b=this.getFeaturesOfLayer(d);for(a in b){if(b[a].data.id===e){c=b[a].geometry.bounds;this.map.zoomToExtent(this.increaseBounds(c),true);break}}},zoomToBlocksOrAreas:function(l,a){var f=0,h=0,b=new OpenLayers.Bounds(),g,d=[],n=null,e=null,m,j=false,c=this.getFeaturesOfLayer(a),k,o;for(f in c){o=c[f];k=o.data.id.toString();if($.inArray(k,l)>-1){b.extend(o.geometry.getBounds());d.push(o.geometry);j=true}}if(j){g=b.getCenterPixel();for(h;h<d.length;h++){m=g.distanceTo(d[h].bounds.getCenterPixel());if(n===null||m<n){n=m;e=d[h]}}if(e!==null){this.map.zoomToExtent(this.increaseBounds(e.bounds),true)}}},increaseBounds:function(c){var b=(c.right-c.left)*0.2,a=(c.top-c.bottom)*0.2,d=new OpenLayers.Bounds();d.left=c.left-b;d.right=c.right+b;d.top=c.top+a;d.bottom=c.bottom-a;return d},selectSeat:function(a,e){var d=parseInt(a,10),c=null,b=null,g=null,f=null;if(e){c=this.nnAreasLayer.features}else{c=this.seatsLayer.features}this.selectControl.unselectAll();for(g in c){b=c[g];f=parseInt((e?b.data.id:b.fid),10);if(f===d){found=true;this.selectControl.select(b);break}}},unselectAllSeats:function(){this.selectControl.unselectAll()},getSeatsFromCache:function(a){if(!this.seatsCache){this.seatsCache=new SeatCache(this.mapProjection,this.seatProjection)}return this.seatsCache.getFromCache(a,this.map.getExtent())},pushSeatsInCache:function(b,a){if(!this.seatsCache){this.seatsCache=new SeatCache(this.mapProjection,this.seatProjection)}return this.seatsCache.pushInCache(b,a)},getCustomBBOXStrategy:function(){return OpenLayers.Class(OpenLayers.Strategy.BBOX,{ratio:1,update:function(b){mapBounds=this.layer.map.getExtent();var d=false,e,a,c;forcedRead=false;if(!SeatMap.blocks){d=true}else{for(a in SeatMap.blocks){e=SeatMap.blocks[a];if(!e.geometry){d=true;break}c=e.geometry.getBounds();if(c.intersectsBounds(mapBounds)){d=true;break}}}if(b&&b.force){this.calculateBounds(mapBounds);this.resolution=this.layer.map.getResolution();this.triggerRead(b);forcedRead=true}mapBounds=this.getMapBounds();if(d&&!forcedRead&&mapBounds!==null&&((b&&b.force)||this.invalidBounds(mapBounds))){this.calculateBounds(mapBounds);this.resolution=this.layer.map.getResolution();this.triggerRead(b)}this.ratio=1.5}})},redrawSeat:function(a,c,d){var b;for(b in this.seatsLayer.features){if(this.seatsLayer.features[b].fid===a){if(!d||this.selectedSeatId!==a){this.seatsLayer.drawFeature(this.seatsLayer.features[b],c)}break}}},redrawArea:function(a,c){var b;for(b in this.nnAreasLayer.features){if(this.nnAreasLayer.features[b].data.id===a){this.nnAreasLayer.drawFeature(this.nnAreasLayer.features[b],c);break}}},removeArea:function(c,a){var b=this;jQuery.each(this.nnAreasLayer.features,function(d,e){if(e.data.id===c){b.unSelectedFeatures.push(e);b.nnAreasLayer.removeFeatures(e);return false}})},addArea:function(b){var a=this;jQuery.each(this.unSelectedFeatures,function(c,d){if(d.data.id===b){a.nnAreasLayer.addFeatures(d);return false}})},hideBlock:function(a){var b=this;jQuery.each(this.blocksLayer.features,function(c,d){if(d.data.id===a){b.hiddenBlocks[a]=d;b.blocksLayer.removeFeatures(d);return false}})},showBlock:function(b){var a=this.hiddenBlocks[b];if(a){delete this.hiddenBlocks[b];this.blocksLayer.addFeatures(a)}},refreshSeatLayer:function(){if(this.map.resolution<=this.resolutions[this.closeUpResolutionIndex]){this.seatsLayer.refresh({force:true})}},showLoadingNotification:function(){$("#seat-map .loading").fadeIn(800)},hideLoadingNotification:function(){$("#seat-map .loading").fadeOut(800)}};tools.module("SeatPano",function(){var b=null,c=null,f=null,e=null,d=null,a=function(){var h=$("#"+c),g=$("#"+b);if(!h.length&&g.length){$("#"+b).append("<div id="+c+"></div>")}};return{init:function(g){b=g.containerId;c=g.krpanoContainerId;f=g.panoSWFUrl;e=g.panoJSUrl;d=g.html5Config;$(function(){a()})},displayPanel:function(g){if($("#"+c+" > div").length){removepano(c);a()}embedpano({swf:f,js:e,xml:g,target:c,html5:d})}}});tools.module("SeatSessionStorage",function(){var c=null,e=function(f,g){tools.storage.setItem(a(f),{contactNumber:c,data:g})},d=function(f){var g=tools.storage.getItem(a(f));if(!g){return null}if(g.contactNumber===null||g.contactNumber===c){return g.data}return null},b=function(f){tools.storage.removeItem(a(f))},a=function(f){return"seatMapSelection_"+f};return{init:function(f){if(f){c=f}},storeSelectedSeat:function(j,g,i){var l={seatData:g,numbered:i},f=d(j),k,h=false;if(f===null){f=[]}else{for(k in f){if(f[k].seatData.data.seatId===g.data.seatId){f[k]=l;h=true;break}}}if(!h){f.push(l)}e(j,f)},getSelectedSeats:function(f){return d(f)},removeStoredSeat:function(g,i){var f=this.getSelectedSeats(g),h;if(f!==null){for(h in f){if(f[h].seatData.data.seatId===i.data.seatId){f.splice(h,1);e(g,f);break}}}},clearPerformance:function(f){b(f)}}});tools.module("services",{init:function(){$("#bookService #book").on("click",function(a){a.preventDefault();functions.validateQuantities(true,null,$("#bookService"))});$("#bookService").on("keypress",function(a){if(a.keyCode==13){a.preventDefault();functions.validateQuantities(true,null,$("#bookService"))}})}});tools.module("social.fb",{imageUrl:contextPath+"/images/",shareProducts:[],institutionUrl:null,isMobile:false,isTnMCApplication:false,init:function(d,b,a,c){if(FB){FB.init({appId:d,status:true,cookie:true,logging:true})}this.institutionUrl=b;this.isMobile=a;this.isTnMCApplication=c}},null,{loadOnce:true});tools.module("social.fb.join",{joinButtonId:"join_button",joinButtonClass:"join_button",init:function(){$("[data-stx-event-id]").click(function(){var a=$(this).attr("data-stx-event-id");social.fb.join.joinEvent(a)})},joinEvent:function(a){tools.dialog.showWaitingPopup("loadingDialog",true);FB.login(function(b){FB.api("/"+a+"/attending","post",function(c){if(c.error){$("#facebook_join_success_message").hide();$("#facebook_join_error_message").show()}else{$("#facebook_join_error_message").hide();$("#facebook_join_success_message").show()}tools.dialog.hideDialog("loadingDialog")})},{scope:"rsvp_event"})}});tools.module("social.fb.share",{imageUrl:contextPath+"/images/",tnmcNativeShareURL:"http://tnmc.secutix.com/sharefb",shareProducts:[],init:function(d){var c=$("#main_content_confirmation_facebook .selector_container select"),b=this,a;this.shareProducts=d;for(a=0;a<d.length;a++){c.append("<option value='"+a+"'>"+d[a].productName+"</option>")}$("#main_content_confirmation_facebook #share").on("click",function(){b.shareProduct()});$("#main_content_confirmation_facebook .selector_container select").on("change",function(){b.displayProduct($(this).val())});if(d.length>0){this.displayProduct(0)}},shareProduct:function(){var d=$("#main_content_confirmation_facebook .selector_container select"),b=d.length?d.val():0,a=this.shareProducts[b],c=this;if($("#display_places").is(":checked")&&"extendedDescription" in a){a.description=a.extendedDescription}c.shareOnFacebook(a)},displayProduct:function(a){$("#facebook_join_error_message").hide();$("#facebook_join_success_message").hide();var c=this.shareProducts[a],b=$("#main_content_confirmation_facebook .product_image_container img");if(!c.logoUrl){b.hide()}else{b.attr("src",c.logoUrl).attr("alt",c.productName).attr("title",c.productName);b.show()}$("#main_content_confirmation_facebook .content .title").html(c.productName);$("#main_content_confirmation_facebook .content .day").html(c.startDate?c.startDate:"");$("#main_content_confirmation_facebook .content .location").html(c.venue?c.venue:"");if("extendedDescription" in c){$("#display_places_container").show()}else{$("#display_places_container").hide()}if(c.socialEventId&&"FACEBOOK" in c.socialEventId){$("#join").attr("data-stx-event-id",c.socialEventId.FACEBOOK);$("#join").parent().show()}else{$("#join").parent().hide()}},shareOnFacebook:function(b){var a=social.fb.isMobile?"touch":"popup";if(social.fb.isTnMCApplication){window.location.href=this.tnmcNativeShareURL+"?link="+encodeURIComponent(b.productUrl)+"&picture="+encodeURIComponent(b.logoUrl)+"&name="+encodeURIComponent(b.productName)+"&caption="+encodeURIComponent(b.linkCaption)+"&description="+encodeURIComponent(b.description)}else{if(FB){FB.ui({method:"feed",link:b.productUrl,picture:b.logoUrl,name:b.productName,caption:b.linkCaption,description:b.description,displayMode:a},function(c){if(c&&c.post_id){$.get(contextPath+"/ajax/share/register",{tracker:b.trackingId})}})}}}});function TimeSlotPass(d,g,e,i,a){var j={},c=function(k){if(i){$("#timeslot_rate_container").html(k)}else{$("#timeslots_container_id").html(k);$("#timeSlotsPassSelectedDate").html($("#newtimeSlotsPassSelectedDate").html());$("#newtimeSlotsPassSelectedDate").remove()}},f=function(l){var m={},k=l,n;n=j[l];if(n){c(n.content);return}tools.dialog.showWaitingPopupDelayed("loadingDialog",true,false,300);if(l!==null){if(!(l instanceof Object)){l=$.datepicker.parseDate(datePickerConfig.dateFormat,l)}m={year:l.getFullYear(),month:l.getMonth()+1,day:l.getDate()}}m.productId=d;m.advantageId=g;m.rateInsteadOfTimeslotsTable=i;m.minQuantity=e?e:"";m.ppid=a.ppid;m.crossSellId=a.crossSellId;m.reservationIdx=a.reservationIdx;$.ajax({type:"GET",url:contextPath+"/ajax/selection/timeslots",cache:false,data:m,success:function(o){c(o);if(!j[k]){j[k]={content:o}}tools.dialog.hideDialog("loadingDialog")},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},b=function(l){var k=$.datepicker.parseDate(datePickerConfig.dateFormat,l);j[k]={content:$("#timeslots_container_id").html()}},h=function(){var k=$("#min_quantity").val();if(!/^\d*$/.test(k)){return}if(!k||k==="0"){k=null}util.url.updateUrlAndReload({minQuantity:k},true)};this.updateTimeSlots=function(k){if(!(k instanceof Object)){k=$.datepicker.parseDate(datePickerConfig.dateFormat,k)}f(k)};this.init=function(l){if(!i){b(l.date)}var k=function(){h();return false};$("#min_quantity_submit").on("click",k);$("#min_quantity").on("keydown",function(m){if(m.keyCode==13){return k()}});$("select#min_quantity").on("change",k);$("#min_quantity_reset").on("click",function(){$("#min_quantity").val("");return k()})}};tools.module("transport.locations",function(){var y=false,p=false,i=false,s=null,m=null,f=null,c={},j=null,k=null,r=2,v={},l={},d=function(A,E){var z=$("input#"+A),H=$("select#"+A+"Selection"),J=$("span#"+A+"Single"),G=$("#"+A+"Btn"),F=$("[name='transport."+A+"Location']"),B=(z&&z.is(":focus"))||(H&&H.is(":focus")),K,D,C,I;z.parent().removeClass("disabled");$("#autocomplete_error_"+A).addClass("hidden");if(!E||!E.length){H.add(J).addClass("hidden");z.removeAttr("readonly").removeClass("disabled hidden");G.show().parent().removeClass("disabled hidden");F.val("");if(E){$("#noRouteError").show();transport.ticketHolders.disableTravelCards();t(A)}else{if(B){z.focus()}}}else{z.addClass("hidden");G.hide();if(E.length==1){I=E[0];J.removeClass("hidden").html(I.label);F.val(I.code);H.addClass("hidden");w(E[0].code,A,J)}else{J.addClass("hidden");F.val("");if(!l[A]){$("option",H).each(function(){var L=$(this);if(L.val()){L.remove()}});l[A]=H.html()}K=[l[A]];for(D=0,C=E.length;D<C;D++){I=E[D];K.push("<option value="+I.code+">"+I.label+"</option>")}H.html(K.join("")).removeClass("hidden");if(B){H.focus()}}}},t=function(B){var z=$("input#"+B),A=z.parent();z.removeClass("hidden").addClass("disabled").attr("readonly","readonly").val("");A.addClass("disabled").removeClass("clearEnabled").find(".clearButton").hide();$("#"+B+"Btn").show().parent().addClass("disabled").removeClass("hidden");$("select#"+B+"Selection, span#"+B+"Single").addClass("hidden")},q=function(z){$(z).addClass("loading").attr("placeholder",k+"...")},h=function(z){$(z).removeAttr("placeholder").removeClass("loading")},n=function(){var z={productId:s,arrivalCode:v.arrivalLocation,departureCode:v.departureLocation};if(m){z.packageLineId=m}if(f){z.advantageId=f}$.ajax({url:contextPath+"/ajax/transport/audienceSubCatAllowed",data:z}).then(function(A){if(!A||A.length){transport.ticketHolders.enableTravelCards();transport.ticketHolders.setAllowedTravelCardIds(A)}else{$("#noPriceError").show();transport.ticketHolders.disableTravelCards();transport.ticketHolders.setAllowedTravelCardIds(A)}})},g=function(C,B){var A=B?$(B):$(this),z=A.parent(),D=z.find(".clearButton");if(A.val()&&!A.hasClass("loading")){z.addClass("clearEnabled");D.show();D.one("click",function(){A.val("").blur().focus();z.removeClass("clearEnabled");D.hide()})}else{z.removeClass("clearEnabled");D.hide()}},w=function(A,E,z){var B=null,C=null,D=null;z.parents(".error").removeClass("error");$("#notification, #error_transportStationsAreEqual, #noPriceError, #noRouteError").hide();$("#autocomplete_error_"+E).addClass("hidden");$("[name='transport."+E+"']").val(A);v[E]=A;if(!z.is("select")&&!z.is("span")){g(null,z)}if(E=="departureLocation"&&y){C="departure";D="arrival"}if(E=="arrivalLocation"&&p){C="arrival";D="departure"}if(D){v[D+"Location"]=null;t(D+"Location");if(A){q("input#"+D+"Location");B={productId:s};B[D]=true;B[C+"Code"]=A;if(m){B.packageLineId=m}if(f){B.advantageId=f}$.ajax({url:contextPath+"/ajax/transport/location",data:B}).then(function(G,F,H){h("input#"+D+"Location");d(D+"Location",G)},function(){h("input#"+D+"Location")})}else{h("input#"+D+"Location")}if(i){transport.ticketHolders.disableTravelCards()}}if(i){if(v.arrivalLocation&&v.departureLocation){n()}else{transport.ticketHolders.disableTravelCards()}}},a=function(A,B){var C=$(this),z=B.item.label;if(z){C.val(z)}w(B.item.code,$(this).attr("id"),C)},u=function(D,B,E){var A=0,z=D?D.length:0,C={code:""};B=B.toLowerCase();for(;A<z;A++){if(D[A].label.toLowerCase()===B){C=D[A];break}}a.call($(E),null,{item:C})},b=function(D,A){var B=D.term,z=this.selector,C=this;$(z).addClass("loading");if(this.timeout){clearTimeout(this.timeout)}this.timeout=setTimeout(function(){var E=C.parent;u(null,B,z);if("departure" in C){D.departure=C.departure}if("arrival" in C){D.arrival=C.departure}if("via" in C){D.via=C.via}D.productId=s;if(m){D.packageLineId=m}if(f){D.advantageId=f}if(E){D[E+"Code"]=v[E+"Location"]}C.lastXhr=$.ajax({url:contextPath+"/ajax/transport/location",data:D});C.lastXhr.then(function(G,F,H){if(H===C.lastXhr){$(z).removeClass("loading");if(C.focus){A(G)}}u(G,B,z)},function(){$(z).removeClass("loading")})},200)},x=function(G,z){var K=[],B=[],F=0,D=G.length,L=z+"StationListDialog",C=$("#"+L),E=null,J,H,I,A;$("#ticketholders .travel_card, #field_departure_location, #field_arrival_location").each(function(){$(this).tipsy("hide")});G.sort(function(N,M){return N.label>M.label?1:-1});for(;F<D;F++){H=G[F];I=H.label;A=H.code;J=I.substr(0,1).toLowerCase();if(J!=E){E=J;B.push(E);K.push("</div><div class='clear'></div>","<div id='stations_"+E+"' class='autocomplete-station'>");K.push("<span class='letter-title'>"+E+"</span>")}K.push("<a href='#' data-code='"+A+"'>"+I+"</a>")}K.shift();K.push("</div>");K="<div class='stations-container'>"+K.join("")+"</div>";C.find(".autocomplete-stations").html(K);$(".stations-container",C).on("click","a",function(N){var O=$(this),M=z+"Location";N.preventDefault();$("#"+z+"Location").val(O.html());w(O.data("code"),M,$("#"+M));tools.dialog.hideDialog(L);$(".autocomplete-stations").html("")});K=[];C.find(".letter").addClass("disabled");C.find(".letter-selector option").not(":first").remove();for(F=0,D=B.length;F<D;F++){E=B[F];C.find(".letter-"+E).removeClass("disabled");K.push("<option value='"+E+"'>"+E.toUpperCase()+"</option>")}C.find(".letter-selector").append(K.join(""));tools.dialog.showDialog(L,true,false,null,"transport_locations_station_modal_dialog")},e=function(A){var z,B;if(A){z=$("#stations_"+A.toLowerCase());B=parseInt(z.css("marginTop"),10);B=B?B:0;$(".autocomplete-stations").scrollTop(z.position().top+B)}},o=function(z,C,B){var E="input#"+z+"Location",D="[name='transport."+z+"Location']",F="#"+z+"LocationSelection",J="#"+z+"LocationBtn",I="#autocomplete_error_"+z+"Location",G=z+"Location",A={xhr:null,timeout:null,focus:false},H=function(){if($(E).parent().hasClass("disabled")){return c[z]}return""};v[G]=$(D).val();$(F).on("change",function(){var K=$(this);w(K.val(),G,K)});A[z]=true;A.selector=E;A.parent=B;$(E).autocomplete({minLength:r,source:$.proxy(b,A),autoFocus:true,select:a,close:function(){$(this).parent().removeClass("error")},position:{my:"left top",at:"left bottom",collision:"flip"},delay:0}).focus(function(){$(E).attr("autocomplete","off");$(I).addClass("hidden");if(C){$("#autocomplete_error_"+C+"Location").addClass("hidden")}if($(window).width()<=700){$("html, body").animate({scrollTop:$(this).parent().parent().offset().top},"slow")}A.focus=true}).blur(function(){var K=$(this),L=K.val();if(K.hasClass("hidden")){return}if(!L||L.length<r){$(D).val("");v[G]=null}if(!v[G]){if(i){transport.ticketHolders.disableTravelCards()}if(C){v[C+"Location"]=null;t(C+"Location");$("#autocomplete_error_"+C+"Location").removeClass("hidden").find(".message").html(c[C])}else{if(i&&(!B||v[B+"Location"])){$(I).removeClass("hidden").find(".message").html(j)}}}A.focus=false}).keyup(g).change(g).parent().tipsy({className:"tipsy-hover",html:true,delayIn:200,gravity:"s",title:H});$(J).on("click",function(K){var L={productId:s,forList:true};L[z]=true;if(m){L.packageLineId=m}if(B){L[B+"Code"]=v[B+"Location"]}K.preventDefault();if($(this).parent().hasClass("disabled")){return}$(E).addClass("loading");$(I).addClass("hidden");$.ajax({url:contextPath+"/ajax/transport/location",data:L}).then(function(N,M,O){x(N,z);$(E).removeClass("loading")},function(){$(E).removeClass("loading")})})};$.ui.autocomplete.prototype._renderItem=function(A,B){var z=B.label.replace(new RegExp("("+this.term+")","gi"),"<span class='match'>$1</span>");return $("<li></li>").data("item.autocomplete",B).append("<a>"+z+"</a>").appendTo(A)};return{init:function(z){s=$("#productId").val();m=z.packageLineId;f=z.advantageId;y=z.originDestinationDependency;p=z.destinationOriginDependency;i=z.originDestinationAudienceSubCatDependency;c.arrival=z.arrivalDisabledTooltip;c.departure=z.departureDisabledTooltip;j=z.travelCardDisabledTooltip;k=z.loadingPlaceholder;o("departure",y?"arrival":null,p?"arrival":null);o("arrival",p?"departure":null,y?"departure":null);if(i&&v.departureLocation&&v.arrivalLocation){n()}$(".station-list").on("click",".letter",function(B){var C=$(this),A=$.trim(C.html()).toLowerCase();B.preventDefault();if(!C.hasClass("disabled")){$(".letter.selected").removeClass("selected");C.addClass("selected");e(A)}}).on("change",".letter-selector",function(){e($(this).val())});if($("#departureLocation").val()&&$("#arrivalLocation").hasClass("disabled")||$("#arrivalLocation").val()&&$("#departureLocation").hasClass("disabled")){$("#departureLocation").val("");$("#arrivalLocation").val("")}}}});tools.module("transport.offers",function(){var h=null,f=false,n=function(v){return !!v},d=function(w){var v=n(w);if(v){if($("[name='transport.departureLocation']").val()!==$("[name='transport.arrivalLocation']").val()){return true}$("#notification.hidden").removeClass("hidden");$("#error_transportStationsAreEqual").removeClass("hidden")}return false},p=null,m={RETURN:["departureLocation","arrivalLocation","departureDate","returnDate","itemClass","onewayReturn"],ROUND_OPEN:["date","departureLocation","arrivalLocation","returnFromLocation","itemClass"],ROUND_CLOSED:["date","departureLocation","itemClass"],ONEWAY:["date","departureLocation","arrivalLocation","itemClass"]},k=null,j={RETURN:{departureLocation:d,arrivalLocation:n,departureDate:n,returnDate:n},ROUND_OPEN:{date:n,departureLocation:n,arrivalLocation:n,returnFromLocation:n},ROUND_CLOSED:{date:n,departureLocation:n}},u=function(v){return $.datepicker.parseDate(datePickerConfig.dateFormat,v)},a=function(){return[true,"datepicker_free datepicker_selectable"]},t=function(w,v){v.beforeShowDay=a;v.selectOtherMonths=false;return tools.date.makeDatePicker(w,v)},i=function(v){return $.datepicker.formatDate(datePickerConfig.dateFormat,v)},s=function(x){var w=null,B=null,C=new Date(),v,z,E=h.parentPackageLineId,y=null,A=1,D;if(f){y=packages.dates.getCurrentDate(E);A=packages.duration}if(x.data==="RETURN"){v=$("#datePickerDialog_transportDeparture");z=$("#departureDate");if(f&&y){w=new Date(packages.dates.getCurrentDate(E));B=new Date(w);B.setDate(B.getDate()-h.validity+A)}else{if(f&&packages.dates.getCurrentValidityFrom(E)){B=new Date(packages.dates.getCurrentValidityFrom(E));w=new Date(packages.dates.getCurrentValidityTo(E))}else{if(h.minTransportDate){B=u(h.minTransportDate)}else{B=C}if(h.maxTransportDate){w=u(h.maxTransportDate)}else{w=new Date();w.setYear(w.getFullYear()+50)}}}C.setHours(0,0,0,0);B.setHours(0,0,0,0);w.setHours(0,0,0,0);if(B-C<0){B=C}if(w-C<0){w=C}if(w&&tools.date.isSameDate(B,w)){z.attr("disabled","disabled");z.parent().addClass("disabled");z.val(i(w));datepickerSelect(null,{currentYear:w.getFullYear(),currentMonth:w.getMonth(),currentDay:w.getDate()},true)}else{v.datepicker("option","minDate",B);v.datepicker("option","maxDate",w);v.datepicker("option","defaultDate",w);z.removeAttr("disabled");z.parent().removeClass("disabled");if(y){if(h.validity<4){v.datepicker("setDate",w);z.val(i(w));datepickerSelect(null,{currentYear:w.getFullYear(),currentMonth:w.getMonth(),currentDay:w.getDate()},true)}else{v.datepicker("setDate",null);z.val("");datepickerSelect(null,null,true)}}else{D=z.val();if(D){D=u(D);D={currentYear:D.getFullYear(),currentMonth:D.getMonth(),currentDay:D.getDate()}}else{D={currentYear:B.getFullYear(),currentMonth:B.getMonth(),currentDay:B.getDate()}}datepickerSelect(null,D,true)}}}else{if(y){$("#date").attr("disabled","disabled").val(i(y));$("#date").parent().addClass("disabled")}else{if(f){B=packages.dates.getCurrentValidityFrom(E);w=packages.dates.getCurrentValidityTo(E)}else{if(h.minTransportDate){B=u(h.minTransportDate)}if(h.maxTransportDate){w=u(h.maxTransportDate)}}if(!B||B<C){B=C}v=$("#datePickerDialog_transportDeparture");v.datepicker("option","minDate",B);if(w){v.datepicker("option","maxDate",w)}}}},b=function(){var v=transport.offers.request;if(v){v.abort();transport.offers.request=null}return false},r=function(){var w=$("[name='transport.itemClass']:checked").val()||$("[name='transport.itemClass']").val(),v=$("[name='transport.onewayReturn']:checked").val()||$("[name='transport.onewayReturn']").val()||"";return h.items[w+"_"+v]},q=function(v){var w=$(v.currentTarget).attr("id");$("[name='transport.uniqueIdentifier']").val(w);$("input:disabled.hasDatepicker").removeAttr("disabled");$("#transportProductItemId").val(r());if(f){tools.form.submitWithProcessing($("#PackageFormModel"))}else{tools.form.submitWithProcessing($("#transportSubmitForm"))}return false},e=function(){$("#main_content_transport_offers").parent().remove()},g=function(){tools.dialog.forceButtonDisplay();$("div.offer","#main_content_transport_offers").click(q);$("#cancelOffer").click(function(){$("#main_content_transport_dialog").parent().dialog("destroy").remove();return false})},o=function(w){var x,y=$(window).height()*0.7,v="";tools.dialog.hideDialog("pleaseWaitDialog");transport.offers.request=null;if($("body").hasClass("lte2_3")){v=" androidlte2_3"}else{if($("body").hasClass("gt2_3")){v=" androidgt2_3"}else{v=" noandroid"}}x=$(w).dialog({dialogClass:"transport_offers_modal_dialog"+v,draggable:false,modal:true,resizable:false,width:"auto",open:g,close:e});if($("#main_content_transport_offers").height()>y){$("#main_content_transport_offers").height(y).css("overflow-y","scroll").css("overflow-x","hidden");x.dialog("option","position","center").dialog("option","width","auto")}},c=function(x,w){var v=function(){tools.dialog.showDialog(w,true,false,false,"date_picker_popup")};$(x).click(v).keydown(function(y){if(y.keyCode==13||y.keyCode==40){v()}}).addClass("hasDatepicker")},l=function(x,w,v){tools.dialog.hideDialog("pleaseWaitDialog");transport.offers.request=null;if(w!=="abort"){tools.dialog.showDialog("ajaxErrorDialog",true)}};return{init:function(){if(h){if(h.requestOfferDisabled){packages.disableWholeContainer();return}$("#cancelRequest").click(b);$("#request_offers").click($.proxy(this.submit,this));if(h.type==="RETURN"){datepickerSelect=function(E,B,C){var F=$("#departureDate"),x=$("#returnDate"),v=$("#datePickerDialog_transportReturn"),y=f?packages.duration:1,z,w,A,D;F.parent().removeClass("error");if(!B){x.val("");v.datepicker("setDate",null);return}D=new Date(B.currentYear,B.currentMonth,B.currentDay);if(E){F.val(E)}if(f&&packages.dates.getCurrentDate()){z=new Date(packages.dates.getCurrentDate())}else{z=new Date(D)}if(y!=1){z.setDate(z.getDate()+y-1)}w=new Date(D.setDate(D.getDate()+h.validity-1));if(w.getTime()<z.getTime()){w=new Date(z)}if(tools.date.isSameDate(z,w)){x.attr("disabled","disabled").val(i(z));x.parent().addClass("disabled");v.datepicker("setDate",z)}else{x.removeAttr("disabled");x.parent().removeClass("disabled");A=v.datepicker("getDate");v.datepicker("option","minDate",z).datepicker("option","maxDate",w);if(A===null||(A-z)<=0||(A-w)>0){$("#datePickerDialog_transportReturn").datepicker("option","defaultDate",z);$("#datePickerDialog_transportReturn").datepicker("setDate",z);x.val(i(z))}}tools.dialog.hideDialog("datePickerDialog_transportDeparture");if(!C){$("#departureDate").focus()}};t("#datePickerDialog_transportDeparture",{onSelect:datepickerSelect});t("#datePickerDialog_transportReturn",{onSelect:function(v){tools.dialog.hideDialog("datePickerDialog_transportReturn");$("#returnDate").val(v).focus().parent().removeClass("error")}});c("#departureDate","datePickerDialog_transportDeparture");c("#returnDate","datePickerDialog_transportReturn");$('input[name="transport.onewayReturn"]').change(function(){if($("#field_oneway_choice").is(":checked")){$("#field_date_return").hide(0.4)}else{$("#field_date_return").show(0.4)}});if($("#field_oneway_choice").is(":checked")){$("#field_date_return").hide(0.4)}else{$("#field_date_return").show(0.4)}}else{t("#datePickerDialog_transportDeparture",{onSelect:function(v){$("#date").parent().removeClass("error");$("#date").val(v);tools.dialog.hideDialog("datePickerDialog_transportDeparture")}});c("#date","datePickerDialog_transportDeparture");if(h.type==="ROUND_OPEN"){$("#returnFromLocation").prop("disabled",true);if($("#arrivalLocation option").length===0){$("#returnFromLocation").prop("disabled",false)}$("#arrivalLocation").change(function(){$("#returnFromLocation").prop("disabled",false).val("");$("option","#returnFromLocation").prop("disabled",false);$("#returnFromLocation").find("option[value='"+$("#arrivalLocation").val()+"']").prop("disabled",true)})}}s({data:h.type});if(f){packages.dates.events.bind(packages.dates.DATE_CHANGE,h.type,s)}}},setConfiguration:function(v){h=v;p=m[h.type];k=j[h.type];if(h.type==="RETURN"){if(!h.isReturn){delete k.returnDate}}h.productId=$("#productId").val();if(h.packageLineId){f=true}},submit:function(){if(this.request){return}var y={},B=transport.ticketHolders.getPassengers(true),E=!B,C,D,w,z=0,x=p.length,A=h.parentPackageLineId,v=null;if(f){v=packages.dates.getCurrentDate(A)}if(h.type==="RETURN"&&h.isOneWay&&h.isReturn){if($("#transport.onewayReturn").filter(":checked").val()==="ONEWAY"){delete k.returnDate}else{k.returnDate=n}}for(;z<x;z++){C=p[z];D=$("[name='transport."+C+"']","#main_content_transport_definition");if(D.length>1){D=D.filter(":checked")}w=$.trim(D.val());if(k[C]&&!k[C](w)){if(!E){E=true;if(D.attr("type")!=="hidden"){D.focus()}else{D.prev().focus()}}D.parent().addClass("error")}else{if(C!="onewayReturn"&&C!="itemClass"){y[C]=w}}}if(!E&&B){y.transportProductItemId=r();y.passengers=B;if(f){y.selections=packages.selectionConfiguration}this.passengers=B;y.packageLineId=h.packageLineId;y.productId=h.productId;y.advantageId=h.advantageId;if(v){y.selectedDate=i(v)}if(secutix.date&&secutix.date.picker&&secutix.date.picker.check){secutix.date.picker.check.checkToday(function(){transport.offers.finalizeSubmit(y)})}else{this.finalizeSubmit(y)}}else{if(!$("#notification").hasClass("hidden")){window.scrollTo(0,0)}}return false},finalizeSubmit:function(v){tools.dialog.showWaitingPopup("pleaseWaitDialog",true,b);this.request=$.ajax({url:contextPath+"/ajax/transport/offers",type:"post",processData:false,data:JSON.stringify(v),contentType:"application/json",success:$.proxy(o,this),error:l})}}});tools.module("transport.ticketHolders",function(){var T=null,B=null,s=null,y=null,v=null,o=1,J=9,I=12,m=99999999,C=97,G=null,r=null,D=o,V=0,i=null,u=["firstName","lastName","birthDate","reductionType","audienceSubCategoryId","cardNumber","isCardValid"],P={},g=[],N={},M=[],L=null,t=true,n=true,q=true,R=false,w={firstName:function(Y){return !!Y},lastName:function(Y){return !!Y},birthDate:function(ab){var Z,Y;try{Z=$.datepicker.parseDate(i,ab)}catch(aa){return false}Y=/\d{4}/.exec(ab);if(Y&&Y.length===1){if(Z.getFullYear()!==parseInt(Y[0],10)){return false}}if(Z&&Z.getTime()<(new Date()).getTime()&&Z.getFullYear()>1000){return $.datepicker.formatDate(i,Z)}return false},reductionType:function(Y){return !!Y},audienceSubCategoryId:function(Y){return !!Y},cardNumber:function(Z){var Y=$("input[name='transport.passengers["+Z+"].isCardValid']").val();if(Y==="VALID"){return true}else{return false}}},a="ticketHolderState",b=$.fn.placeholder.input?function(){}:function(Z,Y){$("input[name='transport.passengers["+Z+"].birthDate']",Y).placeholder()},E=function(Z,ab,aa){var Y="["+aa+"]";Z.attr("id",ab+Y).find("input, select").each(function(){var ad=$(this),ac=ad.attr("name");if(ac){ac=ac.replace(/\[\d+\]/,Y);ad.attr("name",ac)}});Z.find("a").each(function(){var ac=$(this),ad=ac.attr("id");if(ad){ad=ad.replace(/\[\d+\]/,Y);ac.attr("id",ad)}});$("input[name='transport.passengers["+aa+"].passengerNumber']",Z).val(aa+1);b(aa,Z)},K=function(Y){Y.preventDefault();var Z=$(Y.currentTarget),ab=Z.attr("id"),aa=parseInt(/\d+/.exec(ab)[0],10);transport.ticketHolders.deleteLine(aa);return false},z=function(ac){var ad=$(ac.currentTarget),aa=ad.attr("name"),Z=parseInt(/\d+/.exec(aa)[0],10),ab=ad.find(":selected").attr("code"),Y=$("#travel_card_info\\["+Z+"\\]");if(ab==="B2P_GA"){Y.show();$("input[name='transport.passengers["+Z+"].isCardValid']").attr("value","INVALID")}else{if(Y.is(":visible")){x(Y,Z)}}},x=function(Z,Y){var aa=Z.find(".success_icon");Z.find("input").attr("value","");if(aa.is(":visible")){c(aa,"hide")}Z.find(".validate_field").removeClass("error");$("input[name='transport.passengers["+Y+"].isCardValid']").attr("value","VALID");Z.hide();H()},X=function(ab){var ad=$(ab.currentTarget),aa=ad.attr("name"),Z=parseInt(/\d+/.exec(aa)[0],10),Y=$("#travel_card_info\\["+Z+"\\]"),ac=Y.find(".success_icon");$("input[name='transport.passengers["+Z+"].isCardValid']").attr("value","INVALID");if(ac.is(":visible")){c(ac,"hide")}Y.find(".validate_field").removeClass("error")},c=function(Z,Y){if(Y==="hide"){Z.removeClass("visible_field").addClass("hidden_field")}else{Z.removeClass("hidden_field").addClass("visible_field")}},j=function(Z){var Y=0;for(Y,l=u.length;Y<l;Y++){if(u[Y]!=="isCardValid"&&Z[u[Y]]!==""){return true}}return false},H=function(){var Y=transport.ticketHolders.getPassengers();Y.length=V;tools.storage.setItem(a,Y)},F=function(){try{var ah=tools.storage.getItem(a),aa,Z,Y,af,ab,ag,ac,ad;if(ah){af=ah.length;for(aa=0;aa<af;aa++){ac=ah[aa+1];if(j(ac)){ad=aa;if(aa>o-1){ad=D;transport.ticketHolders.addLine()}ab="transport.passengers["+ad+"].";for(Z=0,Y=u.length;Z<Y;Z++){ag=u[Z];$("[name='"+ab+ag+"']").val(ac[ag]);if(ag==="reductionType"){if($("[name='"+ab+ag+"']").find(":selected").attr("code")==="B2P_GA"){$("#travel_card_info\\["+ad+"\\]").show()}}}}}}else{transport.ticketHolders.deleteLine(0)}}catch(ae){tools.storage.removeItem(a)}},W=function(){var aa=packages.allowedSubCategories,Y=aa.length,Z=0,ab;P={};g=[];aa.sort(function(ad,ac){return ad.rank>ac.rank});for(;Z<Y;Z++){ab=aa[Z].id;g.push(ab);P[ab]=packages.audienceSubCategories[ab]}},A=function(ab,ac){var Y=ab.length,aa=0,ad,Z=[];for(;aa<Y;aa++){ad=ab[aa];Z.push("<option value='"+ad+"'>");Z.push(ac[ad]);Z.push("</option>")}return Z.join("")},h=function(){return s+A(g,P)},p=function(){return y+A(L||M,N)},f=function(Y){W();var Z=h();$("#ticketholders select[name*='].audienceSubCategoryId']").each(function(){var aa=$(this).val();$(this).html(Z).val(aa)});if(Y){H()}},O=function(Y){var Z=p();$("#ticketholders select[name*='].reductionType']").each(function(){var aa=$(this).val();$(this).html(Z).val(aa)});if(Y){H()}},e=function(Y){var Z=$('<div class="travel_card_info hidden">'+B+"</div>");E(Z,"travel_card_info",Y);return Z},U=function(ab){var ad="transport.passengers["+ab+"].",Z=$("[name='"+ad+"cardNumber']"),ac=Z.val().replace(/[^a-z0-9]/gi,""),af=$("#travel_card_info\\["+ab+"\\]").find(".success_icon"),Y=Q(ac,Z),aa=$("[name='"+ad+"isCardValid']"),ae=true;switch(Y){case"INVALID":validation.showErrorTooltip(Z,G);Z.parent().addClass("error");if(af.is(":visible")){c(af,"hide")}Z.focus();aa.attr("value","INVALID");ae=false;break;case"ALREADY_USED":validation.showErrorTooltip(Z,r);Z.parent().addClass("error");if(af.is(":visible")){c(af,"hide")}Z.focus();aa.attr("value","INVALID");ae=false;break;default:if(!af.is(":visible")){c(af,"show")}aa.attr("value","VALID");Z.parent().removeClass("error");ae=true}return ae},k=function(Z){var aa=$(Z.currentTarget),ab=aa.attr("id"),Y=parseInt(/\d+/.exec(ab)[0],10);U(Y);return false},d=function(aa,Z){var ab=$("input[name$='cardNumber']"),Y=false;ab.splice(jQuery.inArray(Z[0],ab),1);ab.each(function(){var ac=$(this);if(ac.val().replace(/[^a-z0-9]/gi,"")===aa){Y=true;return false}});return Y},Q=function(ac,aa){var Z,ab,Y;if(ac===""){Y="INVALID"}else{if(d(ac,aa)){Y="ALREADY_USED"}else{switch(ac.length){case 10:if(/^\d+$/.test(ac)){Z=parseInt(ac.substring(0,8),10);ab=parseInt(ac.substring(8),10);if((Z>=I)&&(Z<=m)&&(ab===Z%C)){Y="VALID"}else{Y="INVALID"}}else{Y="INVALID"}break;case 6:if(/[A-Za-z]{3}[0-9]{3}/.test(ac)){Y="VALID"}else{Y="INVALID"}break;default:Y="INVALID"}}}return Y},S=function(Z){var Y;T=$("#ticketholder\\[0\\]").html();B=$("#travel_card_info\\[0\\]").html();s=$("select[name='transport.passengers[0].audienceSubCategoryId']").html();i=$("input[name='transport.passengers[0].birthDate']").data("pattern");if(Z){Y=$("select[name='transport.passengers[0].reductionType']");Y.find("option").each(function(){var ab=$(this),aa=$(this).attr("value");if(aa){N[aa]=ab.html();M.push(aa);ab.remove()}});y=Y.html()}};return{init:function(Y){t=Y.withLeisure;R=Y.originDestinationAudienceSubCatDependency;v=Y.travelCardDisabledTooltip;o=Y.minQuantity;J=Y.maxQuantity;G=Y.errInvalidCard;r=Y.errNumberUsed;D=o;var Z;$("#button_add_participant").click(this.addLine);$("#ticketholders").on("click",".alternative_button.delete a",K).on("change","input, select",H);$("#ticketholders .ticketholder .travel_card").tipsy({className:"tipsy-hover",live:true,delayIn:200,gravity:"s",title:function(){if(!q){return v}return""}});$("#ticketholders").on("change",".travel_card select",z).on("click",".alternative_button.validate a",k);$("#ticketholders").on("keydown","input[name$='cardNumber']",X);for(Z=0;Z<o;Z++){secutix.date.combos.populateCombosDatepicker("day_"+Z,"month_"+Z,"year_"+Z,datePickerConfig.monthNames)}$("#ticketholders").on("change",".birthDay, .birthMonth, .birthYear",function(){var ac=$(this).parent(),aa=parseInt($(".birthDay",ac).val(),10),ad=parseInt($(".birthMonth",ac).val(),10),ab=parseInt($(".birthYear",ac).val(),10),ae=aa&&ad&&ab?aa+"."+ad+"."+ab:"";ac.find("input").val(ae)});S(R);F();if(t){f();packages.events.bind(packages.SELECTION_CHANGE,f)}else{u.splice(jQuery.inArray("audienceSubCategoryId",u),1)}if(R){this.disableTravelCards()}b(0)},addLine:function(Z){if(D<J&&n){var aa=$('<div class="ticketholder">'+T+"</div>"),Y;aa.find("select[name='transport.passengers[0].audienceSubCategoryId']").html(h());if(R){Y=aa.find("select[name='transport.passengers[0].reductionType']");Y.html(p());Y.prop("disabled",!q)}E(aa,"ticketholder",D);$("#ticketholders").append(aa).append(e(D));if(Z){$("[name='transport.passengers["+D+"].firstName']").focus()}D++;if(D===J){$("#button_add_participant").addClass("disabled")}}return false},deleteLine:function(Z){if(!n){return}var Y=$("#travel_card_info\\["+Z+"\\]"),aa;$("input[name='transport.passengers["+Z+"].cardNumber']").tipsy("hide");if(D<=o){$("#ticketholder\\["+Z+"\\]").find("input, select").each(function(){var ab=$(this);if(ab.attr("type")!="hidden"){ab.val("")}});if(Y.is(":visible")){x(Y,Z)}}else{$("#ticketholder\\["+Z+"\\]").remove();$("#travel_card_info\\["+Z+"\\]").remove();for(aa=Z+1;aa<D;aa++){E($("#ticketholder\\["+aa+"\\]"),"ticketholder",aa-1,true);E($("#travel_card_info\\["+aa+"\\]"),"travel_card_info",aa-1,true)}D--;if(D===J-1){$("#button_add_participant").removeClass("disabled")}}H()},getPassengers:function(al){var ah={},ae,ai,ad,Y,aj,ak=false,ac,ab,aa,Z,af=0;for(ac=0;ac<D;ac++){ae={};ad="transport.passengers["+ac+"].";for(ab=0,aa=u.length;ab<aa;ab++){ai=u[ab];aj=$("[name='"+ad+ai+"']");Y=$.trim(aj.val());if(al){if(ai!=="isCardValid"){if(ai==="cardNumber"){Z=w[ai](ac);if(!Z){if(U(ac)){Z=true}}}else{Z=w[ai](Y)}if(!Z){if(!ak){ak=true;try{aj.focus()}catch(ag){}}aj.parent().addClass("error")}else{if(Z!==true){aj.val(Z);ae[ai]=Z}else{ae[ai]=Y}}}}else{ae[ai]=Y}}if(j(ae)){af++;ah[af]=ae}}V=af;return ak?null:ah},clearCache:function(){tools.storage.removeItem(a)},enable:function(){n=true;$(".ticketholders_container").removeClass("disabled").find("input, select").removeAttr("disabled");if(!T){S(true);F()}},disable:function(){n=false;$(".ticketholders_container").addClass("disabled").find("input, select").attr("disabled","disabled")},enableTravelCards:function(){q=true;$("#main_content_transport_ticketholders").find(".travel_card select").removeAttr("disabled")},disableTravelCards:function(){q=false;$("#main_content_transport_ticketholders").find(".travel_card select").attr("disabled","disabled")},setAllowedTravelCardIds:function(aa){var Z=0,Y=0,ac=M.length,ab=aa===null?0:aa.length,ad={};for(;Y<ab;Y++){ad[""+aa[Y]]=true}L=[];for(;Z<ac;Z++){if(aa===null||ad[M[Z]]){L.push(M[Z])}}O(true)}}});tools.module("transport.validation",{init:function(){$(document).on("change",".error input, .error select",function(){$(this).parent().removeClass("error")})}});tools.module("unsupportedBrowser",function(){var a={Opera:0,Chrome:0,Safari:0,Firefox:0,MSIE:8},c=function(){var f=navigator.userAgent,d,h,e,g=f.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(g.length>0){if(/trident/i.test(g[1])){d=/\brv[ :]+(\d+)/g.exec(f)||[];return{name:"MSIE",version:(d[1]||"")}}if(g[1]==="Chrome"){d=f.match(/\bOPR\/(\d+)/);if(d){return{name:"Opera",version:d[1]}}}h=g[1];e=g[2];d=f.match(/version\/(\d+)/i);if(d){e=d[1]}}else{h=navigator.appName;e=navigator.appVersion}return{name:h,version:e}},b=function(d){var e=a[d.name];if(e){return parseInt(d.version,10)>=e}else{return true}};return{init:function(){jQuery("#unsupported_browser .close").click(function(f){f.preventDefault();$("#unsupported_browser").hide()});if(!tools.cookie.getItem("unsupportedBrowserWarningShown")){var d=c(),e=b(d);if(!e){tools.cookie.setItem("unsupportedBrowserWarningShown",true,null,"/");$("#unsupported_browser").show()}}}}});tools.module("upsell",{upgradeSeatUrl:null,upgradedEventBookingRequest:null,reservationUrl:null,upSellSeatCategoryId:null,previousReservationIndex:null,refuseOffer:function(){$("#upsell_box").slideUp()},acceptOffer:function(){tools.dialog.showWaitingPopup("loadingDialog",true);var a=this;$.ajax({url:a.upgradeSeatUrl,type:"POST",data:a.upgradedEventBookingRequest,processData:false,contentType:"application/json",error:function(b){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)},success:function(c){if(c>0){var b=a.reservationUrl+c+"?upgradedSeatCatId="+a.upSellSeatCategoryId+"&previousReservationIndex="+a.previousReservationIndex;window.location.replace(b)}else{$("#added_message_content").parent().hide();$("#upgraded_error_message").parent().show();tools.dialog.hideDialog("loadingDialog");$("#upsell_box").hide()}}})},init:function(a){this.upgradeSeatUrl=a.upgradeSeatUrl;this.upgradedEventBookingRequest=a.upgradedEventBookingRequest;this.reservationUrl=a.reservationUrl;this.upSellSeatCategoryId=a.upSellSeatCategoryId;this.previousReservationIndex=a.previousReservationIndex}});tools.module("util.color",function(){return{invertHexColor:function(b){var a=b;a=a.substring(1);a=parseInt(a,16);a=16777215^a;a=a.toString(16);a=("000000"+a).slice(-6);a="#"+a;return a},hexColor:function(c){if(c.charAt(0)==="#"){return c}var b=c.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),a;if(!b||!b.length){return c}delete (b[0]);for(a=1;a<=3;++a){b[a]=parseInt(b[a],10).toString(16);if(b[a].length==1){b[a]="0"+b[a]}}return"#"+b.join("")},changeColorLuminance:function(e,a){e=String(e).replace(/[^0-9a-f]/gi,"");if(e.length<6){e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]}a=a||0;var b="#",f,d;for(d=0;d<3;d++){f=parseInt(e.substr(d*2,2),16);f=Math.round(Math.min(Math.max(0,f+(f*a)),255)).toString(16);b+=("00"+f).substr(f.length)}return b}}});tools.module("util.domHelper",function(){return{onDomFocus:function(b){var a=(document.documentMode===undefined),c=window.chrome;if(a&&!c){$(window).on("focusin",function(){setTimeout(function(){b()},300)})}else{if(window.addEventListener){window.addEventListener("focus",function(d){setTimeout(function(){b()},300)},false)}else{window.attachEvent("focus",function(d){setTimeout(function(){b()},300)})}}},onDomBlur:function(b){var a=(document.documentMode===undefined),c=window.chrome;if(a&&!c){$(window).on("focusout",function(){b()})}else{if(window.addEventListener){window.addEventListener("blur",function(d){b()},false)}else{window.attachEvent("blur",function(d){b()})}}}}});tools.module("util.url",function(){return{updateUrlAndReload:function(b,c){var a=this.getUpdatedUrl(window.location.href,b);if(c){tools.dialog.showWaitingPopupDelayed("loadingDialog",true,false)}window.location.href=a},getUpdatedUrl:function(a,f){var b=null,e=a.indexOf("?")!=-1,d,c;for(b in f){if(f.hasOwnProperty(b)){if(f[b]){d=b+"="+encodeURIComponent(f[b]);c=new RegExp(b+"=[^&]*(&|$)");if(c.test(a)){a=a.replace(c,d+"$1")}else{a=a.replace(/(#)|$/,(e?"&":"?")+d+"$1")}}else{c=new RegExp("(?:(\\?)|&)"+b+"=[^&]*");a=a.replace(c,"$1")}}}return a}}});tools.module("validation",{rules:{email:{minLength:1,maxLength:200,regExp:new RegExp("^[a-z0-9\\_\\-\\+\\$]+(\\.[a-z0-9\\_\\-\\+\\$]+)*@[a-z0-9\\-]+(\\.[a-z0-9\\-]+)*\\.[a-z]+$","i")},password:{minLength:6,maxLength:40,regExp:new RegExp("^.*(?=.{6,40})(?=(.*[0-9]){2}).*$")},firstname:{minLength:1,maxLength:100},lastname:{minLength:1,maxLength:100},mandatory:{minLength:1},singleFieldPhone:{minLength:7,maxLength:20,regExp:new RegExp("[0-9 ()-]+")}},countriesWithAlphanumericZip:["AR","BN","CA","IE","JM","MT","NL","PE","SO","SZ","GB","US","VE","XE","XS","XN","XW"],numericRule:function(a){if(a){return{minLength:1,regExp:new RegExp("^[-]?\\d+$"),tooltipError:validationErrors.numeric}}else{return{minLength:1,regExp:new RegExp("^[-]?\\d+$")}}},numericBoundsRule:function(d,e,a,c,b,f){if(c){return{minValue:d,maxValue:e,ignoreZero:b,valueTransformFunction:f,tooltipError:e===0?validationErrors.rangeMin:validationErrors.range}}else{return{minValue:d,maxValue:e,ignoreZero:b,valueTransformFunction:f}}},mandatoryRule:function(){return{minLength:1,tooltipError:validationErrors.mandatory}},validateField:function(c,e,b,a,d){return this.validateFieldAndHandleTooltip(false,c,e,b,a,d,true)},validateFieldSilent:function(a,b){return this.validateFieldAndHandleTooltip(false,a,b,"",false,false,false)},validateFieldAndHandleTooltip:function(j,b,p,e,f,o,k){var n=b instanceof jQuery?b:$("#"+b),q=null,a=true,m,h,d,c,g;if(!n.length){return true}c=n.val();if(!p.length){p=[{rule:p}]}for(h=0,d=p.length;h<d;h++){m=p[h].rule;q=p[h].errorId||e;tooltipError=m.tooltipError;if(m.valueTransformFunction){g=m.valueTransformFunction(c)}else{g=c}if(m.minLength&&g.length<m.minLength){a=false;break}if(m.maxLength&&g.length>m.maxLength){a=false;break}if(m.regExp&&!m.regExp.test(g)){a=false;break}if(m.method&&!m.method(g)){a=false;break}if(m.minValue!==undefined&&(parseInt(g,10)!==0||m.ignoreZero===true)&&parseInt(g,10)<m.minValue){a=false;if(tooltipError!==undefined){tooltipError=this.setTooltipParameters(tooltipError,[m.minValue,m.maxValue])}break}if(m.maxValue!==undefined&&m.maxValue!==0&&parseInt(g,10)>m.maxValue){a=false;if(tooltipError!==undefined){tooltipError=this.setTooltipParameters(tooltipError,[m.minValue,m.maxValue])}break}if(m.blackList!==undefined&&m.blackList instanceof Array&&$.inArray(g,m.blackList)>-1){a=false;break}}if(!a&&k){n.addClass("error");if(o){n.parent().addClass("error")}if(f){if(q){$("#"+q).show()}else{if(tooltipError){n.attr("title",tooltipError);n.tipsy({className:"tipsy-validation",gravity:"sw",html:true,trigger:"manual",opacity:1});n.one("focus",function(){n.tipsy("hide");n.removeClass("error")});n.tipsy("show")}}}}else{if(j){n.tipsy("hide");n.removeClass("error")}}return a},validateFields:function(g,j,d){var c=0,b=g.length,h=false,f,a,e;for(;c<b;c++){f=g[c];e=f.fieldId;a=this.validateField(f.fieldId,f.rules,f.defaultErrorId,!h,j);if(!a&&!h){if(!d){if(e instanceof jQuery){e.focus()}else{$("#"+e).focus()}}h=true}}return !h},validateFieldsSilent:function(d){var e=0,a=d.length,c=false,b,f;for(;e<a;e++){b=d[e];f=this.validateFieldSilent(b.fieldId,b.rules);if(!f&&!c){c=true}}return !c},setTooltipParameters:function(b,c){var a=0;for(;a<c.length;a++){b=b.replace("{"+a+"}",c[a])}return b},showErrorTooltip:function(a,c){var b=a instanceof jQuery?a:$("#"+a);b.attr("title",c);b.tipsy({className:"tipsy-validation",gravity:"sw",html:true,trigger:"manual",opacity:1}).tipsy("show");setTimeout(function(){b.tipsy("hide")},5000)},getFilteredZipCode:function(a){return a.replace("-","").replace(" ","")},checkZipCodeValues:function(e,a,d,c,b){if(a&&a.length>0){if($.inArray(e,validation.countriesWithAlphanumericZip)===-1&&!$.isNumeric(a)){b();return false}else{if(e=="FR"&&a.length!=5){d();return false}else{if(a.length>20){c();return false}}}}return true}});tools.module("voucher",function(){var m={},g=[],p=200,s=0.5,e=false,i=false,o={method:function(t){return $.inArray(t,m)===-1}},n={method:function(t){return $.inArray(t,g)===-1}},f={method:function(t){return $.trim(t)!==""}},c=function(){$("#staticVouchersErrors > div").hide()},h=function(){if(!e){voucher.applyVoucher()}return false},k=function(t){$("#apply-voucher").fadeTo(p,s);$("#voucher_input").addClass("loading");e=true},l=function(t){$("#apply-voucher").fadeTo(p,1);$("#voucher_input").removeClass("loading");e=false},q=function(t){e=true;$("img","#button_delete_"+t).hide();$("img.voucher-delete-spinner","#button_delete_"+t).fadeIn(p)},a=function(t){e=false},b=function(x,D){var z=x?$.trim(x):false,C=z?$(z):[],y=0,G=false,A=false,F=false,w=C.length,u=$("#dynamicVouchersErrors").empty(),v=$("#vouchers_list").empty(),H,t,E,B=$("#payment_installments .table_container");for(;y<w;y++){H=$(C[y]);t=H.attr("id");if(t){if(t=="dueAmount_amount"){$("#final_amount").html(H.html());if(typeof(insurance)!=="undefined"&&insurance.dif<0){insurance.adjustPrice($("#final_amount"))}}else{if(t=="unauthorizedVoucherOverPayment"){G=true}else{if(t=="splitPaymentNotAllowed"){A=true;$("#splitPaymentNotAllowed").remove()}else{if(t=="splitPaymentFinishWithSame"){F=true;$("#splitPaymentFinishWithSame").remove()}else{if(t.substring(0,12)==="notification"){u.append(H);H.show()}else{if(t=="payment_installments_table"&&B){B.html(H)}}}}}}}else{v.append(H)}}if(i&&!G){$("#unauthorizedOverPaymentNotification").remove();$("#unauthorizedOverPaymentError").remove();orderSummary.changeProceedButtonState()}if(!A){$("#notification_split_payment").hide()}else{$("#notification_split_payment").show();window.scrollTo(0,0)}if(!F){$("#notification_split_payment_finish").hide();$("#warning_voucher_split_payment").hide();waitingAccount.enableWaitingAccountButtons()}else{if(waitingAccount.isWaitingAccountSelected()){$("#warning_voucher_split_payment").toggle(voucher.isVoucherApplied());waitingAccount.disableWaitingAccountButtons();$("#notification_split_payment_finish").hide()}else{$("#notification_split_payment_finish").show();waitingAccount.enableWaitingAccountButtons();window.scrollTo(0,0)}}$("#voucher_input").val("");c();j();E=parseInt($(".int_part","#final_amount").text(),10)+parseInt($(".mantissa","#final_amount").text(),10)/100;if(E<=0){$("#add_voucher_box").hide();$("#add_new_voucher").parent().hide()}else{if(!m.length&&!g.length){$("#add_voucher_box").show();$("#add_new_voucher").parent().hide()}else{$("#add_voucher_box").hide();$("#add_new_voucher").parent().show()}}orderSummary.changeProceedButtonState();waitingAccount.updatePaymentBox();creditNote.updateCreditNoteAmount()},j=function(){var u=false,t;m=[];g=[];$("td.voucher").each(function(){t=$(this).closest("tr").attr("data-codeType");if(t==="PROMO"){g.push($(this).attr("data-voucherId"))}else{m.push($(this).attr("data-voucherId"))}u=true});if(u){$("#main_content_vouchers div.total").show()}else{$("#main_content_vouchers div.total").hide()}},r=function(t){return $.trim(t)},d=function(){var t=$(this);setTimeout(function(){t.val(r(t.val()))},10)};getPaymentMethodId=function(){var t=$("[name='paymentMethodId']:checked");if(!t.length){return $("[name='paymentMethodId']").val()}return t.val()};return{applyVoucher:function(){var t=$("#voucher_input"),w=r(t.val()),u,v=getPaymentMethodId();c();u=validation.validateField("voucher_input",[{rule:f,errorId:"notification_code_empty"},{rule:o,errorId:"notification_vouchers_already_used"},{rule:n,errorId:"notification_promotional_code_already_used"}],null,true);if(u){this.ajax.applyVoucherRequest(w,v,k,b,l)}else{$("#dynamicVouchersErrors > div.error").remove();t.focus()}},revokeVoucher:function(v,t){var u=getPaymentMethodId();this.ajax.revokeVoucherRequest(v,u,t,q,b,a)},confirmVoucher:function(u){var t=getPaymentMethodId();this.ajax.confirmVoucherRequest(u,t,q,b,a)},canSubmit:function(){if($("#voucher_input").val()){tools.dialog.showDialog("unvalidated_voucher_dialog",true);return false}return true},isVoucherApplied:function(){return $("#vouchers_list .voucher").length>0},init:function(){$("#apply-voucher").click(h);$("#voucher_input").keypress(function(t){if(t.keyCode===13){return h()}}).blur(function(){d.call(this)}).bind("focus.mask",function(){var u=this,t=$(this).val().length;setTimeout(function(){$(u).caret(t)},30)}).bind("paste",d);$("#voucher_input").on("keyup",function(){d.call(this)}).attr("maxlength",20);$("#vouchers_list").on("click",".alternative_button.delete a",function(){var u=$(this).attr("id").substring(7),t=$(this).closest("tr").attr("data-codeType");voucher.revokeVoucher(u,t==="PROMO");return false});$("#add_new_voucher").click(function(){$("#add_voucher_box").show();$("#add_new_voucher").parent().hide();return false});$("#vouchersErrors").on("click","span.confirm",function(){var t=$(this).find("a").attr("id").substring(8);voucher.confirmVoucher(t);return false}).on("click","span.cancel",function(){var t=$(this).find("a").attr("id").substring(7);voucher.revokeVoucher(t,false);return false}).on("click","span.cancel_promotional_code",function(){$("#notification_promotional_code").remove();return false}).on("click","span.confirm_promotional_code",function(){var t=$(this).data("code"),u=getPaymentMethodId();voucher.ajax.applyVoucherRequest(t,u,k,b,l,true);return false});$("#unvalidated_voucher_cancel").on("click",function(){tools.dialog.hideDialog("unvalidated_voucher_dialog");$("#voucher_input").focus();h();return false});$("#unvalidated_voucher_submit").on("click",function(){tools.dialog.hideDialog("unvalidated_voucher_dialog");$("#voucher_input").val("");orderSummary.submit();return false});j();if($("#unauthorizedOverPaymentNotification").length){i=true;orderSummary.changeProceedButtonState()}orderSummary.changeProceedButtonState()}}});tools.module("voucher.ajax",function(){var a=function(d,b,c){if(c!=="abort"){tools.dialog.showDialog("ajaxErrorDialog",true)}};return{applyVoucherRequest:function(g,d,c,f,e,b){$.ajax({url:contextPath+"/ajax/cart/applyVoucher",type:"POST",data:{voucherId:g,paymentMethodId:d,overrideExistingCode:b},cache:false,beforeSend:function(){return c(g)}}).done(function(h){tools.countdown.updateTimer();return f(h,g)}).fail(a).always(function(){return e(g)})},revokeVoucherRequest:function(h,e,c,d,g,f){var b=contextPath+"/ajax/cart/"+(c?"revokePromotionalCode":"revokeVoucher");$.ajax({url:b,type:"POST",data:{voucherId:h,paymentMethodId:e},cache:false,beforeSend:function(){return d(h)}}).done(function(i){return g(i,h)}).fail(a).always(function(){return f(h)})},confirmVoucherRequest:function(f,c,b,e,d){$.ajax({url:contextPath+"/ajax/cart/confirmVoucher",type:"POST",data:{voucherId:f,paymentMethodId:c},cache:false,beforeSend:function(){return b(f)}}).done(function(g){return e(g,f)}).fail(a).always(function(){return d(f)})}}});tools.module("waitingAccount",function(){var a="payment_waiting_account";return{enableWaitingAccount:null,waPaymentLimit:null,updatePaymentBox:function(){var c,b;if(this.enableWaitingAccount){b=$("#final_amount .mantissa").text();c=parseInt($("#final_amount .int_part").text().replace(/\D/g,""),10);if($.isNumeric(b)){c+=parseInt(b,10)/100}if(isNaN(c)){c=$("#saleAmountValue").val()}else{c*=1000}if(this.waPaymentLimit!==null){if(c>this.waPaymentLimit&&$("#main_content_summary_payment_methods .payment_waiting_account").is(":checked")){$("#wa_not_enough").show();orderSummary.changeProceedButtonState()}else{$("#wa_not_enough").hide();orderSummary.changeProceedButtonState()}}}},checkSplitPaymentAllowed:function(b){tools.dialog.showWaitingPopupDelayed("loadingDialog",true,null,200);$.ajax({url:contextPath+"/ajax/checkout/checkPaymentMethod",type:"POST",data:{paymentMethodId:b},cache:false,success:function(c){tools.dialog.hideDialog("loadingDialog");if(c==="OK"){$("#notification_split_payment, #notification_split_payment_finish").hide();$("#warning_voucher_split_payment, #warning_credit_note_split_payment").hide();waitingAccount.enableWaitingAccountButtons()}else{if(c==="KO"){$("#notification_split_payment").show();window.scrollTo(0,0);$("#notification_split_payment_finish").hide();$("#warning_voucher_split_payment, #warning_credit_note_split_payment").hide()}else{$("#notification_split_payment").hide();$("#warning_credit_note_split_payment").toggle(waitingAccount.isWaitingAccountSelected()&&creditNote.isCreditNoteSelected());$("#warning_voucher_split_payment").toggle(waitingAccount.isWaitingAccountSelected()&&voucher.isVoucherApplied());if(waitingAccount.isWaitingAccountSelected()&&(creditNote.isCreditNoteSelected()||voucher.isVoucherApplied())){waitingAccount.disableWaitingAccountButtons();$("#notification_split_payment_finish").hide()}else{$("#notification_split_payment_finish").show();window.scrollTo(0,0);waitingAccount.enableWaitingAccountButtons()}}}orderSummary.changeProceedButtonState()},error:function(){tools.dialog.hideDialog("loadingDialog");tools.dialog.showDialog("ajaxErrorDialog",true)}})},isWaitingAccountSelected:function(){var b=$("input[name=paymentMethodId]:checked");if(b){return $(b).hasClass(a)}else{return false}},disableWaitingAccountButtons:function(){$("input[name=paymentMethodId]."+a).prop("disabled",true);$("input[name=paymentMethodId]."+a).parent().addClass("disabled")},enableWaitingAccountButtons:function(){var b=$("input[name=paymentMethodId]."+a).parent();if(!$(b).hasClass("disabled_on_load")){$("input[name=paymentMethodId]."+a).prop("disabled",false);$(b).removeClass("disabled")}}}});